<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e8e8e8;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            color: #667eea;
        }

        .content {
            padding: 30px;
        }

        .mode {
            display: none;
        }

        .mode.active {
            display: block;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            font-family: 'Courier New', monospace;
            min-height: 100px;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .output {
            background: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            min-height: 100px;
        }

        .output h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .chord-progression {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .chord {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1em;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-box h4 {
            color: #1976d2;
            margin-bottom: 5px;
        }

        .controls-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .controls-row {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }
        }

        .piano-roll {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .note-display {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .note {
            background: #4caf50;
            color: white;
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .playback-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
        }

        .tempo-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tempo-control input[type="range"] {
            width: 200px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø—Ü–∏–π */
        select {
            font-weight: 500;
        }

        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–∏—Ç–º–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
        .rhythm-info {
            display: inline-block;
            padding: 5px 10px;
            background: #e3f2fd;
            border-radius: 5px;
            font-size: 0.9em;
            margin: 5px 5px 5px 0;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–æ—Ç */
        .note {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
        .btn:active {
            transform: scale(0.98);
        }

        /* –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è */
        .visualization-container {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
        }

        .viz-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .viz-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .viz-tab:hover {
            color: #667eea;
        }

        .viz-tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .viz-content {
            display: none;
        }

        .viz-content.active {
            display: block;
        }

        /* –ù–æ—Ç–Ω—ã–π —Å—Ç–∞–Ω */
        .staff-container {
            background: #fefefe;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
        }

        .staff-svg {
            width: 100%;
            min-height: 200px;
        }

        .staff-line {
            stroke: #333;
            stroke-width: 1;
        }

        .note-head {
            fill: #667eea;
        }

        .note-stem {
            stroke: #667eea;
            stroke-width: 2;
        }

        .chord-bracket {
            stroke: #764ba2;
            stroke-width: 2;
            fill: none;
        }

        /* –§–æ—Ä—Ç–µ–ø–∏–∞–Ω–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ */
        .piano-container {
            background: #2c2c2c;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
        }

        .piano-keyboard {
            display: flex;
            position: relative;
            height: 200px;
            min-width: 1400px;
        }

        .piano-key {
            position: relative;
            border: 1px solid #000;
            cursor: pointer;
            transition: all 0.1s;
        }

        .white-key {
            width: 40px;
            height: 200px;
            background: white;
            z-index: 1;
        }

        .white-key:hover {
            background: #f0f0f0;
        }

        .white-key.active {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.8);
        }

        .black-key {
            position: absolute;
            width: 28px;
            height: 120px;
            background: #222;
            z-index: 2;
            border: 1px solid #000;
        }

        .black-key:hover {
            background: #444;
        }

        .black-key.active {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.8);
        }

        .key-label {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 10px;
            font-weight: 600;
            color: #666;
            pointer-events: none;
        }

        .black-key .key-label {
            color: #aaa;
            bottom: 5px;
        }

        /* –ì–∏—Ç–∞—Ä–Ω—ã–µ –∞–ø–ø–ª–∏–∫–∞—Ç—É—Ä—ã */
        .guitar-container {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
        }

        .guitar-neck {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-x: auto;
        }

        .guitar-chord-diagram {
            display: inline-block;
            margin: 10px;
        }

        .fretboard {
            position: relative;
            width: 200px;
            height: 240px;
            background: #d4a574;
            border-radius: 4px;
            padding: 10px;
        }

        .guitar-string {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #888;
            left: 0;
        }

        .guitar-fret {
            position: absolute;
            width: 2px;
            height: 100%;
            background: #666;
            top: 0;
        }

        .finger-position {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #667eea;
            border-radius: 50%;
            border: 2px solid white;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .open-string,
        .muted-string {
            position: absolute;
            top: -25px;
            transform: translateX(-50%);
            font-weight: bold;
            font-size: 14px;
        }

        .open-string {
            color: #4caf50;
        }

        .muted-string {
            color: #f44336;
        }

        .chord-name {
            text-align: center;
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 10px;
            color: #667eea;
        }

        /* –ö–≤–∞—Ä—Ç–æ-–∫–≤–∏–Ω—Ç–æ–≤—ã–π –∫—Ä—É–≥ */
        .circle-container {
            background: #fefefe;
            padding: 30px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .circle-of-fifths {
            position: relative;
            width: 500px;
            height: 500px;
        }

        .circle-segment {
            position: absolute;
            width: 100%;
            height: 100%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .circle-key {
            position: absolute;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            border: 3px solid #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .circle-key:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .circle-key.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #764ba2;
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.8);
            transform: scale(1.15);
        }

        .circle-key.related {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .circle-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
        }

        .circle-center-title {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .circle-center-subtitle {
            font-size: 14px;
            color: #666;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-width: 768px) {
            .tempo-control {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .tempo-control input[type="range"] {
                width: 100%;
            }

            .piano-keyboard {
                min-width: 1000px;
            }

            .circle-of-fifths {
                width: 350px;
                height: 350px;
            }

            .circle-key {
                width: 50px;
                height: 50px;
                font-size: 12px;
            }

            .viz-tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä Pro</h1>
            <p>–ì–æ–ª–æ—Å–æ–≤–µ–¥–µ–Ω–∏–µ ‚Ä¢ –î–∂–∞–∑ ‚Ä¢ –ú–æ–¥–∞–ª—å–Ω–æ—Å—Ç—å ‚Ä¢ –†–∏—Ç–º—ã ‚Ä¢ –ê—Ä–ø–µ–¥–∂–∏–æ ‚Ä¢ –ù–æ—Ç–Ω—ã–π —Å—Ç–∞–Ω ‚Ä¢ –§–æ—Ä—Ç–µ–ø–∏–∞–Ω–æ ‚Ä¢ –ì–∏—Ç–∞—Ä–∞ ‚Ä¢ –ö—Ä—É–≥ –∫–≤–∏–Ω—Ç</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchMode(0)">
                –°–ª—É—á–∞–π–Ω—ã–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏
            </div>
            <div class="tab" onclick="switchMode(1)">
                –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç–∞
            </div>
        </div>

        <div class="content">
            <!-- –†–µ–∂–∏–º 1: –°–ª—É—á–∞–π–Ω—ã–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏ -->
            <div class="mode active" id="mode1">
                <div class="info-box">
                    <h4>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫–∏—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π</h4>
                    <p>–°–æ–∑–¥–∞–Ω–∏–µ –º—É–∑—ã–∫–∞–ª—å–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–π —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π –Ω–∞ –Ω–æ—Ç–Ω–æ–º —Å—Ç–∞–Ω–µ, —Ñ–æ—Ä—Ç–µ–ø–∏–∞–Ω–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ (88 –∫–ª–∞–≤–∏—à), –≥–∏—Ç–∞—Ä–Ω—ã—Ö –∞–ø–ø–ª–∏–∫–∞—Ç—É—Ä–∞—Ö –∏ –∫–≤–∞—Ä—Ç–æ-–∫–≤–∏–Ω—Ç–æ–≤–æ–º –∫—Ä—É–≥–µ. –ü–ª–∞–≤–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–µ–¥–µ–Ω–∏–µ, –¥–∂–∞–∑–æ–≤—ã–µ –∞–ª—å—Ç–µ—Ä–∞—Ü–∏–∏, –º–æ–¥–∞–ª—å–Ω–∞—è –≥–∞—Ä–º–æ–Ω–∏—è, —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ —Ä–∏—Ç–º—ã –∏ —Å—Ç–∏–ª–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è.</p>
                </div>

                <div class="controls-row">
                    <div class="control-group">
                        <label for="musicStyle">–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å:</label>
                        <select id="musicStyle">
                            <option value="traditional">–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞—è –≥–∞—Ä–º–æ–Ω–∏—è</option>
                            <option value="jazz">–î–∂–∞–∑ (II-V-I, —Å—É–±—Å—Ç–∏—Ç—É—Ü–∏–∏)</option>
                            <option value="blues">–ë–ª—é–∑ (12-—Ç–∞–∫—Ç–æ–≤—ã–π)</option>
                            <option value="classical">–ö–ª–∞—Å—Å–∏–∫–∞ (–∫–∞–¥–µ–Ω—Ü–∏–∏)</option>
                            <option value="poprock">–ü–æ–ø/—Ä–æ–∫</option>
                            <option value="modal">–ú–æ–¥–∞–ª—å–Ω–∞—è –≥–∞—Ä–º–æ–Ω–∏—è</option>
                        </select>
                    </div>

                    <div class="control-group" id="modalModeGroup" style="display: none;">
                        <label for="modalMode">–ú–æ–¥–∞–ª—å–Ω—ã–π –ª–∞–¥:</label>
                        <select id="modalMode">
                            <option value="ionian">–ò–æ–Ω–∏–π—Å–∫–∏–π (–º–∞–∂–æ—Ä)</option>
                            <option value="dorian">–î–æ—Ä–∏–π—Å–∫–∏–π</option>
                            <option value="phrygian">–§—Ä–∏–≥–∏–π—Å–∫–∏–π</option>
                            <option value="lydian">–õ–∏–¥–∏–π—Å–∫–∏–π</option>
                            <option value="mixolydian">–ú–∏–∫—Å–æ–ª–∏–¥–∏–π—Å–∫–∏–π</option>
                            <option value="aeolian">–≠–æ–ª–∏–π—Å–∫–∏–π (–º–∏–Ω–æ—Ä)</option>
                            <option value="locrian">–õ–æ–∫—Ä–∏–π—Å–∫–∏–π</option>
                        </select>
                    </div>
                </div>

                <div class="controls-row">
                    <div class="control-group">
                        <label for="complexity">–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:</label>
                        <select id="complexity">
                            <option value="simple">–ü—Ä–æ—Å—Ç–æ–π (—Ç—Ä–µ–∑–≤—É—á–∏—è)</option>
                            <option value="medium">–°—Ä–µ–¥–Ω–∏–π (—Å–µ–ø—Ç–∞–∫–∫–æ—Ä–¥—ã)</option>
                            <option value="complex">–°–ª–æ–∂–Ω—ã–π (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∞–∫–∫–æ—Ä–¥—ã)</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="voiceLeading">–ì–æ–ª–æ—Å–æ–≤–µ–¥–µ–Ω–∏–µ:</label>
                        <select id="voiceLeading">
                            <option value="block">–ë–ª–æ—á–Ω—ã–µ –∞–∫–∫–æ—Ä–¥—ã</option>
                            <option value="smooth">–ü–ª–∞–≤–Ω–æ–µ (—Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏)</option>
                        </select>
                    </div>
                </div>

                <div class="controls-row">
                    <div class="control-group">
                        <label for="length">–î–ª–∏–Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏:</label>
                        <select id="length">
                            <option value="4">4 –∞–∫–∫–æ—Ä–¥–∞</option>
                            <option value="8" selected>8 –∞–∫–∫–æ—Ä–¥–æ–≤</option>
                            <option value="12">12 –∞–∫–∫–æ—Ä–¥–æ–≤</option>
                            <option value="16">16 –∞–∫–∫–æ—Ä–¥–æ–≤</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="passingChords">–ü—Ä–æ—Ö–æ–¥—è—â–∏–µ –∞–∫–∫–æ—Ä–¥—ã:</label>
                        <select id="passingChords">
                            <option value="none">–ë–µ–∑ –ø—Ä–æ—Ö–æ–¥—è—â–∏—Ö</option>
                            <option value="diminished">–£–º–µ–Ω—å—à—ë–Ω–Ω—ã–µ</option>
                        </select>
                    </div>
                </div>

                <div class="control-group">
                    <label for="key">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–π):</label>
                    <select id="key">
                        <option value="">–°–ª—É—á–∞–π–Ω–∞—è</option>
                        <optgroup label="–ú–∞–∂–æ—Ä–Ω—ã–µ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏">
                            <option value="C">C (–î–æ –º–∞–∂–æ—Ä)</option>
                            <option value="G">G (–°–æ–ª—å –º–∞–∂–æ—Ä)</option>
                            <option value="D">D (–†–µ –º–∞–∂–æ—Ä)</option>
                            <option value="A">A (–õ—è –º–∞–∂–æ—Ä)</option>
                            <option value="E">E (–ú–∏ –º–∞–∂–æ—Ä)</option>
                            <option value="B">B (–°–∏ –º–∞–∂–æ—Ä)</option>
                            <option value="F#">F# (–§–∞-–¥–∏–µ–∑ –º–∞–∂–æ—Ä)</option>
                            <option value="Db">Db (–†–µ-–±–µ–º–æ–ª—å –º–∞–∂–æ—Ä)</option>
                            <option value="Ab">Ab (–õ—è-–±–µ–º–æ–ª—å –º–∞–∂–æ—Ä)</option>
                            <option value="Eb">Eb (–ú–∏-–±–µ–º–æ–ª—å –º–∞–∂–æ—Ä)</option>
                            <option value="Bb">Bb (–°–∏-–±–µ–º–æ–ª—å –º–∞–∂–æ—Ä)</option>
                            <option value="F">F (–§–∞ –º–∞–∂–æ—Ä)</option>
                        </optgroup>
                        <optgroup label="–ú–∏–Ω–æ—Ä–Ω—ã–µ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏">
                            <option value="Am">Am (–õ—è –º–∏–Ω–æ—Ä)</option>
                            <option value="Em">Em (–ú–∏ –º–∏–Ω–æ—Ä)</option>
                            <option value="Bm">Bm (–°–∏ –º–∏–Ω–æ—Ä)</option>
                            <option value="F#m">F#m (–§–∞-–¥–∏–µ–∑ –º–∏–Ω–æ—Ä)</option>
                            <option value="C#m">C#m (–î–æ-–¥–∏–µ–∑ –º–∏–Ω–æ—Ä)</option>
                            <option value="G#m">G#m (–°–æ–ª—å-–¥–∏–µ–∑ –º–∏–Ω–æ—Ä)</option>
                            <option value="D#m">D#m (–†–µ-–¥–∏–µ–∑ –º–∏–Ω–æ—Ä)</option>
                            <option value="Bbm">Bbm (–°–∏-–±–µ–º–æ–ª—å –º–∏–Ω–æ—Ä)</option>
                            <option value="Fm">Fm (–§–∞ –º–∏–Ω–æ—Ä)</option>
                            <option value="Cm">Cm (–î–æ –º–∏–Ω–æ—Ä)</option>
                            <option value="Gm">Gm (–°–æ–ª—å –º–∏–Ω–æ—Ä)</option>
                            <option value="Dm">Dm (–†–µ –º–∏–Ω–æ—Ä)</option>
                        </optgroup>
                    </select>
                </div>

                <div class="controls-row">
                    <div class="control-group">
                        <label for="timeSignature">–ú–µ—Ç—Ä:</label>
                        <select id="timeSignature">
                            <option value="4/4">4/4 (—á–µ—Ç—ã—Ä–µ —á–µ—Ç–≤–µ—Ä—Ç–∏)</option>
                            <option value="3/4">3/4 (—Ç—Ä–∏ —á–µ—Ç–≤–µ—Ä—Ç–∏ - –≤–∞–ª—å—Å)</option>
                            <option value="6/8">6/8 (—à–µ—Å—Ç—å –≤–æ—Å—å–º—ã—Ö)</option>
                            <option value="7/8">7/8 (—Å–µ–º—å –≤–æ—Å—å–º—ã—Ö)</option>
                            <option value="5/4">5/4 (–ø—è—Ç—å —á–µ—Ç–≤–µ—Ä—Ç–µ–π)</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="rhythmPattern">–†–∏—Ç–º–∏—á–µ—Å–∫–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω:</label>
                        <select id="rhythmPattern">
                            <option value="straight">–ü—Ä—è–º–æ–π (straight)</option>
                            <option value="waltz">–í–∞–ª—å—Å</option>
                            <option value="bolero">–ë–æ–ª–µ—Ä–æ</option>
                            <option value="ragtime">–†–µ–≥—Ç–∞–π–º</option>
                            <option value="bossa">Bossa Nova</option>
                            <option value="swing">Swing</option>
                            <option value="latin">–õ–∞—Ç–∏–Ω–∞</option>
                            <option value="funk">–§–∞–Ω–∫ (—Å–∏–Ω–∫–æ–ø—ã)</option>
                        </select>
                    </div>
                </div>

                <div class="controls-row">
                    <div class="control-group">
                        <label for="playbackStyle">–°—Ç–∏–ª—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
                        <select id="playbackStyle">
                            <option value="block">–ë–ª–æ–∫–æ–≤—ã–µ –∞–∫–∫–æ—Ä–¥—ã</option>
                            <option value="arpeggio-up">–ê—Ä–ø–µ–¥–∂–∏–æ –≤–≤–µ—Ä—Ö</option>
                            <option value="arpeggio-down">–ê—Ä–ø–µ–¥–∂–∏–æ –≤–Ω–∏–∑</option>
                            <option value="arpeggio-updown">–ê—Ä–ø–µ–¥–∂–∏–æ –≤–≤–µ—Ä—Ö-–≤–Ω–∏–∑</option>
                            <option value="broken">–†–∞–∑–ª–æ–∂–µ–Ω–Ω—ã–π –∞–∫–∫–æ—Ä–¥</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>–¢–µ–º–ø: <span id="tempoValue1">120</span> BPM</label>
                        <input type="range" id="tempo1" min="40" max="200" value="120" style="width: 100%;">
                    </div>
                </div>

                <div class="playback-controls">
                    <button class="btn btn-primary" onclick="generateProgression()">
                        üé≤ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—é
                    </button>
                    <button class="btn btn-primary" onclick="playProgression()">
                        ‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
                    </button>
                    <button class="btn btn-secondary" onclick="stopPlayback()">
                        ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>

                <div class="output" id="output1">
                    <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</h3>
                </div>

                <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è -->
                <div class="visualization-container" id="visualization1" style="display: none;">
                    <div class="viz-tabs">
                        <button class="viz-tab active" onclick="switchVizTab(0, 0)">üìä –ù–æ—Ç–Ω—ã–π —Å—Ç–∞–Ω</button>
                        <button class="viz-tab" onclick="switchVizTab(0, 1)">üéπ –§–æ—Ä—Ç–µ–ø–∏–∞–Ω–æ</button>
                        <button class="viz-tab" onclick="switchVizTab(0, 2)">üé∏ –ì–∏—Ç–∞—Ä–∞</button>
                        <button class="viz-tab" onclick="switchVizTab(0, 3)">‚≠ï –ö—Ä—É–≥ –∫–≤–∏–Ω—Ç</button>
                    </div>

                    <div class="viz-content active" id="viz1-staff">
                        <div class="staff-container">
                            <svg class="staff-svg" id="staff-svg-1"></svg>
                        </div>
                    </div>

                    <div class="viz-content" id="viz1-piano">
                        <div class="piano-container">
                            <div class="piano-keyboard" id="piano-keyboard-1"></div>
                        </div>
                    </div>

                    <div class="viz-content" id="viz1-guitar">
                        <div class="guitar-container">
                            <div class="guitar-neck" id="guitar-neck-1"></div>
                        </div>
                    </div>

                    <div class="viz-content" id="viz1-circle">
                        <div class="circle-container">
                            <div class="circle-of-fifths" id="circle-of-fifths-1"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –†–µ–∂–∏–º 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç–∞ -->
            <div class="mode" id="mode2">
                <div class="info-box">
                    <h4>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç–∞ –ø–æ –º–µ–ª–æ–¥–∏–∏</h4>
                    <p>–í–≤–µ–¥–∏—Ç–µ –º–µ–ª–æ–¥–∏—é, –∏ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–µ—Ä—ë—Ç –≥–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∞–∫–∫–æ—Ä–¥—ã. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç—Ä–æ–≤ –∏ —Å—Ç–∏–ª–µ–π –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è (–±–ª–æ–∫–æ–≤—ã–µ –∞–∫–∫–æ—Ä–¥—ã, –∞—Ä–ø–µ–¥–∂–∏–æ). –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –º–µ–ª–æ–¥–∏–∏ —Å –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.</p>
                </div>

                <div class="control-group">
                    <label for="melody">–ú–µ–ª–æ–¥–∏—è (—Ñ–æ—Ä–º–∞—Ç: –Ω–æ—Ç–∞+–æ–∫—Ç–∞–≤–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä "C4 1 D4 1 E4 2"):</label>
                    <textarea id="melody" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: C4 1 E4 1 G4 1 C5 1 G4 1 E4 1 C4 2&#10;–ò–ª–∏: A3 2 C4 1 E4 1 A4 2 G4 1 E4 1 C4 2"></textarea>
                    <small style="color: #666;">–§–æ—Ä–º–∞—Ç: –ù–û–¢–ê+–û–ö–¢–ê–í–ê –î–õ–ò–¢–ï–õ–¨–ù–û–°–¢–¨ (1=—á–µ—Ç–≤–µ—Ä—Ç—å, 2=–ø–æ–ª–æ–≤–∏–Ω–∞, 4=—Ü–µ–ª–∞—è)</small>
                </div>

                <div class="controls-row">
                    <div class="control-group">
                        <label for="accompComplexity">–°–ª–æ–∂–Ω–æ—Å—Ç—å –∞–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç–∞:</label>
                        <select id="accompComplexity">
                            <option value="simple">–ü—Ä–æ—Å—Ç–æ–π (—Ç—Ä–∏–∞–¥—ã)</option>
                            <option value="medium">–°—Ä–µ–¥–Ω–∏–π (—Å–µ–ø—Ç–∞–∫–∫–æ—Ä–¥—ã)</option>
                            <option value="complex">–°–ª–æ–∂–Ω—ã–π (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∞–∫–∫–æ—Ä–¥—ã)</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="analyzeKey">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:</label>
                        <select id="analyzeKey">
                            <option value="auto">–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</option>
                            <optgroup label="–ú–∞–∂–æ—Ä–Ω—ã–µ">
                                <option value="C">C –º–∞–∂–æ—Ä</option>
                                <option value="G">G –º–∞–∂–æ—Ä</option>
                                <option value="D">D –º–∞–∂–æ—Ä</option>
                                <option value="A">A –º–∞–∂–æ—Ä</option>
                                <option value="E">E –º–∞–∂–æ—Ä</option>
                                <option value="B">B –º–∞–∂–æ—Ä</option>
                                <option value="F#">F# –º–∞–∂–æ—Ä</option>
                                <option value="Db">Db –º–∞–∂–æ—Ä</option>
                                <option value="Ab">Ab –º–∞–∂–æ—Ä</option>
                                <option value="Eb">Eb –º–∞–∂–æ—Ä</option>
                                <option value="Bb">Bb –º–∞–∂–æ—Ä</option>
                                <option value="F">F –º–∞–∂–æ—Ä</option>
                            </optgroup>
                            <optgroup label="–ú–∏–Ω–æ—Ä–Ω—ã–µ">
                                <option value="Am">A –º–∏–Ω–æ—Ä</option>
                                <option value="Em">E –º–∏–Ω–æ—Ä</option>
                                <option value="Bm">B –º–∏–Ω–æ—Ä</option>
                                <option value="F#m">F# –º–∏–Ω–æ—Ä</option>
                                <option value="C#m">C# –º–∏–Ω–æ—Ä</option>
                                <option value="G#m">G# –º–∏–Ω–æ—Ä</option>
                                <option value="D#m">D# –º–∏–Ω–æ—Ä</option>
                                <option value="Bbm">Bb –º–∏–Ω–æ—Ä</option>
                                <option value="Fm">F –º–∏–Ω–æ—Ä</option>
                                <option value="Cm">C –º–∏–Ω–æ—Ä</option>
                                <option value="Gm">G –º–∏–Ω–æ—Ä</option>
                                <option value="Dm">D –º–∏–Ω–æ—Ä</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div class="controls-row">
                    <div class="control-group">
                        <label for="timeSignature2">–ú–µ—Ç—Ä:</label>
                        <select id="timeSignature2">
                            <option value="4/4">4/4 (—á–µ—Ç—ã—Ä–µ —á–µ—Ç–≤–µ—Ä—Ç–∏)</option>
                            <option value="3/4">3/4 (—Ç—Ä–∏ —á–µ—Ç–≤–µ—Ä—Ç–∏)</option>
                            <option value="6/8">6/8 (—à–µ—Å—Ç—å –≤–æ—Å—å–º—ã—Ö)</option>
                            <option value="7/8">7/8 (—Å–µ–º—å –≤–æ—Å—å–º—ã—Ö)</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="accompStyle">–°—Ç–∏–ª—å –∞–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç–∞:</label>
                        <select id="accompStyle">
                            <option value="block">–ë–ª–æ–∫–æ–≤—ã–µ –∞–∫–∫–æ—Ä–¥—ã</option>
                            <option value="arpeggio-up">–ê—Ä–ø–µ–¥–∂–∏–æ –≤–≤–µ—Ä—Ö</option>
                            <option value="arpeggio-down">–ê—Ä–ø–µ–¥–∂–∏–æ –≤–Ω–∏–∑</option>
                            <option value="broken">–†–∞–∑–ª–æ–∂–µ–Ω–Ω—ã–π</option>
                        </select>
                    </div>
                </div>

                <div class="playback-controls">
                    <button class="btn btn-primary" onclick="generateAccompaniment()">
                        üéº –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç
                    </button>
                    <button class="btn btn-primary" onclick="playAccompaniment()">
                        ‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
                    </button>
                    <button class="btn btn-secondary" onclick="stopPlayback()">
                        ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    </button>

                    <div class="tempo-control">
                        <label>–¢–µ–º–ø: <span id="tempoValue2">100</span> BPM</label>
                        <input type="range" id="tempo2" min="40" max="200" value="100" style="width: 100%;">
                    </div>
                </div>

                <div class="output" id="output2">
                    <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</h3>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== –ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è —Ç–µ–æ—Ä–∏—è ==========
        
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        const SCALES = {
            major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 10],
            harmonicMinor: [0, 2, 3, 5, 7, 8, 11],
            // –ú–æ–¥–∞–ª—å–Ω—ã–µ –ª–∞–¥—ã
            ionian: [0, 2, 4, 5, 7, 9, 11],      // –ò–æ–Ω–∏–π—Å–∫–∏–π (–º–∞–∂–æ—Ä)
            dorian: [0, 2, 3, 5, 7, 9, 10],      // –î–æ—Ä–∏–π—Å–∫–∏–π
            phrygian: [0, 1, 3, 5, 7, 8, 10],    // –§—Ä–∏–≥–∏–π—Å–∫–∏–π
            lydian: [0, 2, 4, 6, 7, 9, 11],      // –õ–∏–¥–∏–π—Å–∫–∏–π
            mixolydian: [0, 2, 4, 5, 7, 9, 10],  // –ú–∏–∫—Å–æ–ª–∏–¥–∏–π—Å–∫–∏–π
            aeolian: [0, 2, 3, 5, 7, 8, 10],     // –≠–æ–ª–∏–π—Å–∫–∏–π (–Ω–∞—Ç—É—Ä. –º–∏–Ω–æ—Ä)
            locrian: [0, 1, 3, 5, 6, 8, 10]      // –õ–æ–∫—Ä–∏–π—Å–∫–∏–π
        };

        // –ö–∞—á–µ—Å—Ç–≤–∞ –∞–∫–∫–æ—Ä–¥–æ–≤ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –ª–∞–¥–æ–≤
        const MODAL_CHORD_QUALITIES = {
            dorian: ['min', 'min', 'maj', 'maj', 'min', 'dim', 'maj'],
            phrygian: ['min', 'maj', 'maj', 'min', 'dim', 'maj', 'min'],
            lydian: ['maj', 'maj', 'min', 'dim', 'maj', 'min', 'min'],
            mixolydian: ['maj', 'min', 'dim', 'maj', 'min', 'min', 'maj'],
            locrian: ['dim', 'maj', 'min', 'min', 'maj', 'maj', 'min']
        };

        // –î–∂–∞–∑–æ–≤—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –∞–ª—å—Ç–µ—Ä–∞—Ü–∏–∏
        const JAZZ_EXTENSIONS = {
            maj7: [0, 4, 7, 11],
            min7: [0, 3, 7, 10],
            dom7: [0, 4, 7, 10],
            min7b5: [0, 3, 6, 10],  // Half-diminished
            dim7: [0, 3, 6, 9],
            maj9: [0, 4, 7, 11, 14],
            min9: [0, 3, 7, 10, 14],
            dom9: [0, 4, 7, 10, 14],
            dom7b9: [0, 4, 7, 10, 13],
            dom7sharp9: [0, 4, 7, 10, 15],
            dom7sharp11: [0, 4, 7, 10, 18],
            dom7b13: [0, 4, 7, 10, 20]
        };

        // –†–∏—Ç–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (–¥–æ–ª–∏ –≤–Ω—É—Ç—Ä–∏ —Ç–∞–∫—Ç–∞)
        const RHYTHM_PATTERNS = {
            straight: {
                '4/4': [0, 1, 2, 3],           // –ù–∞ –∫–∞–∂–¥—É—é –¥–æ–ª—é
                '3/4': [0, 1, 2],              // –¢—Ä–∏ –¥–æ–ª–∏
                '6/8': [0, 1.5, 3, 4.5],       // –î–≤–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–æ–ª–∏
                '7/8': [0, 1, 2, 3, 4, 5, 6],  // 2+2+3 –∏–ª–∏ 3+2+2
                '5/4': [0, 1, 2, 3, 4]         // –ü—è—Ç—å –¥–æ–ª–µ–π
            },
            waltz: {
                '3/4': [0, 1, 2],              // –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤–∞–ª—å—Å: –°–ò–õ–¨–ù–ê–Ø-—Å–ª–∞–±–∞—è-—Å–ª–∞–±–∞—è
                '6/8': [0, 3]                  // –î–≤–∞ "–±—É–º-—á–∞-—á–∞"
            },
            bolero: {
                '4/4': [0, 0.75, 1.5, 2.5, 3, 3.5], // –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–π –∏—Å–ø–∞–Ω—Å–∫–∏–π —Ä–∏—Ç–º
                '3/4': [0, 0.66, 1.33, 2, 2.66]
            },
            ragtime: {
                '4/4': [0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5], // –°–∏–Ω–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, —Å –æ—Ñ—Ñ-–±–∏—Ç–∞–º–∏
                '2/4': [0, 0.5, 1, 1.5]
            },
            bossa: {
                '4/4': [0, 0.5, 1.5, 2, 3],    // 3-3-2 –ø–∞—Ç—Ç–µ—Ä–Ω –ë—Ä–∞–∑–∏–ª—å—Å–∫–æ–π –º—É–∑—ã–∫–∏
                '2/4': [0, 0.5, 1.5]
            },
            swing: {
                '4/4': [0, 0.66, 1.33, 2, 2.66, 3.33], // –°–≤–∏–Ω–≥–æ–≤—ã–π —Ç—Ä–∏–æ–ª—å–Ω—ã–π —Ä–∏—Ç–º
                '3/4': [0, 0.66, 1.33, 2, 2.66]
            },
            latin: {
                '4/4': [0, 0.5, 1, 2, 2.5, 3], // –ö–ª–∞–≤–µ 3-2
                '2/4': [0, 0.5, 1]
            },
            funk: {
                '4/4': [0, 0.25, 0.75, 1.25, 1.75, 2.25, 2.75, 3.25, 3.75], // –°–∏–Ω–∫–æ–ø—ã –Ω–∞ –∫–∞–∂–¥—ã–π off-beat
                '2/4': [0, 0.25, 0.75, 1.25, 1.75]
            }
        };

        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∞–∫—Ü–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∏—Ç–º–∞
        const RHYTHM_ACCENTS = {
            straight: [1.0, 0.7, 0.8, 0.7],
            waltz: [1.0, 0.6, 0.6],
            bolero: [1.0, 0.7, 0.8, 0.7, 0.9, 0.6],
            ragtime: [1.0, 0.5, 0.8, 0.5, 0.9, 0.5, 0.8, 0.5],
            bossa: [1.0, 0.7, 0.8, 0.9, 0.7],
            swing: [1.0, 0.6, 0.8, 0.9, 0.6, 0.7],
            latin: [1.0, 0.7, 0.9, 1.0, 0.7, 0.8],
            funk: [1.0, 0.5, 0.7, 0.6, 0.8, 0.6, 0.8, 0.6, 0.7]
        };

        const CHORD_QUALITIES = {
            I: 'maj',
            II: 'min',
            III: 'min',
            IV: 'maj',
            V: 'maj',
            VI: 'min',
            VII: 'dim'
        };

        const MINOR_CHORD_QUALITIES = {
            I: 'min',
            II: 'dim',
            III: 'maj',
            IV: 'min',
            V: 'min',
            VI: 'maj',
            VII: 'maj'
        };

        // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏
        const PROGRESSIONS = {
            simple: [
                ['I', 'IV', 'V', 'I'],
                ['I', 'V', 'VI', 'IV'],
                ['I', 'IV', 'I', 'V'],
                ['VI', 'IV', 'I', 'V']
            ],
            medium: [
                ['I', 'VI', 'II', 'V'],
                ['I', 'IV', 'II', 'V'],
                ['I', 'III', 'VI', 'II', 'V', 'I'],
                ['I', 'V', 'VI', 'III', 'IV', 'I', 'IV', 'V'],
                ['VI', 'II', 'V', 'I'],
                ['I', 'VI', 'IV', 'V']
            ],
            complex: [
                ['I', 'VI', 'II', 'V', 'III', 'VI', 'II', 'V'],
                ['I', 'IV', 'VII', 'III', 'VI', 'II', 'V', 'I'],
                ['I', 'bVII', 'IV', 'I'],
                ['I', 'V/VI', 'VI', 'V/V', 'V', 'I']
            ],
            // –î–∂–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏
            jazz: [
                ['Imaj7', 'VIm7', 'IIm7', 'V7'],           // I-VI-II-V
                ['IIm7', 'V7', 'Imaj7'],                   // II-V-I
                ['Imaj7', 'IV7', 'IIIm7', 'VIm7', 'IIm7', 'V7', 'Imaj7'], // Rhythm changes
                ['Im7', 'IVm7', 'bVIImaj7', 'bIIImaj7'],  // Minor jazz
                ['Imaj7', 'bIIImaj7', 'IIm7', 'V7'],      // –¢—Ä–∏—Ç–æ–Ω–æ–≤–∞—è —Å—É–±—Å—Ç–∏—Ç—É—Ü–∏—è
                ['IIm7', 'V7alt', 'Imaj7'],               // –° –∞–ª—å—Ç–µ—Ä–∞—Ü–∏—è–º–∏
            ],
            // –ë–ª—é–∑–æ–≤—ã–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏
            blues: [
                ['I7', 'I7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'I7', 'V7', 'IV7', 'I7', 'V7'], // 12-bar blues
                ['I7', 'IV7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'I7', 'V7', 'V7', 'I7', 'I7'], // Basic blues
            ],
            // –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –∫–∞–¥–µ–Ω—Ü–∏–∏
            classical: [
                ['I', 'IV', 'V', 'I'],                     // –ü–æ–ª–Ω–∞—è –∫–∞–¥–µ–Ω—Ü–∏—è
                ['I', 'II', 'V', 'I'],                     // –° II —Å—Ç—É–ø–µ–Ω—å—é
                ['I', 'IV', 'I6/4', 'V', 'I'],            // –ö–∞–¥–∞–Ω—Å–æ–≤—ã–π –∫–≤–∞—Ä—Ç—Å–µ–∫—Å—Ç–∞–∫–∫–æ—Ä–¥
                ['I', 'VI', 'IV', 'V', 'I'],              // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è
                ['I', 'IV', 'viidim', 'I'],               // –° —É–º–µ–Ω—å—à—ë–Ω–Ω—ã–º VII
                ['I', 'II6', 'V', 'I'],                   // –°–µ–∫—Å—Ç–∞–∫–∫–æ—Ä–¥ –Ω–∞ II
            ],
            // –ü–æ–ø/—Ä–æ–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏
            poprock: [
                ['I', 'V', 'VI', 'IV'],                    // "Axis of Awesome"
                ['VI', 'IV', 'I', 'V'],                    // –í–∞—Ä–∏–∞–Ω—Ç
                ['I', 'IV', 'V', 'IV'],                    // –ü—Ä–æ—Å—Ç–∞—è —Ä–æ–∫
                ['I', 'bVII', 'IV', 'I'],                 // –†–æ–∫ —Å bVII
                ['I', 'III', 'IV', 'IV'],                 // –Ø–ø–æ–Ω—Å–∫–∞—è –ø–æ–ø
                ['VI', 'III', 'VII', 'IV'],               // –î—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–∞—è
            ]
        };

        // Web Audio API
        let audioContext;
        let currentPlayback = null;
        let currentProgression = [];
        let currentMelody = [];

        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        let generatedChords = [];

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // ========== –£—Ç–∏–ª–∏—Ç—ã ==========

        function noteToFreq(note, octave) {
            const noteIndex = NOTES.indexOf(note);
            const a4 = 440;
            const halfSteps = (octave - 4) * 12 + (noteIndex - 9); // A4 = index 9
            return a4 * Math.pow(2, halfSteps / 12);
        }

        function getScaleNotes(rootNote, scaleType = 'major') {
            const rootIndex = NOTES.indexOf(rootNote);
            const scale = SCALES[scaleType];
            return scale.map(interval => NOTES[(rootIndex + interval) % 12]);
        }

        function getDegreeNote(rootNote, degree, scaleType = 'major') {
            const scaleNotes = getScaleNotes(rootNote, scaleType);
            const romanNumerals = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII'];
            const degreeIndex = romanNumerals.indexOf(degree);
            return scaleNotes[degreeIndex];
        }

        function buildChord(rootNote, quality, complexity = 'simple', chordType = null) {
            const rootIndex = NOTES.indexOf(rootNote);
            let intervals = [0, 4, 7]; // Major triad by default
            let chordName = rootNote;

            // –î–∂–∞–∑–æ–≤—ã–µ –∞–∫–∫–æ—Ä–¥—ã
            if (chordType && JAZZ_EXTENSIONS[chordType]) {
                intervals = JAZZ_EXTENSIONS[chordType];
                chordName = rootNote + chordType.replace('dom', '').replace('maj', 'maj').replace('min', 'm');
            } else {
                // –ë–∞–∑–æ–≤—ã–µ —Ç—Ä–∏–∞–¥—ã
                if (quality === 'min') {
                    intervals = [0, 3, 7];
                    chordName += 'm';
                } else if (quality === 'dim') {
                    intervals = [0, 3, 6];
                    chordName += 'dim';
                } else if (quality === 'aug') {
                    intervals = [0, 4, 8];
                    chordName += 'aug';
                }

                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ–ø—Ç–∏–º—ã
                if (complexity === 'medium' || complexity === 'complex') {
                    if (quality === 'maj' && Math.random() > 0.4) {
                        intervals.push(11); // Maj7
                        chordName += 'maj7';
                    } else if (quality === 'min' && Math.random() > 0.4) {
                        intervals.push(10); // m7
                        chordName += '7';
                    } else if (quality === 'dim' && Math.random() > 0.5) {
                        intervals.push(10); // m7b5 (half-diminished)
                        chordName += '7';
                    } else if (quality === 'maj' && Math.random() > 0.3) {
                        intervals.push(10); // dom7
                        chordName += '7';
                    }
                }

                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –¥–ª—è —Å–ª–æ–∂–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
                if (complexity === 'complex' && intervals.length >= 4 && Math.random() > 0.6) {
                    intervals.push(14); // 9-—è —Å—Ç—É–ø–µ–Ω—å
                    chordName += '9';
                }
            }

            const notes = intervals.map(interval => NOTES[(rootIndex + interval) % 12]);
            
            return {
                notes: notes,
                name: chordName,
                intervals: intervals,
                root: rootNote
            };
        }

        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∞–∫–∫–æ—Ä–¥–∞ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –æ–±—Ä–∞—â–µ–Ω–∏–µ–º
        function buildChordWithInversion(rootNote, quality, complexity, inversion = 0, chordType = null) {
            const chord = buildChord(rootNote, quality, complexity, chordType);
            
            if (inversion === 0) {
                return chord; // –û—Å–Ω–æ–≤–Ω–æ–π –≤–∏–¥
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–µ
            const invertedNotes = [...chord.notes];
            for (let i = 0; i < inversion; i++) {
                const bottom = invertedNotes.shift();
                invertedNotes.push(bottom);
            }
            
            let inversionName = '';
            if (inversion === 1) inversionName = '/3';
            if (inversion === 2) inversionName = '/5';
            if (inversion === 3) inversionName = '/7';
            
            return {
                notes: invertedNotes,
                name: chord.name + inversionName,
                intervals: chord.intervals,
                root: rootNote,
                inversion: inversion
            };
        }

        // –ß–µ—Ç—ã—Ä—ë—Ö–≥–æ–ª–æ—Å–Ω–∞—è –≥–∞—Ä–º–æ–Ω–∏–∑–∞—Ü–∏—è —Å –≥–æ–ª–æ—Å–æ–≤–µ–¥–µ–Ω–∏–µ–º
        function voiceChord(chord, octave = 4) {
            const voices = {
                bass: chord.notes[0],
                tenor: chord.notes[1] || chord.notes[0],
                alto: chord.notes[2] || chord.notes[1],
                soprano: chord.notes[chord.notes.length - 1]
            };
            
            return {
                bass: { note: voices.bass, octave: octave - 1 },
                tenor: { note: voices.tenor, octave: octave },
                alto: { note: voices.alto, octave: octave },
                soprano: { note: voices.soprano, octave: octave + 1 }
            };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∫–≤–∏–Ω—Ç –∏ –æ–∫—Ç–∞–≤
        function hasParallelFifthsOrOctaves(chord1Voices, chord2Voices) {
            const voices = ['bass', 'tenor', 'alto', 'soprano'];
            
            for (let i = 0; i < voices.length; i++) {
                for (let j = i + 1; j < voices.length; j++) {
                    const voice1 = voices[i];
                    const voice2 = voices[j];
                    
                    const interval1 = getInterval(chord1Voices[voice1].note, chord1Voices[voice2].note);
                    const interval2 = getInterval(chord2Voices[voice1].note, chord2Voices[voice2].note);
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∫–≤–∏–Ω—Ç (7 –ø–æ–ª—É—Ç–æ–Ω–æ–≤) –∏ –æ–∫—Ç–∞–≤ (0 –ø–æ–ª—É—Ç–æ–Ω–æ–≤)
                    if ((interval1 === 7 && interval2 === 7) || (interval1 === 0 && interval2 === 0)) {
                        return true;
                    }
                }
            }
            return false;
        }

        function getInterval(note1, note2) {
            const index1 = NOTES.indexOf(note1);
            const index2 = NOTES.indexOf(note2);
            return Math.abs(index2 - index1) % 12;
        }

        // –í—ã–±–æ—Ä –Ω–∞–∏–ª—É—á—à–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–µ–¥–µ–Ω–∏—è
        function findBestInversion(prevChord, currentChordRoot, quality, complexity, chordType = null) {
            let bestInversion = 0;
            let minMovement = Infinity;
            
            const maxInversions = quality === 'dim' ? 2 : (complexity === 'simple' ? 2 : 3);
            
            for (let inv = 0; inv <= maxInversions; inv++) {
                const testChord = buildChordWithInversion(currentChordRoot, quality, complexity, inv, chordType);
                const testVoices = voiceChord(testChord);
                const prevVoices = voiceChord(prevChord);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∫–≤–∏–Ω—Ç/–æ–∫—Ç–∞–≤
                if (hasParallelFifthsOrOctaves(prevVoices, testVoices)) {
                    continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ
                }
                
                // –ü–æ–¥—Å—á—ë—Ç –æ–±—â–µ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤
                let totalMovement = 0;
                ['soprano', 'alto', 'tenor'].forEach(voice => {
                    const move = getInterval(prevVoices[voice].note, testVoices[voice].note);
                    totalMovement += Math.min(move, 12 - move); // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
                });
                
                if (totalMovement < minMovement) {
                    minMovement = totalMovement;
                    bestInversion = inv;
                }
            }
            
            return bestInversion;
        }

        // ========== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–π ==========

        function generateProgression() {
            initAudio();

            const complexity = document.getElementById('complexity').value;
            const length = parseInt(document.getElementById('length').value);
            const musicStyle = document.getElementById('musicStyle').value;
            const voiceLeadingType = document.getElementById('voiceLeading').value;
            const passingChordsType = document.getElementById('passingChords').value;
            let keySelect = document.getElementById('key').value;

            // –°–ª—É—á–∞–π–Ω–∞—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
            if (!keySelect) {
                const majorKeys = ['C', 'G', 'D', 'A', 'E', 'B', 'F#', 'Db', 'Ab', 'Eb', 'Bb', 'F'];
                const minorKeys = ['Am', 'Em', 'Bm', 'F#m', 'C#m', 'G#m', 'D#m', 'Bbm', 'Fm', 'Cm', 'Gm', 'Dm'];
                const allKeys = [...majorKeys, ...minorKeys];
                keySelect = allKeys[Math.floor(Math.random() * allKeys.length)];
            }

            const isMinor = keySelect.includes('m');
            const rootNote = keySelect.replace('m', '');
            let scaleType = isMinor ? 'minor' : 'major';
            let modalMode = null;

            // –ú–æ–¥–∞–ª—å–Ω–∞—è –≥–∞—Ä–º–æ–Ω–∏—è
            if (musicStyle === 'modal') {
                modalMode = document.getElementById('modalMode').value;
                scaleType = modalMode;
            }

            // –í—ã–±–æ—Ä –±–∞–∑–æ–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∏–ª—è
            let baseProgression;
            
            if (musicStyle === 'jazz') {
                baseProgression = PROGRESSIONS.jazz[Math.floor(Math.random() * PROGRESSIONS.jazz.length)];
            } else if (musicStyle === 'blues') {
                baseProgression = PROGRESSIONS.blues[0]; // 12-bar blues
            } else if (musicStyle === 'classical') {
                baseProgression = PROGRESSIONS.classical[Math.floor(Math.random() * PROGRESSIONS.classical.length)];
            } else if (musicStyle === 'poprock') {
                baseProgression = PROGRESSIONS.poprock[Math.floor(Math.random() * PROGRESSIONS.poprock.length)];
            } else {
                // –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞—è –≥–∞—Ä–º–æ–Ω–∏—è
                if (complexity === 'simple') {
                    baseProgression = PROGRESSIONS.simple[Math.floor(Math.random() * PROGRESSIONS.simple.length)];
                } else if (complexity === 'medium') {
                    baseProgression = PROGRESSIONS.medium[Math.floor(Math.random() * PROGRESSIONS.medium.length)];
                } else {
                    baseProgression = PROGRESSIONS.complex[Math.floor(Math.random() * PROGRESSIONS.complex.length)];
                }
            }

            // –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–æ –Ω—É–∂–Ω–æ–π –¥–ª–∏–Ω—ã (–µ—Å–ª–∏ –Ω–µ –±–ª—é–∑)
            let progression = [];
            if (musicStyle === 'blues') {
                progression = baseProgression; // –ë–ª—é–∑ —É–∂–µ 12 —Ç–∞–∫—Ç–æ–≤
            } else {
                while (progression.length < length) {
                    progression = progression.concat(baseProgression);
                }
                progression = progression.slice(0, length);
            }

            // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∞–∫–∫–æ—Ä–¥–æ–≤
            generatedChords = [];
            let prevChord = null;

            for (let i = 0; i < progression.length; i++) {
                let degreeStr = progression[i];
                let chordType = null;
                let quality = 'maj';
                let degree = degreeStr;

                // –ü–∞—Ä—Å–∏–Ω–≥ –¥–∂–∞–∑–æ–≤—ã—Ö –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–π
                if (degreeStr.includes('maj7')) {
                    chordType = 'maj7';
                    degree = degreeStr.replace('maj7', '');
                } else if (degreeStr.includes('m7')) {
                    chordType = 'min7';
                    degree = degreeStr.replace('m7', '');
                } else if (degreeStr.includes('7alt')) {
                    // –°–ª—É—á–∞–π–Ω–∞—è –∞–ª—å—Ç–µ—Ä–∞—Ü–∏—è –¥–ª—è –¥–æ–º–∏–Ω–∞–Ω—Ç–æ–≤–æ–≥–æ –∞–∫–∫–æ—Ä–¥–∞
                    const alterations = ['dom7b9', 'dom7sharp9', 'dom7sharp11', 'dom7b13'];
                    chordType = alterations[Math.floor(Math.random() * alterations.length)];
                    degree = degreeStr.replace('7alt', '');
                } else if (degreeStr.includes('7')) {
                    chordType = 'dom7';
                    degree = degreeStr.replace('7', '');
                } else if (degreeStr.includes('6/4')) {
                    degree = degreeStr.replace('6/4', '');
                    // –ö–≤–∞—Ä—Ç—Å–µ–∫—Å—Ç–∞–∫–∫–æ—Ä–¥ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ
                } else if (degreeStr.includes('6')) {
                    degree = degreeStr.replace('6', '');
                    // –°–µ–∫—Å—Ç–∞–∫–∫–æ—Ä–¥ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ
                }

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ç–æ—Ä–∏—á–Ω—ã—Ö –¥–æ–º–∏–Ω–∞–Ω—Ç
                if (degree.includes('/')) {
                    const [main, target] = degree.split('/');
                    const targetNote = getDegreeNote(rootNote, target, scaleType);
                    const chordRoot = NOTES[(NOTES.indexOf(targetNote) + 7) % 12]; // V —Å—Ç—É–ø–µ–Ω—å –æ—Ç —Ü–µ–ª–∏
                    
                    let chord;
                    if (voiceLeadingType === 'smooth' && prevChord) {
                        const inversion = findBestInversion(prevChord, chordRoot, 'maj', complexity, chordType || 'dom7');
                        chord = buildChordWithInversion(chordRoot, 'maj', complexity, inversion, chordType || 'dom7');
                    } else {
                        chord = buildChord(chordRoot, 'maj', complexity, chordType || 'dom7');
                    }
                    
                    generatedChords.push({
                        name: chord.name,
                        notes: chord.notes,
                        degree: degreeStr,
                        root: chordRoot
                    });
                    prevChord = chord;
                } else {
                    // –û–±—ã—á–Ω—ã–µ —Å—Ç—É–ø–µ–Ω–∏
                    const degreeClean = degree.replace('b', '').replace('dim', '');
                    let degreeNote = getDegreeNote(rootNote, degreeClean, scaleType);
                    
                    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∞–∫–∫–æ—Ä–¥–∞
                    if (musicStyle === 'modal' && MODAL_CHORD_QUALITIES[modalMode]) {
                        const romanNumerals = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII'];
                        const degreeIndex = romanNumerals.indexOf(degreeClean);
                        quality = MODAL_CHORD_QUALITIES[modalMode][degreeIndex];
                    } else if (degreeStr.includes('dim')) {
                        quality = 'dim';
                    } else {
                        const qualities = isMinor ? MINOR_CHORD_QUALITIES : CHORD_QUALITIES;
                        quality = qualities[degreeClean] || 'maj';
                    }

                    // –ê–ª—å—Ç–µ—Ä–∞—Ü–∏–∏ (bVII –∏ —Ç.–¥.)
                    if (degree.startsWith('b') && !degree.includes('dim')) {
                        const rootIndex = NOTES.indexOf(degreeNote);
                        degreeNote = NOTES[(rootIndex - 1 + 12) % 12];
                    }

                    let chord;
                    if (voiceLeadingType === 'smooth' && prevChord) {
                        const inversion = findBestInversion(prevChord, degreeNote, quality, complexity, chordType);
                        chord = buildChordWithInversion(degreeNote, quality, complexity, inversion, chordType);
                    } else {
                        chord = buildChord(degreeNote, quality, complexity, chordType);
                    }

                    generatedChords.push({
                        name: chord.name,
                        notes: chord.notes,
                        degree: degreeStr,
                        root: degreeNote
                    });
                    prevChord = chord;
                }

                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥—è—â–∏—Ö —É–º–µ–Ω—å—à—ë–Ω–Ω—ã—Ö –∞–∫–∫–æ—Ä–¥–æ–≤
                if (passingChordsType === 'diminished' && i < progression.length - 1 && Math.random() > 0.7) {
                    const currentRoot = NOTES.indexOf(generatedChords[generatedChords.length - 1].root);
                    const nextRoot = NOTES.indexOf(getDegreeNote(rootNote, progression[i + 1].replace(/[^IVX]/g, ''), scaleType));
                    
                    // –ü—Ä–æ—Ö–æ–¥—è—â–∏–π –∞–∫–∫–æ—Ä–¥ –º–µ–∂–¥—É —Ç–µ–∫—É—â–∏–º –∏ —Å–ª–µ–¥—É—é—â–∏–º
                    const passingRoot = NOTES[(currentRoot + 1) % 12];
                    const passingChord = buildChord(passingRoot, 'dim', 'simple');
                    
                    generatedChords.push({
                        name: passingChord.name,
                        notes: passingChord.notes,
                        degree: 'dim¬∞',
                        root: passingRoot,
                        passing: true
                    });
                }
            }

            // –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            displayProgression(keySelect, generatedChords, musicStyle, modalMode);
        }

        function displayProgression(key, chords, musicStyle = 'traditional', modalMode = null) {
            const output = document.getElementById('output1');
            
            const timeSignature = document.getElementById('timeSignature').value;
            const rhythmPattern = document.getElementById('rhythmPattern').value;
            const playbackStyle = document.getElementById('playbackStyle').value;
            
            let styleInfo = '';
            if (musicStyle === 'jazz') {
                styleInfo = '<p style="color: #667eea; font-weight: 600;">üé∫ –î–∂–∞–∑–æ–≤–∞—è –≥–∞—Ä–º–æ–Ω–∏—è</p>';
            } else if (musicStyle === 'blues') {
                styleInfo = '<p style="color: #667eea; font-weight: 600;">üé∏ 12-—Ç–∞–∫—Ç–æ–≤—ã–π –±–ª—é–∑</p>';
            } else if (musicStyle === 'classical') {
                styleInfo = '<p style="color: #667eea; font-weight: 600;">üéª –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∫–∞–¥–µ–Ω—Ü–∏—è</p>';
            } else if (musicStyle === 'poprock') {
                styleInfo = '<p style="color: #667eea; font-weight: 600;">üé§ –ü–æ–ø/—Ä–æ–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è</p>';
            } else if (musicStyle === 'modal') {
                const modalNames = {
                    'ionian': '–ò–æ–Ω–∏–π—Å–∫–∏–π',
                    'dorian': '–î–æ—Ä–∏–π—Å–∫–∏–π',
                    'phrygian': '–§—Ä–∏–≥–∏–π—Å–∫–∏–π',
                    'lydian': '–õ–∏–¥–∏–π—Å–∫–∏–π',
                    'mixolydian': '–ú–∏–∫—Å–æ–ª–∏–¥–∏–π—Å–∫–∏–π',
                    'aeolian': '–≠–æ–ª–∏–π—Å–∫–∏–π',
                    'locrian': '–õ–æ–∫—Ä–∏–π—Å–∫–∏–π'
                };
                styleInfo = `<p style="color: #667eea; font-weight: 600;">üåü –ú–æ–¥–∞–ª—å–Ω–∞—è –≥–∞—Ä–º–æ–Ω–∏—è: ${modalNames[modalMode]} –ª–∞–¥</p>`;
            }

            const rhythmNames = {
                'straight': '–ü—Ä—è–º–æ–π',
                'waltz': '–í–∞–ª—å—Å',
                'bolero': '–ë–æ–ª–µ—Ä–æ',
                'ragtime': '–†–µ–≥—Ç–∞–π–º',
                'bossa': 'Bossa Nova',
                'swing': 'Swing',
                'latin': '–õ–∞—Ç–∏–Ω–∞',
                'funk': '–§–∞–Ω–∫'
            };

            const playbackNames = {
                'block': '–ë–ª–æ–∫–æ–≤—ã–µ –∞–∫–∫–æ—Ä–¥—ã',
                'arpeggio-up': '–ê—Ä–ø–µ–¥–∂–∏–æ –≤–≤–µ—Ä—Ö',
                'arpeggio-down': '–ê—Ä–ø–µ–¥–∂–∏–æ –≤–Ω–∏–∑',
                'arpeggio-updown': '–ê—Ä–ø–µ–¥–∂–∏–æ –≤–≤–µ—Ä—Ö-–≤–Ω–∏–∑',
                'broken': '–†–∞–∑–ª–æ–∂–µ–Ω–Ω—ã–π –∞–∫–∫–æ—Ä–¥'
            };

            output.innerHTML = `
                <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è –≤ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ ${key}</h3>
                ${styleInfo}
                <p style="color: #666; margin: 10px 0;">
                    <strong>–ú–µ—Ç—Ä:</strong> ${timeSignature} | 
                    <strong>–†–∏—Ç–º:</strong> ${rhythmNames[rhythmPattern]} | 
                    <strong>–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:</strong> ${playbackNames[playbackStyle]}
                </p>
                <div class="chord-progression">
                    ${chords.map((chord, i) => `
                        <div class="chord" style="${chord.passing ? 'background: linear-gradient(135deg, #9575cd 0%, #7e57c2 100%); font-size: 0.9em;' : ''}">
                            <div>${chord.name}</div>
                            <small style="opacity: 0.8">${chord.passing ? '–ø—Ä–æ—Ö–æ–¥—è—â–∏–π' : chord.degree}</small>
                        </div>
                    `).join('')}
                </div>
                <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                    <strong>–ù–æ—Ç—ã –∞–∫–∫–æ—Ä–¥–æ–≤:</strong><br>
                    ${chords.map(c => `${c.name}: ${c.notes.join(', ')}`).join(' | ')}
                </p>
            `;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            const vizContainer = document.getElementById('visualization1');
            vizContainer.style.display = 'block';

            // –†–∏—Å—É–µ–º –≤—Å–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
            drawStaff(chords, key);
            drawPiano(chords);
            drawGuitar(chords);
            drawCircleOfFifths(key);
        }

        // ========== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç–∞ ==========

        function parseMelody(melodyText) {
            const tokens = melodyText.trim().split(/\s+/);
            const melody = [];
            
            for (let i = 0; i < tokens.length; i += 2) {
                if (i + 1 < tokens.length) {
                    const notePart = tokens[i];
                    const duration = parseFloat(tokens[i + 1]) || 1;
                    
                    const match = notePart.match(/^([A-G]#?)(\d+)$/);
                    if (match) {
                        melody.push({
                            note: match[1],
                            octave: parseInt(match[2]),
                            duration: duration
                        });
                    }
                }
            }
            
            return melody;
        }

        function detectKey(melody) {
            // –ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑: –ø–æ–¥—Å—á–µ—Ç –Ω–æ—Ç –∏ –ø–æ–ø—ã—Ç–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
            const noteCount = {};
            melody.forEach(n => {
                noteCount[n.note] = (noteCount[n.note] || 0) + 1;
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–∞–∂–æ—Ä–Ω—ã–º –∏ –º–∏–Ω–æ—Ä–Ω—ã–º –≥–∞–º–º–∞–º
            const majorKeys = ['C', 'G', 'D', 'A', 'E', 'B', 'F#', 'Db', 'Ab', 'Eb', 'Bb', 'F'];
            const minorKeys = ['Am', 'Em', 'Bm', 'F#m', 'C#m', 'G#m', 'D#m', 'Bbm', 'Fm', 'Cm', 'Gm', 'Dm'];

            let bestKey = 'C';
            let bestScore = 0;

            [...majorKeys, ...minorKeys].forEach(key => {
                const isMinor = key.includes('m');
                const root = key.replace('m', '');
                const scaleNotes = getScaleNotes(root, isMinor ? 'minor' : 'major');
                
                let score = 0;
                melody.forEach(n => {
                    if (scaleNotes.includes(n.note)) {
                        score += 1;
                    }
                });

                if (score > bestScore) {
                    bestScore = score;
                    bestKey = key;
                }
            });

            return bestKey;
        }

        function generateAccompaniment() {
            initAudio();

            const melodyText = document.getElementById('melody').value;
            const complexity = document.getElementById('accompComplexity').value;
            let key = document.getElementById('analyzeKey').value;

            if (!melodyText.trim()) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –º–µ–ª–æ–¥–∏—é!');
                return;
            }

            currentMelody = parseMelody(melodyText);

            if (currentMelody.length === 0) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –º–µ–ª–æ–¥–∏—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞.');
                return;
            }

            // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
            if (key === 'auto') {
                key = detectKey(currentMelody);
            }

            const isMinor = key.includes('m');
            const rootNote = key.replace('m', '');
            const scaleType = isMinor ? 'minor' : 'major';
            const scaleNotes = getScaleNotes(rootNote, scaleType);

            // –ê–Ω–∞–ª–∏–∑ –º–µ–ª–æ–¥–∏–∏ –∏ –ø–æ–¥–±–æ—Ä –∞–∫–∫–æ—Ä–¥–æ–≤
            generatedChords = [];
            let currentChordNotes = new Set();
            let chordDuration = 0;
            const chordChangeDuration = 2; // –ú–µ–Ω—è—Ç—å –∞–∫–∫–æ—Ä–¥ –∫–∞–∂–¥—ã–µ 2 –µ–¥–∏–Ω–∏—Ü—ã –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

            for (let i = 0; i < currentMelody.length; i++) {
                const melodyNote = currentMelody[i];
                currentChordNotes.add(melodyNote.note);
                chordDuration += melodyNote.duration;

                if (chordDuration >= chordChangeDuration || i === currentMelody.length - 1) {
                    // –ü–æ–¥–±–æ—Ä –∞–∫–∫–æ—Ä–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ—Ç –≤ –º–µ–ª–æ–¥–∏–∏
                    const chord = findBestChord(Array.from(currentChordNotes), rootNote, scaleType, complexity);
                    generatedChords.push(chord);
                    
                    currentChordNotes.clear();
                    chordDuration = 0;
                }
            }

            displayAccompaniment(key, currentMelody, generatedChords);
        }

        function findBestChord(melodyNotes, rootNote, scaleType, complexity) {
            const scaleNotes = getScaleNotes(rootNote, scaleType);
            const isMinor = scaleType === 'minor' || scaleType === 'aeolian';
            
            // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –∞–∫–∫–æ—Ä–¥ –Ω–∞ –∫–∞–∂–¥–æ–π —Å—Ç—É–ø–µ–Ω–∏ –∏ –≤—ã–±–µ—Ä–µ–º –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π
            let bestChord = null;
            let bestScore = -1;

            const degrees = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII'];
            
            degrees.forEach(degree => {
                const degreeNote = getDegreeNote(rootNote, degree, scaleType);
                const qualities = isMinor ? MINOR_CHORD_QUALITIES : CHORD_QUALITIES;
                const quality = qualities[degree];
                
                const chord = buildChord(degreeNote, quality, complexity);
                
                // –ü–æ–¥—Å—á–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
                let score = 0;
                melodyNotes.forEach(note => {
                    if (chord.notes.includes(note)) {
                        score += 2; // –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –Ω–æ—Ç –≤ –∞–∫–∫–æ—Ä–¥–µ
                    }
                });

                // –ë–æ–Ω—É—Å –∑–∞ —Ç–æ–Ω–∏–∫—É –∏ –¥–æ–º–∏–Ω–∞–Ω—Ç—É
                if (degree === 'I') score += 1;
                if (degree === 'V') score += 0.5;

                if (score > bestScore) {
                    bestScore = score;
                    bestChord = {
                        name: chord.name,
                        notes: chord.notes,
                        degree: degree,
                        root: degreeNote
                    };
                }
            });

            return bestChord || {
                name: rootNote,
                notes: buildChord(rootNote, 'maj', 'simple').notes,
                degree: 'I',
                root: rootNote
            };
        }

        function displayAccompaniment(key, melody, chords) {
            const output = document.getElementById('output2');
            const timeSignature = document.getElementById('timeSignature2').value;
            const accompStyle = document.getElementById('accompStyle').value;
            
            const playbackNames = {
                'block': '–ë–ª–æ–∫–æ–≤—ã–µ –∞–∫–∫–æ—Ä–¥—ã',
                'arpeggio-up': '–ê—Ä–ø–µ–¥–∂–∏–æ –≤–≤–µ—Ä—Ö',
                'arpeggio-down': '–ê—Ä–ø–µ–¥–∂–∏–æ –≤–Ω–∏–∑',
                'broken': '–†–∞–∑–ª–æ–∂–µ–Ω–Ω—ã–π –∞–∫–∫–æ—Ä–¥'
            };
            
            output.innerHTML = `
                <h3>–ê–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç –¥–ª—è –º–µ–ª–æ–¥–∏–∏ (—Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å: ${key})</h3>
                <p style="color: #666; margin: 10px 0;">
                    <strong>–ú–µ—Ç—Ä:</strong> ${timeSignature} | 
                    <strong>–°—Ç–∏–ª—å:</strong> ${playbackNames[accompStyle]}
                </p>
                
                <div class="piano-roll">
                    <h4>–ú–µ–ª–æ–¥–∏—è:</h4>
                    <div class="note-display">
                        ${melody.map(n => `<div class="note">${n.note}${n.octave} (${n.duration})</div>`).join('')}
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h4>–ê–∫–∫–æ—Ä–¥—ã:</h4>
                    <div class="chord-progression">
                        ${chords.map(chord => `
                            <div class="chord">
                                <div>${chord.name}</div>
                                <small style="opacity: 0.8">${chord.degree}</small>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                    <strong>–ù–æ—Ç—ã –∞–∫–∫–æ—Ä–¥–æ–≤:</strong><br>
                    ${chords.map(c => `${c.name}: ${c.notes.join(', ')}`).join(' | ')}
                </p>
            `;
        }

        // ========== –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ ==========

        function playChord(chord, startTime, duration) {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫—Ç–∞–≤—ã –¥–ª—è –∫–∞–∂–¥–æ–π –Ω–æ—Ç—ã –≤ –∞–∫–∫–æ—Ä–¥–µ
            const baseOctave = 3;
            
            chord.notes.forEach((note, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –æ–∫—Ç–∞–≤–∞–º
                let octave = baseOctave;
                if (index === 0) octave = baseOctave; // –ë–∞—Å
                else if (index === 1) octave = baseOctave + 1; // –¢–µ–Ω–æ—Ä
                else if (index === 2) octave = baseOctave + 1; // –ê–ª—å—Ç
                else octave = baseOctave + 2; // –°–æ–ø—Ä–∞–Ω–æ –∏ –≤—ã—à–µ
                
                oscillator.frequency.value = noteToFreq(note, octave);
                oscillator.type = 'sine';
                
                // –£–º–µ–Ω—å—à–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≥–æ–ª–æ—Å–∞
                const baseGain = 0.15 / (index * 0.3 + 1);
                
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(baseGain, startTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
            });
        }

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—Ä–ø–µ–¥–∂–∏–æ
        function playArpeggio(chord, startTime, totalDuration, style = 'up') {
            const baseOctave = 3;
            let noteSequence = [];
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –Ω–æ—Ç –≤ –∞—Ä–ø–µ–¥–∂–∏–æ
            if (style === 'arpeggio-up') {
                noteSequence = [...chord.notes];
            } else if (style === 'arpeggio-down') {
                noteSequence = [...chord.notes].reverse();
            } else if (style === 'arpeggio-updown') {
                noteSequence = [...chord.notes, ...chord.notes.slice(0, -1).reverse()];
            } else if (style === 'broken') {
                // –†–∞–∑–ª–æ–∂–µ–Ω–Ω—ã–π: 1-3-2-4 –∏–ª–∏ 1-5-3-7 –ø–∞—Ç—Ç–µ—Ä–Ω
                if (chord.notes.length === 3) {
                    noteSequence = [chord.notes[0], chord.notes[2], chord.notes[1]];
                } else if (chord.notes.length === 4) {
                    noteSequence = [chord.notes[0], chord.notes[2], chord.notes[1], chord.notes[3]];
                } else {
                    noteSequence = chord.notes;
                }
            }

            const noteDuration = totalDuration / noteSequence.length;
            
            noteSequence.forEach((note, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –æ–∫—Ç–∞–≤–∞–º
                let octave = baseOctave;
                const originalIndex = chord.notes.indexOf(note);
                if (originalIndex === 0) octave = baseOctave;
                else if (originalIndex === 1) octave = baseOctave + 1;
                else if (originalIndex === 2) octave = baseOctave + 1;
                else octave = baseOctave + 2;
                
                oscillator.frequency.value = noteToFreq(note, octave);
                oscillator.type = 'sine';
                
                const noteStart = startTime + (index * noteDuration);
                const noteEnd = noteStart + noteDuration * 0.9;
                
                gainNode.gain.setValueAtTime(0, noteStart);
                gainNode.gain.linearRampToValueAtTime(0.2, noteStart + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, noteEnd);
                
                oscillator.start(noteStart);
                oscillator.stop(noteEnd);
            });
        }

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å —Ä–∏—Ç–º–∏—á–µ—Å–∫–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º
        function playChordWithRhythm(chord, startTime, chordDuration, rhythmPattern, accents, playbackStyle) {
            rhythmPattern.forEach((beat, index) => {
                const beatTime = startTime + (beat * chordDuration / rhythmPattern.length);
                const beatDuration = chordDuration / rhythmPattern.length * 0.8;
                const accent = accents[index % accents.length];
                
                if (playbackStyle === 'block') {
                    playChordWithAccent(chord, beatTime, beatDuration, accent);
                } else {
                    playArpeggioWithAccent(chord, beatTime, beatDuration, playbackStyle, accent);
                }
            });
        }

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞–∫–∫–æ—Ä–¥–∞ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –∞–∫—Ü–µ–Ω—Ç–æ–º
        function playChordWithAccent(chord, startTime, duration, accent = 1.0) {
            const baseOctave = 3;
            
            chord.notes.forEach((note, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                let octave = baseOctave;
                if (index === 0) octave = baseOctave;
                else if (index === 1) octave = baseOctave + 1;
                else if (index === 2) octave = baseOctave + 1;
                else octave = baseOctave + 2;
                
                oscillator.frequency.value = noteToFreq(note, octave);
                oscillator.type = 'sine';
                
                const baseGain = (0.15 * accent) / (index * 0.3 + 1);
                
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(baseGain, startTime + 0.03);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
            });
        }

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—Ä–ø–µ–¥–∂–∏–æ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º
        function playArpeggioWithAccent(chord, startTime, totalDuration, style, accent = 1.0) {
            const baseOctave = 3;
            let noteSequence = [];
            
            if (style === 'arpeggio-up') {
                noteSequence = [...chord.notes];
            } else if (style === 'arpeggio-down') {
                noteSequence = [...chord.notes].reverse();
            } else if (style === 'arpeggio-updown') {
                noteSequence = [...chord.notes, ...chord.notes.slice(0, -1).reverse()];
            } else if (style === 'broken') {
                if (chord.notes.length === 3) {
                    noteSequence = [chord.notes[0], chord.notes[2], chord.notes[1]];
                } else if (chord.notes.length === 4) {
                    noteSequence = [chord.notes[0], chord.notes[2], chord.notes[1], chord.notes[3]];
                } else {
                    noteSequence = chord.notes;
                }
            }

            const noteDuration = totalDuration / noteSequence.length;
            
            noteSequence.forEach((note, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                let octave = baseOctave;
                const originalIndex = chord.notes.indexOf(note);
                if (originalIndex === 0) octave = baseOctave;
                else if (originalIndex === 1) octave = baseOctave + 1;
                else if (originalIndex === 2) octave = baseOctave + 1;
                else octave = baseOctave + 2;
                
                oscillator.frequency.value = noteToFreq(note, octave);
                oscillator.type = 'sine';
                
                const noteStart = startTime + (index * noteDuration);
                const noteEnd = noteStart + noteDuration * 0.9;
                
                const noteGain = 0.2 * accent;
                
                gainNode.gain.setValueAtTime(0, noteStart);
                gainNode.gain.linearRampToValueAtTime(noteGain, noteStart + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, noteEnd);
                
                oscillator.start(noteStart);
                oscillator.stop(noteEnd);
            });
        }

        function playNote(note, octave, startTime, duration) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = noteToFreq(note, octave);
            oscillator.type = 'triangle';
            
            gainNode.gain.setValueAtTime(0, startTime);
            gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
            
            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
        }

        function playProgression() {
            if (generatedChords.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—é!');
                return;
            }

            initAudio();
            stopPlayback();

            const tempo = parseInt(document.getElementById('tempo1').value);
            const timeSignature = document.getElementById('timeSignature').value;
            const rhythmPattern = document.getElementById('rhythmPattern').value;
            const playbackStyle = document.getElementById('playbackStyle').value;

            // –ü–∞—Ä—Å–∏–º –º–µ—Ç—Ä
            const [beatsPerMeasure, beatUnit] = timeSignature.split('/').map(Number);
            
            // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–π –¥–æ–ª–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            const beatDuration = (60 / tempo) * (4 / beatUnit);
            
            // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–≥–æ —Ç–∞–∫—Ç–∞
            const measureDuration = beatDuration * beatsPerMeasure;
            
            // –ü–æ–ª—É—á–∞–µ–º —Ä–∏—Ç–º–∏—á–µ—Å–∫–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç–∏–ª—è –∏ –º–µ—Ç—Ä–∞
            let pattern = RHYTHM_PATTERNS[rhythmPattern]?.[timeSignature] || RHYTHM_PATTERNS.straight[timeSignature];
            let accents = RHYTHM_ACCENTS[rhythmPattern] || RHYTHM_ACCENTS.straight;
            
            // –ï—Å–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –º–µ—Ç—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π
            if (!pattern) {
                pattern = Array.from({length: beatsPerMeasure}, (_, i) => i);
                accents = Array(beatsPerMeasure).fill(1.0);
                accents[0] = 1.0; // –°–∏–ª—å–Ω–∞—è –¥–æ–ª—è
            }

            let currentTime = audioContext.currentTime + 0.1; // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º

            generatedChords.forEach((chord, index) => {
                // –ö–∞–∂–¥—ã–π –∞–∫–∫–æ—Ä–¥ –∏–≥—Ä–∞–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —Ç–∞–∫—Ç–∞
                const chordDuration = measureDuration;

                if (playbackStyle === 'block') {
                    // –ë–ª–æ—á–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å —Ä–∏—Ç–º–æ–º
                    playChordWithRhythm(chord, currentTime, chordDuration, pattern, accents, 'block');
                } else {
                    // –ê—Ä–ø–µ–¥–∂–∏–æ —Å —Ä–∏—Ç–º–æ–º
                    playChordWithRhythm(chord, currentTime, chordDuration, pattern, accents, playbackStyle);
                }

                currentTime += chordDuration;
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π "–∑–≤–æ–Ω" –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            const finalChord = generatedChords[generatedChords.length - 1];
            playChordWithAccent(finalChord, currentTime, measureDuration * 2, 1.0);
        }

        function playAccompaniment() {
            if (currentMelody.length === 0 || generatedChords.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∞–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç!');
                return;
            }

            initAudio();
            stopPlayback();

            const tempo = parseInt(document.getElementById('tempo2').value);
            const timeSignature = document.getElementById('timeSignature2').value;
            const accompStyle = document.getElementById('accompStyle').value;

            const beatDuration = 60 / tempo;
            
            // –ü–∞—Ä—Å–∏–º –º–µ—Ç—Ä
            const [beatsPerMeasure, beatUnit] = timeSignature.split('/').map(Number);
            const measureDuration = beatDuration * beatsPerMeasure * (4 / beatUnit);

            let melodyTime = audioContext.currentTime + 0.1;
            let chordTime = audioContext.currentTime + 0.1;

            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–µ–ª–æ–¥–∏–∏
            currentMelody.forEach(note => {
                const noteDuration = beatDuration * note.duration;
                playNote(note.note, note.octave, melodyTime, noteDuration * 0.9);
                melodyTime += noteDuration;
            });

            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞–∫–∫–æ—Ä–¥–æ–≤ —Å —Ä–∏—Ç–º–æ–º
            const chordChangeDuration = beatDuration * 2; // –ú–µ–Ω—è—Ç—å –∞–∫–∫–æ—Ä–¥ –∫–∞–∂–¥—ã–µ 2 –µ–¥–∏–Ω–∏—Ü—ã
            
            // –ü—Ä–æ—Å—Ç–æ–π —Ä–∏—Ç–º–∏—á–µ—Å–∫–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –∞–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç–∞
            const accompPattern = timeSignature === '3/4' ? [0, 1, 2] : 
                                  timeSignature === '6/8' ? [0, 1.5, 3, 4.5] :
                                  [0, 1, 2, 3]; // 4/4 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const accompAccents = timeSignature === '3/4' ? [1.0, 0.6, 0.6] :
                                  timeSignature === '6/8' ? [1.0, 0.7, 0.9, 0.7] :
                                  [1.0, 0.6, 0.8, 0.6];

            generatedChords.forEach((chord, index) => {
                if (accompStyle === 'block') {
                    // –ü—Ä–æ—Å—Ç–æ–µ –±–ª–æ—á–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ
                    playChordWithAccent(chord, chordTime, chordChangeDuration * 0.9, 0.8);
                } else {
                    // –ê—Ä–ø–µ–¥–∂–∏–æ
                    playArpeggio(chord, chordTime, chordChangeDuration * 0.9, accompStyle);
                }
                
                chordTime += chordChangeDuration;
            });
        }

        function stopPlayback() {
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
        }

        // ========== UI ==========

        function switchMode(index) {
            const tabs = document.querySelectorAll('.tab');
            const modes = document.querySelectorAll('.mode');

            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });

            modes.forEach((mode, i) => {
                mode.classList.toggle('active', i === index);
            });
        }

        function switchVizTab(modeIndex, tabIndex) {
            const modeId = modeIndex === 0 ? '1' : '2';
            const tabs = document.querySelectorAll(`#visualization${modeId} .viz-tab`);
            const contents = document.querySelectorAll(`#visualization${modeId} .viz-content`);

            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === tabIndex);
            });

            contents.forEach((content, i) => {
                content.classList.toggle('active', i === tabIndex);
            });
        }

        // ========== –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è ==========

        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        const NOTE_POSITIONS = {
            'C': { treble: 0, bass: -12 },
            'D': { treble: -1, bass: -13 },
            'E': { treble: -2, bass: -14 },
            'F': { treble: -3, bass: -15 },
            'G': { treble: -4, bass: -16 },
            'A': { treble: -5, bass: -17 },
            'B': { treble: -6, bass: -18 }
        };

        const WHITE_KEYS = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        const BLACK_KEYS = ['C#', 'D#', 'F#', 'G#', 'A#'];

        // –ü–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–Ω—ã—Ö –∫–ª–∞–≤–∏—à –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –±–µ–ª—ã—Ö
        const BLACK_KEY_POSITIONS = {
            'C#': 0.7,
            'D#': 1.7,
            'F#': 3.7,
            'G#': 4.7,
            'A#': 5.7
        };

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –Ω–æ—Ç–Ω–æ–≥–æ —Å—Ç–∞–Ω–∞
        function drawStaff(chords, key) {
            const svg = document.getElementById('staff-svg-1');
            svg.innerHTML = '';
            
            const width = Math.max(1200, chords.length * 150);
            const height = 300;
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);

            // –†–∏—Å—É–µ–º —Å–∫—Ä–∏–ø–∏—á–Ω—ã–π –∫–ª—é—á (5 –ª–∏–Ω–∏–π)
            const staffY = 80;
            const lineSpacing = 10;
            
            for (let i = 0; i < 5; i++) {
                const y = staffY + i * lineSpacing;
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', '20');
                line.setAttribute('y1', y);
                line.setAttribute('x2', width - 20);
                line.setAttribute('y2', y);
                line.setAttribute('class', 'staff-line');
                svg.appendChild(line);
            }

            // –†–∏—Å—É–µ–º –±–∞—Å–æ–≤—ã–π –∫–ª—é—á (5 –ª–∏–Ω–∏–π)
            const bassStaffY = 180;
            for (let i = 0; i < 5; i++) {
                const y = bassStaffY + i * lineSpacing;
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', '20');
                line.setAttribute('y1', y);
                line.setAttribute('x2', width - 20);
                line.setAttribute('y2', y);
                line.setAttribute('class', 'staff-line');
                svg.appendChild(line);
            }

            // –ö–ª—é—á –∏ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
            const gClef = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            gClef.setAttribute('x', '30');
            gClef.setAttribute('y', staffY + 30);
            gClef.setAttribute('font-size', '48');
            gClef.setAttribute('font-family', 'serif');
            gClef.textContent = 'ùÑû';
            svg.appendChild(gClef);

            const fClef = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            fClef.setAttribute('x', '30');
            fClef.setAttribute('y', bassStaffY + 25);
            fClef.setAttribute('font-size', '36');
            fClef.setAttribute('font-family', 'serif');
            fClef.textContent = 'ùÑ¢';
            svg.appendChild(fClef);

            // –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
            const keyText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            keyText.setAttribute('x', '90');
            keyText.setAttribute('y', '30');
            keyText.setAttribute('font-size', '20');
            keyText.setAttribute('font-weight', 'bold');
            keyText.setAttribute('fill', '#667eea');
            keyText.textContent = `–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å: ${key}`;
            svg.appendChild(keyText);

            // –†–∏—Å—É–µ–º –∞–∫–∫–æ—Ä–¥—ã
            const startX = 120;
            const spacing = (width - startX - 40) / chords.length;

            chords.forEach((chord, index) => {
                const x = startX + index * spacing;
                
                // –†–∏—Å—É–µ–º –∫–∞–∂–¥—É—é –Ω–æ—Ç—É –∞–∫–∫–æ—Ä–¥–∞
                chord.notes.forEach((note, noteIndex) => {
                    const baseNote = note.replace('#', '').replace('b', '');
                    const octave = 4; // –°—Ä–µ–¥–Ω—è—è –æ–∫—Ç–∞–≤–∞
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é Y –Ω–∞ –Ω–æ—Ç–Ω–æ–º —Å—Ç–∞–Ω–µ
                    let yPos;
                    if (noteIndex === 0) {
                        // –ë–∞—Å - –Ω–∞ –±–∞—Å–æ–≤–æ–º –∫–ª—é—á–µ
                        yPos = bassStaffY + 20 - (noteIndex * 5);
                    } else {
                        // –û—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–æ—Ç—ã - –Ω–∞ —Å–∫—Ä–∏–ø–∏—á–Ω–æ–º –∫–ª—é—á–µ
                        yPos = staffY + 40 - (noteIndex * 5);
                    }

                    // –ì–æ–ª–æ–≤–∫–∞ –Ω–æ—Ç—ã
                    const noteHead = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                    noteHead.setAttribute('cx', x);
                    noteHead.setAttribute('cy', yPos);
                    noteHead.setAttribute('rx', '6');
                    noteHead.setAttribute('ry', '5');
                    noteHead.setAttribute('class', 'note-head');
                    noteHead.setAttribute('transform', `rotate(-20 ${x} ${yPos})`);
                    svg.appendChild(noteHead);

                    // –®—Ç–∏–ª—å (–¥–ª—è –ø–µ—Ä–≤–æ–π –Ω–æ—Ç—ã)
                    if (noteIndex === 0) {
                        const stem = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        stem.setAttribute('x1', x + 5);
                        stem.setAttribute('y1', yPos);
                        stem.setAttribute('x2', x + 5);
                        stem.setAttribute('y2', yPos - 30);
                        stem.setAttribute('class', 'note-stem');
                        svg.appendChild(stem);
                    }
                });

                // –ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫–∫–æ—Ä–¥–∞ —Å–≤–µ—Ä—Ö—É
                const chordName = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                chordName.setAttribute('x', x - 10);
                chordName.setAttribute('y', staffY - 20);
                chordName.setAttribute('font-size', '14');
                chordName.setAttribute('font-weight', 'bold');
                chordName.setAttribute('fill', '#764ba2');
                chordName.textContent = chord.name;
                svg.appendChild(chordName);

                // –°–∫–æ–±–∫–∞, –æ–±—ä–µ–¥–∏–Ω—è—é—â–∞—è –∞–∫–∫–æ—Ä–¥
                const bracket = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const bracketPath = `M ${x - 12} ${staffY + 35} L ${x - 12} ${bassStaffY + 25}`;
                bracket.setAttribute('d', bracketPath);
                bracket.setAttribute('class', 'chord-bracket');
                svg.appendChild(bracket);
            });
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä—Ç–µ–ø–∏–∞–Ω–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        function drawPiano(chords) {
            const container = document.getElementById('piano-keyboard-1');
            container.innerHTML = '';

            // 88 –∫–ª–∞–≤–∏—à –æ—Ç A0 –¥–æ C8
            const startOctave = 0;
            const endOctave = 8;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ –Ω–æ—Ç—ã –∏–∑ –∞–∫–∫–æ—Ä–¥–æ–≤ –Ω—É–∂–Ω–æ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å
            const activeNotes = new Set();
            chords.forEach(chord => {
                chord.notes.forEach(note => {
                    activeNotes.add(note);
                });
            });

            let whiteKeyIndex = 0;

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª–∞–≤–∏—à–∏
            for (let octave = startOctave; octave <= endOctave; octave++) {
                const octaveKeys = octave === 0 ? ['A', 'A#', 'B'] : 
                                  octave === 8 ? ['C'] : 
                                  ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

                octaveKeys.forEach(note => {
                    const isBlack = note.includes('#');
                    const noteName = `${note}${octave}`;

                    if (!isBlack) {
                        // –ë–µ–ª–∞—è –∫–ª–∞–≤–∏—à–∞
                        const key = document.createElement('div');
                        key.className = 'piano-key white-key';
                        key.style.left = `${whiteKeyIndex * 40}px`;
                        
                        if (activeNotes.has(note.replace('#', ''))) {
                            key.classList.add('active');
                        }

                        const label = document.createElement('div');
                        label.className = 'key-label';
                        label.textContent = octave >= 2 && octave <= 6 ? note : '';
                        key.appendChild(label);

                        container.appendChild(key);
                        whiteKeyIndex++;
                    }
                });
            }

            // –ß–µ—Ä–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏ –ø–æ–≤–µ—Ä—Ö –±–µ–ª—ã—Ö
            whiteKeyIndex = 0;
            for (let octave = startOctave; octave <= endOctave; octave++) {
                const octaveKeys = octave === 0 ? ['A', 'A#', 'B'] : 
                                  octave === 8 ? ['C'] : 
                                  ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

                octaveKeys.forEach(note => {
                    const isBlack = note.includes('#');
                    const baseNote = note.replace('#', '');

                    if (!isBlack) {
                        const hasBlack = octaveKeys.includes(note + '#');
                        if (hasBlack) {
                            const blackKey = document.createElement('div');
                            blackKey.className = 'piano-key black-key';
                            
                            const blackNote = note + '#';
                            const position = BLACK_KEY_POSITIONS[blackNote];
                            blackKey.style.left = `${(whiteKeyIndex + (position - Math.floor(position))) * 40 - 14}px`;
                            
                            if (activeNotes.has(blackNote.replace('#', ''))) {
                                blackKey.classList.add('active');
                            }

                            const label = document.createElement('div');
                            label.className = 'key-label';
                            label.textContent = octave >= 2 && octave <= 6 ? blackNote : '';
                            blackKey.appendChild(label);

                            container.appendChild(blackKey);
                        }
                        whiteKeyIndex++;
                    }
                });
            }

            container.style.width = `${whiteKeyIndex * 40}px`;
        }

        // –ì–∏—Ç–∞—Ä–Ω—ã–µ –∞–ø–ø–ª–∏–∫–∞—Ç—É—Ä—ã (–±–∞–∑–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏)
        const GUITAR_CHORD_SHAPES = {
            'C': { frets: [0, 3, 2, 0, 1, 0], fingers: [0, 3, 2, 0, 1, 0], name: 'C' },
            'Cmaj7': { frets: [0, 3, 2, 0, 0, 0], fingers: [0, 3, 2, 0, 0, 0], name: 'Cmaj7' },
            'Cm': { frets: [-1, 3, 5, 5, 4, 3], fingers: [0, 1, 3, 4, 2, 1], name: 'Cm', barre: 3 },
            'Cm7': { frets: [-1, 3, 5, 3, 4, 3], fingers: [0, 1, 3, 1, 2, 1], name: 'Cm7', barre: 3 },
            'D': { frets: [-1, -1, 0, 2, 3, 2], fingers: [0, 0, 0, 1, 3, 2], name: 'D' },
            'Dm': { frets: [-1, -1, 0, 2, 3, 1], fingers: [0, 0, 0, 2, 3, 1], name: 'Dm' },
            'Dm7': { frets: [-1, -1, 0, 2, 1, 1], fingers: [0, 0, 0, 2, 1, 1], name: 'Dm7' },
            'E': { frets: [0, 2, 2, 1, 0, 0], fingers: [0, 2, 3, 1, 0, 0], name: 'E' },
            'Em': { frets: [0, 2, 2, 0, 0, 0], fingers: [0, 2, 3, 0, 0, 0], name: 'Em' },
            'Em7': { frets: [0, 2, 0, 0, 0, 0], fingers: [0, 2, 0, 0, 0, 0], name: 'Em7' },
            'F': { frets: [1, 3, 3, 2, 1, 1], fingers: [1, 3, 4, 2, 1, 1], name: 'F', barre: 1 },
            'Fmaj7': { frets: [1, 3, 2, 2, 1, 1], fingers: [1, 3, 2, 2, 1, 1], name: 'Fmaj7', barre: 1 },
            'G': { frets: [3, 2, 0, 0, 0, 3], fingers: [3, 2, 0, 0, 0, 4], name: 'G' },
            'Gmaj7': { frets: [3, 2, 0, 0, 0, 2], fingers: [3, 2, 0, 0, 0, 1], name: 'Gmaj7' },
            'Gm': { frets: [3, 5, 5, 3, 3, 3], fingers: [1, 3, 4, 1, 1, 1], name: 'Gm', barre: 3 },
            'A': { frets: [-1, 0, 2, 2, 2, 0], fingers: [0, 0, 1, 2, 3, 0], name: 'A' },
            'Am': { frets: [-1, 0, 2, 2, 1, 0], fingers: [0, 0, 2, 3, 1, 0], name: 'Am' },
            'Am7': { frets: [-1, 0, 2, 0, 1, 0], fingers: [0, 0, 2, 0, 1, 0], name: 'Am7' },
            'B': { frets: [-1, 2, 4, 4, 4, 2], fingers: [0, 1, 3, 3, 3, 1], name: 'B', barre: 2 },
            'Bm': { frets: [-1, 2, 4, 4, 3, 2], fingers: [0, 1, 3, 4, 2, 1], name: 'Bm', barre: 2 },
        };

        function drawGuitar(chords) {
            const container = document.getElementById('guitar-neck-1');
            container.innerHTML = '<h4 style="margin-bottom: 15px;">–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∞–∫–∫–æ—Ä–¥–æ–≤:</h4>';

            chords.forEach(chord => {
                // –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â—É—é –∞–ø–ø–ª–∏–∫–∞—Ç—É—Ä—É
                const chordName = chord.name;
                let shape = GUITAR_CHORD_SHAPES[chordName];
                
                // –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–π –∞–ø–ø–ª–∏–∫–∞—Ç—É—Ä—ã –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –±–∞–∑–æ–≤—É—é
                if (!shape) {
                    const baseChord = chord.root || chordName.replace(/[0-9maj7dim#]/g, '');
                    shape = GUITAR_CHORD_SHAPES[baseChord] || GUITAR_CHORD_SHAPES['C'];
                }

                const diagram = drawChordDiagram(chordName, shape);
                container.appendChild(diagram);
            });
        }

        function drawChordDiagram(chordName, shape) {
            const wrapper = document.createElement('div');
            wrapper.className = 'guitar-chord-diagram';

            const nameDiv = document.createElement('div');
            nameDiv.className = 'chord-name';
            nameDiv.textContent = chordName;
            wrapper.appendChild(nameDiv);

            const fretboard = document.createElement('div');
            fretboard.className = 'fretboard';

            // –†–∏—Å—É–µ–º —Å—Ç—Ä—É–Ω—ã (6 —à—Ç—É–∫)
            for (let i = 0; i < 6; i++) {
                const string = document.createElement('div');
                string.className = 'guitar-string';
                string.style.top = `${20 + i * 40}px`;
                fretboard.appendChild(string);
            }

            // –†–∏—Å—É–µ–º –ª–∞–¥—ã (4 —à—Ç—É–∫–∏ –¥–ª—è –±–∞–∑–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏)
            for (let i = 0; i <= 4; i++) {
                const fret = document.createElement('div');
                fret.className = 'guitar-fret';
                fret.style.left = `${i * 50}px`;
                if (i === 0) {
                    fret.style.width = '4px';
                    fret.style.background = '#000';
                }
                fretboard.appendChild(fret);
            }

            // –†–∏—Å—É–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø–∞–ª—å—Ü–µ–≤
            shape.frets.forEach((fret, stringIndex) => {
                const stringY = 20 + stringIndex * 40;
                
                if (fret === -1) {
                    // –ü—Ä–∏–≥–ª—É—à–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–Ω–∞
                    const muted = document.createElement('div');
                    muted.className = 'muted-string';
                    muted.textContent = '√ó';
                    muted.style.left = '0px';
                    muted.style.top = `${stringY}px`;
                    fretboard.appendChild(muted);
                } else if (fret === 0) {
                    // –û—Ç–∫—Ä—ã—Ç–∞—è —Å—Ç—Ä—É–Ω–∞
                    const open = document.createElement('div');
                    open.className = 'open-string';
                    open.textContent = '‚óã';
                    open.style.left = '0px';
                    open.style.top = `${stringY}px`;
                    fretboard.appendChild(open);
                } else {
                    // –ó–∞–∂–∞—Ç–∞—è —Å—Ç—Ä—É–Ω–∞
                    const finger = document.createElement('div');
                    finger.className = 'finger-position';
                    finger.style.left = `${(fret - 0.5) * 50}px`;
                    finger.style.top = `${stringY}px`;
                    
                    const fingerNum = shape.fingers[stringIndex];
                    if (fingerNum > 0) {
                        finger.textContent = fingerNum;
                    }
                    
                    fretboard.appendChild(finger);
                }
            });

            // –ë–∞—Ä—Ä—ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if (shape.barre) {
                const barreDiv = document.createElement('div');
                barreDiv.style.position = 'absolute';
                barreDiv.style.left = `${(shape.barre - 0.5) * 50 - 2}px`;
                barreDiv.style.top = '15px';
                barreDiv.style.width = '4px';
                barreDiv.style.height = '205px';
                barreDiv.style.background = 'rgba(102, 126, 234, 0.3)';
                barreDiv.style.borderRadius = '2px';
                fretboard.appendChild(barreDiv);
            }

            wrapper.appendChild(fretboard);
            return wrapper;
        }

        // –ö–≤–∞—Ä—Ç–æ-–∫–≤–∏–Ω—Ç–æ–≤—ã–π –∫—Ä—É–≥
        const CIRCLE_OF_FIFTHS_MAJOR = ['C', 'G', 'D', 'A', 'E', 'B', 'F#/Gb', 'Db', 'Ab', 'Eb', 'Bb', 'F'];
        const CIRCLE_OF_FIFTHS_MINOR = ['Am', 'Em', 'Bm', 'F#m', 'C#m', 'G#m', 'D#m/Ebm', 'Bbm', 'Fm', 'Cm', 'Gm', 'Dm'];

        function drawCircleOfFifths(currentKey) {
            const container = document.getElementById('circle-of-fifths-1');
            container.innerHTML = '';

            const centerX = 250;
            const centerY = 250;
            const radius = 180;
            const minorRadius = 120;

            // –¶–µ–Ω—Ç—Ä –∫—Ä—É–≥–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            const center = document.createElement('div');
            center.className = 'circle-center';
            center.innerHTML = `
                <div class="circle-center-title">–ö–≤–∞—Ä—Ç–æ-–∫–≤–∏–Ω—Ç–æ–≤—ã–π –∫—Ä—É–≥</div>
                <div class="circle-center-subtitle">–¢–µ–∫—É—â–∞—è: ${currentKey}</div>
            `;
            container.appendChild(center);

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
            const isMinor = currentKey.includes('m');
            const currentKeyClean = currentKey.replace('m', '');
            
            const relativeKey = isMinor ? 
                CIRCLE_OF_FIFTHS_MAJOR[CIRCLE_OF_FIFTHS_MINOR.indexOf(currentKey)] :
                CIRCLE_OF_FIFTHS_MINOR[CIRCLE_OF_FIFTHS_MAJOR.indexOf(currentKey)];

            const getCurrentIndex = () => {
                if (isMinor) {
                    return CIRCLE_OF_FIFTHS_MINOR.indexOf(currentKey);
                } else {
                    return CIRCLE_OF_FIFTHS_MAJOR.indexOf(currentKey);
                }
            };

            const currentIndex = getCurrentIndex();

            // –ú–∞–∂–æ—Ä–Ω—ã–µ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ (–≤–Ω–µ—à–Ω–∏–π –∫—Ä—É–≥)
            CIRCLE_OF_FIFTHS_MAJOR.forEach((key, index) => {
                const angle = (index * 30 - 90) * (Math.PI / 180); // 30 –≥—Ä–∞–¥—É—Å–æ–≤ –º–µ–∂–¥—É –∫–∞–∂–¥–æ–π
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);

                const keyElement = document.createElement('div');
                keyElement.className = 'circle-key';
                keyElement.style.left = `${x - 35}px`;
                keyElement.style.top = `${y - 35}px`;
                keyElement.textContent = key;

                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
                if (key === currentKey || key === currentKeyClean) {
                    keyElement.classList.add('active');
                }
                
                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π (¬±1 –ø–æ–∑–∏—Ü–∏—è)
                if (!isMinor && Math.abs(index - currentIndex) === 1) {
                    keyElement.classList.add('related');
                }

                container.appendChild(keyElement);
            });

            // –ú–∏–Ω–æ—Ä–Ω—ã–µ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä—É–≥)
            CIRCLE_OF_FIFTHS_MINOR.forEach((key, index) => {
                const angle = (index * 30 - 90) * (Math.PI / 180);
                const x = centerX + minorRadius * Math.cos(angle);
                const y = centerY + minorRadius * Math.sin(angle);

                const keyElement = document.createElement('div');
                keyElement.className = 'circle-key';
                keyElement.style.left = `${x - 35}px`;
                keyElement.style.top = `${y - 35}px`;
                keyElement.style.fontSize = '14px';
                keyElement.textContent = key;

                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
                if (key === currentKey) {
                    keyElement.classList.add('active');
                }
                
                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π
                if (isMinor && Math.abs(index - currentIndex) === 1) {
                    keyElement.classList.add('related');
                }

                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
                if (key === relativeKey || key.replace('m', '') === relativeKey) {
                    keyElement.classList.add('related');
                }

                container.appendChild(keyElement);
            });

            // –õ–∏–Ω–∏–∏, —Å–æ–µ–¥–∏–Ω—è—é—â–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.style.position = 'absolute';
            svg.style.top = '0';
            svg.style.left = '0';
            svg.style.width = '100%';
            svg.style.height = '100%';
            svg.style.pointerEvents = 'none';

            CIRCLE_OF_FIFTHS_MAJOR.forEach((majorKey, index) => {
                const angle = (index * 30 - 90) * (Math.PI / 180);
                const x1 = centerX + (radius - 40) * Math.cos(angle);
                const y1 = centerY + (radius - 40) * Math.sin(angle);
                const x2 = centerX + (minorRadius + 40) * Math.cos(angle);
                const y2 = centerY + (minorRadius + 40) * Math.sin(angle);

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
                line.setAttribute('stroke', '#e0e0e0');
                line.setAttribute('stroke-width', '1');
                line.setAttribute('stroke-dasharray', '3,3');
                svg.appendChild(line);
            });

            container.appendChild(svg);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π —Ç–µ–º–ø–∞
        document.getElementById('tempo1').addEventListener('input', (e) => {
            document.getElementById('tempoValue1').textContent = e.target.value;
        });

        document.getElementById('tempo2').addEventListener('input', (e) => {
            document.getElementById('tempoValue2').textContent = e.target.value;
        });

        // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –ª–∞–¥–∞
        document.getElementById('musicStyle').addEventListener('change', (e) => {
            const modalGroup = document.getElementById('modalModeGroup');
            if (e.target.value === 'modal') {
                modalGroup.style.display = 'block';
            } else {
                modalGroup.style.display = 'none';
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', () => {
            console.log('–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω');
        });
    </script>
</body>
</html>