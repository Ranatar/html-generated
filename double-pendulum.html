<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–≤–æ–π–Ω–æ–π –ú–∞—è—Ç–Ω–∏–∫ ¬∑ –•–∞–æ—Ç–∏—á–µ—Å–∫–∞—è –°–∏—Å—Ç–µ–º–∞</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #151b23;
            --accent-cyan: #00e5ff;
            --accent-magenta: #ff006e;
            --accent-yellow: #ffbe0b;
            --text-primary: #e8f4f8;
            --text-secondary: #8892a6;
            --border: rgba(0, 229, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Mono', monospace;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0d1821 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 229, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 0, 110, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 0.8s ease-out;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: clamp(2rem, 5vw, 3.5rem);
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            letter-spacing: 0.3em;
            text-transform: uppercase;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 2rem;
            animation: fadeIn 1s ease-out 0.2s both;
        }

        .canvas-container {
            position: relative;
            border: 2px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg-secondary);
            box-shadow: 
                0 0 40px rgba(0, 229, 255, 0.1),
                inset 0 0 60px rgba(0, 0, 0, 0.5);
            aspect-ratio: 1;
            max-height: 80vh;
        }

        .fps-counter {
            position: absolute;
            top: 10px;
            right: 10px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.5);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            opacity: 0.5;
            pointer-events: none;
            z-index: 10;
        }

        .energy-display {
            position: absolute;
            top: 10px;
            left: 10px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.5);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            opacity: 0.7;
            pointer-events: none;
            z-index: 10;
            line-height: 1.5;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: default;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            animation: fadeInRight 1s ease-out 0.4s both;
        }

        .control-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .control-panel:hover {
            border-color: rgba(0, 229, 255, 0.4);
            box-shadow: 0 8px 32px rgba(0, 229, 255, 0.1);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .tabs::-webkit-scrollbar {
            height: 4px;
        }

        .tabs::-webkit-scrollbar-track {
            background: transparent;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }

        .tabs::-webkit-scrollbar-thumb:hover {
            background: var(--accent-cyan);
        }

        .tab {
            padding: 0.6rem 1rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--accent-cyan);
        }

        .tab.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }

        .tab-content {
            display: none;
            animation-duration: 0.4s;
            animation-fill-mode: both;
        }

        .tab-content.active {
            display: block;
            animation-name: slideIn;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .panel-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--accent-cyan);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .control-group {
            margin-bottom: 1.2rem;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: default;
        }

        label[title] {
            cursor: help;
            border-bottom: 1px dotted var(--text-secondary);
            display: inline-block;
            width: 100%;
        }

        label[title]:hover {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }

        .value-display {
            color: var(--accent-yellow);
            float: right;
            font-weight: 500;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, var(--accent-cyan), var(--accent-magenta));
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
            -webkit-appearance: none;
        }

        input[type="range"]:hover {
            opacity: 1;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-cyan);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.6);
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.8);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-cyan);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.6);
        }

        button {
            width: 100%;
            padding: 0.9rem;
            border: 1px solid var(--accent-cyan);
            border-radius: 8px;
            background: rgba(0, 229, 255, 0.1);
            color: var(--accent-cyan);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(0, 229, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button:hover {
            background: rgba(0, 229, 255, 0.2);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        button span {
            position: relative;
            z-index: 1;
        }

        .compact-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.7rem;
            margin-top: 1rem;
        }

        .compact-buttons button {
            width: 100%;
            padding: 0.7rem;
            font-size: 0.75rem;
        }

        .phase-space-container {
            width: 100%;
            aspect-ratio: 1;
            border: 2px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            cursor: crosshair;
            background: var(--bg-primary);
            margin-bottom: 1rem;
            position: relative;
        }

        #phaseSpaceCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .map-info {
            padding: 0.8rem;
            background: rgba(0, 229, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .map-info p {
            margin: 0;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.7rem;
        }

        .preset-btn {
            padding: 0.7rem 0.5rem;
            font-size: 0.7rem;
            border-color: var(--border);
            background: rgba(0, 229, 255, 0.05);
        }

        .preset-btn:hover {
            border-color: var(--accent-magenta);
            background: rgba(255, 0, 110, 0.1);
        }

        .preset-btn.active {
            border-color: var(--accent-cyan);
            background: rgba(0, 229, 255, 0.15);
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.3);
        }

        .preset-btn.active span {
            color: var(--accent-cyan);
        }

        .color-select {
            width: 100%;
            padding: 0.7rem;
            background: rgba(0, 229, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-select:hover {
            border-color: var(--accent-cyan);
            background: rgba(0, 229, 255, 0.1);
        }

        .color-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
        }

        .color-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
        }

        .info {
            background: rgba(0, 229, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .info strong {
            color: var(--accent-cyan);
            display: block;
            margin-bottom: 0.3rem;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .canvas-container {
                max-height: 60vh;
            }

            .controls {
                animation: fadeIn 1s ease-out 0.2s both;
            }

            .tabs {
                overflow-x: auto;
                scrollbar-width: thin;
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.8rem;
            }

            .subtitle {
                font-size: 0.7rem;
            }

            .canvas-container {
                max-height: 50vh;
            }

            .control-panel {
                padding: 1rem;
            }

            .tab {
                font-size: 0.65rem;
                padding: 0.5rem 0.7rem;
            }

            .preset-grid {
                grid-template-columns: 1fr;
            }

            button {
                padding: 0.8rem;
                font-size: 0.75rem;
            }

            label {
                font-size: 0.7rem;
            }

            .info {
                font-size: 0.7rem;
            }

            .map-info {
                padding: 0.6rem;
            }

            .map-info p {
                font-size: 0.65rem;
            }

            .energy-display {
                font-size: 0.6rem;
                padding: 0.2rem 0.4rem;
            }
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-cyan);
            font-size: 1.2rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>–î–≤–æ–π–Ω–æ–π –ú–∞—è—Ç–Ω–∏–∫</h1>
            <p class="subtitle">–•–∞–æ—Ç–∏—á–µ—Å–∫–∞—è –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –°–∏—Å—Ç–µ–º–∞</p>
        </header>

        <div class="main-content">
            <div class="canvas-container">
                <div class="loading">–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø...</div>
                <canvas id="canvas"></canvas>
                <div class="fps-counter" id="fpsCounter">-- FPS</div>
                <div class="energy-display" id="energyDisplay">E: --</div>
            </div>

            <div class="controls">
                <div class="control-panel">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab(event, 'presets')">–ü—Ä–µ—Å–µ—Ç—ã</button>
                        <button class="tab" onclick="switchTab(event, 'physics')">–§–∏–∑–∏–∫–∞</button>
                        <button class="tab" onclick="switchTab(event, 'visual')">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</button>
                        <button class="tab" onclick="switchTab(event, 'initial')">–ù–∞—á–∞–ª—å–Ω—ã–µ</button>
                        <button class="tab" onclick="switchTab(event, 'phaseSpace')">–§–∞–∑–æ–≤–∞—è</button>
                        <button class="tab" onclick="switchTab(event, 'control')">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
                    </div>

                    <!-- –ü—Ä–µ—Å–µ—Ç—ã -->
                    <div id="presets" class="tab-content active">
                        <div class="preset-grid">
                            <button class="preset-btn active" data-preset="chaotic" onclick="loadPreset('chaotic')">
                                <span>–•–∞–æ—Å</span>
                            </button>
                            <button class="preset-btn" data-preset="periodic" onclick="loadPreset('periodic')">
                                <span>–ü–µ—Ä–∏–æ–¥–∏–∫–∞</span>
                            </button>
                            <button class="preset-btn" data-preset="asymmetric" onclick="loadPreset('asymmetric')">
                                <span>–ê—Å–∏–º–º–µ—Ç—Ä–∏—è</span>
                            </button>
                            <button class="preset-btn" data-preset="heavy" onclick="loadPreset('heavy')">
                                <span>–¢—è–∂—ë–ª—ã–π</span>
                            </button>
                            <button class="preset-btn" data-preset="light" onclick="loadPreset('light')">
                                <span>–õ—ë–≥–∫–∏–π</span>
                            </button>
                            <button class="preset-btn" data-preset="extreme" onclick="loadPreset('extreme')">
                                <span>–≠–∫—Å—Ç—Ä–∏–º</span>
                            </button>
                        </div>
                        <button onclick="resetPresetsTab()" style="margin-top: 1rem; width: 100%;">
                            <span>‚Ü∫ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                        </button>
                    </div>

                    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–∑–∏–∫–∏ -->
                    <div id="physics" class="tab-content">
                        <div class="control-group">
                            <label title="–î–ª–∏–Ω–∞ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–µ—Ä–∂–Ω—è">
                                –î–ª–∏–Ω–∞ L1
                                <span class="value-display" id="l1Value">150</span>
                            </label>
                            <input type="range" id="l1" min="50" max="250" step="5" value="150">
                        </div>

                        <div class="control-group">
                            <label title="–î–ª–∏–Ω–∞ –≤—Ç–æ—Ä–æ–≥–æ —Å—Ç–µ—Ä–∂–Ω—è">
                                –î–ª–∏–Ω–∞ L2
                                <span class="value-display" id="l2Value">150</span>
                            </label>
                            <input type="range" id="l2" min="50" max="250" step="5" value="150">
                        </div>

                        <div class="control-group">
                            <label title="–ú–∞—Å—Å–∞ –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞">
                                –ú–∞—Å—Å–∞ M1
                                <span class="value-display" id="m1Value">10</span>
                            </label>
                            <input type="range" id="m1" min="1" max="30" step="1" value="10">
                        </div>

                        <div class="control-group">
                            <label title="–ú–∞—Å—Å–∞ –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞">
                                –ú–∞—Å—Å–∞ M2
                                <span class="value-display" id="m2Value">10</span>
                            </label>
                            <input type="range" id="m2" min="1" max="30" step="1" value="10">
                        </div>

                        <div class="control-group">
                            <label title="–£—Å–∫–æ—Ä–µ–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –ø–∞–¥–µ–Ω–∏—è">
                                –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è (g)
                                <span class="value-display" id="gValue">9.8</span>
                            </label>
                            <input type="range" id="g" min="1" max="20" step="0.1" value="9.8">
                        </div>

                        <div class="control-group">
                            <label title="–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞—Ç—É—Ö–∞–Ω–∏—è (0 = –±–µ–∑ —Ç—Ä–µ–Ω–∏—è)">
                                –ó–∞—Ç—É—Ö–∞–Ω–∏–µ
                                <span class="value-display" id="dampingValue">0.000</span>
                            </label>
                            <input type="range" id="damping" min="0" max="0.01" step="0.0001" value="0">
                        </div>

                        <button onclick="resetPhysicsTab()" style="margin-top: 1rem; width: 100%;">
                            <span>‚Ü∫ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                        </button>
                    </div>

                    <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è -->
                    <div id="visual" class="tab-content">
                        <div class="control-group">
                            <label>–†–µ–∂–∏–º –æ—Ç—Ä–∏—Å–æ–≤–∫–∏</label>
                            <select id="drawMode" class="color-select">
                                <option value="trail">–õ–∏–Ω–∏—è (–Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è)</option>
                                <option value="fade">–ó–∞—Ç—É—Ö–∞—é—â–∏–π —Ñ–æ–Ω</option>
                                <option value="dots">–¢–æ—á–∫–∏ (–¥–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ)</option>
                                <option value="minimal">–¢–æ–ª—å–∫–æ –º–∞—è—Ç–Ω–∏–∫</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label>–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞</label>
                            <select id="colorScheme" class="color-select">
                                <option value="velocity">–ü–æ —Å–∫–æ—Ä–æ—Å—Ç–∏</option>
                                <option value="energy">–ü–æ —ç–Ω–µ—Ä–≥–∏–∏</option>
                                <option value="cyan">Cyan</option>
                                <option value="magenta">Magenta</option>
                                <option value="rainbow">–†–∞–¥—É–≥–∞</option>
                                <option value="fire">–û–≥–æ–Ω—å</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label>–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–ª–µ–¥</label>
                            <select id="trailTarget" class="color-select">
                                <option value="second">–¢–æ–ª—å–∫–æ 2-–π –º–∞—è—Ç–Ω–∏–∫</option>
                                <option value="first">–¢–æ–ª—å–∫–æ 1-–π –º–∞—è—Ç–Ω–∏–∫</option>
                                <option value="both">–û–±–∞ –º–∞—è—Ç–Ω–∏–∫–∞</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label>
                                –î–ª–∏–Ω–∞ —Å–ª–µ–¥–∞
                                <span class="value-display" id="trailLengthValue">500</span>
                            </label>
                            <input type="range" id="trailLength" min="50" max="2000" step="50" value="500">
                        </div>

                        <div class="control-group">
                            <label title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—è—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º">
                                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—è—Ç–Ω–∏–∫–æ–≤
                                <span class="value-display" id="numPendulumsValue">1</span>
                            </label>
                            <input type="range" id="numPendulums" min="1" max="5" step="1" value="1">
                        </div>

                        <div class="control-group">
                            <label title="–í–∞—Ä–∏–∞—Ü–∏—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö —É–≥–ª–æ–≤ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö (–¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–∞—è—Ç–Ω–∏–∫–æ–≤)">
                                –í–∞—Ä–∏–∞—Ü–∏—è —É–≥–ª–æ–≤
                                <span class="value-display" id="angleVariationValue">0.1¬∞</span>
                            </label>
                            <input type="range" id="angleVariation" min="0.01" max="5" step="0.01" value="0.1">
                        </div>

                        <div class="control-group">
                            <label>
                                –°–∫–æ—Ä–æ—Å—Ç—å —Å–∏–º—É–ª—è—Ü–∏–∏
                                <span class="value-display" id="speedValue">1.0x</span>
                            </label>
                            <input type="range" id="speed" min="0.1" max="3" step="0.1" value="1.0">
                        </div>

                        <button onclick="resetVisualTab()" style="margin-top: 1rem; width: 100%;">
                            <span>‚Ü∫ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                        </button>
                    </div>

                    <!-- –ù–∞—á–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è -->
                    <div id="initial" class="tab-content">
                        <div class="control-group">
                            <label title="–ù–∞—á–∞–ª—å–Ω—ã–π —É–≥–æ–ª –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö">
                                –£–≥–æ–ª Œ∏1
                                <span class="value-display" id="theta1Value">90¬∞</span>
                            </label>
                            <input type="range" id="theta1" min="-180" max="180" step="1" value="90">
                        </div>

                        <div class="control-group">
                            <label title="–ù–∞—á–∞–ª—å–Ω—ã–π —É–≥–æ–ª –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö">
                                –£–≥–æ–ª Œ∏2
                                <span class="value-display" id="theta2Value">90¬∞</span>
                            </label>
                            <input type="range" id="theta2" min="-180" max="180" step="1" value="90">
                        </div>

                        <div class="control-group">
                            <label title="–ù–∞—á–∞–ª—å–Ω–∞—è —É–≥–ª–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞">
                                –°–∫–æ—Ä–æ—Å—Ç—å œâ1
                                <span class="value-display" id="omega1Value">0.0</span>
                            </label>
                            <input type="range" id="omega1" min="-5" max="5" step="0.1" value="0">
                        </div>

                        <div class="control-group">
                            <label title="–ù–∞—á–∞–ª—å–Ω–∞—è —É–≥–ª–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞">
                                –°–∫–æ—Ä–æ—Å—Ç—å œâ2
                                <span class="value-display" id="omega2Value">0.0</span>
                            </label>
                            <input type="range" id="omega2" min="-5" max="5" step="0.1" value="0">
                        </div>

                        <div class="compact-buttons">
                            <button onclick="applyInitialConditions()">
                                <span>‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å</span>
                            </button>
                            <button onclick="resetInitialTab()">
                                <span>‚Ü∫ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                            </button>
                        </div>
                    </div>

                    <!-- –§–∞–∑–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ -->
                    <div id="phaseSpace" class="tab-content">
                        <div class="phase-space-container">
                            <canvas id="phaseSpaceCanvas" width="280" height="280"></canvas>
                        </div>
                        <div class="map-info">
                            <p style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                <strong style="color: var(--accent-cyan);">–î–∏–∞–≥—Ä–∞–º–º–∞ –ü—É–∞–Ω–∫–∞—Ä–µ</strong><br>
                                –ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞—á–∞–ª—å–Ω—ã—Ö —É–≥–ª–æ–≤ Œ∏1 –∏ Œ∏2. –¢–æ—á–∫–∏ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è, –ø–æ–∫–∞–∑—ã–≤–∞—è —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏. –ö–ª–∏–∫ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –æ—á–∏—â–∞–µ—Ç –∫–∞—Ä—Ç—É.
                            </p>
                            <p style="font-size: 0.65rem; color: var(--text-secondary); line-height: 1.4;">
                                –°–ª–æ–∂–Ω—ã–µ —É–∑–æ—Ä—ã –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—Ç —Ö–∞–æ—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–∏—Ä–æ–¥—É —Å–∏—Å—Ç–µ–º—ã ‚Äî –º–∞–ª—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–≤–æ–¥—è—Ç –∫ —Ä–∞–¥–∏–∫–∞–ª—å–Ω–æ —Ä–∞–∑–Ω—ã–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è–º.
                            </p>
                        </div>
                    </div>

                    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
                    <div id="control" class="tab-content">
                        <div class="action-buttons">
                            <button onclick="toggleSimulation()">
                                <span id="playPauseBtn">‚è∏ –ü–∞—É–∑–∞</span>
                            </button>
                            <button onclick="resetSimulation()">
                                <span>üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫</span>
                            </button>
                            <button onclick="clearTrail()">
                                <span>üßπ –û—á–∏—Å—Ç–∏—Ç—å —Å–ª–µ–¥</span>
                            </button>
                            <button onclick="randomInitial()">
                                <span>üé≤ –°–ª—É—á–∞–π–Ω—ã–µ —É–≥–ª—ã</span>
                            </button>
                            <button onclick="exportImage()">
                                <span>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å PNG</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="info">
                    <strong>üéØ –û —Å–∏–º—É–ª—è—Ü–∏–∏:</strong>
                    –î–≤–æ–π–Ω–æ–π –º–∞—è—Ç–Ω–∏–∫ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö–∞–æ—Å–∞. –ú–∞–ª–µ–π—à–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –ø—Ä–∏–≤–æ–¥—è—Ç –∫ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ —Ä–∞–∑–Ω—ã–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è–º.<br><br>
                    <strong>üî¢ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–∞—è—Ç–Ω–∏–∫–∏:</strong> –í–æ –≤–∫–ª–∞–¥–∫–µ "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è" –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–æ 5 –º–∞—è—Ç–Ω–∏–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏ —É–≥–ª–æ–≤, —á—Ç–æ–±—ã –Ω–∞–≥–ª—è–¥–Ω–æ —É–≤–∏–¥–µ—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º.<br><br>
                    <strong>‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong> –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ "–ü—Ä–µ—Å–µ—Ç—ã", "–§–∏–∑–∏–∫–∞" –∏ "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è" –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ. –í–∫–ª–∞–¥–∫–∞ "–ù–∞—á–∞–ª—å–Ω—ã–µ" —Ç—Ä–µ–±—É–µ—Ç –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å".<br><br>
                    <strong>üìä –§–∞–∑–æ–≤–∞—è:</strong> –î–∏–∞–≥—Ä–∞–º–º–∞ –ü—É–∞–Ω–∫–∞—Ä–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç —Ç–æ—á–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π. –ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —É–≥–ª–æ–≤. –ö–ª–∏–∫ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –æ—á–∏—â–∞–µ—Ç –∫–∞—Ä—Ç—É.<br><br>
                    <strong>‚å®Ô∏è –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:</strong> –ü—Ä–æ–±–µ–ª ‚Äî –ø–∞—É–∑–∞/–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, R ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫, C ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å —Å–ª–µ–¥.
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ canvas
        canvas.width = 800;
        canvas.height = 800;
        
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2 - 100;

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–∑–∏–∫–∏
        let l1 = 150; // –¥–ª–∏–Ω–∞ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–µ—Ä–∂–Ω—è
        let l2 = 150; // –¥–ª–∏–Ω–∞ –≤—Ç–æ—Ä–æ–≥–æ —Å—Ç–µ—Ä–∂–Ω—è
        let m1 = 10;  // –º–∞—Å—Å–∞ –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
        let m2 = 10;  // –º–∞—Å—Å–∞ –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
        let g = 9.8;  // –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
        let damping = 0.0; // –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞—Ç—É—Ö–∞–Ω–∏—è

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
        let theta1 = Math.PI / 2; // —É–≥–æ–ª –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
        let theta2 = Math.PI / 2; // —É–≥–æ–ª –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
        let omega1 = 0; // —É–≥–ª–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
        let omega2 = 0; // —É–≥–ª–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        let drawMode = 'trail';
        let colorScheme = 'velocity';
        let trailLength = 500;
        let trailTarget = 'second'; // 'first', 'second', 'both'
        let speed = 1.0;
        let numPendulums = 1;
        let angleVariation = 0.1; // –≤ –≥—Ä–∞–¥—É—Å–∞—Ö

        // –ú–∞—Å—Å–∏–≤ –º–∞—è—Ç–Ω–∏–∫–æ–≤ (–∫–∞–∂–¥—ã–π –º–∞—è—Ç–Ω–∏–∫ - –æ—Ç–¥–µ–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è)
        let pendulums = [];
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–º—É–ª—è—Ü–∏–∏
        let running = true;
        let currentPreset = 'chaotic';
        
        // –ù–∞—á–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
        let initialEnergy = 0;

        // –§–∞–∑–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
        const phaseSpaceCanvas = document.getElementById('phaseSpaceCanvas');
        const phaseSpaceCtx = phaseSpaceCanvas.getContext('2d');
        let phaseSpaceData = [];
        
        // –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–∞—è—Ç–Ω–∏–∫–æ–≤
        const pendulumColors = [
            { primary: '#00e5ff', secondary: '#ff006e' },
            { primary: '#ffbe0b', secondary: '#fb5607' },
            { primary: '#06ffa5', secondary: '#7209b7' },
            { primary: '#ff006e', secondary: '#00e5ff' },
            { primary: '#fb5607', secondary: '#06ffa5' }
        ];
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—è—Ç–Ω–∏–∫–æ–≤
        function initPendulums() {
            pendulums = [];
            for (let i = 0; i < numPendulums; i++) {
                const variation = (i - (numPendulums - 1) / 2) * angleVariation * Math.PI / 180;
                pendulums.push({
                    theta1: theta1 + variation,
                    theta2: theta2 + variation,
                    omega1: omega1,
                    omega2: omega2,
                    trail1: [], // —Å–ª–µ–¥ –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
                    trail2: [], // —Å–ª–µ–¥ –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
                    color: pendulumColors[i % pendulumColors.length]
                });
            }
        }

        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã—Ö –¥–ª—è –º–µ—Ç–æ–¥–∞ –†—É–Ω–≥–µ-–ö—É—Ç—Ç—ã
        function derivatives(th1, th2, om1, om2) {
            const delta = th2 - th1;
            const den1 = (m1 + m2) * l1 - m2 * l1 * Math.cos(delta) * Math.cos(delta);
            const den2 = (l2 / l1) * den1;

            const dth1 = om1;
            const dth2 = om2;

            const dom1 = (m2 * l1 * om1 * om1 * Math.sin(delta) * Math.cos(delta) +
                         m2 * g * Math.sin(th2) * Math.cos(delta) +
                         m2 * l2 * om2 * om2 * Math.sin(delta) -
                         (m1 + m2) * g * Math.sin(th1) -
                         damping * om1) / den1;

            const dom2 = (-m2 * l2 * om2 * om2 * Math.sin(delta) * Math.cos(delta) +
                         (m1 + m2) * g * Math.sin(th1) * Math.cos(delta) -
                         (m1 + m2) * l1 * om1 * om1 * Math.sin(delta) -
                         (m1 + m2) * g * Math.sin(th2) -
                         damping * om2) / den2;

            return { dth1, dth2, dom1, dom2 };
        }

        // –ú–µ—Ç–æ–¥ –†—É–Ω–≥–µ-–ö—É—Ç—Ç—ã 2-–≥–æ –ø–æ—Ä—è–¥–∫–∞ (–º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ —Å—Ä–µ–¥–Ω–µ–π —Ç–æ—á–∫–∏)
        function rungeKutta2(pendulum, dt) {
            // k1 - –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ –≤ –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–µ
            const k1 = derivatives(pendulum.theta1, pendulum.theta2, pendulum.omega1, pendulum.omega2);
            
            // k2 - –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ –≤ —Å—Ä–µ–¥–Ω–µ–π —Ç–æ—á–∫–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º k1
            const th1_mid = pendulum.theta1 + 0.5 * dt * k1.dth1;
            const th2_mid = pendulum.theta2 + 0.5 * dt * k1.dth2;
            const om1_mid = pendulum.omega1 + 0.5 * dt * k1.dom1;
            const om2_mid = pendulum.omega2 + 0.5 * dt * k1.dom2;
            
            const k2 = derivatives(th1_mid, th2_mid, om1_mid, om2_mid);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º k2
            pendulum.theta1 += dt * k2.dth1;
            pendulum.theta2 += dt * k2.dth2;
            pendulum.omega1 += dt * k2.dom1;
            pendulum.omega2 += dt * k2.dom2;
        }

        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ —Å–∏—Å—Ç–µ–º—ã
        function calculateEnergy(pendulum) {
            const x1 = l1 * Math.sin(pendulum.theta1);
            const y1 = -l1 * Math.cos(pendulum.theta1);
            const x2 = x1 + l2 * Math.sin(pendulum.theta2);
            const y2 = y1 - l2 * Math.cos(pendulum.theta2);

            const vx1 = l1 * pendulum.omega1 * Math.cos(pendulum.theta1);
            const vy1 = l1 * pendulum.omega1 * Math.sin(pendulum.theta1);
            const vx2 = vx1 + l2 * pendulum.omega2 * Math.cos(pendulum.theta2);
            const vy2 = vy1 + l2 * pendulum.omega2 * Math.sin(pendulum.theta2);

            const ke = 0.5 * m1 * (vx1 * vx1 + vy1 * vy1) + 0.5 * m2 * (vx2 * vx2 + vy2 * vy2);
            const pe = m1 * g * (centerY + y1) + m2 * g * (centerY + y2);

            return ke + pe;
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã
        function draw() {
            // –û—á–∏—Å—Ç–∫–∞ –∏–ª–∏ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ
            if (drawMode === 'fade') {
                ctx.fillStyle = 'rgba(10, 14, 20, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = '#0a0e14';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ—Ö –º–∞—è—Ç–Ω–∏–∫–æ–≤
            pendulums.forEach((pendulum, index) => {
                // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π
                const x1 = centerX + l1 * Math.sin(pendulum.theta1);
                const y1 = centerY + l1 * Math.cos(pendulum.theta1);
                const x2 = x1 + l2 * Math.sin(pendulum.theta2);
                const y2 = y1 + l2 * Math.cos(pendulum.theta2);

                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –≤ —Å–ª–µ–¥—ã (–µ—Å–ª–∏ –Ω–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º)
                if (drawMode !== 'minimal') {
                    const velocity = Math.sqrt(pendulum.omega1 * pendulum.omega1 + pendulum.omega2 * pendulum.omega2);
                    
                    // –°–ª–µ–¥ –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
                    if (trailTarget === 'first' || trailTarget === 'both') {
                        pendulum.trail1.push({ x: x1, y: y1, v: velocity });
                        if (pendulum.trail1.length > trailLength) {
                            pendulum.trail1.shift();
                        }
                    } else {
                        pendulum.trail1 = [];
                    }
                    
                    // –°–ª–µ–¥ –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
                    if (trailTarget === 'second' || trailTarget === 'both') {
                        pendulum.trail2.push({ x: x2, y: y2, v: velocity });
                        if (pendulum.trail2.length > trailLength) {
                            pendulum.trail2.shift();
                        }
                    } else {
                        pendulum.trail2 = [];
                    }
                }

                // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –æ–¥–Ω–æ–≥–æ —Å–ª–µ–¥–∞
                function drawTrail(trail, colorIndex) {
                    if (drawMode === 'trail') {
                        // –õ–∏–Ω–µ–π–Ω–∞—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞
                        for (let i = 1; i < trail.length; i++) {
                            const alpha = i / trail.length;
                            const color = getColor(trail[i].v, alpha, index, colorIndex);
                            
                            ctx.strokeStyle = color;
                            ctx.lineWidth = 2;
                            ctx.beginPath();
                            ctx.moveTo(trail[i - 1].x, trail[i - 1].y);
                            ctx.lineTo(trail[i].x, trail[i].y);
                            ctx.stroke();
                        }
                    } else if (drawMode === 'dots') {
                        // –î–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ —Ç–æ—á–∫–∏ (–∫–∞–∂–¥–∞—è 5-—è —Ç–æ—á–∫–∞ –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏)
                        for (let i = 0; i < trail.length; i += 5) {
                            const alpha = i / trail.length;
                            const color = getColor(trail[i].v, alpha, index, colorIndex);
                            
                            ctx.fillStyle = color;
                            ctx.beginPath();
                            ctx.arc(trail[i].x, trail[i].y, 2.5, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    } else if (drawMode === 'fade') {
                        // –í —Ä–µ–∂–∏–º–µ –∑–∞—Ç—É—Ö–∞–Ω–∏—è —Ä–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â—É—é —Ç–æ—á–∫—É
                        if (trail.length > 0) {
                            const lastPoint = trail[trail.length - 1];
                            const color = getColor(lastPoint.v, 1, index, colorIndex);
                            ctx.fillStyle = color;
                            ctx.beginPath();
                            ctx.arc(lastPoint.x, lastPoint.y, 3, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                }

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ª–µ–¥–æ–≤
                if (trailTarget === 'first' || trailTarget === 'both') {
                    drawTrail(pendulum.trail1, 0); // 0 - –ø–µ—Ä–≤—ã–π –º–∞—è—Ç–Ω–∏–∫
                }
                if (trailTarget === 'second' || trailTarget === 'both') {
                    drawTrail(pendulum.trail2, 1); // 1 - –≤—Ç–æ—Ä–æ–π –º–∞—è—Ç–Ω–∏–∫
                }

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç–µ—Ä–∂–Ω–µ–π –≤ —Ç–µ–∫—É—â–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–∏ (—Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–∞—è—Ç–Ω–∏–∫–æ–≤)
                const opacity = numPendulums > 1 ? 0.5 : 0.8;
                
                ctx.strokeStyle = `rgba(${parseInt(pendulum.color.primary.slice(1, 3), 16)}, ${parseInt(pendulum.color.primary.slice(3, 5), 16)}, ${parseInt(pendulum.color.primary.slice(5, 7), 16)}, ${opacity})`;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x1, y1);
                ctx.stroke();

                ctx.strokeStyle = `rgba(${parseInt(pendulum.color.secondary.slice(1, 3), 16)}, ${parseInt(pendulum.color.secondary.slice(3, 5), 16)}, ${parseInt(pendulum.color.secondary.slice(5, 7), 16)}, ${opacity})`;
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∞—è—Ç–Ω–∏–∫–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∏–ª–∏ –µ—Å–ª–∏ –æ–¥–∏–Ω –º–∞—è—Ç–Ω–∏–∫ - —Ä–∏—Å—É–µ–º –∫—Ä—É–ø–Ω–µ–µ)
                if (index === 0 || numPendulums === 1) {
                    // –ü–µ—Ä–≤—ã–π –º–∞—è—Ç–Ω–∏–∫
                    const radius1 = Math.max(8, Math.sqrt(m1) * 3);
                    ctx.fillStyle = pendulum.color.primary;
                    ctx.beginPath();
                    ctx.arc(x1, y1, radius1, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = `${pendulum.color.primary}80`;
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // –í—Ç–æ—Ä–æ–π –º–∞—è—Ç–Ω–∏–∫
                    const radius2 = Math.max(8, Math.sqrt(m2) * 3);
                    ctx.fillStyle = pendulum.color.secondary;
                    ctx.beginPath();
                    ctx.arc(x2, y2, radius2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = `${pendulum.color.secondary}80`;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                } else {
                    // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –º–∞—è—Ç–Ω–∏–∫–æ–≤ - –º–µ–Ω—å—à–µ –∏ –ø—Ä–æ—â–µ
                    const radius1 = 5;
                    const radius2 = 5;
                    
                    ctx.fillStyle = pendulum.color.primary;
                    ctx.beginPath();
                    ctx.arc(x1, y1, radius1, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = pendulum.color.secondary;
                    ctx.beginPath();
                    ctx.arc(x2, y2, radius2, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–æ—á–∫–∏ –ø–æ–¥–≤–µ—Å–∞ (–ø–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö –º–∞—è—Ç–Ω–∏–∫–æ–≤)
            ctx.fillStyle = '#e8f4f8';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 8, 0, Math.PI * 2);
            ctx.fill();

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –º–∞—è—Ç–Ω–∏–∫)
            if (running && pendulums.length > 0) {
                const currentEnergy = calculateEnergy(pendulums[0]);
                const energyChange = initialEnergy !== 0 ? 
                    ((currentEnergy - initialEnergy) / initialEnergy * 100).toFixed(2) : 0;
                document.getElementById('energyDisplay').innerHTML = 
                    `E: ${currentEnergy.toFixed(0)}<br>ŒîE: ${energyChange}%`;
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ö–µ–º—ã
        function getColor(velocity, alpha, pendulumIndex = 0, massIndex = 1) {
            // massIndex: 0 - –ø–µ—Ä–≤—ã–π –º–∞—è—Ç–Ω–∏–∫, 1 - –≤—Ç–æ—Ä–æ–π –º–∞—è—Ç–Ω–∏–∫
            const schemes = {
                velocity: () => {
                    const hue = Math.min(velocity * 30, 300);
                    return `hsla(${hue}, 80%, 60%, ${alpha})`;
                },
                energy: () => {
                    const energy = pendulums.length > 0 ? calculateEnergy(pendulums[pendulumIndex]) : 0;
                    const hue = (energy / 100) % 360;
                    return `hsla(${hue}, 80%, 60%, ${alpha})`;
                },
                cyan: () => {
                    // –î–ª—è —Ä–µ–∂–∏–º–∞ "–æ–±–∞" - –ø–µ—Ä–≤—ã–π –º–∞—è—Ç–Ω–∏–∫ cyan, –≤—Ç–æ—Ä–æ–π magenta
                    if (trailTarget === 'both') {
                        return massIndex === 0 ? `rgba(0, 229, 255, ${alpha})` : `rgba(255, 0, 110, ${alpha})`;
                    }
                    return `rgba(0, 229, 255, ${alpha})`;
                },
                magenta: () => {
                    if (trailTarget === 'both') {
                        return massIndex === 0 ? `rgba(0, 229, 255, ${alpha})` : `rgba(255, 0, 110, ${alpha})`;
                    }
                    return `rgba(255, 0, 110, ${alpha})`;
                },
                rainbow: () => {
                    const baseHue = (Date.now() / 20 + pendulumIndex * 72) % 360;
                    const hueOffset = trailTarget === 'both' ? (massIndex === 0 ? -30 : 30) : 0;
                    return `hsla(${(baseHue + hueOffset + 360) % 360}, 80%, 60%, ${alpha})`;
                },
                fire: () => {
                    const val = Math.min(velocity * 50, 100);
                    if (trailTarget === 'both') {
                        // –ü–µ—Ä–≤—ã–π - –æ—Ä–∞–Ω–∂–µ–≤—ã–π, –≤—Ç–æ—Ä–æ–π - –∫—Ä–∞—Å–Ω—ã–π
                        return massIndex === 0 ? `rgba(255, ${150 - val}, 0, ${alpha})` : `rgba(255, ${100 - val}, 0, ${alpha})`;
                    }
                    return `rgba(255, ${100 - val}, 0, ${alpha})`;
                }
            };

            return schemes[colorScheme] ? schemes[colorScheme]() : schemes.velocity();
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ —Ñ–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ (–¥–∏–∞–≥—Ä–∞–º–º–∞ –ü—É–∞–Ω–∫–∞—Ä–µ)
        function drawPhaseSpace() {
            const w = phaseSpaceCanvas.width;
            const h = phaseSpaceCanvas.height;
            
            // –§–æ–Ω
            phaseSpaceCtx.fillStyle = '#0a0e14';
            phaseSpaceCtx.fillRect(0, 0, w, h);
            
            // –°–µ—Ç–∫–∞
            phaseSpaceCtx.strokeStyle = 'rgba(0, 229, 255, 0.1)';
            phaseSpaceCtx.lineWidth = 1;
            for (let i = 0; i <= 8; i++) {
                const x = (i / 8) * w;
                const y = (i / 8) * h;
                phaseSpaceCtx.beginPath();
                phaseSpaceCtx.moveTo(x, 0);
                phaseSpaceCtx.lineTo(x, h);
                phaseSpaceCtx.stroke();
                phaseSpaceCtx.beginPath();
                phaseSpaceCtx.moveTo(0, y);
                phaseSpaceCtx.lineTo(w, y);
                phaseSpaceCtx.stroke();
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π
            phaseSpaceData.forEach(data => {
                const x = ((data.th1 + Math.PI) / (2 * Math.PI)) * w;
                const y = ((data.th2 + Math.PI) / (2 * Math.PI)) * h;
                
                phaseSpaceCtx.fillStyle = data.color;
                phaseSpaceCtx.beginPath();
                phaseSpaceCtx.arc(x, y, 1.5, 0, Math.PI * 2);
                phaseSpaceCtx.fill();
            });

            // –¢–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤—Å–µ—Ö –º–∞—è—Ç–Ω–∏–∫–æ–≤
            pendulums.forEach((pendulum, index) => {
                const currentX = ((pendulum.theta1 + Math.PI) / (2 * Math.PI)) * w;
                const currentY = ((pendulum.theta2 + Math.PI) / (2 * Math.PI)) * h;
                
                if (index === 0) {
                    // –ü–µ—Ä–≤—ã–π –º–∞—è—Ç–Ω–∏–∫ - –±–æ–ª—å—à–∞—è –∫—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞
                    phaseSpaceCtx.shadowColor = 'rgba(255, 0, 110, 0.8)';
                    phaseSpaceCtx.shadowBlur = 10;
                    phaseSpaceCtx.fillStyle = '#ff006e';
                    phaseSpaceCtx.beginPath();
                    phaseSpaceCtx.arc(currentX, currentY, 6, 0, Math.PI * 2);
                    phaseSpaceCtx.fill();
                    phaseSpaceCtx.shadowBlur = 0;
                    
                    phaseSpaceCtx.strokeStyle = '#ffffff';
                    phaseSpaceCtx.lineWidth = 2;
                    phaseSpaceCtx.beginPath();
                    phaseSpaceCtx.arc(currentX, currentY, 8, 0, Math.PI * 2);
                    phaseSpaceCtx.stroke();
                } else {
                    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–∞—è—Ç–Ω–∏–∫–∏ - –º–µ–Ω—å—à–∏–µ —Ü–≤–µ—Ç–Ω—ã–µ —Ç–æ—á–∫–∏
                    phaseSpaceCtx.fillStyle = pendulum.color.secondary;
                    phaseSpaceCtx.beginPath();
                    phaseSpaceCtx.arc(currentX, currentY, 4, 0, Math.PI * 2);
                    phaseSpaceCtx.fill();
                    phaseSpaceCtx.strokeStyle = '#ffffff80';
                    phaseSpaceCtx.lineWidth = 1;
                    phaseSpaceCtx.stroke();
                }
            });

            // –ü–æ–¥–ø–∏—Å–∏ –æ—Å–µ–π
            phaseSpaceCtx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            phaseSpaceCtx.font = '11px "IBM Plex Mono"';
            phaseSpaceCtx.fillText('Œ∏1 ‚Üí', w - 40, h - 5);
            phaseSpaceCtx.save();
            phaseSpaceCtx.translate(10, h / 2);
            phaseSpaceCtx.rotate(-Math.PI / 2);
            phaseSpaceCtx.fillText('Œ∏2 ‚Üí', -20, 0);
            phaseSpaceCtx.restore();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ (—Ç–µ–∫—Å—Ç –≤ —É–≥–ª—É)
            phaseSpaceCtx.fillStyle = 'rgba(0, 229, 255, 0.5)';
            phaseSpaceCtx.font = '9px "IBM Plex Mono"';
            phaseSpaceCtx.fillText('[–ö–ª–∏–∫ –æ—á–∏—â–∞–µ—Ç]', w - 80, 12);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
        let phaseSpaceCounter = 0;
        function updatePhaseSpace() {
            phaseSpaceCounter++;
            if (phaseSpaceCounter % 10 === 0 && phaseSpaceData.length < 5000) {
                pendulums.forEach((pendulum, index) => {
                    const velocity = Math.sqrt(pendulum.omega1 * pendulum.omega1 + pendulum.omega2 * pendulum.omega2);
                    phaseSpaceData.push({
                        th1: pendulum.theta1,
                        th2: pendulum.theta2,
                        color: getColor(velocity, 0.4, index)
                    });
                });
            }
        }

        // –ö–ª–∏–∫ –ø–æ —Ñ–∞–∑–æ–≤–æ–º—É –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤—É - –æ—á–∏—â–∞–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ —É–≥–ª—ã
        phaseSpaceCanvas.addEventListener('click', (e) => {
            const rect = phaseSpaceCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / rect.width;
            const y = (e.clientY - rect.top) / rect.height;
            
            // –ï—Å–ª–∏ –∫–ª–∏–∫ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É (–æ–±–ª–∞—Å—Ç—å "–æ—á–∏—Å—Ç–∏—Ç—å") - —Ç–æ–ª—å–∫–æ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (x > 0.7 && y < 0.1) {
                phaseSpaceData = [];
                drawPhaseSpace();
                return;
            }
            
            // –ò–Ω–∞—á–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ —É–≥–ª—ã
            theta1 = x * 2 * Math.PI - Math.PI;
            theta2 = y * 2 * Math.PI - Math.PI;
            omega1 = 0;
            omega2 = 0;
            
            document.getElementById('theta1').value = theta1 * 180 / Math.PI;
            document.getElementById('theta2').value = theta2 * 180 / Math.PI;
            updateValueDisplays();
            
            // –ù–µ –æ—á–∏—â–∞–µ–º phaseSpaceData - –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ–º —Ç–æ—á–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π
            initPendulums();
            if (pendulums.length > 0) {
                initialEnergy = calculateEnergy(pendulums[0]);
            }
            drawPhaseSpace();
        });

        // Touch –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Ñ–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
        phaseSpaceCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = phaseSpaceCanvas.getBoundingClientRect();
            const x = (touch.clientX - rect.left) / rect.width;
            const y = (touch.clientY - rect.top) / rect.height;
            
            // –ï—Å–ª–∏ —Ç–∞–ø –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É - –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (x > 0.7 && y < 0.1) {
                phaseSpaceData = [];
                drawPhaseSpace();
                return;
            }
            
            theta1 = x * 2 * Math.PI - Math.PI;
            theta2 = y * 2 * Math.PI - Math.PI;
            omega1 = 0;
            omega2 = 0;
            
            document.getElementById('theta1').value = theta1 * 180 / Math.PI;
            document.getElementById('theta2').value = theta2 * 180 / Math.PI;
            updateValueDisplays();
            
            initPendulums();
            if (pendulums.length > 0) {
                initialEnergy = calculateEnergy(pendulums[0]);
            }
            drawPhaseSpace();
        });

        // FPS counter
        let lastFrameTime = performance.now();
        let frameCount = 0;
        let fps = 0;
        const fpsCounter = document.getElementById('fpsCounter');

        // –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª
        function loop(currentTime) {
            if (running) {
                const dt = 0.05 * speed;
                const steps = 5;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –º–∞—è—Ç–Ω–∏–∫–∏
                pendulums.forEach(pendulum => {
                    for (let i = 0; i < steps; i++) {
                        rungeKutta2(pendulum, dt / steps);
                    }
                });
                
                updatePhaseSpace();
                draw();

                frameCount++;
                if (currentTime - lastFrameTime >= 1000) {
                    fps = frameCount;
                    fpsCounter.textContent = `${fps} FPS`;
                    frameCount = 0;
                    lastFrameTime = currentTime;
                }
            }
            requestAnimationFrame(loop);
        }

        // –ü—Ä–µ—Å–µ—Ç—ã
        const presets = {
            chaotic: { 
                l1: 150, l2: 150, m1: 10, m2: 10, g: 9.8, 
                th1: 90, th2: 90, om1: 0, om2: 0, damping: 0 
            },
            periodic: { 
                l1: 150, l2: 150, m1: 10, m2: 10, g: 9.8, 
                th1: 30, th2: 30, om1: 0, om2: 0, damping: 0 
            },
            asymmetric: { 
                l1: 200, l2: 100, m1: 15, m2: 5, g: 9.8, 
                th1: 120, th2: -60, om1: 0, om2: 0, damping: 0 
            },
            heavy: { 
                l1: 150, l2: 150, m1: 25, m2: 5, g: 9.8, 
                th1: 90, th2: 90, om1: 0, om2: 0, damping: 0 
            },
            light: { 
                l1: 150, l2: 150, m1: 5, m2: 25, g: 9.8, 
                th1: 90, th2: 90, om1: 0, om2: 0, damping: 0 
            },
            extreme: { 
                l1: 200, l2: 200, m1: 20, m2: 20, g: 15, 
                th1: 170, th2: 170, om1: 2, om2: -2, damping: 0 
            }
        };

        function loadPreset(name) {
            const preset = presets[name];
            l1 = preset.l1;
            l2 = preset.l2;
            m1 = preset.m1;
            m2 = preset.m2;
            g = preset.g;
            damping = preset.damping;
            theta1 = preset.th1 * Math.PI / 180;
            theta2 = preset.th2 * Math.PI / 180;
            omega1 = preset.om1;
            omega2 = preset.om2;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ UI —ç–ª–µ–º–µ–Ω—Ç—ã
            document.getElementById('l1').value = l1;
            document.getElementById('l2').value = l2;
            document.getElementById('m1').value = m1;
            document.getElementById('m2').value = m2;
            document.getElementById('g').value = g;
            document.getElementById('damping').value = damping;
            document.getElementById('theta1').value = preset.th1;
            document.getElementById('theta2').value = preset.th2;
            document.getElementById('omega1').value = omega1;
            document.getElementById('omega2').value = omega2;
            
            updateValueDisplays();
            resetSimulation();
            
            currentPreset = name;
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`[data-preset="${name}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        function toggleSimulation() {
            running = !running;
            document.getElementById('playPauseBtn').textContent = running ? '‚è∏ –ü–∞—É–∑–∞' : '‚ñ∂ –°—Ç–∞—Ä—Ç';
        }

        function resetSimulation() {
            initPendulums();
            phaseSpaceData = [];
            phaseSpaceCounter = 0;
            if (pendulums.length > 0) {
                initialEnergy = calculateEnergy(pendulums[0]);
            }
            draw();
            if (document.getElementById('phaseSpace').classList.contains('active')) {
                drawPhaseSpace();
            }
        }

        function clearTrail() {
            pendulums.forEach(pendulum => {
                pendulum.trail1 = [];
                pendulum.trail2 = [];
            });
            phaseSpaceData = [];
        }

        function randomInitial() {
            theta1 = (Math.random() - 0.5) * Math.PI * 2;
            theta2 = (Math.random() - 0.5) * Math.PI * 2;
            omega1 = 0;
            omega2 = 0;
            
            document.getElementById('theta1').value = theta1 * 180 / Math.PI;
            document.getElementById('theta2').value = theta2 * 180 / Math.PI;
            document.getElementById('omega1').value = omega1;
            document.getElementById('omega2').value = omega2;
            updateValueDisplays();
            
            resetSimulation();
            
            currentPreset = null;
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function applyInitialConditions() {
            theta1 = parseFloat(document.getElementById('theta1').value) * Math.PI / 180;
            theta2 = parseFloat(document.getElementById('theta2').value) * Math.PI / 180;
            omega1 = parseFloat(document.getElementById('omega1').value);
            omega2 = parseFloat(document.getElementById('omega2').value);
            
            resetSimulation();
            
            const applyBtn = document.querySelector('#initial .compact-buttons button:first-child');
            const originalText = applyBtn.innerHTML;
            applyBtn.innerHTML = '<span>‚úì –ü—Ä–∏–º–µ–Ω–µ–Ω–æ!</span>';
            applyBtn.style.borderColor = 'var(--accent-cyan)';
            applyBtn.style.background = 'rgba(0, 229, 255, 0.2)';
            
            setTimeout(() => {
                applyBtn.innerHTML = originalText;
                applyBtn.style.borderColor = '';
                applyBtn.style.background = '';
            }, 1500);
        }

        function exportImage() {
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = canvas.width;
            exportCanvas.height = canvas.height;
            const exportCtx = exportCanvas.getContext('2d');
            exportCtx.drawImage(canvas, 0, 0);
            
            const exportBtn = document.querySelector('#control button:last-child');
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = '<span>‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</span>';
            exportBtn.style.borderColor = 'var(--accent-cyan)';
            exportBtn.style.background = 'rgba(0, 229, 255, 0.2)';
            
            exportCanvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = `double-pendulum-${Date.now()}.png`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
                
                setTimeout(() => {
                    exportBtn.innerHTML = originalText;
                    exportBtn.style.borderColor = '';
                    exportBtn.style.background = '';
                }, 2000);
            });
        }

        function updateValueDisplays() {
            document.getElementById('l1Value').textContent = l1;
            document.getElementById('l2Value').textContent = l2;
            document.getElementById('m1Value').textContent = m1;
            document.getElementById('m2Value').textContent = m2;
            document.getElementById('gValue').textContent = g.toFixed(1);
            document.getElementById('dampingValue').textContent = damping.toFixed(4);
            document.getElementById('theta1Value').textContent = (parseFloat(document.getElementById('theta1').value)).toFixed(0) + '¬∞';
            document.getElementById('theta2Value').textContent = (parseFloat(document.getElementById('theta2').value)).toFixed(0) + '¬∞';
            document.getElementById('omega1Value').textContent = (parseFloat(document.getElementById('omega1').value)).toFixed(1);
            document.getElementById('omega2Value').textContent = (parseFloat(document.getElementById('omega2').value)).toFixed(1);
            document.getElementById('trailLengthValue').textContent = trailLength;
            document.getElementById('numPendulumsValue').textContent = numPendulums;
            document.getElementById('angleVariationValue').textContent = angleVariation.toFixed(2) + '¬∞';
            document.getElementById('speedValue').textContent = speed.toFixed(1) + 'x';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('l1').addEventListener('input', (e) => {
            l1 = parseFloat(e.target.value);
            updateValueDisplays();
        });

        document.getElementById('l2').addEventListener('input', (e) => {
            l2 = parseFloat(e.target.value);
            updateValueDisplays();
        });

        document.getElementById('m1').addEventListener('input', (e) => {
            m1 = parseFloat(e.target.value);
            updateValueDisplays();
        });

        document.getElementById('m2').addEventListener('input', (e) => {
            m2 = parseFloat(e.target.value);
            updateValueDisplays();
        });

        document.getElementById('g').addEventListener('input', (e) => {
            g = parseFloat(e.target.value);
            updateValueDisplays();
        });

        document.getElementById('damping').addEventListener('input', (e) => {
            damping = parseFloat(e.target.value);
            updateValueDisplays();
        });

        document.getElementById('theta1').addEventListener('input', updateValueDisplays);
        document.getElementById('theta2').addEventListener('input', updateValueDisplays);
        document.getElementById('omega1').addEventListener('input', updateValueDisplays);
        document.getElementById('omega2').addEventListener('input', updateValueDisplays);

        document.getElementById('drawMode').addEventListener('change', (e) => {
            drawMode = e.target.value;
            if (drawMode === 'minimal') {
                pendulums.forEach(pendulum => {
                    pendulum.trail1 = [];
                    pendulum.trail2 = [];
                });
            }
        });

        document.getElementById('colorScheme').addEventListener('change', (e) => {
            colorScheme = e.target.value;
        });

        document.getElementById('trailTarget').addEventListener('change', (e) => {
            trailTarget = e.target.value;
            // –û—á–∏—â–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–ª–µ–¥—ã
            pendulums.forEach(pendulum => {
                if (trailTarget === 'first') {
                    pendulum.trail2 = [];
                } else if (trailTarget === 'second') {
                    pendulum.trail1 = [];
                }
            });
        });

        document.getElementById('trailLength').addEventListener('input', (e) => {
            trailLength = parseInt(e.target.value);
            updateValueDisplays();
        });

        document.getElementById('numPendulums').addEventListener('input', (e) => {
            numPendulums = parseInt(e.target.value);
            updateValueDisplays();
            resetSimulation();
        });

        document.getElementById('angleVariation').addEventListener('input', (e) => {
            angleVariation = parseFloat(e.target.value);
            updateValueDisplays();
            if (numPendulums > 1) {
                resetSimulation();
            }
        });

        document.getElementById('speed').addEventListener('input', (e) => {
            speed = parseFloat(e.target.value);
            updateValueDisplays();
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(event, tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            
            if (tabName === 'phaseSpace') {
                setTimeout(() => drawPhaseSpace(), 50);
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Å–±—Ä–æ—Å–∞
        function resetPresetsTab() {
            loadPreset('chaotic');
            showResetFeedback('#presets');
        }

        function resetPhysicsTab() {
            l1 = 150;
            l2 = 150;
            m1 = 10;
            m2 = 10;
            g = 9.8;
            damping = 0;
            
            document.getElementById('l1').value = l1;
            document.getElementById('l2').value = l2;
            document.getElementById('m1').value = m1;
            document.getElementById('m2').value = m2;
            document.getElementById('g').value = g;
            document.getElementById('damping').value = damping;
            updateValueDisplays();
            showResetFeedback('#physics');
        }

        function resetVisualTab() {
            drawMode = 'trail';
            colorScheme = 'velocity';
            trailTarget = 'second';
            trailLength = 500;
            numPendulums = 1;
            angleVariation = 0.1;
            speed = 1.0;
            
            document.getElementById('drawMode').value = drawMode;
            document.getElementById('colorScheme').value = colorScheme;
            document.getElementById('trailTarget').value = trailTarget;
            document.getElementById('trailLength').value = trailLength;
            document.getElementById('numPendulums').value = numPendulums;
            document.getElementById('angleVariation').value = angleVariation;
            document.getElementById('speed').value = speed;
            updateValueDisplays();
            resetSimulation();
            showResetFeedback('#visual');
        }

        function resetInitialTab() {
            document.getElementById('theta1').value = 90;
            document.getElementById('theta2').value = 90;
            document.getElementById('omega1').value = 0;
            document.getElementById('omega2').value = 0;
            updateValueDisplays();
            showResetFeedback('#initial');
        }

        function showResetFeedback(tabSelector) {
            const buttons = document.querySelectorAll(`${tabSelector} button`);
            const resetBtn = Array.from(buttons).find(btn => btn.textContent.includes('–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é'));
            
            if (resetBtn) {
                const originalText = resetBtn.innerHTML;
                resetBtn.innerHTML = '<span>‚úì –°–±—Ä–æ—à–µ–Ω–æ!</span>';
                resetBtn.style.borderColor = 'var(--accent-cyan)';
                resetBtn.style.background = 'rgba(0, 229, 255, 0.2)';
                
                setTimeout(() => {
                    resetBtn.innerHTML = originalText;
                    resetBtn.style.borderColor = '';
                    resetBtn.style.background = '';
                }, 1500);
            }
        }

        // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                e.preventDefault();
                toggleSimulation();
            }
            if (e.code === 'KeyR' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                e.preventDefault();
                resetSimulation();
            }
            if (e.code === 'KeyC' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                e.preventDefault();
                clearTrail();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.querySelector('.loading').style.display = 'none';
        initPendulums();
        if (pendulums.length > 0) {
            initialEnergy = calculateEnergy(pendulums[0]);
        }
        updateValueDisplays();
        drawPhaseSpace();
        requestAnimationFrame(loop);
    </script>
</body>
</html>
