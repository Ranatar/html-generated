<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–≤–æ–π–Ω–æ–π –ú–∞—è—Ç–Ω–∏–∫ ¬∑ –•–∞–æ—Ç–∏—á–µ—Å–∫–∞—è –°–∏—Å—Ç–µ–º–∞</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #151b23;
            --accent-cyan: #00e5ff;
            --accent-magenta: #ff006e;
            --accent-yellow: #ffbe0b;
            --text-primary: #e8f4f8;
            --text-secondary: #8892a6;
            --border: rgba(0, 229, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Mono', monospace;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0d1821 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 229, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 0, 110, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 0.8s ease-out;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: clamp(2rem, 5vw, 3.5rem);
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            letter-spacing: 0.3em;
            text-transform: uppercase;
        }

        .main-content {
            display: grid;
            grid-template-columns: minmax(auto, 800px) minmax(320px, 400px);
            gap: 2rem;
            animation: fadeIn 1s ease-out 0.2s both;
            justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */
        }
        
        .canvas-container {
            position: relative;
            border: 2px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg-secondary);
            box-shadow: 
                0 0 40px rgba(0, 229, 255, 0.1),
                inset 0 0 60px rgba(0, 0, 0, 0.5);
            aspect-ratio: 1;
            max-height: 80vh;
            width: 100%; /* –î–æ–±–∞–≤–ª–µ–Ω–æ */
            max-width: 800px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É */
        }

        .fps-counter {
            position: absolute;
            top: 10px;
            right: 10px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.5);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            opacity: 0.5;
            pointer-events: none;
            z-index: 10;
        }

        .energy-display {
            position: absolute;
            top: 10px;
            left: 10px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.5);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            opacity: 0.7;
            pointer-events: none;
            z-index: 10;
            line-height: 1.5;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: default;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            animation: fadeInRight 1s ease-out 0.4s both;
            min-width: 320px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
        }

        .control-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .control-panel:hover {
            border-color: rgba(0, 229, 255, 0.4);
            box-shadow: 0 8px 32px rgba(0, 229, 255, 0.1);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .tabs::-webkit-scrollbar {
            height: 4px;
        }

        .tabs::-webkit-scrollbar-track {
            background: transparent;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }

        .tabs::-webkit-scrollbar-thumb:hover {
            background: var(--accent-cyan);
        }

        .tab {
            padding: 0.6rem 1rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--accent-cyan);
        }

        .tab.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }

        .tab-content {
            display: none;
            animation-duration: 0.4s;
            animation-fill-mode: both;
        }

        .tab-content.active {
            display: block;
            animation-name: slideIn;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .panel-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--accent-cyan);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .control-group {
            margin-bottom: 1.2rem;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: default;
        }

        label[title] {
            cursor: help;
            border-bottom: 1px dotted var(--text-secondary);
            display: inline-block;
            width: 100%;
        }

        label[title]:hover {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }

        .value-display {
            color: var(--accent-yellow);
            float: right;
            font-weight: 500;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, var(--accent-cyan), var(--accent-magenta));
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
            -webkit-appearance: none;
        }

        input[type="range"]:hover {
            opacity: 1;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-cyan);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.6);
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.8);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-cyan);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.6);
        }

        button {
            width: 100%;
            padding: 0.9rem;
            border: 1px solid var(--accent-cyan);
            border-radius: 8px;
            background: rgba(0, 229, 255, 0.1);
            color: var(--accent-cyan);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(0, 229, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button:hover {
            background: rgba(0, 229, 255, 0.2);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        button span {
            position: relative;
            z-index: 1;
        }

        .compact-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.7rem;
            margin-top: 1rem;
        }

        .compact-buttons button {
            width: 100%;
            padding: 0.7rem;
            font-size: 0.75rem;
        }

        .phase-space-container {
            width: 100%;
            aspect-ratio: 1;
            border: 2px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            cursor: crosshair;
            background: var(--bg-primary);
            margin-bottom: 1rem;
            position: relative;
        }

        #phaseSpaceCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .map-info {
            padding: 0.8rem;
            background: rgba(0, 229, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .map-info p {
            margin: 0;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.7rem;
        }

        .preset-btn {
            padding: 0.7rem 0.5rem;
            font-size: 0.7rem;
            border-color: var(--border);
            background: rgba(0, 229, 255, 0.05);
        }

        .preset-btn:hover {
            border-color: var(--accent-magenta);
            background: rgba(255, 0, 110, 0.1);
        }

        .preset-btn.active {
            border-color: var(--accent-cyan);
            background: rgba(0, 229, 255, 0.15);
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.3);
        }

        .preset-btn.active span {
            color: var(--accent-cyan);
        }

        .color-select {
            width: 100%;
            padding: 0.7rem;
            background: rgba(0, 229, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-select:hover {
            border-color: var(--accent-cyan);
            background: rgba(0, 229, 255, 0.1);
        }

        .color-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
        }

        .color-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
        }

        #recordBtn.recording {
            border-color: var(--accent-magenta);
            background: rgba(255, 0, 110, 0.2);
            animation: recordPulse 1.5s ease-in-out infinite;
        }

        @keyframes recordPulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 0, 110, 0.3);
            }
            50% {
                box-shadow: 0 0 40px rgba(255, 0, 110, 0.6);
            }
        }

        .info {
            background: rgba(0, 229, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .info strong {
            color: var(--accent-cyan);
            display: block;
            margin-bottom: 0.3rem;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .canvas-container {
                max-height: 60vh;
            }

            .controls {
                animation: fadeIn 1s ease-out 0.2s both;
            }

            .tabs {
                overflow-x: auto;
                scrollbar-width: thin;
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.8rem;
            }

            .subtitle {
                font-size: 0.7rem;
            }

            .canvas-container {
                max-height: 50vh;
            }

            .control-panel {
                padding: 1rem;
            }

            .tab {
                font-size: 0.65rem;
                padding: 0.5rem 0.7rem;
            }

            .preset-grid {
                grid-template-columns: 1fr;
            }

            button {
                padding: 0.8rem;
                font-size: 0.75rem;
            }

            label {
                font-size: 0.7rem;
            }

            .info {
                font-size: 0.7rem;
            }

            .map-info {
                padding: 0.6rem;
            }

            .map-info p {
                font-size: 0.65rem;
            }

            .energy-display {
                font-size: 0.6rem;
                padding: 0.2rem 0.4rem;
            }
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-cyan);
            font-size: 1.2rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>–î–≤–æ–π–Ω–æ–π –ú–∞—è—Ç–Ω–∏–∫</h1>
            <p class="subtitle">–•–∞–æ—Ç–∏—á–µ—Å–∫–∞—è –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –°–∏—Å—Ç–µ–º–∞</p>
            <div id="recordingIndicator" style="display: none; margin-top: 1rem; color: var(--accent-magenta); font-family: 'Orbitron', sans-serif; font-size: 0.9rem; animation: recordPulse 1.5s ease-in-out infinite;">
                ‚è∫ –ò–¥—ë—Ç –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ
            </div>
        </header>

        <div class="main-content">
            <div class="canvas-container">
                <div class="loading">–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø...</div>
                <canvas id="canvas"></canvas>
                <div class="fps-counter" id="fpsCounter">-- FPS</div>
                <div class="energy-display" id="energyDisplay">E: --</div>
            </div>

            <div class="controls">
                <div class="control-panel">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab(event, 'presets')">–ü—Ä–µ—Å–µ—Ç—ã</button>
                        <button class="tab" onclick="switchTab(event, 'physics')">–§–∏–∑–∏–∫–∞</button>
                        <button class="tab" onclick="switchTab(event, 'visual')">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</button>
                        <button class="tab" onclick="switchTab(event, 'initial')">–ù–∞—á–∞–ª—å–Ω—ã–µ</button>
                        <button class="tab" onclick="switchTab(event, 'sound')">–ó–≤—É–∫</button>
                        <button class="tab" onclick="switchTab(event, 'phaseSpace')">–§–∞–∑–æ–≤–∞—è</button>
                        <button class="tab" onclick="switchTab(event, 'control')">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
                    </div>

                    <!-- –ü—Ä–µ—Å–µ—Ç—ã -->
                    <div id="presets" class="tab-content active">
                        <div class="preset-grid">
                            <button class="preset-btn active" data-preset="chaotic" onclick="loadPreset('chaotic')">
                                <span>–•–∞–æ—Å</span>
                            </button>
                            <button class="preset-btn" data-preset="periodic" onclick="loadPreset('periodic')">
                                <span>–ü–µ—Ä–∏–æ–¥–∏–∫–∞</span>
                            </button>
                            <button class="preset-btn" data-preset="asymmetric" onclick="loadPreset('asymmetric')">
                                <span>–ê—Å–∏–º–º–µ—Ç—Ä–∏—è</span>
                            </button>
                            <button class="preset-btn" data-preset="heavy" onclick="loadPreset('heavy')">
                                <span>–¢—è–∂—ë–ª—ã–π</span>
                            </button>
                            <button class="preset-btn" data-preset="light" onclick="loadPreset('light')">
                                <span>–õ—ë–≥–∫–∏–π</span>
                            </button>
                            <button class="preset-btn" data-preset="extreme" onclick="loadPreset('extreme')">
                                <span>–≠–∫—Å—Ç—Ä–∏–º</span>
                            </button>
                        </div>
                        <button onclick="resetPresetsTab()" style="margin-top: 1rem; width: 100%;">
                            <span>‚Ü∫ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                        </button>
                    </div>

                    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–∑–∏–∫–∏ -->
                    <div id="physics" class="tab-content">
                        <div class="control-group">
                            <label title="–î–ª–∏–Ω–∞ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–µ—Ä–∂–Ω—è">
                                –î–ª–∏–Ω–∞ L1
                                <span class="value-display" id="l1Value">150</span>
                            </label>
                            <input type="range" id="l1" min="50" max="250" step="5" value="150">
                        </div>

                        <div class="control-group">
                            <label title="–î–ª–∏–Ω–∞ –≤—Ç–æ—Ä–æ–≥–æ —Å—Ç–µ—Ä–∂–Ω—è">
                                –î–ª–∏–Ω–∞ L2
                                <span class="value-display" id="l2Value">150</span>
                            </label>
                            <input type="range" id="l2" min="50" max="250" step="5" value="150">
                        </div>

                        <div class="control-group">
                            <label title="–ú–∞—Å—Å–∞ –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞">
                                –ú–∞—Å—Å–∞ M1
                                <span class="value-display" id="m1Value">10</span>
                            </label>
                            <input type="range" id="m1" min="1" max="30" step="1" value="10">
                        </div>

                        <div class="control-group">
                            <label title="–ú–∞—Å—Å–∞ –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞">
                                –ú–∞—Å—Å–∞ M2
                                <span class="value-display" id="m2Value">10</span>
                            </label>
                            <input type="range" id="m2" min="1" max="30" step="1" value="10">
                        </div>

                        <div class="control-group">
                            <label title="–£—Å–∫–æ—Ä–µ–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –ø–∞–¥–µ–Ω–∏—è">
                                –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è (g)
                                <span class="value-display" id="gValue">9.8</span>
                            </label>
                            <input type="range" id="g" min="1" max="20" step="0.1" value="9.8">
                        </div>

                        <div class="control-group">
                            <label title="–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞—Ç—É—Ö–∞–Ω–∏—è (0 = –±–µ–∑ —Ç—Ä–µ–Ω–∏—è)">
                                –ó–∞—Ç—É—Ö–∞–Ω–∏–µ
                                <span class="value-display" id="dampingValue">0.000</span>
                            </label>
                            <input type="range" id="damping" min="0" max="0.5" step="0.01" value="0">
                        </div>

                        <button onclick="resetPhysicsTab()" style="margin-top: 1rem; width: 100%;">
                            <span>‚Ü∫ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                        </button>
                    </div>

                    <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è -->
                    <div id="visual" class="tab-content">
                        <div class="control-group">
                            <label>–†–µ–∂–∏–º –æ—Ç—Ä–∏—Å–æ–≤–∫–∏</label>
                            <select id="drawMode" class="color-select">
                                <option value="trail">–õ–∏–Ω–∏—è (–Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è)</option>
                                <option value="fade">–ó–∞—Ç—É—Ö–∞—é—â–∏–π —Ñ–æ–Ω</option>
                                <option value="dots">–¢–æ—á–∫–∏ (–¥–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ)</option>
                                <option value="minimal">–¢–æ–ª—å–∫–æ –º–∞—è—Ç–Ω–∏–∫</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label>–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞</label>
                            <select id="colorScheme" class="color-select">
                                <option value="velocity">–ü–æ —Å–∫–æ—Ä–æ—Å—Ç–∏</option>
                                <option value="energy">–ü–æ —ç–Ω–µ—Ä–≥–∏–∏</option>
                                <option value="cyan">Cyan</option>
                                <option value="magenta">Magenta</option>
                                <option value="rainbow">–†–∞–¥—É–≥–∞</option>
                                <option value="fire">–û–≥–æ–Ω—å</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label>–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–ª–µ–¥</label>
                            <select id="trailTarget" class="color-select">
                                <option value="second">–¢–æ–ª—å–∫–æ 2-–π –º–∞—è—Ç–Ω–∏–∫</option>
                                <option value="first">–¢–æ–ª—å–∫–æ 1-–π –º–∞—è—Ç–Ω–∏–∫</option>
                                <option value="both">–û–±–∞ –º–∞—è—Ç–Ω–∏–∫–∞</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label>
                                –î–ª–∏–Ω–∞ —Å–ª–µ–¥–∞
                                <span class="value-display" id="trailLengthValue">500</span>
                            </label>
                            <input type="range" id="trailLength" min="50" max="2000" step="50" value="500">
                        </div>

                        <div class="control-group">
                            <label title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—è—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º">
                                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—è—Ç–Ω–∏–∫–æ–≤
                                <span class="value-display" id="numPendulumsValue">1</span>
                            </label>
                            <input type="range" id="numPendulums" min="1" max="5" step="1" value="1">
                        </div>

                        <div class="control-group">
                            <label title="–í–∞—Ä–∏–∞—Ü–∏—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö —É–≥–ª–æ–≤ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö (–¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–∞—è—Ç–Ω–∏–∫–æ–≤)">
                                –í–∞—Ä–∏–∞—Ü–∏—è —É–≥–ª–æ–≤
                                <span class="value-display" id="angleVariationValue">0.1¬∞</span>
                            </label>
                            <input type="range" id="angleVariation" min="0.01" max="5" step="0.01" value="0.1">
                        </div>

                        <div class="control-group">
                            <label>
                                –°–∫–æ—Ä–æ—Å—Ç—å —Å–∏–º—É–ª—è—Ü–∏–∏
                                <span class="value-display" id="speedValue">1.0x</span>
                            </label>
                            <input type="range" id="speed" min="0.1" max="3" step="0.1" value="1.0">
                        </div>

                        <button onclick="resetVisualTab()" style="margin-top: 1rem; width: 100%;">
                            <span>‚Ü∫ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                        </button>
                    </div>

                    <!-- –ù–∞—á–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è -->
                    <div id="initial" class="tab-content">
                        <div class="control-group">
                            <label title="–ù–∞—á–∞–ª—å–Ω—ã–π —É–≥–æ–ª –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö">
                                –£–≥–æ–ª Œ∏1
                                <span class="value-display" id="theta1Value">90¬∞</span>
                            </label>
                            <input type="range" id="theta1" min="-180" max="180" step="1" value="90">
                        </div>

                        <div class="control-group">
                            <label title="–ù–∞—á–∞–ª—å–Ω—ã–π —É–≥–æ–ª –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö">
                                –£–≥–æ–ª Œ∏2
                                <span class="value-display" id="theta2Value">90¬∞</span>
                            </label>
                            <input type="range" id="theta2" min="-180" max="180" step="1" value="90">
                        </div>

                        <div class="control-group">
                            <label title="–ù–∞—á–∞–ª—å–Ω–∞—è —É–≥–ª–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞">
                                –°–∫–æ—Ä–æ—Å—Ç—å œâ1
                                <span class="value-display" id="omega1Value">0.0</span>
                            </label>
                            <input type="range" id="omega1" min="-5" max="5" step="0.1" value="0">
                        </div>

                        <div class="control-group">
                            <label title="–ù–∞—á–∞–ª—å–Ω–∞—è —É–≥–ª–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞">
                                –°–∫–æ—Ä–æ—Å—Ç—å œâ2
                                <span class="value-display" id="omega2Value">0.0</span>
                            </label>
                            <input type="range" id="omega2" min="-5" max="5" step="0.1" value="0">
                        </div>

                        <div class="compact-buttons">
                            <button onclick="applyInitialConditions()">
                                <span>‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å</span>
                            </button>
                            <button onclick="resetInitialTab()">
                                <span>‚Ü∫ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                            </button>
                        </div>
                    </div>

                    <!-- –ó–≤—É–∫ -->
                    <div id="sound" class="tab-content">
                        <div class="control-group">
                            <label>–ó–≤—É–∫ –≤–∫–ª—é—á—ë–Ω</label>
                            <select id="soundEnabled" class="color-select">
                                <option value="false">–í—ã–∫–ª—é—á–µ–Ω</option>
                                <option value="true">–í–∫–ª—é—á—ë–Ω</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label>–ü–æ–¥—Ö–æ–¥ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è</label>
                            <select id="soundMapping" class="color-select">
                                <option value="combined">–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π</option>
                                <option value="positional">–ü–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–π</option>
                                <option value="energetic">–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π</option>
                                <option value="musical">–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π</option>
                                <option value="chaotic">–•–∞–æ—Ç–∏—á–µ—Å–∫–∏–π</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label>–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</label>
                            <select id="soundMode" class="color-select">
                                <option value="continuous">–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π</option>
                                <option value="harmonic">–ì–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫–∏–π</option>
                                <option value="event">–°–æ–±—ã—Ç–∏–π–Ω—ã–π</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label>
                                –û–±—â–∞—è –≥—Ä–æ–º–∫–æ—Å—Ç—å
                                <span class="value-display" id="masterVolumeValue">50%</span>
                            </label>
                            <input type="range" id="masterVolume" min="0" max="100" step="1" value="50">
                        </div>

                        <div class="control-group">
                            <label>
                                –†–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏—è
                                <span class="value-display" id="reverbValue">30%</span>
                            </label>
                            <input type="range" id="reverb" min="0" max="100" step="1" value="30">
                        </div>

                        <div class="control-group">
                            <label>–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è —à–∫–∞–ª–∞</label>
                            <select id="musicalScale" class="color-select">
                                <option value="pentatonic">–ü–µ–Ω—Ç–∞—Ç–æ–Ω–∏–∫–∞</option>
                                <option value="major">–ú–∞–∂–æ—Ä</option>
                                <option value="minor">–ú–∏–Ω–æ—Ä</option>
                                <option value="chromatic">–•—Ä–æ–º–∞—Ç–∏–∫–∞</option>
                                <option value="wholetone">–¶–µ–ª–æ—Ç–æ–Ω–æ–≤–∞—è</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label>–§–æ—Ä–º–∞ –≤–æ–ª–Ω—ã</label>
                            <select id="waveform" class="color-select">
                                <option value="sine">–°–∏–Ω—É—Å</option>
                                <option value="triangle">–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫</option>
                                <option value="square">–ö–≤–∞–¥—Ä–∞—Ç</option>
                                <option value="sawtooth">–ü–∏–ª–∞</option>
                            </select>
                        </div>

                        <button onclick="resetSoundTab()" style="margin-top: 1rem; width: 100%;">
                            <span>‚Ü∫ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                        </button>

                        <div class="info" style="margin-top: 1rem;">
                            <strong style="font-size: 0.65rem;">üí° –ü–æ–¥—Ö–æ–¥—ã:</strong>
                            <p style="font-size: 0.6rem; margin: 0.3rem 0; line-height: 1.4;">
                                <strong>–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π:</strong> –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è - X‚Üí—á–∞—Å—Ç–æ—Ç–∞, Y‚Üí—Ñ–∏–ª—å—Ç—Ä, —Å–∫–æ—Ä–æ—Å—Ç—å‚Üí–≥—Ä–æ–º–∫–æ—Å—Ç—å, –ø–∞–Ω–æ—Ä–∞–º–∞<br>
                                <strong>–ü–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–π:</strong> –ø—Ä—è–º–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç<br>
                                <strong>–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π:</strong> —ç–Ω–µ—Ä–≥–∏—è‚Üí–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–≤—É–∫–∞<br>
                                <strong>–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π:</strong> —É–≥–ª—ã‚Üí–Ω–æ—Ç—ã, —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è‚Üí–∞—Ä–ø–µ–¥–∂–∏–æ<br>
                                <strong>–•–∞–æ—Ç–∏—á–µ—Å–∫–∏–π:</strong> —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è‚Üí–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã, –±–∏–µ–Ω–∏—è
                            </p>
                        </div>
                    </div>

                    <!-- –§–∞–∑–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ -->
                    <div id="phaseSpace" class="tab-content">
                        <div class="phase-space-container">
                            <canvas id="phaseSpaceCanvas" width="280" height="280"></canvas>
                        </div>
                        <div class="map-info">
                            <p style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                <strong style="color: var(--accent-cyan);">–î–∏–∞–≥—Ä–∞–º–º–∞ –ü—É–∞–Ω–∫–∞—Ä–µ</strong><br>
                                –ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞—á–∞–ª—å–Ω—ã—Ö —É–≥–ª–æ–≤ Œ∏1 –∏ Œ∏2. –¢–æ—á–∫–∏ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è, –ø–æ–∫–∞–∑—ã–≤–∞—è —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏. –ö–ª–∏–∫ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –æ—á–∏—â–∞–µ—Ç –∫–∞—Ä—Ç—É.
                            </p>
                            <p style="font-size: 0.65rem; color: var(--text-secondary); line-height: 1.4;">
                                –°–ª–æ–∂–Ω—ã–µ —É–∑–æ—Ä—ã –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—Ç —Ö–∞–æ—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–∏—Ä–æ–¥—É —Å–∏—Å—Ç–µ–º—ã ‚Äî –º–∞–ª—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–≤–æ–¥—è—Ç –∫ —Ä–∞–¥–∏–∫–∞–ª—å–Ω–æ —Ä–∞–∑–Ω—ã–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è–º.
                            </p>
                        </div>
                    </div>

                    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
                    <div id="control" class="tab-content">
                        <div class="action-buttons">
                            <button onclick="toggleSimulation()">
                                <span id="playPauseBtn">‚è∏ –ü–∞—É–∑–∞</span>
                            </button>
                            <button onclick="toggleRecording()" id="recordBtn">
                                <span id="recordBtnText">‚è∫ –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ</span>
                            </button>
                            <button onclick="resetSimulation()">
                                <span>üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫</span>
                            </button>
                            <button onclick="clearTrail()">
                                <span>üßπ –û—á–∏—Å—Ç–∏—Ç—å —Å–ª–µ–¥</span>
                            </button>
                            <button onclick="randomInitial()">
                                <span>üé≤ –°–ª—É—á–∞–π–Ω—ã–µ —É–≥–ª—ã</span>
                            </button>
                            <button onclick="exportImage()">
                                <span>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å PNG</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="info">
                    <strong>üéØ –û —Å–∏–º—É–ª—è—Ü–∏–∏:</strong>
                    –î–≤–æ–π–Ω–æ–π –º–∞—è—Ç–Ω–∏–∫ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö–∞–æ—Å–∞. –ú–∞–ª–µ–π—à–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –ø—Ä–∏–≤–æ–¥—è—Ç –∫ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ —Ä–∞–∑–Ω—ã–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è–º.<br><br>
                    <strong>üî¢ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–∞—è—Ç–Ω–∏–∫–∏:</strong> –í–æ –≤–∫–ª–∞–¥–∫–µ "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è" –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–æ 5 –º–∞—è—Ç–Ω–∏–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏ —É–≥–ª–æ–≤, —á—Ç–æ–±—ã –Ω–∞–≥–ª—è–¥–Ω–æ —É–≤–∏–¥–µ—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º.<br><br>
                    <strong>üîä –ó–≤—É–∫–æ–≤–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ:</strong> –í–æ –≤–∫–ª–∞–¥–∫–µ "–ó–≤—É–∫" –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–∏–≤–Ω—É—é –º—É–∑—ã–∫—É, –æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é –Ω–∞ –¥–≤–∏–∂–µ–Ω–∏–∏ –º–∞—è—Ç–Ω–∏–∫–æ–≤. 5 –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—é √ó 3 —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã = 15 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–≤—É–∫–æ–≤—ã—Ö –ø–µ–π–∑–∞–∂–µ–π!<br><br>
                    <strong>‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong> –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ "–ü—Ä–µ—Å–µ—Ç—ã", "–§–∏–∑–∏–∫–∞", "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è" –∏ "–ó–≤—É–∫" –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ. –í–∫–ª–∞–¥–∫–∞ "–ù–∞—á–∞–ª—å–Ω—ã–µ" —Ç—Ä–µ–±—É–µ—Ç –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å".<br><br>
                    <strong>üìä –§–∞–∑–æ–≤–∞—è:</strong> –î–∏–∞–≥—Ä–∞–º–º–∞ –ü—É–∞–Ω–∫–∞—Ä–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç —Ç–æ—á–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π. –ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —É–≥–ª–æ–≤. –ö–ª–∏–∫ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –æ—á–∏—â–∞–µ—Ç –∫–∞—Ä—Ç—É.<br><br>
                    <strong>‚å®Ô∏è –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:</strong> –ü—Ä–æ–±–µ–ª ‚Äî –ø–∞—É–∑–∞/–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, R ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫, C ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å —Å–ª–µ–¥, V ‚Äî –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ.
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ canvas
        canvas.width = 800;
        canvas.height = 800;
        
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2 - 100;

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–∑–∏–∫–∏
        let l1 = 150; // –¥–ª–∏–Ω–∞ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–µ—Ä–∂–Ω—è
        let l2 = 150; // –¥–ª–∏–Ω–∞ –≤—Ç–æ—Ä–æ–≥–æ —Å—Ç–µ—Ä–∂–Ω—è
        let m1 = 10;  // –º–∞—Å—Å–∞ –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
        let m2 = 10;  // –º–∞—Å—Å–∞ –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
        let g = 9.8;  // –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
        let damping = 0.0; // –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞—Ç—É—Ö–∞–Ω–∏—è

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
        let theta1 = Math.PI / 2; // —É–≥–æ–ª –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
        let theta2 = Math.PI / 2; // —É–≥–æ–ª –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
        let omega1 = 0; // —É–≥–ª–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
        let omega2 = 0; // —É–≥–ª–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        let drawMode = 'trail';
        let colorScheme = 'velocity';
        let trailLength = 500;
        let trailTarget = 'second'; // 'first', 'second', 'both'
        let speed = 1.0;
        let numPendulums = 1;
        let angleVariation = 0.1; // –≤ –≥—Ä–∞–¥—É—Å–∞—Ö

        // –ú–∞—Å—Å–∏–≤ –º–∞—è—Ç–Ω–∏–∫–æ–≤ (–∫–∞–∂–¥—ã–π –º–∞—è—Ç–Ω–∏–∫ - –æ—Ç–¥–µ–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è)
        let pendulums = [];
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–º—É–ª—è—Ü–∏–∏
        let running = true;
        let currentPreset = 'chaotic';

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        
        // –ù–∞—á–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
        let initialEnergy = 0;

        // –§–∞–∑–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
        const phaseSpaceCanvas = document.getElementById('phaseSpaceCanvas');
        const phaseSpaceCtx = phaseSpaceCanvas.getContext('2d');
        let phaseSpaceData = [];
        
        // –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–∞—è—Ç–Ω–∏–∫–æ–≤
        const pendulumColors = [
            { primary: '#00e5ff', secondary: '#ff006e' },
            { primary: '#ffbe0b', secondary: '#fb5607' },
            { primary: '#06ffa5', secondary: '#7209b7' },
            { primary: '#ff006e', secondary: '#00e5ff' },
            { primary: '#fb5607', secondary: '#06ffa5' }
        ];

        // ========================================
        // –ó–í–£–ö–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê
        // ========================================
        
        let audioContext = null;
        let soundEnabled = false;
        let soundMapping = 'combined'; // combined, positional, energetic, musical, chaotic
        let soundMode = 'continuous'; // continuous, harmonic, event
        let masterVolume = 0.5;
        let reverbAmount = 0.3;
        let waveformType = 'sine';
        let musicalScale = 'pentatonic';
        
        // –£–∑–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
        let pendulumAudioNodes = [];
        
        // –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ —à–∫–∞–ª—ã (—á–∞—Å—Ç–æ—Ç—ã –≤ Hz –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ C4 = 261.63 Hz)
        const musicalScales = {
            pentatonic: [0, 2, 4, 7, 9], // –î–æ, –†–µ, –ú–∏, –°–æ–ª—å, –õ—è
            major: [0, 2, 4, 5, 7, 9, 11], // –ú–∞–∂–æ—Ä–Ω–∞—è –≥–∞–º–º–∞
            minor: [0, 2, 3, 5, 7, 8, 10], // –ú–∏–Ω–æ—Ä–Ω–∞—è –≥–∞–º–º–∞
            chromatic: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11], // –í—Å–µ –ø–æ–ª—É—Ç–æ–Ω–∞
            wholetone: [0, 2, 4, 6, 8, 10] // –¶–µ–ª–æ—Ç–æ–Ω–æ–≤–∞—è
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                createReverbNode();
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ç–æ—Ä–∞
        let reverbNode = null;
        let reverbGain = null;
        
        function createReverbNode() {
            if (!audioContext) return;
            
            // Convolver –¥–ª—è —Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏–∏
            reverbNode = audioContext.createConvolver();
            reverbGain = audioContext.createGain();
            reverbGain.gain.value = reverbAmount;
            
            // –°–æ–∑–¥–∞—ë–º –∏–º–ø—É–ª—å—Å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ –¥–ª—è —Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏–∏
            const sampleRate = audioContext.sampleRate;
            const length = sampleRate * 2; // 2 —Å–µ–∫—É–Ω–¥—ã —Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏–∏
            const impulse = audioContext.createBuffer(2, length, sampleRate);
            
            for (let channel = 0; channel < 2; channel++) {
                const channelData = impulse.getChannelData(channel);
                for (let i = 0; i < length; i++) {
                    channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
                }
            }
            
            reverbNode.buffer = impulse;
            reverbNode.connect(reverbGain);
            reverbGain.connect(audioContext.destination);
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –∞—É–¥–∏–æ —É–∑–ª–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
        function createPendulumAudioNode(index) {
            if (!audioContext) return null;
            
            const oscillator1 = audioContext.createOscillator(); // –ü–µ—Ä–≤—ã–π –º–∞—è—Ç–Ω–∏–∫
            const oscillator2 = audioContext.createOscillator(); // –í—Ç–æ—Ä–æ–π –º–∞—è—Ç–Ω–∏–∫
            
            oscillator1.type = waveformType;
            oscillator2.type = waveformType;
            
            const gain1 = audioContext.createGain();
            const gain2 = audioContext.createGain();
            gain1.gain.value = 0;
            gain2.gain.value = 0;
            
            const filter1 = audioContext.createBiquadFilter();
            const filter2 = audioContext.createBiquadFilter();
            filter1.type = 'lowpass';
            filter2.type = 'lowpass';
            filter1.frequency.value = 2000;
            filter2.frequency.value = 2000;
            
            const panner1 = audioContext.createStereoPanner();
            const panner2 = audioContext.createStereoPanner();
            
            const masterGain = audioContext.createGain();
            masterGain.gain.value = masterVolume / Math.max(1, numPendulums);
            
            // –¶–µ–ø–æ—á–∫–∞ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
            oscillator1.connect(gain1);
            gain1.connect(filter1);
            filter1.connect(panner1);
            panner1.connect(masterGain);
            
            // –¶–µ–ø–æ—á–∫–∞ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
            oscillator2.connect(gain2);
            gain2.connect(filter2);
            filter2.connect(panner2);
            panner2.connect(masterGain);
            
            // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤—ã—Ö–æ–¥—É –∏ —Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ç–æ—Ä—É
            masterGain.connect(audioContext.destination);
            if (reverbNode) {
                masterGain.connect(reverbNode);
            }
            
            oscillator1.start();
            oscillator2.start();
            
            return {
                oscillator1, oscillator2,
                gain1, gain2,
                filter1, filter2,
                panner1, panner2,
                masterGain,
                lastEventTime: 0,
                lastAngle1: 0,
                lastAngle2: 0
            };
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—É–∫–∞ –¥–ª—è –≤—Å–µ—Ö –º–∞—è—Ç–Ω–∏–∫–æ–≤
        function initPendulumsAudio() {
            if (!soundEnabled || !audioContext) return;
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ —É–∑–ª—ã
            pendulumAudioNodes.forEach(node => {
                if (node) {
                    try {
                        node.oscillator1.stop();
                        node.oscillator2.stop();
                    } catch (e) {}
                }
            });
            
            pendulumAudioNodes = [];
            
            // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
            for (let i = 0; i < numPendulums; i++) {
                pendulumAudioNodes.push(createPendulumAudioNode(i));
            }
        }
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –≤ –±–ª–∏–∂–∞–π—à—É—é –Ω–æ—Ç—É –∏–∑ —à–∫–∞–ª—ã
        function quantizeToScale(frequency, scale) {
            const baseFreq = 261.63; // C4
            const semitones = 12 * Math.log2(frequency / baseFreq);
            const octave = Math.floor(semitones / 12);
            const noteInOctave = Math.round(semitones % 12);
            
            const scaleNotes = musicalScales[scale];
            let closestNote = scaleNotes[0];
            let minDist = Math.abs(noteInOctave - closestNote);
            
            for (let note of scaleNotes) {
                const dist = Math.abs(noteInOctave - note);
                if (dist < minDist) {
                    minDist = dist;
                    closestNote = note;
                }
            }
            
            return baseFreq * Math.pow(2, (octave * 12 + closestNote) / 12);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–≤—É–∫–∞
        function updateSound() {
            if (!soundEnabled || !audioContext || pendulumAudioNodes.length === 0) return;
            
            const currentTime = audioContext.currentTime;
            
            pendulums.forEach((pendulum, index) => {
                const node = pendulumAudioNodes[index];
                if (!node) return;
                
                // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏
                const x1 = centerX + l1 * Math.sin(pendulum.theta1);
                const y1 = centerY + l1 * Math.cos(pendulum.theta1);
                const x2 = x1 + l2 * Math.sin(pendulum.theta2);
                const y2 = y1 + l2 * Math.cos(pendulum.theta2);
                
                // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (-1 –¥–æ 1)
                const normX1 = (x1 - centerX) / (canvas.width / 2);
                const normY1 = (y1 - centerY) / (canvas.height / 2);
                const normX2 = (x2 - centerX) / (canvas.width / 2);
                const normY2 = (y2 - centerY) / (canvas.height / 2);
                
                const velocity1 = Math.abs(pendulum.omega1);
                const velocity2 = Math.abs(pendulum.omega2);
                const totalVelocity = Math.sqrt(pendulum.omega1 ** 2 + pendulum.omega2 ** 2);
                
                let freq1, freq2, volume1, volume2, pan1, pan2, filter1Freq, filter2Freq;
                
                // ========================================
                // –ü–û–î–•–û–î–´ –ö –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–Æ
                // ========================================
                
                if (soundMapping === 'combined') {
                    // –ö–û–ú–ë–ò–ù–ò–†–û–í–ê–ù–ù–´–ô: –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–¥—Ö–æ–¥–æ–≤
                    // X-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ ‚Üí –ß–∞—Å—Ç–æ—Ç–∞ (–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ)
                    freq1 = 200 + (normX1 + 1) * 300; // 200-800 Hz (–Ω–∏–∑–∫–∏–π —Ä–µ–≥–∏—Å—Ç—Ä)
                    freq2 = 400 + (normX2 + 1) * 600; // 400-1600 Hz (–æ–∫—Ç–∞–≤–æ–π –≤—ã—à–µ)
                    
                    // –£–≥–ª–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å ‚Üí –ì—Ä–æ–º–∫–æ—Å—Ç—å (–¥–∏–Ω–∞–º–∏–∫–∞)
                    volume1 = Math.min(1, velocity1 * 0.3 + 0.05) * masterVolume;
                    volume2 = Math.min(1, velocity2 * 0.3 + 0.05) * masterVolume;
                    
                    // X-–ø–æ–∑–∏—Ü–∏—è ‚Üí –°—Ç–µ—Ä–µ–æ –ø–∞–Ω–æ—Ä–∞–º–∞ (–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å)
                    pan1 = Math.max(-1, Math.min(1, normX1 * 0.8));
                    pan2 = Math.max(-1, Math.min(1, normX2 * 0.8));
                    
                    // Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ ‚Üí –§–∏–ª—å—Ç—Ä (—Ç–µ–º–±—Ä, "—è—Ä–∫–æ—Å—Ç—å" –∑–≤—É–∫–∞)
                    // –í—ã—à–µ = —è—Ä—á–µ (–≤—ã—à–µ —á–∞—Å—Ç–æ—Ç–∞ —Å—Ä–µ–∑–∞)
                    filter1Freq = 800 + (1 - (normY1 + 1) / 2) * 2200; // 800-3000 Hz
                    filter2Freq = 800 + (1 - (normY2 + 1) / 2) * 2200;
                    
                    // –ù–µ–±–æ–ª—å—à–æ–π –¥–µ—Ç—é–Ω–∏–Ω–≥ –¥–ª—è –±–æ–≥–∞—Ç—Å—Ç–≤–∞ –∑–≤—É–∫–∞ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–∞—è—Ç–Ω–∏–∫–∞—Ö
                    if (numPendulums > 1) {
                        const detune = Math.sin(index * 1.5) * 5;
                        freq1 += detune;
                        freq2 += detune;
                    }
                    
                } else if (soundMapping === 'positional') {
                    // –ü–û–ó–ò–¶–ò–û–ù–ù–´–ô: X‚Üí—á–∞—Å—Ç–æ—Ç–∞, Y‚Üí—Ñ–∏–ª—å—Ç—Ä, —Å–∫–æ—Ä–æ—Å—Ç—å‚Üí–≥—Ä–æ–º–∫–æ—Å—Ç—å
                    freq1 = 200 + (normX1 + 1) * 300; // 200-800 Hz
                    freq2 = 400 + (normX2 + 1) * 600; // 400-1600 Hz
                    
                    volume1 = Math.min(1, velocity1 * 0.3) * masterVolume;
                    volume2 = Math.min(1, velocity2 * 0.3) * masterVolume;
                    
                    pan1 = Math.max(-1, Math.min(1, normX1));
                    pan2 = Math.max(-1, Math.min(1, normX2));
                    
                    filter1Freq = 500 + (1 - normY1) * 1500; // 500-2000 Hz
                    filter2Freq = 500 + (1 - normY2) * 1500;
                    
                } else if (soundMapping === 'energetic') {
                    // –≠–ù–ï–†–ì–ï–¢–ò–ß–ï–°–ö–ò–ô: —ç–Ω–µ—Ä–≥–∏—è‚Üí–ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                    const energy = calculateEnergy(pendulum);
                    const ke1 = 0.5 * m1 * l1 * l1 * pendulum.omega1 * pendulum.omega1;
                    const ke2 = 0.5 * m2 * l2 * l2 * pendulum.omega2 * pendulum.omega2;
                    const pe1 = m1 * g * (centerY + y1);
                    const pe2 = m2 * g * (centerY + y2);
                    
                    // –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è ‚Üí –≤—ã—Å–æ—Ç–∞ —Ç–æ–Ω–∞
                    freq1 = 200 + (pe1 / (m1 * g * l1)) * 600;
                    freq2 = 400 + (pe2 / (m2 * g * l2)) * 800;
                    
                    // –ö–∏–Ω–µ—Ç–∏—á–µ—Å–∫–∞—è —ç–Ω–µ—Ä–≥–∏—è ‚Üí –≥—Ä–æ–º–∫–æ—Å—Ç—å
                    volume1 = Math.min(1, ke1 / 1000) * masterVolume;
                    volume2 = Math.min(1, ke2 / 1000) * masterVolume;
                    
                    pan1 = 0;
                    pan2 = 0;
                    
                    // –ü–æ–ª–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è ‚Üí —Ñ–∏–ª—å—Ç—Ä
                    filter1Freq = 500 + (energy / 200) * 1500;
                    filter2Freq = 500 + (energy / 200) * 1500;
                    
                } else if (soundMapping === 'musical') {
                    // –ú–£–ó–´–ö–ê–õ–¨–ù–´–ô: —É–≥–ª—ã‚Üí–Ω–æ—Ç—ã
                    const baseFreq1 = 261.63; // C4
                    const baseFreq2 = 523.25; // C5
                    
                    // –£–≥–æ–ª –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–æ—Ç—É (–Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ—Ç -œÄ –¥–æ œÄ –≤ 0-1)
                    const angle1Norm = (pendulum.theta1 + Math.PI) / (2 * Math.PI);
                    const angle2Norm = (pendulum.theta2 + Math.PI) / (2 * Math.PI);
                    
                    const scaleNotes = musicalScales[musicalScale];
                    const octaveRange = 2; // –î–≤–µ –æ–∫—Ç–∞–≤—ã
                    
                    const note1Index = Math.floor(angle1Norm * scaleNotes.length * octaveRange);
                    const note2Index = Math.floor(angle2Norm * scaleNotes.length * octaveRange);
                    
                    const octave1 = Math.floor(note1Index / scaleNotes.length);
                    const octave2 = Math.floor(note2Index / scaleNotes.length);
                    
                    const note1 = scaleNotes[note1Index % scaleNotes.length];
                    const note2 = scaleNotes[note2Index % scaleNotes.length];
                    
                    freq1 = baseFreq1 * Math.pow(2, (octave1 * 12 + note1) / 12);
                    freq2 = baseFreq2 * Math.pow(2, (octave2 * 12 + note2) / 12);
                    
                    // –°–∫–æ—Ä–æ—Å—Ç—å ‚Üí –≥—Ä–æ–º–∫–æ—Å—Ç—å
                    volume1 = Math.min(1, velocity1 * 0.4) * masterVolume;
                    volume2 = Math.min(1, velocity2 * 0.4) * masterVolume;
                    
                    // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ ‚Üí –ø–∞–Ω–æ—Ä–∞–º–∞
                    const dist1 = Math.sqrt(normX1 * normX1 + normY1 * normY1);
                    const dist2 = Math.sqrt(normX2 * normX2 + normY2 * normY2);
                    pan1 = Math.max(-1, Math.min(1, normX1 * dist1));
                    pan2 = Math.max(-1, Math.min(1, normX2 * dist2));
                    
                    filter1Freq = 1000 + dist1 * 1000;
                    filter2Freq = 1000 + dist2 * 1000;
                    
                } else if (soundMapping === 'chaotic') {
                    // –•–ê–û–¢–ò–ß–ï–°–ö–ò–ô: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è‚Üí–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
                    const dx = x2 - x1;
                    const dy = y2 - y1;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const normalizedDist = distance / (l1 + l2);
                    
                    // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –º–∞—è—Ç–Ω–∏–∫–∞–º–∏ ‚Üí –≥–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
                    const baseFreq = 300 + totalVelocity * 50;
                    const ratio = 1 + normalizedDist; // 1:1 –¥–æ 2:1
                    
                    freq1 = baseFreq;
                    freq2 = baseFreq * ratio;
                    
                    // –î–µ—Ç—é–Ω–∏–Ω–≥ –¥–ª—è –±–∏–µ–Ω–∏–π
                    const detune = Math.sin(currentTime * 0.5 + index) * 10;
                    freq1 += detune;
                    freq2 -= detune;
                    
                    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ ‚Üí –≥—Ä–æ–º–∫–æ—Å—Ç—å
                    const energyChange = Math.abs(calculateEnergy(pendulum) - initialEnergy);
                    volume1 = Math.min(1, (0.1 + energyChange / 1000)) * masterVolume;
                    volume2 = Math.min(1, (0.1 + energyChange / 1000)) * masterVolume;
                    
                    // –§–∞–∑–æ–≤–æ–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ ‚Üí –ø–∞–Ω–æ—Ä–∞–º–∞
                    const phaseDiff = pendulum.theta2 - pendulum.theta1;
                    pan1 = Math.sin(phaseDiff) * 0.8;
                    pan2 = -Math.sin(phaseDiff) * 0.8;
                    
                    filter1Freq = 800 + Math.abs(Math.sin(pendulum.theta1)) * 1200;
                    filter2Freq = 800 + Math.abs(Math.sin(pendulum.theta2)) * 1200;
                }
                
                // ========================================
                // –†–ï–ñ–ò–ú–´ –†–ê–ë–û–¢–´
                // ========================================
                
                if (soundMode === 'continuous') {
                    // –ù–ï–ü–†–ï–†–´–í–ù–´–ô: –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
                    node.oscillator1.frequency.setTargetAtTime(freq1, currentTime, 0.01);
                    node.oscillator2.frequency.setTargetAtTime(freq2, currentTime, 0.01);
                    
                    node.gain1.gain.setTargetAtTime(volume1 / Math.max(1, numPendulums), currentTime, 0.05);
                    node.gain2.gain.setTargetAtTime(volume2 / Math.max(1, numPendulums), currentTime, 0.05);
                    
                } else if (soundMode === 'harmonic') {
                    // –ì–ê–†–ú–û–ù–ò–ß–ï–°–ö–ò–ô: –∫–≤–∞–Ω—Ç–∏–∑–∞—Ü–∏—è –Ω–∞ –Ω–æ—Ç—ã
                    const quantizedFreq1 = quantizeToScale(freq1, musicalScale);
                    const quantizedFreq2 = quantizeToScale(freq2, musicalScale);
                    
                    node.oscillator1.frequency.setTargetAtTime(quantizedFreq1, currentTime, 0.01);
                    node.oscillator2.frequency.setTargetAtTime(quantizedFreq2, currentTime, 0.01);
                    
                    node.gain1.gain.setTargetAtTime(volume1 / Math.max(1, numPendulums), currentTime, 0.05);
                    node.gain2.gain.setTargetAtTime(volume2 / Math.max(1, numPendulums), currentTime, 0.05);
                    
                } else if (soundMode === 'event') {
                    // –°–û–ë–´–¢–ò–ô–ù–´–ô: –∑–≤—É–∫ –ø—Ä–∏ —ç–∫—Å—Ç—Ä–µ–º—É–º–∞—Ö
                    const angleDiff1 = Math.abs(pendulum.theta1 - node.lastAngle1);
                    const angleDiff2 = Math.abs(pendulum.theta2 - node.lastAngle2);
                    
                    // –¢—Ä–∏–≥–≥–µ—Ä –ø—Ä–∏ —Å–º–µ–Ω–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—ç–∫—Å—Ç—Ä–µ–º—É–º–µ)
                    const threshold = 0.1;
                    
                    if (angleDiff1 > threshold && velocity1 < 0.5) {
                        // –ö–æ—Ä–æ—Ç–∫–∏–π –∑–≤—É–∫
                        node.oscillator1.frequency.setValueAtTime(freq1, currentTime);
                        node.gain1.gain.cancelScheduledValues(currentTime);
                        node.gain1.gain.setValueAtTime(volume1 / Math.max(1, numPendulums), currentTime);
                        node.gain1.gain.exponentialRampToValueAtTime(0.001, currentTime + 0.3);
                        node.lastEventTime = currentTime;
                    } else if (currentTime - node.lastEventTime > 0.3) {
                        node.gain1.gain.setTargetAtTime(0.001, currentTime, 0.1);
                    }
                    
                    if (angleDiff2 > threshold && velocity2 < 0.5) {
                        node.oscillator2.frequency.setValueAtTime(freq2, currentTime);
                        node.gain2.gain.cancelScheduledValues(currentTime);
                        node.gain2.gain.setValueAtTime(volume2 / Math.max(1, numPendulums), currentTime);
                        node.gain2.gain.exponentialRampToValueAtTime(0.001, currentTime + 0.3);
                    } else if (currentTime - node.lastEventTime > 0.3) {
                        node.gain2.gain.setTargetAtTime(0.001, currentTime, 0.1);
                    }
                    
                    node.lastAngle1 = pendulum.theta1;
                    node.lastAngle2 = pendulum.theta2;
                }
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏ –ø–∞–Ω–æ—Ä–∞–º—É
                node.filter1.frequency.setTargetAtTime(Math.max(100, Math.min(5000, filter1Freq)), currentTime, 0.05);
                node.filter2.frequency.setTargetAtTime(Math.max(100, Math.min(5000, filter2Freq)), currentTime, 0.05);
                
                node.panner1.pan.setTargetAtTime(pan1, currentTime, 0.05);
                node.panner2.pan.setTargetAtTime(pan2, currentTime, 0.05);
            });
        }
        
        // –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∑–≤—É–∫–∞
        function toggleSound(enabled) {
            soundEnabled = enabled;
            
            if (soundEnabled) {
                initAudio();
                initPendulumsAudio();
            } else {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∑–≤—É–∫–∏
                pendulumAudioNodes.forEach(node => {
                    if (node) {
                        node.gain1.gain.setTargetAtTime(0, audioContext.currentTime, 0.1);
                        node.gain2.gain.setTargetAtTime(0, audioContext.currentTime, 0.1);
                    }
                });
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –≤–æ–ª–Ω—ã
        function updateWaveform(type) {
            waveformType = type;
            if (soundEnabled && audioContext) {
                // –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã
                initPendulumsAudio();
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        function updateMasterVolume(value) {
            masterVolume = value / 100;
            if (audioContext && pendulumAudioNodes.length > 0) {
                pendulumAudioNodes.forEach(node => {
                    if (node) {
                        node.masterGain.gain.setTargetAtTime(
                            masterVolume / Math.max(1, numPendulums),
                            audioContext.currentTime,
                            0.05
                        );
                    }
                });
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏–∏
        function updateReverb(value) {
            reverbAmount = value / 100;
            if (reverbGain) {
                reverbGain.gain.setTargetAtTime(reverbAmount, audioContext.currentTime, 0.1);
            }
        }
        
        // ========================================
        // –ö–û–ù–ï–¶ –ó–í–£–ö–û–í–û–ô –°–ò–°–¢–ï–ú–´
        // ========================================
        
        // ========================================
        // –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–û–ï –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–ï (–£–ü–†–û–©–ï–ù–ù–û–ï)
        // ========================================
        
        let dragState = {
            active: false,
            target: null,
            wasPaused: false
        };
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –º—ã—à–∏ –Ω–∞ –º–∞—è—Ç–Ω–∏–∫
        function checkHit(mouseX, mouseY) {
            if (numPendulums > 1 && running) {
                return null;
            }
            
            const hitRadius = 25;
            const pendulum = pendulums[0];
            if (!pendulum) return null;
            
            const x1 = centerX + l1 * Math.sin(pendulum.theta1);
            const y1 = centerY + l1 * Math.cos(pendulum.theta1);
            const x2 = x1 + l2 * Math.sin(pendulum.theta2);
            const y2 = y1 + l2 * Math.cos(pendulum.theta2);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ç–æ—Ä–æ–π –º–∞—è—Ç–Ω–∏–∫ –ø–µ—Ä–≤—ã–º (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
            const dist2 = Math.sqrt((mouseX - x2) ** 2 + (mouseY - y2) ** 2);
            if (dist2 < hitRadius) {
                return 'bob2';
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–π –º–∞—è—Ç–Ω–∏–∫
            const dist1 = Math.sqrt((mouseX - x1) ** 2 + (mouseY - y1) ** 2);
            if (dist1 < hitRadius) {
                return 'bob1';
            }
            
            return null;
        }
        
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –º—ã—à–∏ –∫ –º–∞—è—Ç–Ω–∏–∫—É
        function updatePendulumFromMouse(mouseX, mouseY) {
            if (!dragState.active || pendulums.length === 0) return;
            
            const pendulum = pendulums[0];
            
            if (dragState.target === 'bob1') {
                // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –º–∞—è—Ç–Ω–∏–∫
                const dx = mouseX - centerX;
                const dy = mouseY - centerY;
                pendulum.theta1 = Math.atan2(dx, dy);
                // –í—Ç–æ—Ä–æ–π –º–∞—è—Ç–Ω–∏–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ
                
            } else if (dragState.target === 'bob2') {
                // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º –≤—Ç–æ—Ä–æ–π –º–∞—è—Ç–Ω–∏–∫ - –∏—Å–ø–æ–ª—å–∑—É–µ–º inverse kinematics
                const dx = mouseX - centerX;
                const dy = mouseY - centerY;
                const distToTarget = Math.sqrt(dx * dx + dy * dy);
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º —Ä–∞–¥–∏—É—Å–æ–º
                const maxReach = l1 + l2;
                const minReach = Math.abs(l1 - l2);
                
                if (distToTarget > maxReach) {
                    // –°–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ - –≤—ã—Ç—è–≥–∏–≤–∞–µ–º –æ–±–∞ —Å—Ç–µ—Ä–∂–Ω—è –≤ –ª–∏–Ω–∏—é
                    const angle = Math.atan2(dx, dy);
                    pendulum.theta1 = angle;
                    pendulum.theta2 = angle;
                } else if (distToTarget < minReach) {
                    // –°–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ - —Å–∫–ª–∞–¥—ã–≤–∞–µ–º
                    const angle = Math.atan2(dx, dy);
                    pendulum.theta1 = angle;
                    pendulum.theta2 = angle + Math.PI;
                } else {
                    // –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –¥–æ—Å—Ç–∏–∂–∏–º–∞—è –ø–æ–∑–∏—Ü–∏—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–∫–æ–Ω –∫–æ—Å–∏–Ω—É—Å–æ–≤
                    const angleToTarget = Math.atan2(dx, dy);
                    
                    // –£–≥–æ–ª –≤ "–ª–æ–∫—Ç–µ"
                    const cosElbow = (l1 * l1 + l2 * l2 - distToTarget * distToTarget) / (2 * l1 * l2);
                    const elbowAngle = Math.acos(Math.max(-1, Math.min(1, cosElbow)));
                    
                    // –£–≥–æ–ª "–ø–ª–µ—á–∞"
                    const cosShoulder = (l1 * l1 + distToTarget * distToTarget - l2 * l2) / (2 * l1 * distToTarget);
                    const shoulderOffset = Math.acos(Math.max(-1, Math.min(1, cosShoulder)));
                    
                    pendulum.theta1 = angleToTarget - shoulderOffset;
                    pendulum.theta2 = pendulum.theta1 + elbowAngle;
                }
            }
            
            // –û–±–Ω—É–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            pendulum.omega1 = 0;
            pendulum.omega2 = 0;
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
            theta1 = pendulum.theta1;
            theta2 = pendulum.theta2;
            omega1 = 0;
            omega2 = 0;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('theta1').value = (theta1 * 180 / Math.PI).toFixed(0);
            document.getElementById('theta2').value = (theta2 * 180 / Math.PI).toFixed(0);
            document.getElementById('omega1').value = 0;
            document.getElementById('omega2').value = 0;
            updateValueDisplays();
        }
        
        // Mouse events
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
            const mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            const hit = checkHit(mouseX, mouseY);
            if (hit) {
                dragState.active = true;
                dragState.target = hit;
                dragState.wasPaused = !running;
                running = false; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏–º—É–ª—è—Ü–∏—é
                
                canvas.style.cursor = 'grabbing';
                e.preventDefault();
            }
        });
        
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
            const mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            if (dragState.active) {
                updatePendulumFromMouse(mouseX, mouseY);
                draw(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Ä—É—á–Ω—É—é
                e.preventDefault();
            } else {
                const hit = checkHit(mouseX, mouseY);
                canvas.style.cursor = hit ? 'grab' : 'default';
            }
        });
        
        canvas.addEventListener('mouseup', (e) => {
            if (dragState.active) {
                dragState.active = false;
                canvas.style.cursor = 'default';
                
                // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º —Å–∏–º—É–ª—è—Ü–∏—é –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –±—ã–ª–∞ –Ω–∞ –ø–∞—É–∑–µ
                if (!dragState.wasPaused) {
                    running = true;
                }
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —ç–Ω–µ—Ä–≥–∏—é
                if (pendulums.length > 0) {
                    initialEnergy = calculateEnergy(pendulums[0]);
                }
                
                e.preventDefault();
            }
        });
        
        canvas.addEventListener('mouseleave', () => {
            if (dragState.active) {
                dragState.active = false;
                canvas.style.cursor = 'default';
                
                if (!dragState.wasPaused) {
                    running = true;
                }
            }
        });
        
        // Touch events
        canvas.addEventListener('touchstart', (e) => {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const mouseX = (touch.clientX - rect.left) * (canvas.width / rect.width);
            const mouseY = (touch.clientY - rect.top) * (canvas.height / rect.height);
            
            const hit = checkHit(mouseX, mouseY);
            if (hit) {
                dragState.active = true;
                dragState.target = hit;
                dragState.wasPaused = !running;
                running = false;
                
                e.preventDefault();
            }
        });
        
        canvas.addEventListener('touchmove', (e) => {
            if (dragState.active) {
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                const mouseX = (touch.clientX - rect.left) * (canvas.width / rect.width);
                const mouseY = (touch.clientY - rect.top) * (canvas.height / rect.height);
                
                updatePendulumFromMouse(mouseX, mouseY);
                draw();
                e.preventDefault();
            }
        });
        
        canvas.addEventListener('touchend', (e) => {
            if (dragState.active) {
                dragState.active = false;
                
                if (!dragState.wasPaused) {
                    running = true;
                }
                
                if (pendulums.length > 0) {
                    initialEnergy = calculateEnergy(pendulums[0]);
                }
                
                e.preventDefault();
            }
        });
        
        // ========================================
        // –ö–û–ù–ï–¶ –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–û–ì–û –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø
        // ========================================
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—è—Ç–Ω–∏–∫–æ–≤
        function initPendulums() {
            pendulums = [];
            for (let i = 0; i < numPendulums; i++) {
                const variation = (i - (numPendulums - 1) / 2) * angleVariation * Math.PI / 180;
                pendulums.push({
                    theta1: theta1 + variation,
                    theta2: theta2 + variation,
                    omega1: omega1,
                    omega2: omega2,
                    trail1: [], // —Å–ª–µ–¥ –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
                    trail2: [], // —Å–ª–µ–¥ –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
                    color: pendulumColors[i % pendulumColors.length]
                });
            }
        }

        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã—Ö –¥–ª—è –º–µ—Ç–æ–¥–∞ –†—É–Ω–≥–µ-–ö—É—Ç—Ç—ã
        function derivatives(th1, th2, om1, om2) {
            const delta = th2 - th1;
            const den1 = (m1 + m2) * l1 - m2 * l1 * Math.cos(delta) * Math.cos(delta);
            const den2 = (l2 / l1) * den1;

            const dth1 = om1;
            const dth2 = om2;

            const dom1 = (m2 * l1 * om1 * om1 * Math.sin(delta) * Math.cos(delta) 
                        + m2 * g * Math.sin(th2) * Math.cos(delta) 
                        + m2 * l2 * om2 * om2 * Math.sin(delta) 
                        - (m1 + m2) * g * Math.sin(th1)) / den1 - damping * om1;

            const dom2 = (-m2 * l2 * om2 * om2 * Math.sin(delta) * Math.cos(delta) 
                       + ( m1 + m2) * g * Math.sin(th1) * Math.cos(delta)
                       - ( m1 + m2) * l1 * om1 * om1 * Math.sin(delta)
                       - (m1 + m2) * g * Math.sin(th2)) / den2 - damping * om2;

            return { dth1, dth2, dom1, dom2 };
        }

        // –ú–µ—Ç–æ–¥ –†—É–Ω–≥–µ-–ö—É—Ç—Ç—ã 2-–≥–æ –ø–æ—Ä—è–¥–∫–∞ (–º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ —Å—Ä–µ–¥–Ω–µ–π —Ç–æ—á–∫–∏)
        function rungeKutta2(pendulum, dt) {
            // k1 - –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ –≤ –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–µ
            const k1 = derivatives(pendulum.theta1, pendulum.theta2, pendulum.omega1, pendulum.omega2);
            
            // k2 - –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ –≤ —Å—Ä–µ–¥–Ω–µ–π —Ç–æ—á–∫–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º k1
            const th1_mid = pendulum.theta1 + 0.5 * dt * k1.dth1;
            const th2_mid = pendulum.theta2 + 0.5 * dt * k1.dth2;
            const om1_mid = pendulum.omega1 + 0.5 * dt * k1.dom1;
            const om2_mid = pendulum.omega2 + 0.5 * dt * k1.dom2;
            
            const k2 = derivatives(th1_mid, th2_mid, om1_mid, om2_mid);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º k2
            pendulum.theta1 += dt * k2.dth1;
            pendulum.theta2 += dt * k2.dth2;
            pendulum.omega1 += dt * k2.dom1;
            pendulum.omega2 += dt * k2.dom2;
        }

        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ —Å–∏—Å—Ç–µ–º—ã
        function calculateEnergy(pendulum) {
            const x1 = l1 * Math.sin(pendulum.theta1);
            const y1 = -l1 * Math.cos(pendulum.theta1);
            const x2 = x1 + l2 * Math.sin(pendulum.theta2);
            const y2 = y1 - l2 * Math.cos(pendulum.theta2);

            const vx1 = l1 * pendulum.omega1 * Math.cos(pendulum.theta1);
            const vy1 = l1 * pendulum.omega1 * Math.sin(pendulum.theta1);
            const vx2 = vx1 + l2 * pendulum.omega2 * Math.cos(pendulum.theta2);
            const vy2 = vy1 + l2 * pendulum.omega2 * Math.sin(pendulum.theta2);

            const ke = 0.5 * m1 * (vx1 * vx1 + vy1 * vy1) + 0.5 * m2 * (vx2 * vx2 + vy2 * vy2);
            const pe = m1 * g * (centerY + y1) + m2 * g * (centerY + y2);

            return ke + pe;
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã
        function draw() {
            // –û—á–∏—Å—Ç–∫–∞ –∏–ª–∏ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ
            if (drawMode === 'fade') {
                ctx.fillStyle = 'rgba(10, 14, 20, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = '#0a0e14';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ—Ö –º–∞—è—Ç–Ω–∏–∫–æ–≤
            pendulums.forEach((pendulum, index) => {
                // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π
                const x1 = centerX + l1 * Math.sin(pendulum.theta1);
                const y1 = centerY + l1 * Math.cos(pendulum.theta1);
                const x2 = x1 + l2 * Math.sin(pendulum.theta2);
                const y2 = y1 + l2 * Math.cos(pendulum.theta2);

                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –≤ —Å–ª–µ–¥—ã (–µ—Å–ª–∏ –Ω–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º)
                if (drawMode !== 'minimal') {
                    const velocity = Math.sqrt(pendulum.omega1 * pendulum.omega1 + pendulum.omega2 * pendulum.omega2);
                    
                    // –°–ª–µ–¥ –ø–µ—Ä–≤–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
                    if (trailTarget === 'first' || trailTarget === 'both') {
                        pendulum.trail1.push({ x: x1, y: y1, v: velocity });
                        if (pendulum.trail1.length > trailLength) {
                            pendulum.trail1.shift();
                        }
                    } else {
                        pendulum.trail1 = [];
                    }
                    
                    // –°–ª–µ–¥ –≤—Ç–æ—Ä–æ–≥–æ –º–∞—è—Ç–Ω–∏–∫–∞
                    if (trailTarget === 'second' || trailTarget === 'both') {
                        pendulum.trail2.push({ x: x2, y: y2, v: velocity });
                        if (pendulum.trail2.length > trailLength) {
                            pendulum.trail2.shift();
                        }
                    } else {
                        pendulum.trail2 = [];
                    }
                }

                // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –æ–¥–Ω–æ–≥–æ —Å–ª–µ–¥–∞
                function drawTrail(trail, colorIndex) {
                    if (drawMode === 'trail') {
                        // –õ–∏–Ω–µ–π–Ω–∞—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞
                        for (let i = 1; i < trail.length; i++) {
                            const alpha = i / trail.length;
                            const color = getColor(trail[i].v, alpha, index, colorIndex);
                            
                            ctx.strokeStyle = color;
                            ctx.lineWidth = 2;
                            ctx.beginPath();
                            ctx.moveTo(trail[i - 1].x, trail[i - 1].y);
                            ctx.lineTo(trail[i].x, trail[i].y);
                            ctx.stroke();
                        }
                    } else if (drawMode === 'dots') {
                        // –î–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ —Ç–æ—á–∫–∏ (–∫–∞–∂–¥–∞—è 5-—è —Ç–æ—á–∫–∞ –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏)
                        for (let i = 0; i < trail.length; i += 5) {
                            const alpha = i / trail.length;
                            const color = getColor(trail[i].v, alpha, index, colorIndex);
                            
                            ctx.fillStyle = color;
                            ctx.beginPath();
                            ctx.arc(trail[i].x, trail[i].y, 2.5, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    } else if (drawMode === 'fade') {
                        // –í —Ä–µ–∂–∏–º–µ –∑–∞—Ç—É—Ö–∞–Ω–∏—è —Ä–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â—É—é —Ç–æ—á–∫—É
                        if (trail.length > 0) {
                            const lastPoint = trail[trail.length - 1];
                            const color = getColor(lastPoint.v, 1, index, colorIndex);
                            ctx.fillStyle = color;
                            ctx.beginPath();
                            ctx.arc(lastPoint.x, lastPoint.y, 3, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                }

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ª–µ–¥–æ–≤
                if (trailTarget === 'first' || trailTarget === 'both') {
                    drawTrail(pendulum.trail1, 0); // 0 - –ø–µ—Ä–≤—ã–π –º–∞—è—Ç–Ω–∏–∫
                }
                if (trailTarget === 'second' || trailTarget === 'both') {
                    drawTrail(pendulum.trail2, 1); // 1 - –≤—Ç–æ—Ä–æ–π –º–∞—è—Ç–Ω–∏–∫
                }

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç–µ—Ä–∂–Ω–µ–π –≤ —Ç–µ–∫—É—â–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–∏ (—Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–∞—è—Ç–Ω–∏–∫–æ–≤)
                const opacity = numPendulums > 1 ? 0.5 : 0.8;
                
                ctx.strokeStyle = `rgba(${parseInt(pendulum.color.primary.slice(1, 3), 16)}, ${parseInt(pendulum.color.primary.slice(3, 5), 16)}, ${parseInt(pendulum.color.primary.slice(5, 7), 16)}, ${opacity})`;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x1, y1);
                ctx.stroke();

                ctx.strokeStyle = `rgba(${parseInt(pendulum.color.secondary.slice(1, 3), 16)}, ${parseInt(pendulum.color.secondary.slice(3, 5), 16)}, ${parseInt(pendulum.color.secondary.slice(5, 7), 16)}, ${opacity})`;
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∞—è—Ç–Ω–∏–∫–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∏–ª–∏ –µ—Å–ª–∏ –æ–¥–∏–Ω –º–∞—è—Ç–Ω–∏–∫ - —Ä–∏—Å—É–µ–º –∫—Ä—É–ø–Ω–µ–µ)
                if (index === 0 || numPendulums === 1) {
                    // –ü–µ—Ä–≤—ã–π –º–∞—è—Ç–Ω–∏–∫
                    const radius1 = Math.max(8, Math.sqrt(m1) * 3);
                    ctx.fillStyle = pendulum.color.primary;
                    ctx.beginPath();
                    ctx.arc(x1, y1, radius1, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = `${pendulum.color.primary}80`;
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // –í—Ç–æ—Ä–æ–π –º–∞—è—Ç–Ω–∏–∫
                    const radius2 = Math.max(8, Math.sqrt(m2) * 3);
                    ctx.fillStyle = pendulum.color.secondary;
                    ctx.beginPath();
                    ctx.arc(x2, y2, radius2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = `${pendulum.color.secondary}80`;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                } else {
                    // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –º–∞—è—Ç–Ω–∏–∫–æ–≤ - –º–µ–Ω—å—à–µ –∏ –ø—Ä–æ—â–µ
                    const radius1 = 5;
                    const radius2 = 5;
                    
                    ctx.fillStyle = pendulum.color.primary;
                    ctx.beginPath();
                    ctx.arc(x1, y1, radius1, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = pendulum.color.secondary;
                    ctx.beginPath();
                    ctx.arc(x2, y2, radius2, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–æ—á–∫–∏ –ø–æ–¥–≤–µ—Å–∞ (–ø–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö –º–∞—è—Ç–Ω–∏–∫–æ–≤)
            ctx.fillStyle = '#e8f4f8';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 8, 0, Math.PI * 2);
            ctx.fill();

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –º–∞—è—Ç–Ω–∏–∫)
            if (running && pendulums.length > 0) {
                const currentEnergy = calculateEnergy(pendulums[0]);
                const energyChange = initialEnergy !== 0 ? 
                    ((currentEnergy - initialEnergy) / initialEnergy * 100).toFixed(2) : 0;
                document.getElementById('energyDisplay').innerHTML = 
                    `E: ${currentEnergy.toFixed(0)}<br>ŒîE: ${energyChange}%`;
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ö–µ–º—ã
        function getColor(velocity, alpha, pendulumIndex = 0, massIndex = 1) {
            // massIndex: 0 - –ø–µ—Ä–≤—ã–π –º–∞—è—Ç–Ω–∏–∫, 1 - –≤—Ç–æ—Ä–æ–π –º–∞—è—Ç–Ω–∏–∫
            const schemes = {
                velocity: () => {
                    const hue = Math.min(velocity * 30, 300);
                    return `hsla(${hue}, 80%, 60%, ${alpha})`;
                },
                energy: () => {
                    const energy = pendulums.length > 0 ? calculateEnergy(pendulums[pendulumIndex]) : 0;
                    const hue = (energy / 100) % 360;
                    return `hsla(${hue}, 80%, 60%, ${alpha})`;
                },
                cyan: () => {
                    // –î–ª—è —Ä–µ–∂–∏–º–∞ "–æ–±–∞" - –ø–µ—Ä–≤—ã–π –º–∞—è—Ç–Ω–∏–∫ cyan, –≤—Ç–æ—Ä–æ–π magenta
                    if (trailTarget === 'both') {
                        return massIndex === 0 ? `rgba(0, 229, 255, ${alpha})` : `rgba(255, 0, 110, ${alpha})`;
                    }
                    return `rgba(0, 229, 255, ${alpha})`;
                },
                magenta: () => {
                    if (trailTarget === 'both') {
                        return massIndex === 0 ? `rgba(0, 229, 255, ${alpha})` : `rgba(255, 0, 110, ${alpha})`;
                    }
                    return `rgba(255, 0, 110, ${alpha})`;
                },
                rainbow: () => {
                    const baseHue = (Date.now() / 20 + pendulumIndex * 72) % 360;
                    const hueOffset = trailTarget === 'both' ? (massIndex === 0 ? -30 : 30) : 0;
                    return `hsla(${(baseHue + hueOffset + 360) % 360}, 80%, 60%, ${alpha})`;
                },
                fire: () => {
                    const val = Math.min(velocity * 50, 100);
                    if (trailTarget === 'both') {
                        // –ü–µ—Ä–≤—ã–π - –æ—Ä–∞–Ω–∂–µ–≤—ã–π, –≤—Ç–æ—Ä–æ–π - –∫—Ä–∞—Å–Ω—ã–π
                        return massIndex === 0 ? `rgba(255, ${150 - val}, 0, ${alpha})` : `rgba(255, ${100 - val}, 0, ${alpha})`;
                    }
                    return `rgba(255, ${100 - val}, 0, ${alpha})`;
                }
            };

            return schemes[colorScheme] ? schemes[colorScheme]() : schemes.velocity();
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ —Ñ–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ (–¥–∏–∞–≥—Ä–∞–º–º–∞ –ü—É–∞–Ω–∫–∞—Ä–µ)
        function drawPhaseSpace() {
            const w = phaseSpaceCanvas.width;
            const h = phaseSpaceCanvas.height;
            
            // –§–æ–Ω
            phaseSpaceCtx.fillStyle = '#0a0e14';
            phaseSpaceCtx.fillRect(0, 0, w, h);
            
            // –°–µ—Ç–∫–∞
            phaseSpaceCtx.strokeStyle = 'rgba(0, 229, 255, 0.1)';
            phaseSpaceCtx.lineWidth = 1;
            for (let i = 0; i <= 8; i++) {
                const x = (i / 8) * w;
                const y = (i / 8) * h;
                phaseSpaceCtx.beginPath();
                phaseSpaceCtx.moveTo(x, 0);
                phaseSpaceCtx.lineTo(x, h);
                phaseSpaceCtx.stroke();
                phaseSpaceCtx.beginPath();
                phaseSpaceCtx.moveTo(0, y);
                phaseSpaceCtx.lineTo(w, y);
                phaseSpaceCtx.stroke();
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π
            phaseSpaceData.forEach(data => {
                const x = ((data.th1 + Math.PI) / (2 * Math.PI)) * w;
                const y = ((data.th2 + Math.PI) / (2 * Math.PI)) * h;
                
                phaseSpaceCtx.fillStyle = data.color;
                phaseSpaceCtx.beginPath();
                phaseSpaceCtx.arc(x, y, 1.5, 0, Math.PI * 2);
                phaseSpaceCtx.fill();
            });

            // –¢–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤—Å–µ—Ö –º–∞—è—Ç–Ω–∏–∫–æ–≤
            pendulums.forEach((pendulum, index) => {
                const currentX = ((pendulum.theta1 + Math.PI) / (2 * Math.PI)) * w;
                const currentY = ((pendulum.theta2 + Math.PI) / (2 * Math.PI)) * h;
                
                if (index === 0) {
                    // –ü–µ—Ä–≤—ã–π –º–∞—è—Ç–Ω–∏–∫ - –±–æ–ª—å—à–∞—è –∫—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞
                    phaseSpaceCtx.shadowColor = 'rgba(255, 0, 110, 0.8)';
                    phaseSpaceCtx.shadowBlur = 10;
                    phaseSpaceCtx.fillStyle = '#ff006e';
                    phaseSpaceCtx.beginPath();
                    phaseSpaceCtx.arc(currentX, currentY, 6, 0, Math.PI * 2);
                    phaseSpaceCtx.fill();
                    phaseSpaceCtx.shadowBlur = 0;
                    
                    phaseSpaceCtx.strokeStyle = '#ffffff';
                    phaseSpaceCtx.lineWidth = 2;
                    phaseSpaceCtx.beginPath();
                    phaseSpaceCtx.arc(currentX, currentY, 8, 0, Math.PI * 2);
                    phaseSpaceCtx.stroke();
                } else {
                    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–∞—è—Ç–Ω–∏–∫–∏ - –º–µ–Ω—å—à–∏–µ —Ü–≤–µ—Ç–Ω—ã–µ —Ç–æ—á–∫–∏
                    phaseSpaceCtx.fillStyle = pendulum.color.secondary;
                    phaseSpaceCtx.beginPath();
                    phaseSpaceCtx.arc(currentX, currentY, 4, 0, Math.PI * 2);
                    phaseSpaceCtx.fill();
                    phaseSpaceCtx.strokeStyle = '#ffffff80';
                    phaseSpaceCtx.lineWidth = 1;
                    phaseSpaceCtx.stroke();
                }
            });

            // –ü–æ–¥–ø–∏—Å–∏ –æ—Å–µ–π
            phaseSpaceCtx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            phaseSpaceCtx.font = '11px "IBM Plex Mono"';
            phaseSpaceCtx.fillText('Œ∏1 ‚Üí', w - 40, h - 5);
            phaseSpaceCtx.save();
            phaseSpaceCtx.translate(10, h / 2);
            phaseSpaceCtx.rotate(-Math.PI / 2);
            phaseSpaceCtx.fillText('Œ∏2 ‚Üí', -20, 0);
            phaseSpaceCtx.restore();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ (—Ç–µ–∫—Å—Ç –≤ —É–≥–ª—É)
            phaseSpaceCtx.fillStyle = 'rgba(0, 229, 255, 0.5)';
            phaseSpaceCtx.font = '9px "IBM Plex Mono"';
            phaseSpaceCtx.fillText('[–ö–ª–∏–∫ –æ—á–∏—â–∞–µ—Ç]', w - 80, 12);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
        let phaseSpaceCounter = 0;
        function updatePhaseSpace() {
            phaseSpaceCounter++;
            if (phaseSpaceCounter % 10 === 0 && phaseSpaceData.length < 5000) {
                pendulums.forEach((pendulum, index) => {
                    const velocity = Math.sqrt(pendulum.omega1 * pendulum.omega1 + pendulum.omega2 * pendulum.omega2);
                    phaseSpaceData.push({
                        th1: pendulum.theta1,
                        th2: pendulum.theta2,
                        color: getColor(velocity, 0.4, index)
                    });
                });
            }
        }

        // –ö–ª–∏–∫ –ø–æ —Ñ–∞–∑–æ–≤–æ–º—É –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤—É - –æ—á–∏—â–∞–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ —É–≥–ª—ã
        phaseSpaceCanvas.addEventListener('click', (e) => {
            const rect = phaseSpaceCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / rect.width;
            const y = (e.clientY - rect.top) / rect.height;
            
            // –ï—Å–ª–∏ –∫–ª–∏–∫ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É (–æ–±–ª–∞—Å—Ç—å "–æ—á–∏—Å—Ç–∏—Ç—å") - —Ç–æ–ª—å–∫–æ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (x > 0.7 && y < 0.1) {
                phaseSpaceData = [];
                drawPhaseSpace();
                return;
            }
            
            // –ò–Ω–∞—á–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ —É–≥–ª—ã
            theta1 = x * 2 * Math.PI - Math.PI;
            theta2 = y * 2 * Math.PI - Math.PI;
            omega1 = 0;
            omega2 = 0;
            
            document.getElementById('theta1').value = theta1 * 180 / Math.PI;
            document.getElementById('theta2').value = theta2 * 180 / Math.PI;
            updateValueDisplays();
            
            // –ù–µ –æ—á–∏—â–∞–µ–º phaseSpaceData - –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ–º —Ç–æ—á–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π
            initPendulums();
            if (pendulums.length > 0) {
                initialEnergy = calculateEnergy(pendulums[0]);
            }
            drawPhaseSpace();
        });

        // Touch –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Ñ–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
        phaseSpaceCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = phaseSpaceCanvas.getBoundingClientRect();
            const x = (touch.clientX - rect.left) / rect.width;
            const y = (touch.clientY - rect.top) / rect.height;
            
            // –ï—Å–ª–∏ —Ç–∞–ø –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É - –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (x > 0.7 && y < 0.1) {
                phaseSpaceData = [];
                drawPhaseSpace();
                return;
            }
            
            theta1 = x * 2 * Math.PI - Math.PI;
            theta2 = y * 2 * Math.PI - Math.PI;
            omega1 = 0;
            omega2 = 0;
            
            document.getElementById('theta1').value = theta1 * 180 / Math.PI;
            document.getElementById('theta2').value = theta2 * 180 / Math.PI;
            updateValueDisplays();
            
            initPendulums();
            if (pendulums.length > 0) {
                initialEnergy = calculateEnergy(pendulums[0]);
            }
            drawPhaseSpace();
        });

        // FPS counter
        let lastFrameTime = performance.now();
        let frameCount = 0;
        let fps = 0;
        const fpsCounter = document.getElementById('fpsCounter');

        // –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª
        function loop(currentTime) {
            if (running) {
                const dt = 0.05 * speed;
                const steps = 5;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –º–∞—è—Ç–Ω–∏–∫–∏
                pendulums.forEach(pendulum => {
                    for (let i = 0; i < steps; i++) {
                        rungeKutta2(pendulum, dt / steps);
                    }
                });
                
                updatePhaseSpace();
                updateSound(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–≤—É–∫–∞
                draw();

                frameCount++;
                if (currentTime - lastFrameTime >= 1000) {
                    fps = frameCount;
                    fpsCounter.textContent = `${fps} FPS`;
                    frameCount = 0;
                    lastFrameTime = currentTime;
                }
            }
            requestAnimationFrame(loop);
        }

        // –ü—Ä–µ—Å–µ—Ç—ã
        const presets = {
            chaotic: { 
                l1: 150, l2: 150, m1: 10, m2: 10, g: 9.8, 
                th1: 90, th2: 90, om1: 0, om2: 0, damping: 0 
            },
            periodic: { 
                l1: 150, l2: 150, m1: 10, m2: 10, g: 9.8, 
                th1: 30, th2: 30, om1: 0, om2: 0, damping: 0 
            },
            asymmetric: { 
                l1: 200, l2: 100, m1: 15, m2: 5, g: 9.8, 
                th1: 120, th2: -60, om1: 0, om2: 0, damping: 0 
            },
            heavy: { 
                l1: 150, l2: 150, m1: 25, m2: 5, g: 9.8, 
                th1: 90, th2: 90, om1: 0, om2: 0, damping: 0 
            },
            light: { 
                l1: 150, l2: 150, m1: 5, m2: 25, g: 9.8, 
                th1: 90, th2: 90, om1: 0, om2: 0, damping: 0 
            },
            extreme: { 
                l1: 200, l2: 200, m1: 20, m2: 20, g: 15, 
                th1: 170, th2: 170, om1: 2, om2: -2, damping: 0 
            }
        };

        function loadPreset(name) {
            const preset = presets[name];
            l1 = preset.l1;
            l2 = preset.l2;
            m1 = preset.m1;
            m2 = preset.m2;
            g = preset.g;
            damping = preset.damping;
            theta1 = preset.th1 * Math.PI / 180;
            theta2 = preset.th2 * Math.PI / 180;
            omega1 = preset.om1;
            omega2 = preset.om2;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ UI —ç–ª–µ–º–µ–Ω—Ç—ã
            document.getElementById('l1').value = l1;
            document.getElementById('l2').value = l2;
            document.getElementById('m1').value = m1;
            document.getElementById('m2').value = m2;
            document.getElementById('g').value = g;
            document.getElementById('damping').value = damping;
            document.getElementById('theta1').value = preset.th1;
            document.getElementById('theta2').value = preset.th2;
            document.getElementById('omega1').value = omega1;
            document.getElementById('omega2').value = omega2;
            
            updateValueDisplays();
            resetSimulation();
            
            currentPreset = name;
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`[data-preset="${name}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        function toggleSimulation() {
            running = !running;
            document.getElementById('playPauseBtn').textContent = running ? '‚è∏ –ü–∞—É–∑–∞' : '‚ñ∂ –°—Ç–∞—Ä—Ç';
        }

        function resetSimulation() {
            initPendulums();
            phaseSpaceData = [];
            phaseSpaceCounter = 0;
            if (pendulums.length > 0) {
                initialEnergy = calculateEnergy(pendulums[0]);
            }
            // –ü–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º –∞—É–¥–∏–æ —É–∑–ª—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–∞—è—Ç–Ω–∏–∫–æ–≤
            if (soundEnabled) {
                initPendulumsAudio();
            }
            draw();
            if (document.getElementById('phaseSpace').classList.contains('active')) {
                drawPhaseSpace();
            }
        }

        function clearTrail() {
            pendulums.forEach(pendulum => {
                pendulum.trail1 = [];
                pendulum.trail2 = [];
            });
            phaseSpaceData = [];
        }

        function randomInitial() {
            theta1 = (Math.random() - 0.5) * Math.PI * 2;
            theta2 = (Math.random() - 0.5) * Math.PI * 2;
            omega1 = 0;
            omega2 = 0;
            
            document.getElementById('theta1').value = theta1 * 180 / Math.PI;
            document.getElementById('theta2').value = theta2 * 180 / Math.PI;
            document.getElementById('omega1').value = omega1;
            document.getElementById('omega2').value = omega2;
            updateValueDisplays();
            
            resetSimulation();
            
            currentPreset = null;
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function applyInitialConditions() {
            theta1 = parseFloat(document.getElementById('theta1').value) * Math.PI / 180;
            theta2 = parseFloat(document.getElementById('theta2').value) * Math.PI / 180;
            omega1 = parseFloat(document.getElementById('omega1').value);
            omega2 = parseFloat(document.getElementById('omega2').value);
            
            resetSimulation();
            
            const applyBtn = document.querySelector('#initial .compact-buttons button:first-child');
            const originalText = applyBtn.innerHTML;
            applyBtn.innerHTML = '<span>‚úì –ü—Ä–∏–º–µ–Ω–µ–Ω–æ!</span>';
            applyBtn.style.borderColor = 'var(--accent-cyan)';
            applyBtn.style.background = 'rgba(0, 229, 255, 0.2)';
            
            setTimeout(() => {
                applyBtn.innerHTML = originalText;
                applyBtn.style.borderColor = '';
                applyBtn.style.background = '';
            }, 1500);
        }

        function exportImage() {
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = canvas.width;
            exportCanvas.height = canvas.height;
            const exportCtx = exportCanvas.getContext('2d');
            exportCtx.drawImage(canvas, 0, 0);
            
            const exportBtn = document.querySelector('#control button:last-child');
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = '<span>‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</span>';
            exportBtn.style.borderColor = 'var(--accent-cyan)';
            exportBtn.style.background = 'rgba(0, 229, 255, 0.2)';
            
            exportCanvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = `double-pendulum-${Date.now()}.png`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
                
                setTimeout(() => {
                    exportBtn.innerHTML = originalText;
                    exportBtn.style.borderColor = '';
                    exportBtn.style.background = '';
                }, 2000);
            });
        }

        // ========================================
        // –ó–ê–ü–ò–°–¨ –í–ò–î–ï–û –°–û –ó–í–£–ö–û–ú
        // ========================================

        function updateRecordingUI() {
            const recordBtn = document.getElementById('recordBtn');
            const recordBtnText = document.getElementById('recordBtnText');
            const recordingIndicator = document.getElementById('recordingIndicator');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            if (!recordBtn || !recordBtnText) {
                return;
            }
            
            if (isRecording) {
                recordBtnText.textContent = '‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
                recordBtn.classList.add('recording');
                if (recordingIndicator) {
                    recordingIndicator.style.display = 'block';
                }
            } else {
                recordBtnText.textContent = '‚è∫ –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ';
                recordBtn.classList.remove('recording');
                if (recordingIndicator) {
                    recordingIndicator.style.display = 'none';
                }
            }
        }

        function toggleRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            recordedChunks = [];
            
            try {
                // –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –ø–æ—Ç–æ–∫ —Å canvas
                const canvasStream = canvas.captureStream(30); // 30 FPS
                
                let finalStream;
                
                // –ï—Å–ª–∏ –∑–≤—É–∫ –≤–∫–ª—é—á—ë–Ω –∏ audioContext —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ
                if (soundEnabled && audioContext && audioContext.state === 'running') {
                    // –°–æ–∑–¥–∞—ë–º destination –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∞—É–¥–∏–æ
                    const audioDestination = audioContext.createMediaStreamDestination();
                    
                    // –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞—É–¥–∏–æ —É–∑–ª—ã –∫ destination
                    pendulumAudioNodes.forEach(node => {
                        if (node && node.masterGain) {
                            node.masterGain.connect(audioDestination);
                        }
                    });
                    
                    // –¢–∞–∫–∂–µ –ø–æ–¥–∫–ª—é—á–∞–µ–º reverb –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                    if (reverbGain) {
                        reverbGain.connect(audioDestination);
                    }
                    
                    // –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º –≤–∏–¥–µ–æ –∏ –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–∏
                    const audioTrack = audioDestination.stream.getAudioTracks()[0];
                    const videoTrack = canvasStream.getVideoTracks()[0];
                    
                    finalStream = new MediaStream([videoTrack, audioTrack]);
                    
                    console.log('–ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ —Å–æ –∑–≤—É–∫–æ–º');
                } else {
                    // –¢–æ–ª—å–∫–æ –≤–∏–¥–µ–æ –±–µ–∑ –∑–≤—É–∫–∞
                    finalStream = canvasStream;
                    console.log('–ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ –±–µ–∑ –∑–≤—É–∫–∞');
                }
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è MediaRecorder
                const options = {
                    mimeType: 'video/webm;codecs=vp9,opus',
                    videoBitsPerSecond: 2500000 // 2.5 Mbps
                };
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ñ–æ—Ä–º–∞—Ç–∞
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm';
                }
                
                mediaRecorder = new MediaRecorder(finalStream, options);
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    link.download = `double-pendulum-${timestamp}.webm`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    isRecording = false;
                    mediaRecorder = null;
                    recordedChunks = [];
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    updateRecordingUI();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    const recordBtnText = document.getElementById('recordBtnText');
                    if (recordBtnText) {
                        recordBtnText.textContent = '‚úì –í–∏–¥–µ–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                        setTimeout(() => {
                            if (!isRecording) {
                                recordBtnText.textContent = '‚è∫ –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ';
                            }
                        }, 2000);
                    }
                };
                
                mediaRecorder.onerror = (event) => {
                    console.error('–û—à–∏–±–∫–∞ MediaRecorder:', event.error);
                    isRecording = false;
                    mediaRecorder = null;
                    updateRecordingUI();
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ.');
                };
                
                mediaRecorder.start(100); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 100ms
                isRecording = true;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                updateRecordingUI();
                
                console.log('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∑–∞–ø–∏—Å–∏:', error);
                isRecording = false;
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à –±—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ');
                mediaRecorder.stop();
                // –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º isRecording –∑–¥–µ—Å—å - —ç—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ –≤ onstop
            }
        }

        // ========================================
        // –ö–û–ù–ï–¶ –°–ò–°–¢–ï–ú–´ –ó–ê–ü–ò–°–ò –í–ò–î–ï–û
        // ========================================`

        function updateValueDisplays() {
            document.getElementById('l1Value').textContent = l1;
            document.getElementById('l2Value').textContent = l2;
            document.getElementById('m1Value').textContent = m1;
            document.getElementById('m2Value').textContent = m2;
            document.getElementById('gValue').textContent = g.toFixed(1);
            document.getElementById('dampingValue').textContent = damping.toFixed(4);
            document.getElementById('theta1Value').textContent = (parseFloat(document.getElementById('theta1').value)).toFixed(0) + '¬∞';
            document.getElementById('theta2Value').textContent = (parseFloat(document.getElementById('theta2').value)).toFixed(0) + '¬∞';
            document.getElementById('omega1Value').textContent = (parseFloat(document.getElementById('omega1').value)).toFixed(1);
            document.getElementById('omega2Value').textContent = (parseFloat(document.getElementById('omega2').value)).toFixed(1);
            document.getElementById('trailLengthValue').textContent = trailLength;
            document.getElementById('numPendulumsValue').textContent = numPendulums;
            document.getElementById('angleVariationValue').textContent = angleVariation.toFixed(2) + '¬∞';
            document.getElementById('speedValue').textContent = speed.toFixed(1) + 'x';
            document.getElementById('masterVolumeValue').textContent = Math.round(masterVolume * 100) + '%';
            document.getElementById('reverbValue').textContent = Math.round(reverbAmount * 100) + '%';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('l1').addEventListener('input', (e) => {
            l1 = parseFloat(e.target.value);
            updateValueDisplays();
        });

        document.getElementById('l2').addEventListener('input', (e) => {
            l2 = parseFloat(e.target.value);
            updateValueDisplays();
        });

        document.getElementById('m1').addEventListener('input', (e) => {
            m1 = parseFloat(e.target.value);
            updateValueDisplays();
        });

        document.getElementById('m2').addEventListener('input', (e) => {
            m2 = parseFloat(e.target.value);
            updateValueDisplays();
        });

        document.getElementById('g').addEventListener('input', (e) => {
            g = parseFloat(e.target.value);
            updateValueDisplays();
        });

        document.getElementById('damping').addEventListener('input', (e) => {
            damping = parseFloat(e.target.value);
            updateValueDisplays();
        });

        document.getElementById('theta1').addEventListener('input', updateValueDisplays);
        document.getElementById('theta2').addEventListener('input', updateValueDisplays);
        document.getElementById('omega1').addEventListener('input', updateValueDisplays);
        document.getElementById('omega2').addEventListener('input', updateValueDisplays);

        document.getElementById('drawMode').addEventListener('change', (e) => {
            drawMode = e.target.value;
            if (drawMode === 'minimal') {
                pendulums.forEach(pendulum => {
                    pendulum.trail1 = [];
                    pendulum.trail2 = [];
                });
            }
        });

        document.getElementById('colorScheme').addEventListener('change', (e) => {
            colorScheme = e.target.value;
        });

        document.getElementById('trailTarget').addEventListener('change', (e) => {
            trailTarget = e.target.value;
            // –û—á–∏—â–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–ª–µ–¥—ã
            pendulums.forEach(pendulum => {
                if (trailTarget === 'first') {
                    pendulum.trail2 = [];
                } else if (trailTarget === 'second') {
                    pendulum.trail1 = [];
                }
            });
        });

        document.getElementById('trailLength').addEventListener('input', (e) => {
            trailLength = parseInt(e.target.value);
            updateValueDisplays();
        });

        document.getElementById('numPendulums').addEventListener('input', (e) => {
            numPendulums = parseInt(e.target.value);
            updateValueDisplays();
            resetSimulation(); // –≠—Ç–æ —Ç–µ–ø–µ—Ä—å —Ç–∞–∫–∂–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç –∞—É–¥–∏–æ —É–∑–ª—ã
        });

        document.getElementById('angleVariation').addEventListener('input', (e) => {
            angleVariation = parseFloat(e.target.value);
            updateValueDisplays();
            if (numPendulums > 1) {
                resetSimulation();
            }
        });

        document.getElementById('speed').addEventListener('input', (e) => {
            speed = parseFloat(e.target.value);
            updateValueDisplays();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–≤—É–∫–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        document.getElementById('soundEnabled').addEventListener('change', (e) => {
            toggleSound(e.target.value === 'true');
        });

        document.getElementById('soundMapping').addEventListener('change', (e) => {
            soundMapping = e.target.value;
        });

        document.getElementById('soundMode').addEventListener('change', (e) => {
            soundMode = e.target.value;
        });

        document.getElementById('masterVolume').addEventListener('input', (e) => {
            updateMasterVolume(parseInt(e.target.value));
            updateValueDisplays();
        });

        document.getElementById('reverb').addEventListener('input', (e) => {
            updateReverb(parseInt(e.target.value));
            updateValueDisplays();
        });

        document.getElementById('musicalScale').addEventListener('change', (e) => {
            musicalScale = e.target.value;
        });

        document.getElementById('waveform').addEventListener('change', (e) => {
            updateWaveform(e.target.value);
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(event, tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            
            if (tabName === 'phaseSpace') {
                setTimeout(() => drawPhaseSpace(), 50);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            if (tabName === 'control' && document.getElementById('recordBtn')) {
                updateRecordingUI();
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Å–±—Ä–æ—Å–∞
        function resetPresetsTab() {
            loadPreset('chaotic');
            showResetFeedback('#presets');
        }

        function resetPhysicsTab() {
            l1 = 150;
            l2 = 150;
            m1 = 10;
            m2 = 10;
            g = 9.8;
            damping = 0;
            
            document.getElementById('l1').value = l1;
            document.getElementById('l2').value = l2;
            document.getElementById('m1').value = m1;
            document.getElementById('m2').value = m2;
            document.getElementById('g').value = g;
            document.getElementById('damping').value = damping;
            updateValueDisplays();
            showResetFeedback('#physics');
        }

        function resetVisualTab() {
            drawMode = 'trail';
            colorScheme = 'velocity';
            trailTarget = 'second';
            trailLength = 500;
            numPendulums = 1;
            angleVariation = 0.1;
            speed = 1.0;
            
            document.getElementById('drawMode').value = drawMode;
            document.getElementById('colorScheme').value = colorScheme;
            document.getElementById('trailTarget').value = trailTarget;
            document.getElementById('trailLength').value = trailLength;
            document.getElementById('numPendulums').value = numPendulums;
            document.getElementById('angleVariation').value = angleVariation;
            document.getElementById('speed').value = speed;
            updateValueDisplays();
            resetSimulation();
            showResetFeedback('#visual');
        }

        function resetInitialTab() {
            document.getElementById('theta1').value = 90;
            document.getElementById('theta2').value = 90;
            document.getElementById('omega1').value = 0;
            document.getElementById('omega2').value = 0;
            updateValueDisplays();
            showResetFeedback('#initial');
        }

        function resetSoundTab() {
            soundEnabled = false;
            soundMapping = 'combined';
            soundMode = 'continuous';
            waveformType = 'sine';
            musicalScale = 'pentatonic';
            
            document.getElementById('soundEnabled').value = 'false';
            document.getElementById('soundMapping').value = 'combined';
            document.getElementById('soundMode').value = 'continuous';
            document.getElementById('masterVolume').value = 50;
            document.getElementById('reverb').value = 30;
            document.getElementById('musicalScale').value = 'pentatonic';
            document.getElementById('waveform').value = 'sine';
            
            masterVolume = 0.5;
            reverbAmount = 0.3;
            
            toggleSound(false);
            updateValueDisplays();
            showResetFeedback('#sound');
        }

        function showResetFeedback(tabSelector) {
            const buttons = document.querySelectorAll(`${tabSelector} button`);
            const resetBtn = Array.from(buttons).find(btn => btn.textContent.includes('–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é'));
            
            if (resetBtn) {
                const originalText = resetBtn.innerHTML;
                resetBtn.innerHTML = '<span>‚úì –°–±—Ä–æ—à–µ–Ω–æ!</span>';
                resetBtn.style.borderColor = 'var(--accent-cyan)';
                resetBtn.style.background = 'rgba(0, 229, 255, 0.2)';
                
                setTimeout(() => {
                    resetBtn.innerHTML = originalText;
                    resetBtn.style.borderColor = '';
                    resetBtn.style.background = '';
                }, 1500);
            }
        }

        // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                e.preventDefault();
                toggleSimulation();
            }
            if (e.code === 'KeyR' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                e.preventDefault();
                resetSimulation();
            }
            if (e.code === 'KeyC' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                e.preventDefault();
                clearTrail();
            }

            // V - –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ
            if (e.code === 'KeyV' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                e.preventDefault();
                toggleRecording();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.querySelector('.loading').style.display = 'none';
        initPendulums();
        if (pendulums.length > 0) {
            initialEnergy = calculateEnergy(pendulums[0]);
        }
        updateValueDisplays();
        drawPhaseSpace();
        requestAnimationFrame(loop);
    </script>
</body>
</html>
