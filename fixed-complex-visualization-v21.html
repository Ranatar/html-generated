<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .main-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .left-panel {
            flex: 1;
            min-width: 600px;
        }

        .right-panel {
            width: 520px;
            position: sticky;
            top: 20px;
            align-self: flex-start;
        }

        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            .left-panel, .right-panel {
                width: 100%;
            }
        }

        .collapsible-section {
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .collapsible-header {
            background-color: #f5f5f5;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .collapsible-header:after {
            content: '‚ñº';
            font-size: 12px;
        }

        .collapsible-header.collapsed:after {
            content: '‚ñ∫';
        }

        .collapsible-content {
            padding: 15px;
            display: none;
        }

        .collapsible-content.visible {
            display: block;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }

        .template-tab-content {
            display: none;
            padding: 10px;
        }

        .template-tab-content.active {
            display: block;
        }

        .controls {
            margin-bottom: 20px;
        }
        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }
        .control-group {
            margin: 10px 0;
            flex: 1;
            min-width: 300px;
        }
        .circular-slider {
            position: relative;
            width: 150px;
            height: 150px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 20px;
        }
        .slider-container {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .param-input {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .param-input label {
            width: 30px;
            text-align: right;
            margin-right: 10px;
        }
        .param-input input[type="range"] {
            flex: 1;
            margin: 0 10px;
        }
        .param-input input[type="number"] {
            width: 70px;
            padding: 4px;
        }
        canvas {
            border: 1px solid #ccc;
            display: block;
            margin: 0 auto;
        }
        canvas.control-canvas {
            border: 1px solid #aaa;
            border-radius: 50%;
        }
        select {
            padding: 5px;
            margin: 5px 0;
            width: 100%;
        }
        .angles-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .angle-control {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .angle-value {
            margin-top: 5px;
            font-family: monospace;
            display: inline-block;
            width: 150px;
            text-align: center;
        }
        h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #444;
        }
        h3 {
            font-size: 1em;
            margin: 10px 0 5px 0;
            color: #555;
        }
        button {
            padding: 8px 16px;
            margin-top: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .template-btn {
            padding: 5px 10px;
            margin: 2px;
            background-color: #e8f4e8;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .template-btn:hover {
            background-color: #d8ecd8;
        }
        #customFunctionInput {
            font-size: 1.1em;
            padding: 8px;
            width: 100%;
            border: 1px solid #aaa;
            border-radius: 4px;
        }
        .error-message {
            color: #f44336;
            margin-top: 5px;
            font-size: 0.9em;
        }
        #debug-panel {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }
        
        .category-section {
            margin-bottom: 25px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .category-section h3 {
            color: #2c7744;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
            display: inline-block;
        }
        
        .template-category {
            margin-bottom: 15px;
        }
        
        .template-category h4 {
            color: #333;
            margin: 8px 0;
            font-size: 0.95em;
            font-weight: bold;
        }
        
        .template-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 5px;
            padding-left: 10px;
        }
        
        .template-btn {
            padding: 5px 10px;
            margin: 2px;
            background-color: #e8f4e8;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        .template-btn:hover {
            background-color: #d0e9d0;
            transform: translateY(-1px);
        }
        
        /* –†–∞–∑–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
        .category-section:nth-child(1) .template-btn { background-color: #e8f4e8; }
        .category-section:nth-child(2) .template-btn { background-color: #e8f0f4; }
        .category-section:nth-child(3) .template-btn { background-color: #f0e8f4; }
        .category-section:nth-child(4) .template-btn { background-color: #f4e8e8; }
        .category-section:nth-child(5) .template-btn { background-color: #f4f0e8; }
        .category-section:nth-child(6) .template-btn { background-color: #e8f4f0; }
        
        .category-section:nth-child(1) .template-btn:hover { background-color: #d0e9d0; }
        .category-section:nth-child(2) .template-btn:hover { background-color: #d0e5f0; }
        .category-section:nth-child(3) .template-btn:hover { background-color: #e5d0f0; }
        .category-section:nth-child(4) .template-btn:hover { background-color: #f0d0d0; }
        .category-section:nth-child(5) .template-btn:hover { background-color: #f0e5d0; }
        .category-section:nth-child(6) .template-btn:hover { background-color: #d0f0e5; }

        .input-group {
            margin-bottom: 10px;
        }

        .input-label {
            width: 80px;
            display: inline-block;
            font-weight: bold;
        }

        .function-mode-selector {
            margin-bottom: 15px;
            padding: 8px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }

        .function-mode-selector label {
            margin-right: 15px;
            cursor: pointer;
        }

        .template-category-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 10px;
            margin-bottom: 15px;
        }

        .template-column {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .template-example-row {
            grid-column: span 2;
            display: flex;
            justify-content: center;
            margin-top: 5px;
        }

        .template-tab {
            padding: 8px 15px;
            cursor: pointer;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            transition: background-color 0.2s;
        }

        .template-tab:hover {
            background-color: #e8e8e8;
        }

        .template-tab.active {
            background-color: #4CAF50;
            color: white;
            border-color: #3d8b40;
        }

        .template-tab-content {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
        }

        .template-tab-content.active {
            display: block;
        }

        .tab-icon {
            margin-right: 5px;
            font-size: 1.1em;
        }

        .export-btn {
            padding: 8px 16px;
            margin: 5px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .export-btn:hover {
            background-color: #0b7dda;
        }

        #notifications-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }

        .notification {
            background-color: #f8f9fa;
            border: 1px solid #4CAF50;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            position: relative;
        }

        .notification-title {
            margin: 0 0 5px 0;
            color: #4CAF50;
            padding-right: 20px;
        }

        .notification-message {
            font-size: 0.9em;
            color: #333;
        }

        .notification-close {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .canvas-wrapper {
            position: relative;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .right-panel {
            width: 520px;
            min-width: 520px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #progress-container {
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
        }
        
    </style>
</head>
<body>
    <h1>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π</h1>

    <div class="main-container">
        <div class="left-panel">

            <div class="collapsible-section">
                <div class="collapsible-header">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö–æ–ª—Å—Ç–∞</div>
                <div class="collapsible-content">
                    <h2>–†–∞–∑–º–µ—Ä—ã —Ö–æ–ª—Å—Ç–∞:</h2>
                    <div class="control-group">
                            <select id="canvasSizePreset" onchange="setCanvasSize()">
                                <option value="500x500">500 x 500 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>
                                <option value="800x600">800 x 600</option>
                                <option value="1024x768">1024 x 768</option>
                                <option value="1200x900">1200 x 900</option>
                                <option value="1600x1200">1600 x 1200</option>
                                <option value="1920x1080">1920 x 1080 (FullHD)</option>
                                <option value="custom">–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä</option>
                            </select>
                        </div>
                    </div>
                    <div class="control-group" style="margin-top: 15px;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; cursor: pointer; margin-right: 20px;">
                                <input type="checkbox" id="keepAspectRatioCheckbox" checked onchange="toggleAspectRatioMode()">
                                <span style="margin-left: 5px;">–°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω</span>
                            </label>
                            
                            <button id="resetSquareButton" onclick="resetToSquare()" 
                                    style="background-color: #4CAF50; color: white; border: none; 
                                    padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                –°–±—Ä–æ—Å–∏—Ç—å –¥–æ –∫–≤–∞–¥—Ä–∞—Ç–∞
                            </button>
                        </div>
                        <div id="aspectRatioInfo" style="font-size: 0.9em; color: #666; margin-top: 5px;">
                            –†–µ–∂–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–π –≤–∫–ª—é—á–µ–Ω. –û–±–ª–∞—Å—Ç—å –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è.
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer; margin-right: 20px;">
                            <input type="checkbox" id="linkSWithDomainCheckbox" checked onchange="toggleSLinkMode()">
                            <span style="margin-left: 5px;">–°–≤—è–∑–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä s —Å –æ–±–ª–∞—Å—Ç—å—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏</span>
                        </label>
                        <div id="sLinkInfo" style="font-size: 0.9em; color: #666; margin-top: 5px;">
                            –†–µ–∂–∏–º —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω. –û–±–ª–∞—Å—Ç—å –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ s.
                        </div>
                    </div>

                    <div class="control-row" id="customSizeControl" style="display: none; margin-top: 10px;">
                        <div class="control-group">
                            <div class="param-input">
                                <label for="canvasWidth">–®–∏—Ä–∏–Ω–∞:</label>
                                <input type="number" id="canvasWidth" min="100" max="4000" value="500" style="width: 80px;">
                                <span style="margin: 0 10px;">x</span>
                                <label for="canvasHeight">–í—ã—Å–æ—Ç–∞:</label>
                                <input type="number" id="canvasHeight" min="100" max="4000" value="500" style="width: 80px;">
                                <button onclick="applyCustomSize()" style="margin-left: 10px;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                            </div>
                        </div>
                    
                    <h2>–û–±–ª–∞—Å—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏:</h2>
                    <div class="control-row">
                        <div class="control-group">
                            <div class="param-input">
                                <label for="xMin">X –º–∏–Ω:</label>
                                <input type="number" id="xMin" step="0.1" value="-3.14" style="width: 80px;">
                                <label for="xMax" style="margin-left: 10px;">X –º–∞–∫—Å:</label>
                                <input type="number" id="xMax" step="0.1" value="3.14" style="width: 80px;">
                            </div>
                            <div class="param-input">
                                <label for="yMin">Y –º–∏–Ω:</label>
                                <input type="number" id="yMin" step="0.1" value="-3.14" style="width: 80px;">
                                <label for="yMax" style="margin-left: 10px;">Y –º–∞–∫—Å:</label>
                                <input type="number" id="yMax" step="0.1" value="3.14" style="width: 80px;">
                            </div>
                            <button onclick="applyComplexDomain()" style="margin-top: 10px;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ–±–ª–∞—Å—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section">
                <div class="collapsible-header">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–µ–π –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏</div>
                <div class="collapsible-content visible">

                    <div class="function-mode-selector" style="margin-bottom: 15px;">
                        <h2>–†–µ–∂–∏–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:</h2>
                        <div style="display: flex; margin-bottom: 10px;">
                            <div style="margin-right: 20px;">
                                <label>
                                    <input type="radio" name="vizMode" id="domainColoringRadio" checked onchange="toggleVizMode()">
                                    –†–∞—Å–∫—Ä–∞—Å–∫–∞ –æ–±–ª–∞—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                                </label>
                            </div>
                            <div>
                                <label>
                                    <input type="radio" name="vizMode" id="conformalMapRadio" onchange="toggleVizMode()">
                                    –ö–æ–Ω—Ñ–æ—Ä–º–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                </label>
                            </div>
                        </div>
                    </div>

                    <div id="conformalSettingsContainer" style="display: none; margin-bottom: 20px; padding: 10px; background-color: #f9f9f9; border-radius: 4px; border: 1px solid #eee;">
                        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ñ–æ—Ä–º–Ω—ã—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–π:</h2>
                        
                        <div class="control-group">
                            <h3>–¢–∏–ø —Å–µ—Ç–∫–∏:</h3>
                            <select id="gridType" onchange="updateGridType()">
                                <option value="rectangular">–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è</option>
                                <option value="polar">–ü–æ–ª—è—Ä–Ω–∞—è</option>
                                <option value="chessboard">–®–∞—Ö–º–∞—Ç–Ω–æ–µ –ø–æ–ª–µ</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <h3>–ü–ª–æ—Ç–Ω–æ—Å—Ç—å —Å–µ—Ç–∫–∏:</h3>
                            <div class="param-input">
                                <label for="gridDensitySlider">–ü–ª–æ—Ç–Ω–æ—Å—Ç—å:</label>
                                <input type="range" id="gridDensitySlider" min="4" max="50" step="1" value="10" oninput="updateGridDensity()">
                                <input type="number" id="gridDensityValue" min="4" step="1" value="10" oninput="updateGridDensityFromInput()">
                            </div>
                        </div>

                        <div class="control-group">
                            <h3>–¶–≤–µ—Ç–∞ —Å–µ—Ç–∫–∏:</h3>
                            <div style="display: flex; gap: 20px;">
                                <div class="param-input">
                                    <label for="gridColor1">–¶–≤–µ—Ç 1:</label>
                                    <input type="color" id="gridColor1" value="#000000" onchange="updateGridColor1()">
                                </div>
                                <div class="param-input">
                                    <label for="gridColor2">–¶–≤–µ—Ç 2:</label>
                                    <input type="color" id="gridColor2" value="#ffffff" onchange="updateGridColor2()">
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <h3>–¶–≤–µ—Ç —Ñ–æ–Ω–∞:</h3>
                            <div class="param-input">
                                <label for="gridBackgroundColor">–¶–≤–µ—Ç —Ñ–æ–Ω–∞:</label>
                                <input type="color" id="gridBackgroundColor" value="#ffffff" onchange="updateGridBackgroundColor()">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <h3>–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–π —Å–µ—Ç–∫–∏ (–∫—Ä–æ–º–µ —à–∞—Ö–º–∞—Ç–Ω–æ–≥–æ –ø–æ–ª—è):</h3>
                            <div class="param-input">
                                <label for="gridLineWidthSlider">–¢–æ–ª—â–∏–Ω–∞:</label>
                                <input type="range" id="gridLineWidthSlider" min="1" max="20" step="1" value="2" oninput="updateGridLineWidth()">
                                <input type="number" id="gridLineWidthValue" min="1" step="1" value="2" oninput="updateGridLineWidthFromInput()">
                                <span style="margin-left: 5px;">%</span>
                            </div>
                        </div>
                    </div>

                    <div class="control-row">
                        <div class="control-group">
                            <h2>–ú–µ—Ç–æ–¥ —Ä–∞—Å—á–µ—Ç–∞ L:</h2>
                            <select id="lMethod" onchange="updateMethodControls(); updateVisualization()">
                                <option value="0">–†–∞–≤–Ω–æ–º–µ—Ä–Ω–∞—è —è—Ä–∫–æ—Å—Ç—å</option>
                                <option value="1">–†–∞–¥–∏–∞–ª—å–Ω–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ</option>
                                <option value="2">–û–±—ä—ë–º–Ω–∞—è —Å–µ—Ç–∫–∞</option>
                                <option value="3">–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è –æ–±—ä—ë–º–Ω–∞—è —Å–µ—Ç–∫–∞</option>
                                <option value="4">–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è –ø–ª–æ—Å–∫–∞—è —Å–µ—Ç–∫–∞</option>
                                <option value="5">–®–∞—Ö–º–∞—Ç–Ω–∞—è —Å–µ—Ç–∫–∞</option>
                                <option value="6">–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∞—Ö–º–∞—Ç–Ω–∞—è —Å–µ—Ç–∫–∞</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <h2>–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã:</h2>
                            <div class="param-input" id="sContainer">
                                <label for="sSlider">–ú–∞—Å—à—Ç–∞–±</label>
                                <input type="range" id="sSlider" min="0.1" max="10" step="0.1" value="6.28" oninput="updateConstant('s')">
                                <input type="number" id="sValue" min="0.1" step="0.1" value="6.28" oninput="updateConstantFromInput('s')">
                            </div>

                            <div class="param-input" id="dContainer">
                                <label for="dSlider">–ü–ª–æ—Ç–Ω–æ—Å—Ç—å —Å–µ—Ç–∫–∏</label>
                                <input type="range" id="dSlider" min="1" max="10" step="0.1" value="4" oninput="updateConstant('d')">
                                <input type="number" id="dValue" min="0.1" step="0.1" value="4" oninput="updateConstantFromInput('d')">
                            </div>

                            <div class="param-input" id="lContainer">
                                <label for="lSlider">–ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å</label>
                                <input type="range" id="lSlider" min="0.1" max="10" step="0.1" value="2" oninput="updateConstant('l')">
                                <input type="number" id="lValue" min="0.1" step="0.1" value="2" oninput="updateConstantFromInput('l')">
                            </div>

                            <div class="param-input" id="pContainer">
                                <label for="pSlider">–°–∫–æ—Ä–æ—Å—Ç—å –∑–∞—Ç—É—Ö–∞–Ω–∏—è</label>
                                <input type="range" id="pSlider" min="0.1" max="5" step="0.1" value="1" oninput="updateConstant('p')">
                                <input type="number" id="pValue" min="0.1" step="0.1" value="1" oninput="updateConstantFromInput('p')">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h2>–£–≥–ª—ã –ø–æ–≤–æ—Ä–æ—Ç–∞:</h2>
                        <div class="angles-container">
                            <div class="angle-control">
                                <h3>–ü–æ–≤–æ—Ä–æ—Ç z</h3>
                                <div class="circular-slider" id="thetaCircularSlider">
                                    <canvas id="thetaCanvas" width="150" height="150" class="control-canvas"></canvas>
                                </div>
                                <div class="angle-value" id="thetaValue">0 (0 —Ä–∞–¥)</div>
                            </div>

                            <div class="angle-control">
                                <h3>–ü–æ–≤–æ—Ä–æ—Ç f(z)</h3>
                                <div class="circular-slider" id="phiCircularSlider">
                                    <canvas id="phiCanvas" width="150" height="150" class="control-canvas"></canvas>
                                </div>
                                <div class="angle-value" id="phiValue">0 (0 —Ä–∞–¥)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section">
                <div class="collapsible-header">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è</div>
                <div class="collapsible-content visible">
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; margin-bottom: 10px;">
                            <div style="margin-right: 20px;">
                                <label>
                                    <input type="radio" name="inputMode" id="zModeRadio" checked onchange="toggleInputMode()">
                                    –§—É–Ω–∫—Ü–∏—è –æ—Ç z
                                </label>
                            </div>
                            <div>
                                <label>
                                    <input type="radio" name="inputMode" id="xyModeRadio" onchange="toggleInputMode()">
                                    –§—É–Ω–∫—Ü–∏—è –æ—Ç (x,y) —á–µ—Ä–µ–∑ Re –∏ Im
                                </label>
                            </div>
                        </div>
                        
                        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ z -->
                        <div id="zInputContainer" style="display: flex; margin-bottom: 10px;">
                            <input type="text" id="customFunctionInput" style="flex-grow: 1; padding: 8px; font-family: monospace;" value="(z^3 + i) / z" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–≥–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: z^2 + 1">
                            <button onclick="updateVisualization()" style="margin-left: 10px;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        </div>
                        
                        <!-- –ü–æ–ª—è –≤–≤–æ–¥–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ (x,y) -->
                        <div id="xyInputContainer" style="display: none; margin-bottom: 10px;">
                            <div style="display: flex; margin-bottom: 5px;">
                                <label style="width: 80px; line-height: 36px;">Re(x,y) = </label>
                                <input type="text" id="reFunction" style="flex-grow: 1; padding: 8px; font-family: monospace;" value="x" placeholder="–í—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π —á–∞—Å—Ç–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: x/(x^2+y^2)">
                            </div>
                            <div style="display: flex; margin-bottom: 5px;">
                                <label style="width: 80px; line-height: 36px;">Im(x,y) = </label>
                                <input type="text" id="imFunction" style="flex-grow: 1; padding: 8px; font-family: monospace;" value="y" placeholder="–í—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –º–Ω–∏–º–æ–π —á–∞—Å—Ç–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: y/(x^2+y^2)">
                            </div>
                            <div style="text-align: right;">
                                <button onclick="updateVisualization()" style="padding: 8px 16px;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section">
                <div class="collapsible-header">–®–∞–±–ª–æ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–π</div>
                <div class="collapsible-content">
                    <div class="template-category-grid">
                        <div class="template-column">
                            <div class="template-tab active" onclick="changeTab(event, 'basic')">
                                <span class="tab-icon">‚öôÔ∏è</span> –ë–∞–∑–æ–≤—ã–µ
                            </div>
                            <div class="template-tab" onclick="changeTab(event, 'trig')">
                                <span class="tab-icon">üìê</span> –¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ
                            </div>
                            <div class="template-tab" onclick="changeTab(event, 'special')">
                                <span class="tab-icon">üîç</span> –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ
                            </div>
                        </div>
                        <div class="template-column">
                            <div class="template-tab" onclick="changeTab(event, 'hyper')">
                                <span class="tab-icon">‚öõÔ∏è</span> –ì–∏–ø–µ—Ä–±–æ–ª–∏—á–µ—Å–∫–∏–µ
                            </div>
                            <div class="template-tab" onclick="changeTab(event, 'poly')">
                                <span class="tab-icon">üìä</span> –ü–æ–ª–∏–Ω–æ–º—ã
                            </div>
                            <div class="template-tab" onclick="changeTab(event, 'comp')">
                                <span class="tab-icon">üîÑ</span> –ö–æ–º–ø–æ–∑–∏—Ü–∏–∏
                            </div>
                        </div>
                        <div class="template-example-row">
                            <div class="template-tab" onclick="changeTab(event, 'examples')">
                                <span class="tab-icon">üìù</span> –ü—Ä–∏–º–µ—Ä—ã
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ë–∞–∑–æ–≤—ã–µ -->
                    <div class="template-tab-content active" id="basic">
                        <h3>–ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
                        <div class="templates-grid">
                            <button onclick="insertTemplate('z')" class="template-btn">z</button>
                            <button onclick="insertTemplate('(a + b)')" class="template-btn">a + b</button>
                            <button onclick="insertTemplate('(a - b)')" class="template-btn">a - b</button>
                            <button onclick="insertTemplate('(a * b)')" class="template-btn">a * b</button>
                            <button onclick="insertTemplate('(a / b)')" class="template-btn">a / b</button>
                            <button onclick="insertTemplate('a^b')" class="template-btn">a^b</button>
                            <button onclick="insertTemplate('1/z')" class="template-btn">1/z</button>
                            <button onclick="insertTemplate('-z')" class="template-btn">-z</button>
                            <button onclick="insertTemplate('mod(a, b)')" class="template-btn">a mod b</button>
                        </div>
                        
                        <h3>–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã</h3>
                        <div class="templates-grid">
                            <button onclick="insertTemplate('i')" class="template-btn">i</button>
                            <button onclick="insertTemplate('e')" class="template-btn">e</button>
                            <button onclick="insertTemplate('pi')" class="template-btn">œÄ</button>
                            <button onclick="insertTemplate('phi')" class="template-btn">œÜ</button>
                            <button onclick="insertTemplate('gamma')" class="template-btn">Œ≥</button>
                            <button onclick="insertTemplate('infinity')" class="template-btn">‚àû</button>
                            <button onclick="insertTemplate('sqrt(2)')" class="template-btn">‚àö2</button>
                            <button onclick="insertTemplate('sqrt(3)')" class="template-btn">‚àö3</button>
                        </div>
                        
                        <h3>–°–≤–æ–π—Å—Ç–≤–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö —á–∏—Å–µ–ª</h3>
                        <div class="templates-grid">
                            <button onclick="insertTemplate('abs(z)')" class="template-btn">|z|</button>
                            <button onclick="insertTemplate('arg(z)')" class="template-btn">arg(z)</button>
                            <button onclick="insertTemplate('conj(z)')" class="template-btn">z*</button>
                            <button onclick="insertTemplate('re(z)')" class="template-btn">Re(z)</button>
                            <button onclick="insertTemplate('im(z)')" class="template-btn">Im(z)</button>
                            <button onclick="insertTemplate('1/conj(z)')" class="template-btn">1/z*</button>
                            <button onclick="insertTemplate('z * conj(z)')" class="template-btn">z * z*</button>
                        </div>
                        
                        <h3>–°—Ç–µ–ø–µ–Ω–Ω—ã–µ –∏ –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∏–µ</h3>
                        <div class="templates-grid">
                            <button onclick="insertTemplate('z^n')" class="template-btn">z^n</button>
                            <button onclick="insertTemplate('z^(1/n)')" class="template-btn">z^(1/n)</button>
                            <button onclick="insertTemplate('exp(z)')" class="template-btn">e^z</button>
                            <button onclick="insertTemplate('log(z)')" class="template-btn">ln(z)</button>
                            <button onclick="insertTemplate('log10(z)')" class="template-btn">log‚ÇÅ‚ÇÄ(z)</button>
                            <button onclick="insertTemplate('log(a, b)')" class="template-btn">log_a(b)</button>
                            <button onclick="insertTemplate('sqrt(z)')" class="template-btn">‚àöz</button>
                            <button onclick="insertTemplate('cbrt(z)')" class="template-btn">cbrt(z)</button>
                        </div>
                    </div>
                    
                    <!-- –¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ -->
                    <div class="template-tab-content" id="trig">
                        <h3>–û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ</h3>
                        <div class="templates-grid">
                            <button onclick="smartInsert('sin(z)', 'sin(z)')" class="template-btn">sin(z)</button>
                            <button onclick="smartInsert('cos(z)', 'cos(z)')" class="template-btn">cos(z)</button>
                            <button onclick="smartInsert('tan(z)', 'tan(z)')" class="template-btn">tan(z)</button>
                        </div>
                        
                        <h3>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ</h3>
                        <div class="templates-grid">
                            <button onclick="smartInsert('sec(z)', 'sec(z)')" class="template-btn">sec(z)</button>
                            <button onclick="smartInsert('csc(z)', 'csc(z)')" class="template-btn">csc(z)</button>
                            <button onclick="smartInsert('cot(z)', 'cot(z)')" class="template-btn">cot(z)</button>
                        </div>
                        
                        <h3>–û–±—Ä–∞—Ç–Ω—ã–µ —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ</h3>
                        <div class="templates-grid">
                            <button onclick="smartInsert('asin(z)', 'asin(z)')" class="template-btn">asin(z)</button>
                            <button onclick="smartInsert('acos(z)', 'acos(z)')" class="template-btn">acos(z)</button>
                            <button onclick="smartInsert('atan(z)', 'atan(z)')" class="template-btn">atan(z)</button>
                            <button onclick="smartInsert('asec(z)', 'asec(z)')" class="template-btn">asec(z)</button>
                            <button onclick="smartInsert('acsc(z)', 'acsc(z)')" class="template-btn">acsc(z)</button>
                            <button onclick="smartInsert('acot(z)', 'acot(z)')" class="template-btn">acot(z)</button>
                        </div>
                        
                        <h3>–§—É–Ω–∫—Ü–∏–∏ –ì—É–¥–µ—Ä–º–∞–Ω–∞</h3>
                        <div class="templates-grid">
                            <button onclick="smartInsert('gd(z)', 'gd(z)')" class="template-btn">gd(z)</button>
                            <button onclick="smartInsert('gdInv(z)', 'gdInv(z)')" class="template-btn">gd‚Åª¬π(z)</button>
                            <button onclick="setFunction('gd(z)')" class="template-btn">f(z) = gd(z)</button>
                            <button onclick="setFunction('gdInv(z)')" class="template-btn">f(z) = gd‚Åª¬π(z)</button>
                        </div>
                    </div>
                    
                    <!-- –ì–∏–ø–µ—Ä–±–æ–ª–∏—á–µ—Å–∫–∏–µ -->
                    <div class="template-tab-content" id="hyper">
                        <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –≥–∏–ø–µ—Ä–±–æ–ª–∏—á–µ—Å–∫–∏–µ</h3>
                        <div class="templates-grid">
                            <button onclick="smartInsert('sinh(z)', 'sinh(z)')" class="template-btn">sinh(z)</button>
                            <button onclick="smartInsert('cosh(z)', 'cosh(z)')" class="template-btn">cosh(z)</button>
                            <button onclick="smartInsert('tanh(z)', 'tanh(z)')" class="template-btn">tanh(z)</button>
                        </div>
                        
                        <h3>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≥–∏–ø–µ—Ä–±–æ–ª–∏—á–µ—Å–∫–∏–µ</h3>
                        <div class="templates-grid">
                            <button onclick="smartInsert('sech(z)', 'sech(z)')" class="template-btn">sech(z)</button>
                            <button onclick="smartInsert('csch(z)', 'csch(z)')" class="template-btn">csch(z)</button>
                            <button onclick="smartInsert('coth(z)', 'coth(z)')" class="template-btn">coth(z)</button>
                        </div>
                        
                        <h3>–û–±—Ä–∞—Ç–Ω—ã–µ –≥–∏–ø–µ—Ä–±–æ–ª–∏—á–µ—Å–∫–∏–µ</h3>
                        <div class="templates-grid">
                            <button onclick="smartInsert('asinh(z)', 'asinh(z)')" class="template-btn">asinh(z)</button>
                            <button onclick="smartInsert('acosh(z)', 'acosh(z)')" class="template-btn">acosh(z)</button>
                            <button onclick="smartInsert('atanh(z)', 'atanh(z)')" class="template-btn">atanh(z)</button>
                            <button onclick="smartInsert('asech(z)', 'asech(z)')" class="template-btn">asech(z)</button>
                            <button onclick="smartInsert('acsch(z)', 'acsch(z)')" class="template-btn">acsch(z)</button>
                            <button onclick="smartInsert('acoth(z)', 'acoth(z)')" class="template-btn">acoth(z)</button>
                        </div>
                    </div>
                    
                    <!-- –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ -->
                    <div class="template-tab-content" id="special">
                        <h3>–ì–∞–º–º–∞-—Ñ—É–Ω–∫—Ü–∏—è –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ</h3>
                        <div class="templates-grid">
                            <button onclick="smartInsert('gamma(z)', 'gamma(z)')" class="template-btn">Œì(z)</button>
                            <button onclick="smartInsert('factorial(z)', 'factorial(z)')" class="template-btn">z!</button>
                            <button onclick="setFunction('gamma(z) * gamma(1 - z)')" class="template-btn">Œì(z)Œì(1-z)</button>
                        </div>
                        
                        <h3>–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h3>
                        <div class="templates-grid">
                            <button onclick="smartInsert('zeta(z)', 'zeta(z)')" class="template-btn">Œ∂(z)</button>
                            <button onclick="smartInsert('erf(z)', 'erf(z)')" class="template-btn">erf(z)</button>
                            <button onclick="smartInsert('lambertW(z)', 'lambertW(z)')" class="template-btn">W(z)</button>
                        </div>
                        
                        <h3>–§—É–Ω–∫—Ü–∏–∏ –ë–µ—Å—Å–µ–ª—è –∏ –≠–π—Ä–∏</h3>
                        <div class="templates-grid">
                            <button onclick="insertTemplate('besselJ(n, z)')" class="template-btn">J_n(z)</button>
                            <button onclick="insertTemplate('besselY(n, z)')" class="template-btn">Y_n(z)</button>
                            <button onclick="smartInsert('airyAi(z)', 'airyAi(z)')" class="template-btn">Ai(z)</button>
                            <button onclick="insertTemplate('airyBi(z)')" class="template-btn">Bi(z)</button>
                            <button onclick="setFunction('besselJ(0, z)')" class="template-btn">J‚ÇÄ(z)</button>
                            <button onclick="setFunction('besselJ(1, z)')" class="template-btn">J‚ÇÅ(z)</button>
                        </div>
                        
                        <h3>–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h3>
                        <div class="templates-grid">
                            <button onclick="smartInsert('sinc(z)', 'sinc(z)')" class="template-btn">sinc(z)</button>
                            <button onclick="smartInsert('Si(z)', 'Si(z)')" class="template-btn">Si(z)</button>
                            <button onclick="smartInsert('Ci(z)', 'Ci(z)')" class="template-btn">Ci(z)</button>
                            <button onclick="smartInsert('Ei(z)', 'Ei(z)')" class="template-btn">Ei(z)</button>
                            <button onclick="smartInsert('fresnelS(z)', 'fresnelS(z)')" class="template-btn">S(z)</button>
                            <button onclick="smartInsert('fresnelC(z)', 'fresnelC(z)')" class="template-btn">C(z)</button>
                            <button onclick="setFunction('sinc(z)')" class="template-btn">f(z) = sinc(z)</button>
                        </div>
                        
                        <h3>–û—Ä—Ç–æ–≥–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª–∏–Ω–æ–º—ã</h3>
                        <div class="templates-grid">
                            <button onclick="smartInsert('legendre(n, z)', 'legendre(2, z)')" class="template-btn">P_n(z)</button>
                            <button onclick="smartInsert('chebyshevT(n, z)', 'chebyshevT(2, z)')" class="template-btn">T_n(z)</button>
                            <button onclick="smartInsert('chebyshevU(n, z)', 'chebyshevU(2, z)')" class="template-btn">U_n(z)</button>
                            <button onclick="setFunction('legendre(2, z)')" class="template-btn">P‚ÇÇ(z)</button>
                            <button onclick="setFunction('chebyshevT(3, z)')" class="template-btn">T‚ÇÉ(z)</button>
                        </div>
                        
                        <h3>–≠–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏</h3>
                        <div class="templates-grid">
                            <button onclick="smartInsert('ellipticSn(z, 0.5)', 'ellipticSn(z, 0.5)')" class="template-btn">sn(z,k)</button>
                            <button onclick="smartInsert('ellipticCn(z, 0.5)', 'ellipticCn(z, 0.5)')" class="template-btn">cn(z,k)</button>
                            <button onclick="smartInsert('ellipticDn(z, 0.5)', 'ellipticDn(z, 0.5)')" class="template-btn">dn(z,k)</button>
                            <button onclick="smartInsert('ellipticK(0.5)', 'ellipticK(0.5)')" class="template-btn">K(k)</button>
                            <button onclick="smartInsert('ellipticE(0.5)', 'ellipticE(0.5)')" class="template-btn">E(k)</button>
                            <button onclick="smartInsert('weierstrassP(z, 1, 0.5)', 'weierstrassP(z, 1, 0.5)')" class="template-btn">‚Ñò(z,g‚ÇÇ,g‚ÇÉ)</button>
                        </div>
                        
                        <h3>–¢–µ—Ç–∞-—Ñ—É–Ω–∫—Ü–∏–∏ –Ø–∫–æ–±–∏</h3>
                        <div class="templates-grid">
                            <button onclick="smartInsert('theta1(z, 0.5)', 'theta1(z, 0.5)')" class="template-btn">Œ∏‚ÇÅ(z,q)</button>
                            <button onclick="smartInsert('theta2(z, 0.5)', 'theta2(z, 0.5)')" class="template-btn">Œ∏‚ÇÇ(z,q)</button>
                            <button onclick="smartInsert('theta3(z, 0.5)', 'theta3(z, 0.5)')" class="template-btn">Œ∏‚ÇÉ(z,q)</button>
                            <button onclick="smartInsert('theta4(z, 0.5)', 'theta4(z, 0.5)')" class="template-btn">Œ∏‚ÇÑ(z,q)</button>
                            <button onclick="smartInsert('thetaGeneral(z, math.complex(0, 1), 0, 0)', 'thetaGeneral(z, math.complex(0, 1), 0, 0)')" class="template-btn">Œ∏[a,b](z,œÑ)</button>
                            <button onclick="setFunction('theta3(z, 0.5)')" class="template-btn">f(z) = Œ∏‚ÇÉ(z,0.5)</button>
                            <button onclick="setFunction('theta1(z, 0.7)')" class="template-btn">f(z) = Œ∏‚ÇÅ(z,0.7)</button>
                        </div>
                        
                        <h3>–î—Ä—É–≥–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h3>
                        <div class="templates-grid">
                            <button onclick="smartInsert('polylog(2, z)', 'polylog(2, z)')" class="template-btn">Li_s(z)</button>
                            <button onclick="smartInsert('dirichlet(5, z)', 'dirichlet(5, z)')" class="template-btn">D_n(z)</button>
                            <button onclick="smartInsert('lorentz(z, 0.1)', 'lorentz(z, 0.1)')" class="template-btn">L(z,Œ≥)</button>
                            <button onclick="smartInsert('landau(z)', 'landau(z)')" class="template-btn">Œ¶(z)</button>
                            <button onclick="smartInsert('wright(0.5, 1, z)', 'wright(0.5, 1, z)')" class="template-btn">W(a,b,z)</button>
                            <button onclick="setFunction('polylog(2, z)')" class="template-btn">f(z) = Li‚ÇÇ(z)</button>
                            <button onclick="setFunction('landau(z)')" class="template-btn">f(z) = Œ¶(z)</button>
                        </div>

                        <h3>–î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å—É–º–º—ã</h3>
                        <div class="templates-grid">
                            <button onclick="smartInsert('diff(z, z)', 'diff(z, z)')" class="template-btn">f'(z)</button>
                            <button onclick="smartInsert('deriv(z, 2)', 'deriv(z, 2)')" class="template-btn">f''(z)</button>
                            <button onclick="smartInsert('sum(z^k, k, 1, n)', 'sum(z^k, k, 1, 10)')" class="template-btn">Œ£z^k</button>
                            <button onclick="smartInsert('series(z^k/factorial(k), k, 0)', 'series(z^k/factorial(k), k, 0, 20)')" class="template-btn">Œ£z^k/k!</button>
                            <button onclick="setFunction('diff(sin(z), z)')" class="template-btn">f(z) = sin'(z)</button>
                            <button onclick="setFunction('deriv(exp(z), 2)')" class="template-btn">f(z) = exp''(z)</button>
                        </div>

                    </div>
                    
                    <!-- –ü–æ–ª–∏–Ω–æ–º—ã -->
                    <div class="template-tab-content" id="poly">
                        <h3>–ü–æ–ª–∏–Ω–æ–º—ã</h3>
                        <div class="templates-grid">
                            <button onclick="setFunction('z^2')" class="template-btn">f(z) = z¬≤</button>
                            <button onclick="setFunction('z^3 - 1')" class="template-btn">f(z) = z¬≥ - 1</button>
                            <button onclick="setFunction('z^4 - 1')" class="template-btn">f(z) = z‚Å¥ - 1</button>
                            <button onclick="setFunction('z^5 - 1')" class="template-btn">f(z) = z‚Åµ - 1</button>
                            <button onclick="setFunction('z^2 - z - 1')" class="template-btn">f(z) = z¬≤ - z - 1</button>
                            <button onclick="setFunction('z^3 - z')" class="template-btn">f(z) = z¬≥ - z</button>
                            <button onclick="setFunction('z^4 - z^2')" class="template-btn">f(z) = z‚Å¥ - z¬≤</button>
                            <button onclick="setFunction('z^2 + z + 1')" class="template-btn">f(z) = z¬≤ + z + 1</button>
                        </div>
                        
                        <h3>–†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h3>
                        <div class="templates-grid">
                            <button onclick="setFunction('1/z')" class="template-btn">f(z) = 1/z</button>
                            <button onclick="setFunction('(z^3 + i) / z')" class="template-btn">f(z) = (z¬≥ + i) / z</button>
                            <button onclick="setFunction('(z^2 - 1)/(z^2 + 1)')" class="template-btn">f(z) = (z¬≤ - 1)/(z¬≤ + 1)</button>
                            <button onclick="setFunction('(z^2 - 4)/(z^2 - 1)')" class="template-btn">f(z) = (z¬≤ - 4)/(z¬≤ - 1)</button>
                            <button onclick="setFunction('(z^3 - 1)/(z - 1)')" class="template-btn">f(z) = (z¬≥ - 1)/(z - 1)</button>
                            <button onclick="setFunction('z/(z^2 + 1)')" class="template-btn">f(z) = z/(z¬≤ + 1)</button>
                        </div>
                    </div>
                    
                    <!-- –ö–æ–º–ø–æ–∑–∏—Ü–∏–∏ -->
                    <div class="template-tab-content" id="comp">
                        <h3>–ö–æ–º–ø–æ–∑–∏—Ü–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π</h3>
                        <div class="templates-grid">
                            <button onclick="setFunction('sin(z^2)')" class="template-btn">f(z) = sin(z¬≤)</button>
                            <button onclick="setFunction('exp(sin(z))')" class="template-btn">f(z) = e^(sin(z))</button>
                            <button onclick="setFunction('log(sin(z))')" class="template-btn">f(z) = ln(sin(z))</button>
                            <button onclick="setFunction('z * exp(z)')" class="template-btn">f(z) = z * e^z</button>
                            <button onclick="setFunction('z * log(z)')" class="template-btn">f(z) = z * ln(z)</button>
                            <button onclick="setFunction('sin(z)/z')" class="template-btn">f(z) = sin(z)/z</button>
                            <button onclick="setFunction('(exp(z) - 1)/z')" class="template-btn">f(z) = (e^z - 1)/z</button>
                            <button onclick="setFunction('exp(1/z)')" class="template-btn">f(z) = e^(1/z)</button>
                            <button onclick="setFunction('log(1 + z)')" class="template-btn">f(z) = ln(1 + z)</button>
                            <button onclick="setFunction('exp(-z^2)')" class="template-btn">f(z) = e^(-z¬≤)</button>
                        </div>
                        
                        <h3>–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏</h3>
                        <div class="templates-grid">
                            <button onclick="insertTemplate('(z^2 + a)/(z^2 - a)')" class="template-btn">(z¬≤ + a)/(z¬≤ - a)</button>
                            <button onclick="insertTemplate('exp(i*z)')" class="template-btn">e^(iz)</button>
                            <button onclick="insertTemplate('sin(z)/z')" class="template-btn">sin(z)/z</button>
                            <button onclick="insertTemplate('exp(-z^2)')" class="template-btn">e^(-z¬≤)</button>
                            <button onclick="insertTemplate('log(1 + z)/(1 + z)')" class="template-btn">ln(1+z)/(1+z)</button>
                            <button onclick="insertTemplate('z/(e^z - 1)')" class="template-btn">z/(e^z - 1)</button>
                            <button onclick="insertTemplate('(z - a)/(1 - conj(a)*z)')" class="template-btn">–ú—ë–±–∏—É—Å</button>
                            <button onclick="insertTemplate('(z^n - 1)/(z - 1)')" class="template-btn">–°—É–º–º–∞ z^k</button>
                        </div>
                    </div>
                    
                    <!-- –ü—Ä–∏–º–µ—Ä—ã -->
                    <div class="template-tab-content" id="examples">
                        <h3>–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–æ–∂–¥–µ—Å—Ç–≤–∞</h3>
                        <div class="templates-grid">
                            <button onclick="setFunction('exp(i*z)')" class="template-btn">f(z) = e^(iz)</button>
                            <button onclick="setFunction('cos(z) + i*sin(z)')" class="template-btn">f(z) = cos(z) + i*sin(z)</button>
                            <button onclick="setFunction('(exp(z) - exp(-z))/2')" class="template-btn">f(z) = sinh(z)</button>
                            <button onclick="setFunction('(exp(z) + exp(-z))/2')" class="template-btn">f(z) = cosh(z)</button>
                            <button onclick="setFunction('i^z')" class="template-btn">f(z) = i^z</button>
                            <button onclick="setFunction('z^i')" class="template-btn">f(z) = z^i</button>
                            <button onclick="setFunction('z^z')" class="template-btn">f(z) = z^z</button>
                        </div>
                        
                        <h3>–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ñ—É–∫–æ–≤—Å–∫–æ–≥–æ</h3>
                        <div class="templates-grid">
                            <button onclick="setFunction('(z + 1/z)/2')" class="template-btn">f(z) = (z + 1/z)/2</button>
                            <button onclick="setFunction('(z - 1/z)/2')" class="template-btn">f(z) = (z - 1/z)/2</button>
                            <button onclick="setFunction('(z + 1/z)/2 + i*(z - 1/z)/2')" class="template-btn">f(z) = Re(z) + i*Im(z)¬≤</button>
                            <button onclick="setFunction('z/(exp(z) - 1)')" class="template-btn">f(z) = z/(e^z - 1)</button>
                        </div>
                        
                        <h3>–§—É–Ω–∫—Ü–∏–∏ –ú—ë–±–∏—É—Å–∞</h3>
                        <div class="templates-grid">
                            <button onclick="setFunction('(z - 1)/(z + 1)')" class="template-btn">f(z) = (z - 1)/(z + 1)</button>
                            <button onclick="setFunction('(z^2 - 1)/(z^2 + 1)')" class="template-btn">f(z) = (z¬≤ - 1)/(z¬≤ + 1)</button>
                            <button onclick="setFunction('(z - i)/(z + i)')" class="template-btn">f(z) = (z - i)/(z + i)</button>
                            <button onclick="setFunction('z/(z^2 + 2*z + 2)')" class="template-btn">f(z) = z/(z¬≤ + 2z + 2)</button>
                        </div>
                        
                        <h3>–§—É–Ω–∫—Ü–∏–∏ –∏–∑ –∫–≤–∞–Ω—Ç–æ–≤–æ–π –º–µ—Ö–∞–Ω–∏–∫–∏</h3>
                        <div class="templates-grid">
                            <button onclick="setFunction('exp(-z*conj(z))')" class="template-btn">f(z) = e^(-|z|¬≤)</button>
                            <button onclick="setFunction('(z^2)*exp(-z*conj(z))')" class="template-btn">f(z) = z¬≤e^(-|z|¬≤)</button>
                            <button onclick="setFunction('z*exp(-abs(z))')" class="template-btn">f(z) = z*e^(-|z|)</button>
                        </div>
                        
                        <h3>–§—Ä–∞–∫—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h3>
                        <div class="templates-grid">
                            <button onclick="setFunction('z^2 - 0.75')" class="template-btn">f(z) = z¬≤ - 0.75</button>
                            <button onclick="setFunction('z^2 - 0.123 + 0.745i')" class="template-btn">f(z) = z¬≤ - 0.123 + 0.745i</button>
                            <button onclick="setFunction('z^2 + 0.36 + 0.1i')" class="template-btn">f(z) = z¬≤ + 0.36 + 0.1i</button>
                            <button onclick="setFunction('z^2 - 1.25')" class="template-btn">f(z) = z¬≤ - 1.25</button>
                            <button onclick="setFunction('z^3 - 1 + 0.1i')" class="template-btn">f(z) = z¬≥ - 1 + 0.1i</button>
                        </div>
                        
                        <h3>–ü—Ä–∏–º–µ—Ä—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ Re/Im</h3>
                        <div class="templates-grid">
                            <button onclick="setReImFunction('x', 'y')" class="template-btn">f(z) = z</button>
                            <button onclick="setReImFunction('x/(x^2+y^2)', 'y/(x^2+y^2)')" class="template-btn">f(z) = 1/z</button>
                            <button onclick="setReImFunction('x^2-y^2', '2*x*y')" class="template-btn">f(z) = z^2</button>
                            <button onclick="setReImFunction('exp(x)*cos(y)', 'exp(x)*sin(y)')" class="template-btn">f(z) = e^z</button>
                            <button onclick="setReImFunction('cos(x)*cosh(y)', 'sin(x)*sinh(y)')" class="template-btn">f(z) = cos(z)</button>
                        </div>

                        <h3>–ü—Ä–∏–º–µ—Ä—ã –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å—É–º–º</h3>
                        <div class="templates-grid">
                            <button onclick="setFunction('diff(z^2, z)')" class="template-btn">f(z) = (z¬≤)'</button>
                            <button onclick="setFunction('deriv(sin(z), 2)')" class="template-btn">f(z) = sin''(z)</button>
                            <button onclick="setFunction('diff(1/z, z)')" class="template-btn">f(z) = (1/z)'</button>
                            <button onclick="setFunction('sum(z^k, k, 1, 5)')" class="template-btn">f(z) = Œ£z^k (1-5)</button>
                            <button onclick="setFunction('series(z^k/factorial(k), k, 0)')" class="template-btn">f(z) = e^z –∫–∞–∫ —Ä—è–¥</button>
                            <button onclick="setFunction('sum(k*z^k, k, 1, 10)')" class="template-btn">f(z) = Œ£k¬∑z^k</button>
                        </div>

                    </div>
                </div>
            </div>
            
            <div class="collapsible-section">
                <div class="collapsible-header">–≠–∫—Å–ø–æ—Ä—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏</div>
                <div class="collapsible-content">
                    <div class="control-row">
                        <div class="control-group">
                            <h2>–≠–∫—Å–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</h2>
                            <button id="exportPngButton" onclick="exportImage('png')" class="export-btn">–≠–∫—Å–ø–æ—Ä—Ç –≤ PNG</button>
                            <button id="exportJpgButton" onclick="exportImage('jpg')" class="export-btn">–≠–∫—Å–ø–æ—Ä—Ç –≤ JPEG</button>
                            <button id="exportSvgButton" onclick="exportImage('svg')" class="export-btn">–≠–∫—Å–ø–æ—Ä—Ç –≤ SVG</button>
                        </div>
                        
                        <div class="control-group">
                            <h2>–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:</h2>
                            <textarea id="metadataText" readonly style="width: 100%; height: 150px; font-family: monospace; padding: 10px;"></textarea>
                            <button onclick="copyMetadata()" class="export-btn" style="margin-top: 10px;">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ</button>
                            <button onclick="exportMetadata()" class="export-btn" style="margin-top: 10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ .txt</button>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button onclick="updateVisualization()" style="padding: 10px 20px; font-size: 16px;">–û–±–Ω–æ–≤–∏—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é</button>
                <button onclick="toggleDebug()" style="background-color: #999; margin-left: 15px;">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–∫—É</button>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="canvas-wrapper" style="position: relative;">
                <canvas id="screen" width="500" height="500"></canvas>
                
                <div id="progress-container" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 400px; text-align: center; background-color: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); z-index: 100;">
                    <h3 style="margin-top: 0; color: #333;">–í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏...</h3>
                    <div style="background-color: #eee; border-radius: 5px; overflow: hidden; height: 25px; margin: 10px 0;">
                        <div id="progress-bar" style="background-color: #4CAF50; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="progress-text">0%</div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ <span id="function-name" style="font-family: monospace; font-weight: bold;">z</span>
                    </div>
                    <button id="cancel-rendering" style="margin-top: 15px; padding: 5px 10px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <div id="debug-panel">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:</h3>
        <div id="debug-output" style="font-family: monospace; white-space: pre-wrap; font-size: 12px;"></div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    <script>
    
        // –§–ª–∞–≥ –¥–ª—è –æ—Ç–º–µ–Ω—ã —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
        let renderingCancelled = false;

        // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–µ–∂–∏–º–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        let vizMode = "domainColoring"; // –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: "domainColoring", "conformalMap"

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–æ—Ä–º–Ω—ã—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–π
        let gridType = "rectangular";
        let gridDensity = 10;
        let gridLineWidth = 2; // –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —è—á–µ–π–∫–∏
        let gridColor1 = "#000000";
        let gridColor2 = "#ffffff";

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞ —Ä–µ—à—ë—Ç–∫–∏
        let gridBackgroundColor = "#ffffff";

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞ —Ä–µ—à—ë—Ç–∫–∏
        function updateGridBackgroundColor() {
            gridBackgroundColor = document.getElementById('gridBackgroundColor').value;
            updateVisualization();
        }
    
        // –í–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ—Ç–ª–∞–¥–∫–∏
        let debugMode = false;
        
        function toggleDebug() {
            debugMode = !debugMode;
            document.getElementById('debug-panel').style.display = debugMode ? 'block' : 'none';
            if (debugMode) {
                updateDebugInfo();
            }
        }
        
        function updateDebugInfo() {
            if (!debugMode) return;
            
            const debugOutput = document.getElementById('debug-output');
            let debug = "–í–µ—Ä—Å–∏—è math.js: " + (math.version || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞') + "\n\n";
            
            // –î–û–ë–ê–í–õ–ï–ù–û: –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
            debug += "== –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã ==\n";

            debug += "–†–µ–∂–∏–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏: " + (vizMode === "domainColoring" ? "–†–∞—Å–∫—Ä–∞—Å–∫–∞ –æ–±–ª–∞—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è" : "–ö–æ–Ω—Ñ–æ—Ä–º–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è") + "\n";
            if (vizMode === "conformalMap") {
                debug += "–¢–∏–ø —Ä–µ—à—ë—Ç–∫–∏: " + getGridTypeString() + "\n";
                debug += "–ü–ª–æ—Ç–Ω–æ—Å—Ç—å —Ä–µ—à—ë—Ç–∫–∏: " + gridDensity + "\n";
                debug += "–®–∏—Ä–∏–Ω–∞ –ª–∏–Ω–∏–π: " + gridLineWidth + "%\n";
            }

            if (vizMode === "conformalMap") {
                debug += "== –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–æ—Ä–º–Ω—ã—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–π ==\n";
                debug += `–¢–∏–ø —Ä–µ—à—ë—Ç–∫–∏: ${gridType} (${getGridTypeString()})\n`;
                debug += `–ü–ª–æ—Ç–Ω–æ—Å—Ç—å —Ä–µ—à—ë—Ç–∫–∏: ${gridDensity}\n`;
                debug += `–®–∏—Ä–∏–Ω–∞ –ª–∏–Ω–∏–π: ${gridLineWidth}%\n`;
                debug += `–¶–≤–µ—Ç 1: ${gridColor1}\n`;
                debug += `–¶–≤–µ—Ç 2: ${gridColor2}\n`;
                
                // –°—á–∏—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ HTML-—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                const htmlGridType = document.getElementById('gridType').value;
                const htmlGridDensity = parseInt(document.getElementById('gridDensityValue').value);
                const htmlGridLineWidth = parseInt(document.getElementById('gridLineWidthValue').value);
                const htmlGridColor1 = document.getElementById('gridColor1').value;
                const htmlGridColor2 = document.getElementById('gridColor2').value;
                
                debug += "\n–ó–Ω–∞—á–µ–Ω–∏—è –∏–∑ HTML-—ç–ª–µ–º–µ–Ω—Ç–æ–≤:\n";
                debug += `–¢–∏–ø —Ä–µ—à—ë—Ç–∫–∏: ${htmlGridType}\n`;
                debug += `–ü–ª–æ—Ç–Ω–æ—Å—Ç—å —Ä–µ—à—ë—Ç–∫–∏: ${htmlGridDensity}\n`;
                debug += `–®–∏—Ä–∏–Ω–∞ –ª–∏–Ω–∏–π: ${htmlGridLineWidth}%\n`;
                debug += `–¶–≤–µ—Ç 1: ${htmlGridColor1}\n`;
                debug += `–¶–≤–µ—Ç 2: ${htmlGridColor2}\n`;
            }

            debug += "–†–µ–∂–∏–º —Å–≤—è–∑—ã–≤–∞–Ω–∏—è s —Å –æ–±–ª–∞—Å—Ç—å—é: " + (linkSWithDomain ? "–í–∫–ª—é—á–µ–Ω" : "–í—ã–∫–ª—é—á–µ–Ω") + "\n";
            debug += "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–π: " + (keepAspectRatio ? "–í–∫–ª—é—á–µ–Ω–æ" : "–í—ã–∫–ª—é—á–µ–Ω–æ") + "\n\n";
            
            debug += "== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ==\n";
            debug += `s: ${s} (–∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞: ${document.getElementById('sValue').value})\n`;
            debug += `d: ${d} (–∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞: ${document.getElementById('dValue').value})\n`;
            debug += `l: ${l} (–∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞: ${document.getElementById('lValue').value})\n`;
            debug += `p: ${p} (–∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞: ${document.getElementById('pValue').value})\n\n`;
            
            debug += "== –ì—Ä–∞–Ω–∏—Ü—ã –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏ ==\n";
            debug += "–ó–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:\n";
            debug += `xMin: ${xMin}, xMax: ${xMax}, yMin: ${yMin}, yMax: ${yMax}\n`;
            
            debug += "–ó–Ω–∞—á–µ–Ω–∏—è –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞:\n";
            debug += `xMin: ${document.getElementById('xMin').value}, ` +
                     `xMax: ${document.getElementById('xMax').value}, ` +
                     `yMin: ${document.getElementById('yMin').value}, ` +
                     `yMax: ${document.getElementById('yMax').value}\n\n`;
            
            debug += "== –°–ø–∏—Å–æ–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π ==\n";
            
            const functions = [
                'sin', 'cos', 'tan', 'asin', 'acos', 'atan',
                'sinh', 'cosh', 'tanh', 'asinh', 'acosh', 'atanh',
                'exp', 'log', 'sqrt', 'abs', 'conj', 'arg',
                'sec', 'csc', 'cot', 'sech', 'csch', 'coth',
                'factorial', 'zeta', 'erf', 'besselJ', 'besselY',
                'lambertW', 'airyAi', 'airyBi', 'cbrt'
            ];
            
            for (const func of functions) {
                if (typeof math[func] === 'function') {
                    debug += `math.${func}: ‚úì\n`;
                } else {
                    debug += `math.${func}: ‚úó\n`;
                }
            }

            debug += "\n== –§—É–Ω–∫—Ü–∏–∏ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å—É–º–º ==\n";
            debug += `deriv: ${typeof math.deriv === 'function' ? '‚úì' : '‚úó'}\n`;
            debug += `nthDeriv: ${typeof math.nthDeriv === 'function' ? '‚úì' : '‚úó'}\n`;
            debug += `diff: ${typeof math.diff === 'function' ? '‚úì' : '‚úó'}\n`;
            debug += `sum: ${typeof math.sum === 'function' ? '‚úì' : '‚úó'}\n`;
            debug += `series: ${typeof math.series === 'function' ? '‚úì' : '‚úó'}\n`;
            
            debug += "\n–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: " + (inputMode === "z" ? "–§—É–Ω–∫—Ü–∏—è –æ—Ç z" : "–§—É–Ω–∫—Ü–∏—è –æ—Ç (x,y)") + "\n";

            if (inputMode === "z") {
                debug += "–¢–µ–∫—É—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è: " + customFunction + "\n";
                
                if (compiledFunction) {
                    debug += "–§—É–Ω–∫—Ü–∏—è —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–∞: –î–∞\n";
                } else {
                    debug += "–§—É–Ω–∫—Ü–∏—è —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–∞: –ù–µ—Ç\n";
                }
            } else {
                debug += "–§—É–Ω–∫—Ü–∏—è Re(x,y): " + reFunction + "\n";
                debug += "–§—É–Ω–∫—Ü–∏—è Im(x,y): " + imFunction + "\n";
                
                if (compiledReFunction && compiledImFunction) {
                    debug += "–§—É–Ω–∫—Ü–∏–∏ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω—ã: –î–∞\n";
                } else {
                    debug += "–§—É–Ω–∫—Ü–∏–∏ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω—ã: –ù–µ—Ç\n";
                }
            }

            debug += "\n–†–∞–∑–º–µ—Ä—ã —Ö–æ–ª—Å—Ç–∞: " + document.getElementById('screen').width + "x" + document.getElementById('screen').height + " –ø–∏–∫—Å–µ–ª–µ–π\n";
            debug += "–û–±–ª–∞—Å—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏: X[" + xMin.toFixed(2) + ", " + xMax.toFixed(2) + "], Y[" + yMin.toFixed(2) + ", " + yMax.toFixed(2) + "]\n";
            
            debugOutput.innerHTML = debug;
        }
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—É–¥—É—Ç –º–µ–Ω—è—Ç—å—Å—è
        const PI = Math.PI;
        const PI2 = PI * 2;
        const ANGLE_SNAP_THRESHOLD = 0.1; // –ü–æ—Ä–æ–≥ –ø—Ä–∏—Ç—è–≥–∏–≤–∞–Ω–∏—è –≤ —Ä–∞–¥–∏–∞–Ω–∞—Ö
        
        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        const lMethodSelect = document.getElementById('lMethod');
        
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        let s = 2*Math.PI;
        let d = 4;
        let l = 2;
        let p = 1;

        // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
        let keepAspectRatio = true;

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞–Ω–∏—Ü –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏
        let xMin = -3.14, xMax = 3.14, yMin = -3.14, yMax = 3.14;

        // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Å–≤—è–∑–∏ s —Å –æ–±–ª–∞—Å—Ç—å—é
        let linkSWithDomain = true;
        
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —É–≥–ª–∞
        let theta = 0;
        let phi = 0;

        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
        let customFunction = "(z^3 + i) / z"; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let compiledFunction = null;

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ –≤–≤–æ–¥–∞ (x,y)
        let inputMode = "z"; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∂–∏–º z
        let reFunction = "x"; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è Re(x,y)
        let imFunction = "y"; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è Im(x,y)
        let compiledReFunction = null;
        let compiledImFunction = null;

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—è –≤–≤–æ–¥–∞
        let activeInputField = 'customFunctionInput';

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –≤–≤–æ–¥–∞
        function toggleInputMode() {
            const zModeRadio = document.getElementById('zModeRadio');
            const zInputContainer = document.getElementById('zInputContainer');
            const xyInputContainer = document.getElementById('xyInputContainer');
            
            if (zModeRadio.checked) {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∂–∏–º z
                inputMode = "z";
                zInputContainer.style.display = "flex";
                xyInputContainer.style.display = "none";
                activeInputField = 'customFunctionInput';
            } else {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∂–∏–º (x,y)
                inputMode = "xy";
                zInputContainer.style.display = "none";
                xyInputContainer.style.display = "block";
                activeInputField = 'reFunction'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–∫—Ç–∏–≤–Ω–æ –ø–æ–ª–µ Re
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
            compiledFunction = null;
            compiledReFunction = null;
            compiledImFunction = null;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Re –∏ Im —Ñ—É–Ω–∫—Ü–∏–π
        function setReImFunction(re, im) {
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∂–∏–º (x,y) –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
            if (inputMode !== "xy") {
                document.getElementById('xyModeRadio').checked = true;
                toggleInputMode();
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
            document.getElementById('reFunction').value = re;
            document.getElementById('imFunction').value = im;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            compiledReFunction = null;
            compiledImFunction = null;
            //updateVisualization();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç z –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏—è Re –∏ Im
        function transformZToXY(funcStr) {
            // –¢–∞–±–ª–∏—Ü–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π
            const transformations = {
                'z': { re: 'x', im: 'y' },
                'z^2': { re: 'x^2-y^2', im: '2*x*y' },
                '1/z': { re: 'x/(x^2+y^2)', im: '-y/(x^2+y^2)' },
                'exp(z)': { re: 'exp(x)*cos(y)', im: 'exp(x)*sin(y)' },
                'sin(z)': { re: 'sin(x)*cosh(y)', im: 'cos(x)*sinh(y)' },
                'cos(z)': { re: 'cos(x)*cosh(y)', im: '-sin(x)*sinh(y)' },
                'tan(z)': { re: 'sin(2*x)/(cos(2*x)+cosh(2*y))', im: 'sinh(2*y)/(cos(2*x)+cosh(2*y))' },
                'log(z)': { re: 'log(sqrt(x^2+y^2))', im: 'atan2(y,x)' },
                'sqrt(z)': { re: 'sqrt((sqrt(x^2+y^2)+x)/2)', im: 'sign(y)*sqrt((sqrt(x^2+y^2)-x)/2)' }
            };
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ
            if (transformations[funcStr]) {
                return transformations[funcStr];
            }
            
            // –ò–Ω–∞—á–µ –≤—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ—Å—Ç—É—é –∑–∞–º–µ–Ω—É z -> x –¥–ª—è Re –∏ z -> y –¥–ª—è Im
            return {
                re: funcStr.replace(/z(?!\w)/g, 'x'),
                im: funcStr.replace(/z(?!\w)/g, 'y')
            };
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ —Ö–æ–ª—Å—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏
        function setCanvasSize() {
            const sizePreset = document.getElementById('canvasSizePreset').value;
            const customSizeControl = document.getElementById('customSizeControl');
            
            if (sizePreset === 'custom') {
                customSizeControl.style.display = 'block';
            } else {
                customSizeControl.style.display = 'none';
                
                const [width, height] = sizePreset.split('x').map(Number);
                resizeCanvas(width, height);

            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        function applyCustomSize() {
            const width = parseInt(document.getElementById('canvasWidth').value);
            const height = parseInt(document.getElementById('canvasHeight').value);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
            if (width < 100 || width > 4000 || height < 100 || height > 4000) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ä–∞–∑–º–µ—Ä—ã –æ—Ç 100 –¥–æ 4000 –ø–∏–∫—Å–µ–ª–µ–π');
                return;
            }
            
            resizeCanvas(width, height);

            if (linkSWithDomain) {
                updateDomainFromS();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ö–æ–ª—Å—Ç–∞
        function resizeCanvas(width, height) {
            const canvas = document.getElementById('screen');
            
            // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
            const prevWidth = canvas.width;
            const prevHeight = canvas.height;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∏–∫—Å–µ–ª–µ–π)
            canvas.width = width;
            canvas.height = height;
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω
            const aspectRatio = width / height;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫—É—é —Å—Ç–æ—Ä–æ–Ω—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–∞—á–µ—Å—Ç–≤–µ –±–∞–∑–æ–≤–æ–π –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å –º–∞–∫—Å–∏–º—É–º–æ–º 500px
            let displayWidth, displayHeight;
            
            if (width >= height) {
                // –î–ª—è –∞–ª—å–±–æ–º–Ω–æ–π –∏–ª–∏ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
                displayHeight = 500;
                displayWidth = displayHeight * aspectRatio;
            } else {
                // –î–ª—è –ø–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
                displayWidth = 500;
                displayHeight = displayWidth / aspectRatio;
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –º–∞–∫–µ—Ç–æ–º
            const maxWidth = 500;
            if (displayWidth > maxWidth) {
                displayWidth = maxWidth;
                displayHeight = displayWidth / aspectRatio;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
            canvas.style.width = `${displayWidth}px`;
            canvas.style.height = `${displayHeight}px`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ canvas-wrapper –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const canvasWrapper = canvas.closest('.canvas-wrapper');
            if (canvasWrapper) {
                canvasWrapper.style.width = `${displayWidth}px`;
                canvasWrapper.style.height = `${displayHeight}px`;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±–ª–∞—Å—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ä–µ–∂–∏–º–æ–º
            if (linkSWithDomain) {
                updateDomainFromS(); // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±–ª–∞—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ s
            } else {
                // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –æ–±–ª–∞—Å—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏ —Å —É—á—ë—Ç–æ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
                adjustComplexDomainAspectRatio();
            }
            
            console.log(`–†–∞–∑–º–µ—Ä —Ö–æ–ª—Å—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${width}x${height} –ø–∏–∫—Å–µ–ª–µ–π (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ ${Math.round(displayWidth)}x${Math.round(displayHeight)} –ø–∏–∫—Å–µ–ª–µ–π)`);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏
        function applyComplexDomain() {
            xMin = parseFloat(document.getElementById('xMin').value);
            xMax = parseFloat(document.getElementById('xMax').value);
            yMin = parseFloat(document.getElementById('yMin').value);
            yMax = parseFloat(document.getElementById('yMax').value);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –≥—Ä–∞–Ω–∏—Ü
            if (xMin >= xMax || yMin >= yMax) {
                alert('–ù–µ–≤–µ—Ä–Ω–æ –∑–∞–¥–∞–Ω—ã –≥—Ä–∞–Ω–∏—Ü—ã: –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ');
                return;
            }
            
            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –æ–±–ª–∞—Å—Ç—å —Å —É—á—ë—Ç–æ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–Ω, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
            adjustComplexDomainAspectRatio();

            // –û—Ç–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Å–≤—è–∑—ã–≤–∞–Ω–∏—è s —Å –æ–±–ª–∞—Å—Ç—å—é –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            if (linkSWithDomain) {
                linkSWithDomain = false;
                document.getElementById('linkSWithDomainCheckbox').checked = false;
                toggleSLinkMode();
            }
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å –Ω–æ–≤—ã–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
            updateVisualization();
            
            console.log(`–ì—Ä–∞–Ω–∏—Ü—ã –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω—ã: X[${xMin}, ${xMax}], Y[${yMin}, ${yMax}]`);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –≥—Ä–∞–Ω–∏—Ü –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏ —Å —É—á—ë—Ç–æ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–Ω —Ö–æ–ª—Å—Ç–∞
        function adjustComplexDomainAspectRatio(showNotification = true) {
            // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–π –≤—ã–∫–ª—é—á–µ–Ω, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            if (!keepAspectRatio) return;
            
            // –£–î–ê–õ–ï–ù–û: –±–ª–æ–∫ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π linkSWithDomain, —ç—Ç–æ —É–∂–µ –¥–µ–ª–∞–µ—Ç—Å—è –≤ updateDomainFromS
            
            const canvas = document.getElementById('screen');
            const canvasRatio = canvas.width / canvas.height;
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ —Ä–∞–∑–º–µ—Ä—ã –æ–±–ª–∞—Å—Ç–∏
            const domainWidth = xMax - xMin;
            const domainHeight = yMax - yMin;
            const domainRatio = domainWidth / domainHeight;
            
            // –ï—Å–ª–∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–Ω –æ—Ç–ª–∏—á–∞—é—Ç—Å—è, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –æ–±–ª–∞—Å—Ç—å
            if (Math.abs(canvasRatio - domainRatio) > 0.001) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—Ç—Ä –æ–±–ª–∞—Å—Ç–∏
                const centerX = (xMax + xMin) / 2;
                const centerY = (yMax + yMin) / 2;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                const oldXMin = xMin;
                const oldXMax = xMax;
                const oldYMin = yMin;
                const oldYMax = yMax;
                
                if (canvasRatio > domainRatio) {
                    // –•–æ–ª—Å—Ç —à–∏—Ä–µ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –æ–±–ª–∞—Å—Ç–∏
                    const newWidth = domainHeight * canvasRatio;
                    xMin = centerX - newWidth / 2;
                    xMax = centerX + newWidth / 2;
                } else {
                    // –•–æ–ª—Å—Ç –≤—ã—à–µ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –æ–±–ª–∞—Å—Ç–∏
                    const newHeight = domainWidth / canvasRatio;
                    yMin = centerY - newHeight / 2;
                    yMax = centerY + newHeight / 2;
                }
                
                // –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞, —á—Ç–æ–±—ã –æ—Ç—Ä–∞–∑–∏—Ç—å –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                document.getElementById('xMin').value = xMin.toFixed(2);
                document.getElementById('xMax').value = xMax.toFixed(2);
                document.getElementById('yMin').value = yMin.toFixed(2);
                document.getElementById('yMax').value = yMax.toFixed(2);
                
                if (debugMode) {
                    console.log(`–û–±–ª–∞—Å—Ç—å —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞: X[${xMin.toFixed(2)}, ${xMax.toFixed(2)}], Y[${yMin.toFixed(2)}, ${yMax.toFixed(2)}]`);
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (showNotification) {
                    showNotification('–û–±–ª–∞—Å—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–π', 
                        `–°—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: X[${oldXMin.toFixed(2)}, ${oldXMax.toFixed(2)}], Y[${oldYMin.toFixed(2)}, ${oldYMax.toFixed(2)}]<br>` + 
                        `–ù–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: X[${xMin.toFixed(2)}, ${xMax.toFixed(2)}], Y[${yMin.toFixed(2)}, ${yMax.toFixed(2)}]`);
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
        function toggleAspectRatioMode() {
            keepAspectRatio = document.getElementById('keepAspectRatioCheckbox').checked;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            const infoElement = document.getElementById('aspectRatioInfo');
            if (infoElement) {
                if (keepAspectRatio) {
                    infoElement.textContent = '–†–µ–∂–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–π –≤–∫–ª—é—á–µ–Ω. –û–±–ª–∞—Å—Ç—å –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è.';
                    // –°—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É
                    adjustComplexDomainAspectRatio();
                    updateVisualization();
                } else {
                    infoElement.textContent = '–†–µ–∂–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–π –≤—ã–∫–ª—é—á–µ–Ω. –ú–∞—Å—à—Ç–∞–±—ã –ø–æ –æ—Å—è–º X –∏ Y –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è.';
                }
            }
            
            if (debugMode) {
                console.log(`–†–µ–∂–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–π ${keepAspectRatio ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω'}`);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Å–≤—è–∑–∏ s —Å –æ–±–ª–∞—Å—Ç—å—é
        function toggleSLinkMode() {
            linkSWithDomain = document.getElementById('linkSWithDomainCheckbox').checked;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            const infoElement = document.getElementById('sLinkInfo');
            if (infoElement) {
                if (linkSWithDomain) {
                    infoElement.textContent = '–†–µ–∂–∏–º —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω. –û–±–ª–∞—Å—Ç—å –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ s.';
                    // –í–ê–ñ–ù–û: –°—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è–µ–º –æ–±–ª–∞—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ s
                    updateDomainFromS();
                } else {
                    infoElement.textContent = '–†–µ–∂–∏–º —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω. –ü–∞—Ä–∞–º–µ—Ç—Ä s –∏ –æ–±–ª–∞—Å—Ç—å –º–æ–≥—É—Ç –∏–∑–º–µ–Ω—è—Ç—å—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ.';
                }
            }
            
            if (debugMode) {
                console.log(`–†–µ–∂–∏–º —Å–≤—è–∑—ã–≤–∞–Ω–∏—è s —Å –æ–±–ª–∞—Å—Ç—å—é ${linkSWithDomain ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω'}`);
                updateDebugInfo();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –æ–±–ª–∞—Å—Ç–∏ –∫ –∫–≤–∞–¥—Ä–∞—Ç—É —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –º–∞—Å—à—Ç–∞–±–∞
        function resetToSquare() {
            const canvas = document.getElementById('screen');
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ —Ä–∞–∑–º–µ—Ä—ã –æ–±–ª–∞—Å—Ç–∏
            const domainWidth = xMax - xMin;
            const domainHeight = yMax - yMin;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –æ–±–ª–∞—Å—Ç–∏
            const centerX = (xMax + xMin) / 2;
            const centerY = (yMax + yMin) / 2;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–≤–∞–¥—Ä–∞—Ç–∞
            const maxSide = Math.max(domainWidth, domainHeight);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã, —Å–æ–∑–¥–∞–≤–∞—è –∫–≤–∞–¥—Ä–∞—Ç–Ω—É—é –æ–±–ª–∞—Å—Ç—å
            xMin = centerX - maxSide / 2;
            xMax = centerX + maxSide / 2;
            yMin = centerY - maxSide / 2;
            yMax = centerY + maxSide / 2;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
            document.getElementById('xMin').value = xMin.toFixed(2);
            document.getElementById('xMax').value = xMax.toFixed(2);
            document.getElementById('yMin').value = yMin.toFixed(2);
            document.getElementById('yMax').value = yMax.toFixed(2);
            
            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å —É—á—ë—Ç–æ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–Ω —Ö–æ–ª—Å—Ç–∞
            adjustComplexDomainAspectRatio();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            updateVisualization();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification('–û–±–ª–∞—Å—Ç—å —Å–±—Ä–æ—à–µ–Ω–∞ –¥–æ –∫–≤–∞–¥—Ä–∞—Ç–∞', 
                           `–ù–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: X[${xMin.toFixed(2)}, ${xMax.toFixed(2)}], Y[${yMin.toFixed(2)}, ${yMax.toFixed(2)}]`);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(title, message, duration = 4000) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            let notificationsContainer = document.getElementById('notifications-container');
            
            if (!notificationsContainer) {
                // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                notificationsContainer = document.createElement('div');
                notificationsContainer.id = 'notifications-container';
                notificationsContainer.style.position = 'fixed';
                notificationsContainer.style.top = '20px';
                notificationsContainer.style.right = '20px';
                notificationsContainer.style.zIndex = '1000';
                notificationsContainer.style.maxWidth = '400px';
                document.body.appendChild(notificationsContainer);
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const notification = document.createElement('div');
            notification.style.backgroundColor = '#f8f9fa';
            notification.style.border = '1px solid #4CAF50';
            notification.style.borderRadius = '4px';
            notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
            notification.style.padding = '15px';
            notification.style.marginBottom = '10px';
            notification.style.transition = 'all 0.3s ease';
            notification.style.opacity = '0';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const titleElement = document.createElement('h4');
            titleElement.textContent = title;
            titleElement.style.margin = '0 0 5px 0';
            titleElement.style.color = '#4CAF50';
            notification.appendChild(titleElement);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const messageElement = document.createElement('div');
            messageElement.innerHTML = message;
            messageElement.style.fontSize = '0.9em';
            messageElement.style.color = '#333';
            notification.appendChild(messageElement);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
            const closeButton = document.createElement('span');
            closeButton.textContent = '√ó';
            closeButton.style.position = 'absolute';
            closeButton.style.top = '5px';
            closeButton.style.right = '10px';
            closeButton.style.fontSize = '20px';
            closeButton.style.cursor = 'pointer';
            closeButton.style.color = '#666';
            closeButton.onclick = () => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    notificationsContainer.removeChild(notification);
                }, 300);
            };
            notification.appendChild(closeButton);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            notificationsContainer.appendChild(notification);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode === notificationsContainer) {
                        notificationsContainer.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }

        // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã—á–∏—Å–ª—è–µ–º —É–≥–ª—ã –¥–ª—è –º–µ—Ç–æ–∫
        const angleLabels = {};
        [
            {val: 0, text: '0'},
            {val: PI/6, text: 'œÄ/6'},
            {val: PI/4, text: 'œÄ/4'},
            {val: PI/3, text: 'œÄ/3'},
            {val: PI/2, text: 'œÄ/2'},
            {val: 2*PI/3, text: '2œÄ/3'},
            {val: 3*PI/4, text: '3œÄ/4'},
            {val: 5*PI/6, text: '5œÄ/6'},
            {val: PI, text: 'œÄ'},
            {val: 7*PI/6, text: '7œÄ/6'},
            {val: 5*PI/4, text: '5œÄ/4'},
            {val: 4*PI/3, text: '4œÄ/3'},
            {val: 3*PI/2, text: '3œÄ/2'},
            {val: 5*PI/3, text: '5œÄ/3'},
            {val: 7*PI/4, text: '7œÄ/4'},
            {val: 11*PI/6, text: '11œÄ/6'},
            {val: 2*PI, text: '2œÄ'}
        ].forEach(item => {
            angleLabels[item.val.toFixed(5)] = item.text;
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞
        function updateMethodControls() {
            const method = parseInt(lMethodSelect.value);
            
            // s –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ–≥–¥–∞
            document.getElementById('sContainer').style.display = 'flex';
            
            // d –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–ª—è –º–µ—Ç–æ–¥–æ–≤ 2, 3, 4, 5, 6
            document.getElementById('dContainer').style.display = 
                (method >= 2) ? 'flex' : 'none';
            
            // l –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ—Ç–æ–¥–∞ 4
            document.getElementById('lContainer').style.display = 
                (method === 4) ? 'flex' : 'none';
                
            // p –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ—Ç–æ–¥–∞ 1
            document.getElementById('pContainer').style.display = 
                (method === 1) ? 'flex' : 'none';
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–æ–≤
        let thetaSlider, phiSlider;

        // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è initCircularSliders
        function initCircularSliders() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –¥–ª—è theta
            const thetaCanvas = document.getElementById('thetaCanvas');
            const thetaCtx = thetaCanvas.getContext('2d');
            thetaSlider = initSlider(thetaCanvas, thetaCtx, 'thetaValue', value => {
                theta = value;
                return theta;
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –¥–ª—è phi
            const phiCanvas = document.getElementById('phiCanvas');
            const phiCtx = phiCanvas.getContext('2d');
            phiSlider = initSlider(phiCanvas, phiCtx, 'phiValue', value => {
                phi = value;
                return phi;
            });
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            displayAngleValue('thetaValue', theta);
            displayAngleValue('phiValue', phi);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–¥–Ω–æ–≥–æ –∫—Ä—É–≥–æ–≤–æ–≥–æ –ø–æ–ª–∑—É–Ω–∫–∞
        function initSlider(canvas, ctx, valueElementId, updateFunction) {
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = width / 2 - 10;
            let isDragging = false;
            
            // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã—á–∏—Å–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º–µ—Ç–æ–∫ –Ω–∞ –∫—Ä—É–≥–µ
            const markPositions = [];
            for (let i = 0; i < 12; i++) {
                const markAngle = i * Math.PI / 6;
                markPositions.push({
                    angle: markAngle,
                    startX: centerX + (radius - 5) * Math.cos(markAngle),
                    startY: centerY + (radius - 5) * Math.sin(markAngle),
                    endX: centerX + radius * Math.cos(markAngle),
                    endY: centerY + radius * Math.sin(markAngle)
                });
            }
            
            // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –ø–æ–ª–∑—É–Ω–∫–∞
            function drawSlider(angle) {
                ctx.clearRect(0, 0, width, height);
                
                // –†–∏—Å—É–µ–º –∫—Ä—É–≥
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, PI2);
                ctx.strokeStyle = '#999';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // –†–∏—Å—É–µ–º –º–µ—Ç–∫–∏ –ø–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                for (let i = 0; i < markPositions.length; i++) {
                    const mark = markPositions[i];
                    
                    ctx.beginPath();
                    ctx.moveTo(mark.startX, mark.startY);
                    ctx.lineTo(mark.endX, mark.endY);
                    ctx.strokeStyle = '#555';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —É–≥–ª–æ–≤ (0, œÄ/2, œÄ, 3œÄ/2)
                    if (i % 3 === 0) {
                        const textX = centerX + (radius - 15) * Math.cos(mark.angle);
                        const textY = centerY + (radius - 15) * Math.sin(mark.angle);
                        ctx.fillStyle = '#555';
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        
                        let text = '';
                        if (i === 0) text = '0';
                        else if (i === 3) text = 'œÄ/2';
                        else if (i === 6) text = 'œÄ';
                        else if (i === 9) text = '3œÄ/2';
                        
                        ctx.fillText(text, textX, textY);
                    }
                }
                
                // –†–∏—Å—É–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å (–º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è)
                const markerX = centerX + radius * Math.cos(angle);
                const markerY = centerY + radius * Math.sin(angle);
                
                ctx.beginPath();
                ctx.arc(markerX, markerY, 8, 0, PI2);
                ctx.fillStyle = '#4CAF50';
                ctx.fill();
                
                // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –¥–æ —É–∫–∞–∑–∞—Ç–µ–ª—è
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(markerX, markerY);
                ctx.strokeStyle = '#4CAF50';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —É–≥–ª–∞
                displayAngleValue(valueElementId, angle);
            }
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —É–≥–æ–ª –∏–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –º—ã—à–∏
            function getAngleFromMousePosition(mouseX, mouseY) {
                const rect = canvas.getBoundingClientRect();
                const x = mouseX - rect.left - centerX;
                const y = mouseY - rect.top - centerY;
                let angle = Math.atan2(y, x);
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —É–≥–ª—ã –≤ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ (0 –¥–æ 2œÄ)
                if (angle < 0) {
                    angle += PI2;
                }
                
                return angle;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø—Ä–∏—Ç—è–≥–∏–≤–∞—Ç—å —É–≥–æ–ª –∫ –±–ª–∏–∂–∞–π—à–µ–π –º–µ—Ç–∫–µ
            function checkForSnapping(angle) {
                const snapInterval = Math.PI / 6;
                const nearestSnapAngle = Math.round(angle / snapInterval) * snapInterval;
                
                // –ï—Å–ª–∏ —É–≥–æ–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–æ—Ä–æ–≥–∞ –ø—Ä–∏—Ç—è–≥–∏–≤–∞–Ω–∏—è –æ—Ç –º–µ—Ç–∫–∏,
                // –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ–º –µ–≥–æ –∫ –º–µ—Ç–∫–µ
                if (Math.abs(angle - nearestSnapAngle) < ANGLE_SNAP_THRESHOLD) {
                    return nearestSnapAngle;
                }
                
                return angle;
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏
            canvas.addEventListener('mousedown', function(e) {
                const angle = getAngleFromMousePosition(e.clientX, e.clientY);
                const snappedAngle = checkForSnapping(angle);
                const updatedAngle = updateFunction(snappedAngle);
                drawSlider(updatedAngle);
                isDragging = true;
            });
            
            canvas.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    const angle = getAngleFromMousePosition(e.clientX, e.clientY);
                    const snappedAngle = checkForSnapping(angle);
                    const updatedAngle = updateFunction(snappedAngle);
                    drawSlider(updatedAngle);
                }
            });
            
            canvas.addEventListener('mouseup', function() {
                isDragging = false;
            });
            
            canvas.addEventListener('mouseleave', function() {
                isDragging = false;
            });
            
            // –ù–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–æ–ª–∑—É–Ω–∫–∞ —Å —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º —É–≥–ª–∞
            drawSlider(updateFunction(0)); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–∑—É–Ω–∫–∞
            return {
                update: function(angle) {
                    drawSlider(angle);
                }
            };
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —É–≥–ª–∞ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö –∏ —Ä–∞–¥–∏–∞–Ω–∞—Ö
        function displayAngleValue(elementId, radians) {
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≥—Ä–∞–¥—É—Å—ã
            const degrees = Math.round(radians * 180 / Math.PI);
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–∞–¥–∏–∞–Ω—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫—Ä–∞—Å–∏–≤—ã—Ö –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–π
            let radiansText = '';
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            const anglesMap = {
                '0': '0',
                [Math.PI/6]: 'œÄ/6',
                [Math.PI/4]: 'œÄ/4',
                [Math.PI/3]: 'œÄ/3',
                [Math.PI/2]: 'œÄ/2',
                [2*Math.PI/3]: '2œÄ/3',
                [3*Math.PI/4]: '3œÄ/4',
                [5*Math.PI/6]: '5œÄ/6',
                [Math.PI]: 'œÄ',
                [7*Math.PI/6]: '7œÄ/6',
                [5*Math.PI/4]: '5œÄ/4',
                [4*Math.PI/3]: '4œÄ/3',
                [3*Math.PI/2]: '3œÄ/2',
                [5*Math.PI/3]: '5œÄ/3',
                [7*Math.PI/4]: '7œÄ/4',
                [11*Math.PI/6]: '11œÄ/6',
                [2*Math.PI]: '2œÄ'
            };
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –Ω–∞—à–µ–π –∫–∞—Ä—Ç–µ —É–≥–ª–æ–≤ —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é 0.01
            let found = false;
            for (const [angle, text] of Object.entries(anglesMap)) {
                if (Math.abs(radians - angle) < 0.01) {
                    radiansText = text;
                    found = true;
                    break;
                }
            }
            
            // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –∫–∞—Ä—Ç–µ, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            if (!found) {
                radiansText = radians.toFixed(2) + ' —Ä–∞–¥';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ —ç–ª–µ–º–µ–Ω—Ç–µ
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = `${degrees}¬∞ (${radiansText})`;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç –∏–∑ –ø–æ–ª–∑—É–Ω–∫–æ–≤
        function updateConstant(constName) {
            const sliderValue = parseFloat(document.getElementById(constName + 'Slider').value);
            document.getElementById(constName + 'Value').value = sliderValue;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            window[constName] = sliderValue;

            // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä s –∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —Å–≤—è–∑—ã–≤–∞–Ω–∏—è, –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±–ª–∞—Å—Ç—å
            if (constName === 's' && linkSWithDomain) {
                updateDomainFromS();
            }
            
            if (debugMode) {
                console.log(`–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ ${constName} –æ–±–Ω–æ–≤–ª–µ–Ω–∞: ${sliderValue}`);
                updateDebugInfo();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
        function updateConstantFromInput(constName) {
            const inputValue = parseFloat(document.getElementById(constName + 'Value').value);
            document.getElementById(constName + 'Slider').value = inputValue;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            window[constName] = inputValue;
            
            // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä s –∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —Å–≤—è–∑—ã–≤–∞–Ω–∏—è, –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±–ª–∞—Å—Ç—å
            if (constName === 's' && linkSWithDomain) {
                updateDomainFromS();
            }
            
            if (debugMode) {
                console.log(`–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ ${constName} –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞: ${inputValue}`);
                updateDebugInfo();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±–ª–∞—Å—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ s
        function updateDomainFromS() {
            // –í—ã—á–∏—Å–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ s (—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –æ—Ç -s/2 –¥–æ s/2)
            const halfS = s / 2;
            xMin = -halfS;
            xMax = halfS;
            yMin = -halfS;
            yMax = halfS;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞, —á—Ç–æ–±—ã –∑–Ω–∞—á–µ–Ω–∏—è –±—ã–ª–∏ –≤–∏–¥–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            document.getElementById('xMin').value = xMin.toFixed(2);
            document.getElementById('xMax').value = xMax.toFixed(2);
            document.getElementById('yMin').value = yMin.toFixed(2);
            document.getElementById('yMax').value = yMax.toFixed(2);
            
            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å —É—á—ë—Ç–æ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–Ω, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ä–µ–∂–∏–º
            if (keepAspectRatio) {
                adjustComplexDomainAspectRatio(false); // false - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            }
            
            if (debugMode) {
                console.log(`–û–±–ª–∞—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ s=${s}: X[${xMin}, ${xMax}], Y[${yMin}, ${yMax}]`);
            }
        }
        
        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ L –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞
        function calculateL(abs, arg, method) {
            // –†–∞—Å—á–µ—Ç –±–∞–∑–æ–≤—ã—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç
            const logAbs = Math.log(abs);
            const absLogAbs = Math.abs(logAbs);
            const piDivided = Math.PI / (d * 3);
            const argDivided = arg / piDivided;
            
            switch(method) {
                case 0:
                    return 0.5; // –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞
                    
                case 1:
                    return Math.exp(-Math.LN2 * abs * p); // –ó–∞—Ç—É—Ö–∞–Ω–∏–µ
                    
                case 2:
                    // –ú–∏–Ω–∏–º—É–º –¥—Ä–æ–±–Ω—ã—Ö —á–∞—Å—Ç–µ–π
                    const fracLogAbs = logAbs - Math.floor(logAbs);
                    const fracArgDiv = argDivided - Math.floor(argDivided);
                    return Math.min(fracLogAbs, fracArgDiv);
                    
                case 3:
                    // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∏–Ω–∏–º—É–º –¥—Ä–æ–±–Ω—ã—Ö —á–∞—Å—Ç–µ–π
                    const scaledLogAbs3 = d * logAbs;
                    const fracScaledLogAbs3 = scaledLogAbs3 - Math.floor(scaledLogAbs3);
                    const fracArgDiv3 = argDivided - Math.floor(argDivided);
                    return Math.min(fracScaledLogAbs3, fracArgDiv3);
                    
                case 4:
                    // –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –¥—Ä–æ–±–Ω—ã—Ö —á–∞—Å—Ç–µ–π —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π
                    const scaledLogAbs4 = d * logAbs;
                    const fracScaledLogAbs4 = scaledLogAbs4 - Math.floor(scaledLogAbs4);
                    const fracArgDiv4 = argDivided - Math.floor(argDivided);
                    const product = fracScaledLogAbs4 * fracArgDiv4;
                    return (product - 0.5) / l + 0.5;
                    
                case 5:
                    // –ü–æ–±–∏—Ç–æ–≤–æ–µ XOR –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                    const scaledLogAbs5 = d * absLogAbs;
                    const binary1 = Math.floor(scaledLogAbs5) % 2;
                    const argShifted5 = arg + Math.PI;
                    const binary2 = Math.floor(argShifted5 / piDivided) % 2;
                    return binary1 ^ binary2;
                    
                case 6:
                    // –°–ª–æ–∂–Ω–æ–µ XOR —Å –ø–æ–≤–æ—Ä–æ—Ç–æ–º
                    const turn = (abs >= 1) ? 1 : 0;
                    const factor = 1 - 2 * turn;
                    const scaledLogAbs6 = d * absLogAbs;
                    const binary1_6 = Math.floor(scaledLogAbs6) % 2;
                    const xorPart1 = Math.floor(turn + factor * binary1_6);
                    const argShifted6 = arg + Math.PI;
                    const xorPart2 = Math.floor(argShifted6 / piDivided) % 2;
                    return xorPart1 ^ xorPart2;
                    
                default:
                    return 0.5;
            }
        }
        
        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—Ç–∏–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π Math –¥–ª—è HSL -> RGB
        function calculateRGB(H, L, S) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ JavaScript –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            // –≤ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏
            const C = (1 - Math.abs(2*L - 1)) * S;
            const H1 = H / (Math.PI/3);
            const Z = C * (1 - Math.abs((H1 % 2) - 1));
            const m = L - C/2;
            
            let R, G, B;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Math.floor –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤–µ—Ç–≤–ª–µ–Ω–∏—è
            const segment = Math.floor(H1);
            
            if (H1 >= 0 && H1 <= 6) {
                if (segment === 5 || segment === 6) { R = C; G = 0; B = Z; }
                else if (segment === 4) { R = Z; G = 0; B = C; }
                else if (segment === 3) { R = 0; G = Z; B = C; }
                else if (segment === 2) { R = 0; G = C; B = Z; }
                else if (segment === 1) { R = Z; G = C; B = 0; }
                else { R = C; G = Z; B = 0; }
            } else {
                R = G = B = 0;
            }
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ü–µ–ª—ã–µ —á–∏—Å–ª–∞ –¥–ª—è RGB –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            return [
                Math.round((R + m) * 255),
                Math.round((G + m) * 255),
                Math.round((B + m) * 255)
            ];
        }

        // –í—Å—Ç–∞–≤–∫–∞ —à–∞–±–ª–æ–Ω–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å —É—á–µ—Ç–æ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π
        function insertTemplate(template) {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            const inputField = document.getElementById(activeInputField);
            if (!inputField) {
                console.error("–ê–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:", activeInputField);
                return;
            }
            
            const start = inputField.selectionStart;
            const end = inputField.selectionEnd;
            const selectedText = inputField.value.substring(start, end);
            
            // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –≤—ã–¥–µ–ª–µ–Ω, —Ä–µ—à–∞–µ–º, –∫–∞–∫ –µ–≥–æ –≤—Å—Ç–∞–≤–∏—Ç—å –≤ —à–∞–±–ª–æ–Ω
            let newText;
            if (selectedText) {
                if (template === 'z' || template === 'i' || template === 'e' || template === 'pi') {
                    // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ - –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤–ª—è–µ–º —à–∞–±–ª–æ–Ω
                    newText = template;
                } else if (template.includes('(a + b)') || template.includes('(a - b)') || 
                           template.includes('(a * b)') || template.includes('(a / b)') || 
                           template.includes('a^b') || template.includes('log(a, b)')) {
                    // –î–ª—è –±–∏–Ω–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∑–∞–º–µ–Ω—è–µ–º 'a' –Ω–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
                    newText = template.replace('a', selectedText);
                } else {
                    // –î–ª—è —Ñ—É–Ω–∫—Ü–∏–π –∑–∞–º–µ–Ω—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç (z) –Ω–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
                    if (template.includes('z')) {
                        newText = template.replace(/z(?!\w)/g, selectedText); // –ó–∞–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ 'z', –∞ –Ω–µ —á–∞—Å—Ç—å —Å–ª–æ–≤–∞
                    } else {
                        // –ï—Å–ª–∏ –≤ —à–∞–±–ª–æ–Ω–µ –Ω–µ—Ç 'z', –ø—Ä–æ—Å—Ç–æ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ —à–∞–±–ª–æ–Ω
                        newText = template.replace(/\(.*?\)/, '(' + selectedText + ')');
                    }
                }
            } else {
                // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–¥–µ–ª–µ–Ω–æ, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –≤–≤–æ–¥–∞
                if (inputMode === "xy" && template.includes('z') && (activeInputField === 'reFunction' || activeInputField === 'imFunction')) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∞–±–ª–∏—Ü—É –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π
                    const transformed = transformZToXY(template);
                    if (activeInputField === 'reFunction') {
                        newText = transformed.re;
                    } else {
                        newText = transformed.im;
                    }
                } else {
                    // –ü—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤–ª—è–µ–º —à–∞–±–ª–æ–Ω –∫–∞–∫ –µ—Å—Ç—å
                    newText = template;
                }
            }
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç
            const newValue = inputField.value.substring(0, start) + newText + inputField.value.substring(end);
            inputField.value = newValue;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            inputField.focus();
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
            const newPosition = start + newText.length;
            inputField.setSelectionRange(newPosition, newPosition);
        }
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        function setFunction(func) {
            if (inputMode === "z") {
                document.getElementById('customFunctionInput').value = func;
            } else {
                // –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ Re –∏ Im –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ "re + i*im"
                const match = func.match(/^(.*?)\s*\+\s*i\s*\*\s*(.*?)$/);
                if (match) {
                    document.getElementById('reFunction').value = match[1].trim();
                    document.getElementById('imFunction').value = match[2].trim();
                } else {
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
                    const transformed = transformZToXY(func);
                    document.getElementById('reFunction').value = transformed.re;
                    document.getElementById('imFunction').value = transformed.im;
                }
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            compiledFunction = null;
            compiledReFunction = null;
            compiledImFunction = null;
            //updateVisualization();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏ –∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ—É–Ω–∫—Ü–∏–∏
        function smartInsert(template, fullFunction) {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            const inputField = document.getElementById(activeInputField);
            if (!inputField) {
                console.error("–ê–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:", activeInputField);
                return;
            }
            
            if (inputField.value.trim() === "" || 
                (inputField.selectionStart === 0 && inputField.selectionEnd === inputField.value.length)) {
                // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ –∏–ª–∏ –≤–µ—Å—å —Ç–µ–∫—Å—Ç –≤—ã–¥–µ–ª–µ–Ω
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –≤–≤–æ–¥–∞
                if (inputMode === "xy" && (activeInputField === 'reFunction' || activeInputField === 'imFunction')) {
                    // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω –¥–ª—è —Ä–µ–∂–∏–º–∞ (x,y) –∏—Å–ø–æ–ª—å–∑—É—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é
                    const transformed = transformZToXY(fullFunction);
                    if (activeInputField === 'reFunction') {
                        inputField.value = transformed.re;
                    } else {
                        inputField.value = transformed.im;
                    }
                } else {
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
                    inputField.value = fullFunction;
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                inputField.focus();
            } else {
                // –ò–Ω–∞—á–µ –≤—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ —à–∞–±–ª–æ–Ω
                insertTemplate(template);
            }
            
            // –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—è –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            compiledFunction = null;
            compiledReFunction = null;
            compiledImFunction = null;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—è –≤–≤–æ–¥–∞
        function highlightActiveField() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
            document.getElementById('reFunction').style.backgroundColor = '#ffffff';
            document.getElementById('imFunction').style.backgroundColor = '#ffffff';
            document.getElementById('customFunctionInput').style.backgroundColor = '#ffffff';
            
            // –í—ã–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ
            if (document.getElementById(activeInputField)) {
                document.getElementById(activeInputField).style.backgroundColor = '#f0f8ff';
            }
        }

        // =============================================
        // –û–°–ù–û–í–ù–ê–Ø –ß–ê–°–¢–¨ –†–ï–®–ï–ù–ò–Ø –ü–†–û–ë–õ–ï–ú–´ –° –§–£–ù–ö–¶–ò–Ø–ú–ò
        // =============================================

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—à–∏—Ö –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
        window.customMathFunctions = {};

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—Å–µ—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
        function defineCustomMathFunctions() {
            console.log("–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π...");

            // 1. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤—Å–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –Ω–∞—à–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ
            
            // –°–µ–∫–∞–Ω—Å
            window.customMathFunctions.sec = function(z) {
                return math.divide(1, math.cos(z));
            };

            // –ö–æ—Å–µ–∫–∞–Ω—Å
            window.customMathFunctions.csc = function(z) {
                return math.divide(1, math.sin(z));
            };

            // –ö–æ—Ç–∞–Ω–≥–µ–Ω—Å
            window.customMathFunctions.cot = function(z) {
                return math.divide(math.cos(z), math.sin(z));
            };

            // –ì–∏–ø–µ—Ä–±–æ–ª–∏—á–µ—Å–∫–∏–π —Å–µ–∫–∞–Ω—Å
            window.customMathFunctions.sech = function(z) {
                return math.divide(1, math.cosh(z));
            };

            // –ì–∏–ø–µ—Ä–±–æ–ª–∏—á–µ—Å–∫–∏–π –∫–æ—Å–µ–∫–∞–Ω—Å
            window.customMathFunctions.csch = function(z) {
                return math.divide(1, math.sinh(z));
            };

            // –ì–∏–ø–µ—Ä–±–æ–ª–∏—á–µ—Å–∫–∏–π –∫–æ—Ç–∞–Ω–≥–µ–Ω—Å
            window.customMathFunctions.coth = function(z) {
                return math.divide(math.cosh(z), math.sinh(z));
            };

            // –ö—É–±–∏—á–µ—Å–∫–∏–π –∫–æ—Ä–µ–Ω—å
            window.customMathFunctions.cbrt = function(z) {
                return math.pow(z, 1/3);
            };

            // –§–∞–∫—Ç–æ—Ä–∏–∞–ª (—á–µ—Ä–µ–∑ –≥–∞–º–º–∞-—Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö —á–∏—Å–µ–ª)
            window.customMathFunctions.factorial = function(z) {
                return math.gamma(math.add(z, 1));
            };

            // –î–∑–µ—Ç–∞-—Ñ—É–Ω–∫—Ü–∏—è –†–∏–º–∞–Ω–∞ (–∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏—è)
            window.customMathFunctions.zeta = function(z) {
                var sum = math.complex(0, 0);
                var terms = 20; // –î–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                
                for (var k = 1; k <= terms; k++) {
                    sum = math.add(sum, math.divide(1, math.pow(k, z)));
                }
                
                return sum;
            };

            // –§—É–Ω–∫—Ü–∏—è –æ—à–∏–±–æ–∫
            window.customMathFunctions.erf = function(z) {
                return math.multiply(
                    math.divide(2, math.sqrt(math.pi)),
                    math.multiply(z, math.exp(math.multiply(-1, math.pow(z, 2))))
                );
            };

            // –§—É–Ω–∫—Ü–∏–∏ –ë–µ—Å—Å–µ–ª—è (–ø—Ä–æ—Å—Ç–∞—è –∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏—è)
            window.customMathFunctions.besselJ = function(n, z) {
                if (n === 0) {
                    return math.cos(z);
                } else if (n === 1) {
                    return math.divide(math.sin(z), 2);
                } else {
                    return math.multiply(
                        math.cos(math.subtract(z, math.multiply(n, math.pi/2))),
                        math.divide(1, math.sqrt(z))
                    );
                }
            };

            // –§—É–Ω–∫—Ü–∏—è –ë–µ—Å—Å–µ–ª—è –≤—Ç–æ—Ä–æ–≥–æ —Ä–æ–¥–∞
            window.customMathFunctions.besselY = function(n, z) {
                if (n === 0) {
                    return math.sin(z);
                } else {
                    return math.multiply(math.sin(z), math.log(z));
                }
            };

            // W-—Ñ—É–Ω–∫—Ü–∏—è –õ–∞–º–±–µ—Ä—Ç–∞ (–∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏—è)
            window.customMathFunctions.lambertW = function(z) {
                return math.subtract(z, math.pow(z, 2));
            };

            // –§—É–Ω–∫—Ü–∏–∏ –≠–π—Ä–∏
            window.customMathFunctions.airyAi = function(z) {
                return math.multiply(
                    math.exp(math.multiply(-0.333, math.pow(z, 1.5))),
                    math.cos(math.multiply(0.5, z))
                );
            };

            window.customMathFunctions.airyBi = function(z) {
                return math.multiply(
                    math.exp(math.multiply(0.333, math.pow(z, 1.5))),
                    math.sin(math.multiply(0.5, z))
                );
            };
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω—ã–µ —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
            window.customMathFunctions.asec = function(z) {
                return math.acos(math.divide(1, z));
            };
            
            window.customMathFunctions.acsc = function(z) {
                return math.asin(math.divide(1, z));
            };
            
            window.customMathFunctions.acot = function(z) {
                return math.atan(math.divide(1, z));
            };
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω—ã–µ –≥–∏–ø–µ—Ä–±–æ–ª–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
            window.customMathFunctions.asech = function(z) {
                return math.acosh(math.divide(1, z));
            };
            
            window.customMathFunctions.acsch = function(z) {
                return math.asinh(math.divide(1, z));
            };
            
            window.customMathFunctions.acoth = function(z) {
                return math.atanh(math.divide(1, z));
            };
            
            // –§—É–Ω–∫—Ü–∏—è –ì—É–¥–µ—Ä–º–∞–Ω–∞ –∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ì—É–¥–µ—Ä–º–∞–Ω–∞
            window.customMathFunctions.gd = function(z) {
                return math.atan(math.sinh(z));
            };
            
            window.customMathFunctions.gdInv = function(z) {
                return math.asinh(math.tan(z));
            };
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
            
            // –°–∏–Ω—É—Å-–∫–∞—Ä–¥–∏–Ω–∞–ª
            window.customMathFunctions.sinc = function(z) {
                if (math.abs(z) < 1e-10) {
                    return 1;
                }
                return math.divide(math.sin(z), z);
            };
            
            // –ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–π —Å–∏–Ω—É—Å
            window.customMathFunctions.Si = function(z) {
                var sum = math.complex(0, 0);
                var terms = 20;
                
                for (var k = 0; k < terms; k++) {
                    var term = math.divide(
                        math.multiply(
                            math.pow(-1, k),
                            math.pow(z, 2*k+1)
                        ),
                        math.multiply(
                            2*k+1,
                            math.factorial(2*k+1)
                        )
                    );
                    sum = math.add(sum, term);
                }
                
                return sum;
            };
            
            // –ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–π –∫–æ—Å–∏–Ω—É—Å
            window.customMathFunctions.Ci = function(z) {
                var sum = math.complex(0, 0);
                var terms = 20;
                var gamma = 0.57721566490153286; // –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –≠–π–ª–µ—Ä–∞-–ú–∞—Å–∫–µ—Ä–æ–Ω–∏
                
                sum = math.add(sum, math.log(z));
                sum = math.add(sum, gamma);
                
                for (var k = 1; k < terms; k++) {
                    var term = math.divide(
                        math.multiply(
                            math.pow(-1, k),
                            math.pow(z, 2*k)
                        ),
                        math.multiply(
                            2*k,
                            math.factorial(2*k)
                        )
                    );
                    sum = math.add(sum, term);
                }
                
                return sum;
            };
            
            // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–≥—Ä–∞–ª
            window.customMathFunctions.Ei = function(z) {
                var sum = math.complex(0, 0);
                var terms = 20;
                var gamma = 0.57721566490153286; // –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –≠–π–ª–µ—Ä–∞-–ú–∞—Å–∫–µ—Ä–æ–Ω–∏
                
                sum = math.add(sum, gamma);
                sum = math.add(sum, math.log(math.abs(z)));
                
                for (var k = 1; k < terms; k++) {
                    var term = math.divide(
                        math.pow(z, k),
                        math.multiply(
                            k,
                            math.factorial(k)
                        )
                    );
                    sum = math.add(sum, term);
                }
                
                return sum;
            };
            
            // –ò–Ω—Ç–µ–≥—Ä–∞–ª—ã –§—Ä–µ–Ω–µ–ª—è
            window.customMathFunctions.fresnelS = function(z) {
                var sum = math.complex(0, 0);
                var terms = 10;
                
                for (var k = 0; k < terms; k++) {
                    var term = math.multiply(
                        math.pow(-1, k),
                        math.divide(
                            math.pow(z, 4*k+3),
                            math.multiply(
                                math.factorial(2*k+1),
                                4*k+3
                            )
                        )
                    );
                    sum = math.add(sum, term);
                }
                
                return math.multiply(
                    math.divide(math.pi, 2),
                    sum
                );
            };
            
            window.customMathFunctions.fresnelC = function(z) {
                var sum = math.complex(0, 0);
                var terms = 10;
                
                for (var k = 0; k < terms; k++) {
                    var term = math.multiply(
                        math.pow(-1, k),
                        math.divide(
                            math.pow(z, 4*k+1),
                            math.multiply(
                                math.factorial(2*k),
                                4*k+1
                            )
                        )
                    );
                    sum = math.add(sum, term);
                }
                
                return sum;
            };
            
            // –ü–æ–ª–∏–Ω–æ–º—ã –õ–µ–∂–∞–Ω–¥—Ä–∞
            window.customMathFunctions.legendre = function(n, z) {
                if (n === 0) {
                    return 1;
                } else if (n === 1) {
                    return z;
                } else {
                    var p0 = 1;
                    var p1 = z;
                    var p = 0;
                    
                    for (var k = 2; k <= n; k++) {
                        p = math.divide(
                            math.subtract(
                                math.multiply(
                                    math.multiply(2*k-1, z),
                                    p1
                                ),
                                math.multiply(k-1, p0)
                            ),
                            k
                        );
                        p0 = p1;
                        p1 = p;
                    }
                    
                    return p;
                }
            };
            
            // –ü–æ–ª–∏–Ω–æ–º—ã –ß–µ–±—ã—à–µ–≤–∞ –ø–µ—Ä–≤–æ–≥–æ —Ä–æ–¥–∞
            window.customMathFunctions.chebyshevT = function(n, z) {
                if (n === 0) {
                    return 1;
                } else if (n === 1) {
                    return z;
                } else {
                    var t0 = 1;
                    var t1 = z;
                    var t = 0;
                    
                    for (var k = 2; k <= n; k++) {
                        t = math.subtract(
                            math.multiply(2, math.multiply(z, t1)),
                            t0
                        );
                        t0 = t1;
                        t1 = t;
                    }
                    
                    return t;
                }
            };
            
            // –ü–æ–ª–∏–Ω–æ–º—ã –ß–µ–±—ã—à–µ–≤–∞ –≤—Ç–æ—Ä–æ–≥–æ —Ä–æ–¥–∞
            window.customMathFunctions.chebyshevU = function(n, z) {
                if (n === 0) {
                    return 1;
                } else if (n === 1) {
                    return math.multiply(2, z);
                } else {
                    var u0 = 1;
                    var u1 = math.multiply(2, z);
                    var u = 0;
                    
                    for (var k = 2; k <= n; k++) {
                        u = math.subtract(
                            math.multiply(2, math.multiply(z, u1)),
                            u0
                        );
                        u0 = u1;
                        u1 = u;
                    }
                    
                    return u;
                }
            };
            
            // –≠–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ø–∫–æ–±–∏
            window.customMathFunctions.ellipticSn = function(z, k) {
                return math.sin(z); // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
            };
            
            window.customMathFunctions.ellipticCn = function(z, k) {
                return math.cos(z); // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
            };
            
            window.customMathFunctions.ellipticDn = function(z, k) {
                return math.sqrt(1 - k*k * math.pow(math.sin(z), 2)); // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
            };
            
            // –≠–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ–≥—Ä–∞–ª –ø–µ—Ä–≤–æ–≥–æ —Ä–æ–¥–∞
            window.customMathFunctions.ellipticK = function(k) {
                var sum = math.complex(0, 0);
                var terms = 10;
                
                for (var n = 0; n < terms; n++) {
                    var term = math.multiply(
                        math.pow(
                            math.divide(
                                math.factorial(2*n),
                                math.pow(math.factorial(n), 2)
                            ),
                            2
                        ),
                        math.divide(
                            math.pow(k, 2*n),
                            4*n+1
                        )
                    );
                    sum = math.add(sum, term);
                }
                
                return math.multiply(
                    math.divide(math.pi, 2),
                    sum
                );
            };
            
            // –≠–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ–≥—Ä–∞–ª –≤—Ç–æ—Ä–æ–≥–æ —Ä–æ–¥–∞
            window.customMathFunctions.ellipticE = function(k) {
                var sum = math.complex(1, 0);
                var terms = 10;
                
                for (var n = 1; n < terms; n++) {
                    var term = math.multiply(
                        math.pow(
                            math.divide(
                                math.factorial(2*n),
                                math.pow(math.factorial(n), 2)
                            ),
                            2
                        ),
                        math.divide(
                            math.pow(k, 2*n),
                            1-2*n
                        )
                    );
                    sum = math.add(sum, term);
                }
                
                return math.multiply(
                    math.divide(math.pi, 2),
                    sum
                );
            };
            
            // –ü–æ–ª–∏–ª–æ–≥–∞—Ä–∏—Ñ–º
            window.customMathFunctions.polylog = function(s, z) {
                var sum = math.complex(0, 0);
                var terms = 15;
                
                for (var k = 1; k <= terms; k++) {
                    sum = math.add(
                        sum,
                        math.divide(
                            math.pow(z, k),
                            math.pow(k, s)
                        )
                    );
                }
                
                return sum;
            };
            
            // –§—É–Ω–∫—Ü–∏—è –î–∏—Ä–∏—Ö–ª–µ
            window.customMathFunctions.dirichlet = function(n, z) {
                var sum = 0;
                for (var k = 1; k <= n; k++) {
                    if (n % k === 0) {
                        sum += Math.cos(k * z);
                    }
                }
                return sum;
            };
            
            // –§—É–Ω–∫—Ü–∏—è –õ–æ—Ä–µ–Ω—Ü–∞
            window.customMathFunctions.lorentz = function(z, gamma) {
                return math.divide(
                    1,
                    math.add(
                        1,
                        math.pow(
                            math.divide(z, gamma),
                            2
                        )
                    )
                );
            };
            
            // –§—É–Ω–∫—Ü–∏—è –í–µ–π–µ—Ä—à—Ç—Ä–∞—Å—Å–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
            window.customMathFunctions.weierstrassP = function(z, g2, g3) {
                return math.divide(
                    1,
                    math.pow(z, 2)
                ); // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è, —Ç–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π —á–ª–µ–Ω —Ä–∞–∑–ª–æ–∂–µ–Ω–∏—è
            };
            
            // –§—É–Ω–∫—Ü–∏—è –õ–∞–Ω–¥–∞—É
            window.customMathFunctions.landau = function(z) {
                return math.exp(
                    math.multiply(
                        -1,
                        math.exp(math.multiply(-1, z))
                    )
                );
            };
            
            // –§—É–Ω–∫—Ü–∏—è –†–∞–π—Ç–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
            window.customMathFunctions.wright = function(a, b, z) {
                var sum = math.complex(0, 0);
                var terms = 10;
                
                for (var k = 0; k < terms; k++) {
                    sum = math.add(
                        sum,
                        math.divide(
                            math.pow(z, k),
                            math.multiply(
                                math.factorial(k),
                                math.gamma(a*k + b)
                            )
                        )
                    );
                }
                
                return sum;
            };
            
            // –¢–µ—Ç–∞-—Ñ—É–Ω–∫—Ü–∏–∏ –Ø–∫–æ–±–∏
            window.customMathFunctions.theta1 = function(z, q) {
                if (typeof q === 'undefined') q = 0.5;
                
                var sum = math.complex(0, 0);
                var terms = 10; // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —á–∏—Å–ª–æ —á–ª–µ–Ω–æ–≤ —Ä—è–¥–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                
                for (var n = 0; n < terms; n++) {
                    var sign = Math.pow(-1, n);
                    var qPower = Math.pow(q, n * (n + 1));
                    var term = math.multiply(
                        sign * qPower,
                        math.sin(math.multiply(2 * n + 1, z))
                    );
                    sum = math.add(sum, term);
                }
                
                return math.multiply(2, sum);
            };
            
            window.customMathFunctions.theta2 = function(z, q) {
                if (typeof q === 'undefined') q = 0.5;
                
                var sum = math.complex(0, 0);
                var terms = 10;
                
                for (var n = 0; n < terms; n++) {
                    var qPower = Math.pow(q, n * (n + 1));
                    var term = math.multiply(
                        qPower,
                        math.cos(math.multiply(2 * n + 1, z))
                    );
                    sum = math.add(sum, term);
                }
                
                return math.multiply(2, sum);
            };
            
            window.customMathFunctions.theta3 = function(z, q) {
                if (typeof q === 'undefined') q = 0.5;
                
                var sum = math.complex(1, 0); // –ù–∞—á–∏–Ω–∞–µ–º —Å 1 (n=0 —á–ª–µ–Ω)
                var terms = 10;
                
                for (var n = 1; n < terms; n++) {
                    var qPower = Math.pow(q, n * n);
                    var term = math.multiply(
                        2 * qPower,
                        math.cos(math.multiply(2 * n, z))
                    );
                    sum = math.add(sum, term);
                }
                
                return sum;
            };
            
            window.customMathFunctions.theta4 = function(z, q) {
                if (typeof q === 'undefined') q = 0.5;
                
                var sum = math.complex(1, 0); // –ù–∞—á–∏–Ω–∞–µ–º —Å 1 (n=0 —á–ª–µ–Ω)
                var terms = 10;
                
                for (var n = 1; n < terms; n++) {
                    var sign = Math.pow(-1, n);
                    var qPower = Math.pow(q, n * n);
                    var term = math.multiply(
                        2 * sign * qPower,
                        math.cos(math.multiply(2 * n, z))
                    );
                    sum = math.add(sum, term);
                }
                
                return sum;
            };
            
            // –û–±—â–∞—è —Ç–µ—Ç–∞-—Ñ—É–Ω–∫—Ü–∏—è —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏
            window.customMathFunctions.thetaGeneral = function(z, tau, a, b) {
                if (typeof tau === 'undefined') tau = math.complex(0, 1);
                if (typeof a === 'undefined') a = 0;
                if (typeof b === 'undefined') b = 0;
                
                var sum = math.complex(0, 0);
                var terms = 7; // –ú–µ–Ω—å—à–µ —á–ª–µ–Ω–æ–≤ –¥–ª—è –æ–±—â–µ–π —Ñ–æ—Ä–º—ã (–±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è)
                var q = math.exp(math.multiply(math.pi, math.multiply(math.i, tau)));
                
                for (var n = -terms; n <= terms; n++) {
                    // exp(œÄi(n+a)¬≤œÑ) * exp(2œÄi(n+a)(z+b))
                    var nPlusA = n + a;
                    var exponent1 = math.multiply(
                        math.multiply(math.pi, math.i),
                        math.multiply(nPlusA * nPlusA, tau)
                    );
                    var exponent2 = math.multiply(
                        math.multiply(2 * math.pi, math.i),
                        math.multiply(nPlusA, z + b)
                    );
                    
                    var term = math.multiply(
                        math.exp(exponent1),
                        math.exp(exponent2)
                    );
                    
                    sum = math.add(sum, term);
                }
                
                return sum;
            };
            
            // –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è –∏ –º–Ω–∏–º–∞—è —á–∞—Å—Ç–∏
            window.customMathFunctions.re = function(z) {
                if (math.typeOf(z) === 'Complex') {
                    return z.re;
                }
                return z;
            };

            window.customMathFunctions.im = function(z) {
                if (math.typeOf(z) === 'Complex') {
                    return z.im;
                }
                return 0;
            };
            
            // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
            window.customMathFunctions.phi = (1 + Math.sqrt(5)) / 2; // –ó–æ–ª–æ—Ç–æ–µ —Å–µ—á–µ–Ω–∏–µ
            window.customMathFunctions.eulergamma = 0.57721566490153286; // –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –≠–π–ª–µ—Ä–∞-–ú–∞—Å–∫–µ—Ä–æ–Ω–∏

            // –§—É–Ω–∫—Ü–∏—è —á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
            window.customMathFunctions.deriv = function(func, z, h) {
                if (typeof h === 'undefined') h = 1e-6;
                
                try {
                    // –í—ã—á–∏—Å–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Ç–æ—á–∫–µ z + h
                    const scope = { z: math.add(z, h) };
                    const f_z_plus_h = evaluateWithParser(func, scope);
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Ç–æ—á–∫–µ z
                    scope.z = z;
                    const f_z = evaluateWithParser(func, scope);
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–π
                    return math.divide(math.subtract(f_z_plus_h, f_z), h);
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–π:", error);
                    return math.complex(0, 0);
                }
            };

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è n-–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–π
            window.customMathFunctions.nthDeriv = function(func, z, n, h) {
                if (typeof h === 'undefined') h = 1e-6;
                if (typeof n === 'undefined') n = 1;
                
                // –î–ª—è n = 0 –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å–∞–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
                if (n === 0) {
                    try {
                        return evaluateWithParser(func, { z: z });
                    } catch (error) {
                        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏:", error);
                        return math.complex(0, 0);
                    }
                }
                
                // –î–ª—è n = 1 –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω–æ–µ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ
                if (n === 1) {
                    return window.customMathFunctions.deriv(func, z, h);
                }
                
                // –î–ª—è n > 1 —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –≤—ã—á–∏—Å–ª—è–µ–º n-1 –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é –∏ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä—É–µ–º –µ—ë
                const derivFunc = function(z) {
                    return window.customMathFunctions.nthDeriv(func, z, n-1, h);
                };
                
                try {
                    // –í—ã—á–∏—Å–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ (n-1)-–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–π –≤ —Ç–æ—á–∫–µ z + h
                    const deriv_z_plus_h = derivFunc(math.add(z, h));
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ (n-1)-–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–π –≤ —Ç–æ—á–∫–µ z
                    const deriv_z = derivFunc(z);
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ n-–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–π
                    return math.divide(math.subtract(deriv_z_plus_h, deriv_z), h);
                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ ${n}-–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–π:`, error);
                    return math.complex(0, 0);
                }
            };

            // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–π (–¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏—è—Ö)
            window.customMathFunctions.diff = function(func, z, h) {
                return window.customMathFunctions.deriv(func, z, h);
            };

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—É–º–º—ã –≤—ã—Ä–∞–∂–µ–Ω–∏–π
            window.customMathFunctions.sum = function(expr, variable, start, end) {
                if (typeof start !== 'number' || typeof end !== 'number') {
                    throw new Error("–ü—Ä–µ–¥–µ–ª—ã —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–æ–≤—ã–º–∏");
                }
                
                let result = math.complex(0, 0);
                
                for (let i = start; i <= end; i++) {
                    try {
                        // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
                        const scope = {};
                        scope[variable] = i;
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É–º–º–µ
                        const termValue = evaluateWithParser(expr, scope);
                        result = math.add(result, termValue);
                    } catch (error) {
                        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ —Å—É–º–º—ã –¥–ª—è ${variable}=${i}:`, error);
                    }
                }
                
                return result;
            };

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ä—è–¥–∞ —Å –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é
            window.customMathFunctions.series = function(expr, variable, start, maxTerms, tolerance) {
                if (typeof start !== 'number') {
                    throw new Error("–ù–∞—á–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–≤—ã–º");
                }
                
                if (typeof maxTerms === 'undefined') maxTerms = 100;
                if (typeof tolerance === 'undefined') tolerance = 1e-10;
                
                let result = math.complex(0, 0);
                let prevResult = math.complex(0, 0);
                let i = start;
                let termCount = 0;
                
                while (termCount < maxTerms) {
                    try {
                        // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
                        const scope = {};
                        scope[variable] = i;
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É–º–º–µ
                        const termValue = evaluateWithParser(expr, scope);
                        result = math.add(result, termValue);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ–π —Ä–∞–∑–Ω–∏—Ü–µ
                        const diff = math.abs(math.subtract(result, prevResult));
                        if (diff < tolerance) {
                            break;
                        }
                        
                        prevResult = result;
                        i++;
                        termCount++;
                    } catch (error) {
                        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ —Ä—è–¥–∞ –¥–ª—è ${variable}=${i}:`, error);
                        break;
                    }
                }
                
                return result;
            };

            // 2. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ math.js

            // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π parser
            try {
                window.parser = math.parser();
                
                // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ parser
                Object.entries(window.customMathFunctions).forEach(([name, func]) => {
                    if (typeof func === 'function') {
                        math[name] = func; // –î–æ–±–∞–≤–ª—è–µ–º –≤ math
                        window.parser.set(name, func); // –ò –≤ parser
                        console.log(`–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è: ${name}`);
                    } else {
                        math[name] = func; // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ math
                        window.parser.set(name, func); // –ò –≤ parser
                        console.log(`–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞: ${name} = ${func}`);
                    }
                });
                
                console.log("–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã.");
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π:", error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –≤—ã—á–∏—Å–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –≥–æ—Ç–æ–≤–æ–≥–æ parser
        function evaluateWithParser(expr, scope) {
            try {
                // –í—Ä–µ–º–µ–Ω–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ parser
                Object.entries(scope).forEach(([key, value]) => {
                    window.parser.set(key, value);
                });
                
                // –í—ã—á–∏—Å–ª–∏—Ç—å
                const result = window.parser.evaluate(expr);
                
                return result;
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è:", error);
                throw error;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏—è
        function transformForDifferentiation(funcStr) {
            // –ó–∞–º–µ–Ω—è–µ–º diff(f(z), z) –Ω–∞ –≤—ã–∑–æ–≤ –Ω–∞—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ diff
            const diffPattern = /diff\s*\(\s*([^,]+)\s*,\s*z\s*(?:,\s*([^)]+))?\s*\)/g;
            funcStr = funcStr.replace(diffPattern, (match, innerFunc, step) => {
                if (step) {
                    return `diff("${innerFunc.replace(/"/g, '\\"')}", z, ${step})`;
                } else {
                    return `diff("${innerFunc.replace(/"/g, '\\"')}", z)`;
                }
            });
            
            // –ó–∞–º–µ–Ω—è–µ–º deriv(f(z), n) –Ω–∞ –≤—ã–∑–æ–≤ nthDeriv
            const derivPattern = /deriv\s*\(\s*([^,]+)\s*,\s*(\d+)\s*(?:,\s*([^)]+))?\s*\)/g;
            funcStr = funcStr.replace(derivPattern, (match, innerFunc, order, step) => {
                if (step) {
                    return `nthDeriv("${innerFunc.replace(/"/g, '\\"')}", z, ${order}, ${step})`;
                } else {
                    return `nthDeriv("${innerFunc.replace(/"/g, '\\"')}", z, ${order})`;
                }
            });
            
            // –ó–∞–º–µ–Ω—è–µ–º —Å—É–º–º—É sum(expr, i, start, end) –Ω–∞ –≤—ã–∑–æ–≤ –Ω–∞—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ sum
            const sumPattern = /sum\s*\(\s*([^,]+)\s*,\s*([a-zA-Z][a-zA-Z0-9]*)\s*,\s*(\d+|\-\d+)\s*,\s*(\d+|\-\d+)\s*\)/g;
            funcStr = funcStr.replace(sumPattern, (match, expr, variable, start, end) => {
                return `sum("${expr.replace(/"/g, '\\"')}", "${variable}", ${start}, ${end})`;
            });
            
            // –ó–∞–º–µ–Ω—è–µ–º —Ä—è–¥ series(expr, i, start) –Ω–∞ –≤—ã–∑–æ–≤ –Ω–∞—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ series
            const seriesPattern = /series\s*\(\s*([^,]+)\s*,\s*([a-zA-Z][a-zA-Z0-9]*)\s*,\s*(\d+|\-\d+)\s*(?:,\s*(\d+))?\s*(?:,\s*([^)]+))?\s*\)/g;
            funcStr = funcStr.replace(seriesPattern, (match, expr, variable, start, maxTerms, tolerance) => {
                let result = `series("${expr.replace(/"/g, '\\"')}", "${variable}", ${start}`;
                if (maxTerms) result += `, ${maxTerms}`;
                if (tolerance) result += `, ${tolerance}`;
                return result + ')';
            });
            
            return funcStr;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        function compileUserFunction() {
            let success = true;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ —Å—É–º–º—ã –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏—Ö
            if (inputMode === "z") {
                const functionText = document.getElementById('customFunctionInput').value;
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å diff, deriv, sum –∏ series
                customFunction = transformForDifferentiation(functionText);
            } else {
                const reFunctionText = document.getElementById('reFunction').value;
                const imFunctionText = document.getElementById('imFunction').value;
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ–±–µ–∏—Ö —á–∞—Å—Ç–µ–π
                reFunction = transformForDifferentiation(reFunctionText);
                imFunction = transformForDifferentiation(imFunctionText);
            }

            if (inputMode === "z") {
                // –†–µ–∂–∏–º z - –∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º –æ–¥–Ω—É —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç z
                const functionText = document.getElementById('customFunctionInput').value;
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                customFunction = functionText;
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
                const transformedFunction = transformForDifferentiation(functionText);
                
                if (debugMode) {
                    console.log("–ö–æ–º–ø–∏–ª—è—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–∏:", functionText);
                    updateDebugInfo();
                }
                
                try {
                    // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å –ø—Ä–æ—Å—Ç—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
                    const z = math.complex(1, 1);
                    const result = evaluateWithParser(transformedFunction, { z: z });
                    
                    // –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ - –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é
                    compiledFunction = transformedFunction;
                    
                    // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    clearErrorMessages();
                    
                    if (debugMode) {
                        console.log("–§—É–Ω–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è z=1+i:", result);
                        console.log("–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:", transformedFunction);
                    }
                } catch (error) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    showErrorMessage('functionError', `–û—à–∏–±–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏: ${error.message}`, 
                                     document.getElementById('customFunctionInput').parentNode);
                    console.error("–û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏:", error);
                    console.error("–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:", transformedFunction);
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                    compiledFunction = "z";
                    success = false;
                }
            } else {
                // –†–µ–∂–∏–º (x,y) - –∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º –¥–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç x –∏ y
                const reFunctionText = document.getElementById('reFunction').value;
                const imFunctionText = document.getElementById('imFunction').value;
                
                reFunction = reFunctionText;
                imFunction = imFunctionText;
                
                if (debugMode) {
                    console.log("–ö–æ–º–ø–∏–ª—è—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π Re:", reFunctionText, "Im:", imFunctionText);
                    updateDebugInfo();
                }
                
                // –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º Re —Ñ—É–Ω–∫—Ü–∏—é
                try {
                    // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å –ø—Ä–æ—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                    const result = evaluateWithParser(reFunctionText, { x: 1, y: 1 });
                    
                    // –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ - –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é
                    compiledReFunction = reFunctionText;
                    
                    // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    const errorElement = document.getElementById('reFunctionError');
                    if (errorElement) {
                        errorElement.remove();
                    }
                    
                    if (debugMode) {
                        console.log("Re —Ñ—É–Ω–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è x=1,y=1:", result);
                    }
                } catch (error) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    showErrorMessage('reFunctionError', `–û—à–∏–±–∫–∞ –≤ Re —Ñ—É–Ω–∫—Ü–∏–∏: ${error.message}`, 
                                    document.getElementById('reFunction').parentNode);
                    console.error("–û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ Re:", error);
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                    compiledReFunction = "x";
                    success = false;
                }
                
                // –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º Im —Ñ—É–Ω–∫—Ü–∏—é
                try {
                    // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å –ø—Ä–æ—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                    const result = evaluateWithParser(imFunctionText, { x: 1, y: 1 });
                    
                    // –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ - –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é
                    compiledImFunction = imFunctionText;
                    
                    // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    const errorElement = document.getElementById('imFunctionError');
                    if (errorElement) {
                        errorElement.remove();
                    }
                    
                    if (debugMode) {
                        console.log("Im —Ñ—É–Ω–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è x=1,y=1:", result);
                    }
                } catch (error) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    showErrorMessage('imFunctionError', `–û—à–∏–±–∫–∞ –≤ Im —Ñ—É–Ω–∫—Ü–∏–∏: ${error.message}`, 
                                    document.getElementById('imFunction').parentNode);
                    console.error("–û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ Im:", error);
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                    compiledImFunction = "y";
                    success = false;
                }
            }
            
            return success;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö
        function clearErrorMessages() {
            const errorElements = document.querySelectorAll('.error-message');
            errorElements.forEach(element => element.remove());
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö
        function showErrorMessage(id, message, parentElement) {
            let errorElement = document.getElementById(id);
            
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.id = id;
                errorElement.className = 'error-message';
                parentElement.parentNode.insertBefore(errorElement, parentElement.nextSibling);
            }
            
            errorElement.textContent = message;
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function showProgressIndicator() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –æ—Ç–º–µ–Ω—ã
            renderingCancelled = false;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const progressContainer = document.getElementById('progress-container');
            if (progressContainer) {
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–µ
                document.getElementById('function-name').textContent = customFunction;
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ 0%
                updateProgressBar(0);
                
                // –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä - –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–∂–µ –∑–∞–¥–∞–Ω–æ –≤ HTML/CSS
                progressContainer.style.display = 'block';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
                const cancelButton = document.getElementById('cancel-rendering');
                if (cancelButton) {
                    cancelButton.onclick = function() {
                        renderingCancelled = true;
                        hideProgressIndicator();
                    };
                }
            }
        }
        
        function hideProgressIndicator() {
            const progressContainer = document.getElementById('progress-container');
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
        }
        
        function updateProgressBar(percent) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (progressBar && progressText) {
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –º–µ–∂–¥—É 0 –∏ 100
                percent = Math.max(0, Math.min(100, percent));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—É –ø–æ–ª–æ—Å—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                progressBar.style.width = percent + '%';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                progressText.textContent = Math.round(percent) + '%';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function exportImage(format) {
            const canvas = document.getElementById('screen');
            let dataURL, filename, link;
            
            if (format === 'svg') {
                // –°–æ–∑–¥–∞–Ω–∏–µ SVG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const svgData = createSVGFromCanvas(canvas);
                const blob = new Blob([svgData], {type: 'image/svg+xml'});
                dataURL = URL.createObjectURL(blob);
                filename = `complex_function_${getCurrentTimestamp()}.svg`;
            } else if (format === 'jpg') {
                dataURL = canvas.toDataURL('image/jpeg', 0.92);
                filename = `complex_function_${getCurrentTimestamp()}.jpg`;
            } else {
                // PNG –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                dataURL = canvas.toDataURL('image/png');
                filename = `complex_function_${getCurrentTimestamp()}.png`;
            }
            
            // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            link = document.createElement('a');
            link.href = dataURL;
            link.download = filename;
            link.click();
            
            // –ï—Å–ª–∏ –±—ã–ª —Å–æ–∑–¥–∞–Ω –æ–±—ä–µ–∫—Ç–Ω—ã–π URL, –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –µ–≥–æ
            if (format === 'svg') {
                URL.revokeObjectURL(dataURL);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
            updateMetadata();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è SVG –∏–∑ Canvas
        function createSVGFromCanvas(canvas) {
            const width = canvas.width;
            const height = canvas.height;
            const ctx = canvas.getContext('2d');
            const imgData = ctx.getImageData(0, 0, width, height);
            const pixels = imgData.data;
            
            // –°–æ–∑–¥–∞–µ–º SVG —Å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∏–∫—Å–µ–ª—è
            let svgContent = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ SVG
            svgContent += `<metadata>
                <function>${escapeXml(getFunctionString())}</function>
                <vizMode>${vizMode}</vizMode>`;
                
            if (vizMode === "domainColoring") {
                svgContent += `<method>${escapeXml(getMethodString())}</method>`;
            } else {
                svgContent += `<gridType>${getGridTypeString()}</gridType>
                <gridDensity>${gridDensity}</gridDensity>
                <gridLineWidth>${gridLineWidth}</gridLineWidth>`;
            }
            
            svgContent += `<domain>X[${xMin.toFixed(2)}, ${xMax.toFixed(2)}], Y[${yMin.toFixed(2)}, ${yMax.toFixed(2)}]</domain>
                <constants>s=${s.toFixed(2)}, d=${d.toFixed(2)}, l=${l.toFixed(2)}, p=${p.toFixed(2)}, theta=${(theta*180/Math.PI).toFixed(1)}¬∞, phi=${(phi*180/Math.PI).toFixed(1)}¬∞</constants>
                <date>${new Date().toISOString()}</date>
            </metadata>`;
            
            // –î–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ SVG, —Å–æ–∑–¥–∞–µ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏ –ø–æ —Å—Ç—Ä–æ–∫–∞–º –æ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
            for (let y = 0; y < height; y++) {
                let currentColor = null;
                let startX = 0;
                let currentRun = 0;
                
                for (let x = 0; x <= width; x++) {
                    const isLastPixel = x === width;
                    let pixelColor = null;
                    
                    if (!isLastPixel) {
                        const idx = (y * width + x) * 4;
                        pixelColor = `rgb(${pixels[idx]},${pixels[idx+1]},${pixels[idx+2]})`;
                    }
                    
                    if (pixelColor !== currentColor || isLastPixel) {
                        if (currentColor !== null && currentRun > 0) {
                            svgContent += `<rect x="${startX}" y="${y}" width="${currentRun}" height="1" fill="${currentColor}" />`;
                        }
                        currentColor = pixelColor;
                        startX = x;
                        currentRun = 1;
                    } else {
                        currentRun++;
                    }
                }
            }
            
            svgContent += '</svg>';
            return svgContent;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç—Å–∫–µ–π–ø–∏–Ω–≥–∞ XML
        function escapeXml(unsafe) {
            return unsafe.replace(/[<>&'"]/g, c => {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case "'": return '&apos;';
                    case '"': return '&quot;';
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
        function getCurrentTimestamp() {
            const now = new Date();
            return now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ —Ñ—É–Ω–∫—Ü–∏–∏
        function getFunctionString() {
            if (inputMode === "z") {
                return customFunction;
            } else {
                return `Re(x,y) = ${reFunction}, Im(x,y) = ${imFunction}`;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –º–µ—Ç–æ–¥–∞ –æ–∫—Ä–∞—Å–∫–∏
        function getMethodString() {
            const method = parseInt(lMethodSelect.value);
            const methodNames = [
                "L = 0.5 (–∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞)",
                "L = Math.pow(1/2, abs * p) (–∑–∞—Ç—É—Ö–∞–Ω–∏–µ)",
                "L = Math.min(Math.abs((Math.floor(Math.log(abs)))-Math.log(abs)), ...)",
                "L = Math.min(Math.abs((Math.floor(d*Math.log(abs)))-d*Math.log(abs)), ...)",
                "L = (Math.abs((Math.floor(ABS)-ABS)*(Math.floor(ARG)-ARG))-0.5)/l+0.5",
                "L = (Math.floor(d*Math.abs(Math.log(abs))%2))^(Math.floor((arg+Math.PI)/(Math.PI/(d*3)))%2)",
                "L = (turn+Math.pow(-1, turn)*(Math.floor(d*Math.abs(Math.log(abs))%2)))^(Math.floor((arg+Math.PI)/(Math.PI/(d*3)))%2)"
            ];
            
            return methodNames[method] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–µ—Ç–æ–¥";
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        function updateMetadata() {
            const metadataElem = document.getElementById('metadataText');
            if (!metadataElem) return;
            
            let metadata = `
        –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –ö–û–ú–ü–õ–ï–ö–°–ù–û–ô –§–£–ù–ö–¶–ò–ò
        -------------------------------
        –î–∞—Ç–∞: ${new Date().toLocaleString()}

        –§–£–ù–ö–¶–ò–Ø:
        ${getFunctionString()}

        `;

            if (vizMode === "domainColoring") {
                metadata += `–†–ï–ñ–ò–ú: –†–∞—Å–∫—Ä–∞—Å–∫–∞ –æ–±–ª–∞—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è

        –ú–ï–¢–û–î –û–ö–†–ê–°–ö–ò:
        ${getMethodString()}
        `;
            } else {
                metadata += `–†–ï–ñ–ò–ú: –ö–æ–Ω—Ñ–æ—Ä–º–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

        –¢–ò–ü –†–ï–®–Å–¢–ö–ò: ${getGridTypeString()}
        –ü–õ–û–¢–ù–û–°–¢–¨ –†–ï–®–Å–¢–ö–ò: ${gridDensity}
        –®–ò–†–ò–ù–ê –õ–ò–ù–ò–ô: ${gridLineWidth}%
        `;
            }

            metadata += `
        –û–ë–õ–ê–°–¢–¨ –ö–û–ú–ü–õ–ï–ö–°–ù–û–ô –ü–õ–û–°–ö–û–°–¢–ò:
        X: [${xMin.toFixed(2)}, ${xMax.toFixed(2)}]
        Y: [${yMin.toFixed(2)}, ${yMax.toFixed(2)}]

        –ö–û–ù–°–¢–ê–ù–¢–´:
        s = ${s.toFixed(2)}
        d = ${d.toFixed(2)}
        l = ${l.toFixed(2)}
        p = ${p.toFixed(2)}
        theta = ${(theta*180/Math.PI).toFixed(1)}¬∞ (${formatAngleValue(theta)})
        phi = ${(phi*180/Math.PI).toFixed(1)}¬∞ (${formatAngleValue(phi)})

        –†–ê–ó–ú–ï–†–´ –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø:
        ${document.getElementById('screen').width}x${document.getElementById('screen').height} –ø–∏–∫—Å–µ–ª–µ–π
        -------------------------------
        `;
            
            metadataElem.value = metadata;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —É–≥–ª–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function formatAngleValue(radians) {
            // –ü–æ–∏—Å–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —É–≥–ª–æ–≤
            const anglesMap = {
                '0': '0',
                [Math.PI/6]: 'œÄ/6',
                [Math.PI/4]: 'œÄ/4',
                [Math.PI/3]: 'œÄ/3',
                [Math.PI/2]: 'œÄ/2',
                [2*Math.PI/3]: '2œÄ/3',
                [3*Math.PI/4]: '3œÄ/4',
                [5*Math.PI/6]: '5œÄ/6',
                [Math.PI]: 'œÄ',
                [7*Math.PI/6]: '7œÄ/6',
                [5*Math.PI/4]: '5œÄ/4',
                [4*Math.PI/3]: '4œÄ/3',
                [3*Math.PI/2]: '3œÄ/2',
                [5*Math.PI/3]: '5œÄ/3',
                [7*Math.PI/4]: '7œÄ/4',
                [11*Math.PI/6]: '11œÄ/6',
                [2*Math.PI]: '2œÄ'
            };
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –Ω–∞—à–µ–π –∫–∞—Ä—Ç–µ —É–≥–ª–æ–≤ —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é 0.01
            for (const [angle, text] of Object.entries(anglesMap)) {
                if (Math.abs(radians - angle) < 0.01) {
                    return text + ' —Ä–∞–¥';
                }
            }
            
            // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –∫–∞—Ä—Ç–µ, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            return radians.toFixed(2) + ' —Ä–∞–¥';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyMetadata() {
            const metadataElem = document.getElementById('metadataText');
            metadataElem.select();
            document.execCommand('copy');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏
            const tempNotice = document.createElement('div');
            tempNotice.textContent = '–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!';
            tempNotice.style.position = 'fixed';
            tempNotice.style.bottom = '20px';
            tempNotice.style.left = '50%';
            tempNotice.style.transform = 'translateX(-50%)';
            tempNotice.style.backgroundColor = '#4CAF50';
            tempNotice.style.color = 'white';
            tempNotice.style.padding = '10px 20px';
            tempNotice.style.borderRadius = '4px';
            tempNotice.style.zIndex = '1000';
            document.body.appendChild(tempNotice);
            
            setTimeout(() => {
                document.body.removeChild(tempNotice);
            }, 2000);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
        function exportMetadata() {
            const metadata = document.getElementById('metadataText').value;
            const blob = new Blob([metadata], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `complex_function_metadata_${getCurrentTimestamp()}.txt`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        function toggleVizMode() {
            const domainColoringRadio = document.getElementById('domainColoringRadio');
            const conformalSettingsContainer = document.getElementById('conformalSettingsContainer');
            const lMethodSelect = document.getElementById('lMethod');
            const lMethodContainer = lMethodSelect.closest('.control-group');
            
            if (domainColoringRadio.checked) {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∂–∏–º —Ä–∞—Å–∫—Ä–∞—Å–∫–∏ –æ–±–ª–∞—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                vizMode = "domainColoring";
                conformalSettingsContainer.style.display = "none";
                lMethodContainer.style.display = "block";
            } else {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∂–∏–º –∫–æ–Ω—Ñ–æ—Ä–º–Ω—ã—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–π
                vizMode = "conformalMap";
                conformalSettingsContainer.style.display = "block";
                lMethodContainer.style.display = "none";
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            updateVisualization();
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ —Ä–µ—à—ë—Ç–∫–∏
        function updateGridDensity() {
            gridDensity = parseInt(document.getElementById('gridDensitySlider').value);
            document.getElementById('gridDensityValue').value = gridDensity;
            updateVisualization();
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ —Ä–µ—à—ë—Ç–∫–∏ –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞
        function updateGridDensityFromInput() {
            gridDensity = parseInt(document.getElementById('gridDensityValue').value);
            document.getElementById('gridDensitySlider').value = gridDensity;
            updateVisualization();
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã –ª–∏–Ω–∏–π —Ä–µ—à—ë—Ç–∫–∏
        function updateGridLineWidth() {
            gridLineWidth = parseInt(document.getElementById('gridLineWidthSlider').value);
            document.getElementById('gridLineWidthValue').value = gridLineWidth;
            updateVisualization();
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã –ª–∏–Ω–∏–π —Ä–µ—à—ë—Ç–∫–∏ –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞
        function updateGridLineWidthFromInput() {
            gridLineWidth = parseInt(document.getElementById('gridLineWidthValue').value);
            document.getElementById('gridLineWidthSlider').value = gridLineWidth;
            updateVisualization();
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è hex-—Ü–≤–µ—Ç–∞ –≤ RGB
        function hexToRgb(hex) {
            // –£–±–∏—Ä–∞–µ–º # –µ—Å–ª–∏ –µ—Å—Ç—å
            hex = hex.replace(/^#/, '');
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ RGB
            const bigint = parseInt(hex, 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            
            return { r, g, b };
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞ —Ä–µ—à—ë—Ç–∫–∏
        function getGridTypeString() {
            switch (gridType) {
                case "rectangular": return "–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è";
                case "polar": return "–ü–æ–ª—è—Ä–Ω–∞—è";
                case "chessboard": return "–®–∞—Ö–º–∞—Ç–Ω–æ–µ –ø–æ–ª–µ";
                default: return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø";
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞ —Ä–µ—à—ë—Ç–∫–∏
        function updateGridType() {
            gridType = document.getElementById('gridType').value;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            updateVisualization();
            
            if (debugMode) {
                console.log(`–¢–∏–ø —Ä–µ—à—ë—Ç–∫–∏ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${getGridTypeString()}`);
                updateDebugInfo();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —Ä–µ—à—ë—Ç–∫–∏ 1
        function updateGridColor1() {
            gridColor1 = document.getElementById('gridColor1').value;
            updateVisualization();
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —Ä–µ—à—ë—Ç–∫–∏ 2
        function updateGridColor2() {
            gridColor2 = document.getElementById('gridColor2').value;
            updateVisualization();
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function drawComplex() {
            const c = document.getElementById('screen');
            const SWIDTH = c.width;
            const SHEIGHT = c.height;
            const ctx = c.getContext("2d");
            
            // –î–û–ë–ê–í–õ–ï–ù–û: –°–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–æ–ø–∏–∏ –≥—Ä–∞–Ω–∏—Ü –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏
            // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            const x_min = xMin;
            const x_max = xMax;
            const y_min = yMin;
            const y_max = yMax;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            showProgressIndicator();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
            if (vizMode === "conformalMap") {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∫–æ–Ω—Ñ–æ—Ä–º–Ω—ã—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–π
                drawConformalMap();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                hideProgressIndicator();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                updateMetadata();
                
                return;  // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏, —Ç–∞–∫ –∫–∞–∫ –∫–æ–Ω—Ñ–æ—Ä–º–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–∂–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω—ã
            }
            
            // –°–æ–∑–¥–∞–µ–º imgData –æ–¥–∏–Ω —Ä–∞–∑
            const imgData = ctx.createImageData(SWIDTH, SHEIGHT);
            const pixels = imgData.data;
            
            // –í—ã–±–∏—Ä–∞–µ–º –º–µ—Ç–æ–¥ L
            const lMethod = parseInt(lMethodSelect.value);
            
            // –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é —Ñ—É–Ω–∫—Ü–∏—é, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
            if (!compiledFunction) {
                compileUserFunction();
            }
            
            // –§—É–Ω–∫—Ü–∏—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —á–∏—Å–ª–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
            const w = z => {
                try {
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–≤–æ—Ä–æ—Ç –∫ z
                    const rotatedZ = math.multiply(z, math.complex(Math.cos(theta), Math.sin(theta)));
                    
                    let result;
                    
                    if (inputMode === "z") {
                        // –†–µ–∂–∏–º z - –ø—Ä–∏–º–µ–Ω—è–µ–º –æ–¥–Ω—É —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç z
                        result = evaluateWithParser(compiledFunction, { 
                            z: rotatedZ, 
                            i: math.complex(0, 1), 
                            e: math.e, 
                            pi: math.pi 
                        });
                    } else {
                        // –†–µ–∂–∏–º (x,y) - –ø—Ä–∏–º–µ–Ω—è–µ–º –¥–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç x –∏ y
                        const x = rotatedZ.re;
                        const y = rotatedZ.im;
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º Re –∏ Im —á–∞—Å—Ç–∏
                        const reResult = evaluateWithParser(compiledReFunction, { 
                            x: x,
                            y: y,
                            i: math.complex(0, 1), 
                            e: math.e, 
                            pi: math.pi 
                        });
                        
                        const imResult = evaluateWithParser(compiledImFunction, { 
                            x: x,
                            y: y,
                            i: math.complex(0, 1), 
                            e: math.e, 
                            pi: math.pi 
                        });
                        
                        // –°–æ–∑–¥–∞–µ–º –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —á–∏—Å–ª–æ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                        result = math.complex(reResult, imResult);
                    }
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ç–æ—Ä–æ–π –ø–æ–≤–æ—Ä–æ—Ç –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
                    return math.multiply(result, math.complex(Math.cos(phi), Math.sin(phi)));
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏:", error);
                    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π z
                    return z;
                }
            };
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
            let y = 0;
            const startTime = performance.now(); // –î–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
            
            // –ò–ó–ú–ï–ù–ï–ù–û: –í—ã—á–∏—Å–ª—è–µ–º —à–∞–≥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏
            // –∏—Å–ø–æ–ª—å–∑—É—è –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–æ–ø–∏–∏
            const xStep = (x_max - x_min) / SWIDTH;
            const yStep = (y_max - y_min) / SHEIGHT;
            
            // –î–ª—è –∫–æ–Ω—Ñ–æ—Ä–º–Ω—ã—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–π - –≤—ã—á–∏—Å–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ—à—ë—Ç–∫–∏
            let gridSpacingX, gridSpacingY, lineWidthX, lineWidthY;
            if (vizMode === "conformalMap") {
                gridSpacingX = (x_max - x_min) / gridDensity;
                gridSpacingY = (y_max - y_min) / gridDensity;
                lineWidthX = gridSpacingX * (gridLineWidth / 100);
                lineWidthY = gridSpacingY * (gridLineWidth / 100);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                if (gridType === "chessboard") {
                    document.getElementById('function-name').textContent = `${customFunction} (—à–∞—Ö–º–∞—Ç–Ω–æ–µ –ø–æ–ª–µ ${gridDensity}x${gridDensity})`;
                } else {
                    document.getElementById('function-name').textContent = `${customFunction} (${getGridTypeString()} —Ä–µ—à—ë—Ç–∫–∞ ${gridDensity}x${gridDensity})`;
                }
            }
            
            function renderChunk() {
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –∫—É—Å–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞ —Ä–∞–∑ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ UI
                const chunkSize = 10;
                const endY = Math.min(y + chunkSize, SHEIGHT);
                
                for (; y < endY; y++) {
                    const yOffset = y * SWIDTH << 2; // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å–º–µ—â–µ–Ω–∏—è Y
                    // –ò–ó–ú–ï–ù–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–æ–ø–∏–∏ –≥—Ä–∞–Ω–∏—Ü
                    const Yc = y_max - y * yStep;
                    
                    for (let x = 0; x < SWIDTH; x++) {
                        const pixelOffset = yOffset + (x << 2); // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –∏–Ω–¥–µ–∫—Å–∞ –ø–∏–∫—Å–µ–ª—è
                        
                        // –ò–ó–ú–ï–ù–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–æ–ø–∏–∏ –≥—Ä–∞–Ω–∏—Ü
                        const Xc = x_min + x * xStep;
                        const z = math.complex(Xc, Yc);
                        
                        // –†–∞–∑–Ω—ã–µ —Ä–µ–∂–∏–º—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∏–∫—Å–µ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                        if (vizMode === "domainColoring") {
                            // –†–µ–∂–∏–º —Ä–∞—Å–∫—Ä–∞—Å–∫–∏ –æ–±–ª–∞—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π)
                            // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
                            const res = w(z);
                            
                            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–æ–¥—É–ª—å –∏ –∞—Ä–≥—É–º–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É—è math.js
                            const abs = math.abs(res);
                            const arg = math.arg(res);
                            
                            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º L –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –º–µ—Ç–æ–¥—É
                            const L = calculateL(abs, arg, lMethod);
                            
                            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º RGB –Ω–∞ –æ—Å–Ω–æ–≤–µ HSL –º–æ–¥–µ–ª–∏
                            const [r, g, b] = calculateRGB(Math.PI - arg, L, 1);
                            
                            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–∏–∫—Å–µ–ª—å –Ω–∞–ø—Ä—è–º—É—é
                            pixels[pixelOffset] = r;
                            pixels[pixelOffset+1] = g;
                            pixels[pixelOffset+2] = b;
                            pixels[pixelOffset+3] = 255;
                        } else {
                            // –†–µ–∂–∏–º –∫–æ–Ω—Ñ–æ—Ä–º–Ω—ã—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–π
                            let isOnGrid = false;
                            let isFirstColor = true;

                            // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ñ–æ—Ä–º—ã
                            const currentGridType = document.getElementById('gridType').value;
                            gridType = currentGridType; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é

                            if (currentGridType === "rectangular") {
                                // –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è —Ä–µ—à—ë—Ç–∫–∞
                                const xMod = Math.abs((Xc - x_min) % gridSpacingX);
                                const yMod = Math.abs((Yc - y_min) % gridSpacingY);
                                isOnGrid = (xMod < lineWidthX || xMod > gridSpacingX - lineWidthX || 
                                           yMod < lineWidthY || yMod > gridSpacingY - lineWidthY);
                                
                                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–ª–∏–∑–æ—Å—Ç–∏ –∫ –æ—Å–∏
                                const isCloseToX = Math.abs(Yc) < lineWidthY;
                                const isCloseToY = Math.abs(Xc) < lineWidthX;
                                
                                // –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–µ–º –æ—Å–∏
                                if (isCloseToX || isCloseToY) {
                                    isFirstColor = true;
                                } else {
                                    isFirstColor = true; // –í—Å–µ –ª–∏–Ω–∏–∏ —Å–µ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
                                }
                            } else if (currentGridType === "polar") {
                                // –ü–æ–ª—è—Ä–Ω–∞—è —Ä–µ—à—ë—Ç–∫–∞
                                const r = Math.sqrt(Xc * Xc + Yc * Yc);
                                const rMod = r % gridSpacingX;
                                const theta = Math.atan2(Yc, Xc);
                                const thetaStep = 2 * Math.PI / gridDensity;
                                const thetaMod = ((theta % thetaStep) + thetaStep) % thetaStep;
                                
                                // –î–ª—è –ª—É—á–µ–π –∏ –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–µ–π
                                isOnGrid = (rMod < lineWidthX || rMod > gridSpacingX - lineWidthX || 
                                           thetaMod < lineWidthY * thetaStep / gridSpacingY || 
                                           thetaMod > thetaStep - lineWidthY * thetaStep / gridSpacingY);
                                
                                // –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é –æ–∫—Ä—É–∂–Ω–æ—Å—Ç—å –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –æ—Å–∏
                                const isMainAxis = Math.abs(theta % (Math.PI/2)) < 0.05;
                                const isCentralCircle = r < lineWidthX * 2;
                                
                                if (isMainAxis || isCentralCircle) {
                                    isFirstColor = true;
                                } else {
                                    isFirstColor = false; // –í—Ç–æ—Ä–æ–π —Ü–≤–µ—Ç –¥–ª—è –Ω–µ–æ—Å–Ω–æ–≤–Ω—ã—Ö –ª–∏–Ω–∏–π
                                }
                            } else if (currentGridType === "chessboard") {
                                // –®–∞—Ö–º–∞—Ç–Ω–æ–µ –ø–æ–ª–µ
                                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫ –Ω–∏–∂–Ω–µ–º—É –ª–µ–≤–æ–º—É —É–≥–ª—É –æ–±–ª–∞—Å—Ç–∏
                                const normalizedX = Xc - x_min;
                                const normalizedY = Yc - y_min;
                                
                                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã —è—á–µ–π–∫–∏
                                const xGrid = Math.floor(normalizedX / gridSpacingX);
                                const yGrid = Math.floor(normalizedY / gridSpacingY);
                                
                                // –ß–µ—Ä–Ω–æ-–±–µ–ª—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
                                isFirstColor = (xGrid + yGrid) % 2 === 0;
                                isOnGrid = true; // –í—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ü–≤–µ—Ç –¥–ª—è —à–∞—Ö–º–∞—Ç–Ω–æ–≥–æ –ø–æ–ª—è
                            }

                            if (vizMode === "conformalMap") {
                                // –°—á–∏—Ç—ã–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º—ã
                                const color1 = document.getElementById('gridColor1').value;
                                const color2 = document.getElementById('gridColor2').value;
                                gridColor1 = color1;
                                gridColor2 = color2;
                                
                                if (isOnGrid) {
                                    // –ï—Å–ª–∏ —Ç–æ—á–∫–∞ –Ω–∞ —Ä–µ—à—ë—Ç–∫–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç —Ä–µ—à—ë—Ç–∫–∏ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –µ—ë
                                    const res = w(z);
                                    
                                    if (isFinite(res.re) && isFinite(res.im)) {
                                        // –í—ã–±–∏—Ä–∞–µ–º —Ü–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–ª–∞–≥–∞
                                        const color = isFirstColor ? hexToRgb(gridColor1) : hexToRgb(gridColor2);
                                        
                                        pixels[pixelOffset] = color.r;
                                        pixels[pixelOffset+1] = color.g;
                                        pixels[pixelOffset+2] = color.b;
                                        pixels[pixelOffset+3] = 255;
                                    } else {
                                        // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –∫–æ–Ω–µ—á–Ω—ã–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç
                                        pixels[pixelOffset] = 255;
                                        pixels[pixelOffset+1] = 0;
                                        pixels[pixelOffset+2] = 0;
                                        pixels[pixelOffset+3] = 255;
                                    }
                                } else {
                                    // –ï—Å–ª–∏ —Ç–æ—á–∫–∞ –Ω–µ –Ω–∞ —Ä–µ—à—ë—Ç–∫–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–ª—ã–π —Ü–≤–µ—Ç (—Ñ–æ–Ω)
                                    pixels[pixelOffset] = 255;
                                    pixels[pixelOffset+1] = 255;
                                    pixels[pixelOffset+2] = 255;
                                    pixels[pixelOffset+3] = 255;
                                }
                            }
                        }
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                const progress = (y / SHEIGHT) * 100;
                updateProgressBar(progress);
                
                // –ï—Å–ª–∏ –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –Ω–µ –æ—Ç–º–µ–Ω–µ–Ω, –ø–ª–∞–Ω–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∫—É—Å–æ–∫
                if (y < SHEIGHT && !renderingCancelled) {
                    requestAnimationFrame(renderChunk);
                } else {
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ canvas, –∫–æ–≥–¥–∞ –≤—Å–µ –ø–∏–∫—Å–µ–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏–ª–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ—Ç–º–µ–Ω–µ–Ω
                    if (!renderingCancelled) {
                        ctx.putImageData(imgData, 0, 0);
                        // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                        updateMetadata();
                    }
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    hideProgressIndicator();
                    
                    // –õ–æ–≥–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    if (debugMode) {
                        const endTime = performance.now();
                        console.log(`–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è ${renderingCancelled ? '–æ—Ç–º–µ–Ω–µ–Ω–∞' : '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞'} –∑–∞ ${(endTime - startTime).toFixed(2)} –º—Å`);
                        updateDebugInfo();
                    }
                }
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π –∫—É—Å–æ–∫ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            y = 0;
            renderChunk();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–æ—Ä–º–Ω—ã—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function drawConformalMap() {
            const canvas = document.getElementById('screen');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // –û—á–∏—â–∞–µ–º —Ö–æ–ª—Å—Ç –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ü–≤–µ—Ç–æ–º —Ñ–æ–Ω–∞
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = gridBackgroundColor;
            ctx.fillRect(0, 0, width, height);
            
            // –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–æ–ø–∏–∏ –≥—Ä–∞–Ω–∏—Ü
            const x_min = xMin;
            const x_max = xMax;
            const y_min = yMin;
            const y_max = yMax;
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø —Ä–µ—à—ë—Ç–∫–∏ –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const currentGridType = document.getElementById('gridType').value;
            const currentGridDensity = parseInt(document.getElementById('gridDensityValue').value);
            const color1 = document.getElementById('gridColor1').value;
            const color2 = document.getElementById('gridColor2').value;
            
            // –í—ã—á–∏—Å–ª—è–µ–º —à–∞–≥–∏ –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            const xStep = (x_max - x_min) / width;
            const yStep = (y_max - y_min) / height;
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ö–æ–ª—Å—Ç–∞
            const complexToCanvas = (z) => {
                if (!isFinite(z.re) || !isFinite(z.im)) return null;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏
                if (z.re < x_min || z.re > x_max || z.im < y_min || z.im > y_max) return null;
                
                const x = Math.round((z.re - x_min) / xStep);
                const y = Math.round((y_max - z.im) / yStep);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –Ω–∞ —Ö–æ–ª—Å—Ç–µ
                if (x < 0 || x >= width || y < 0 || y >= height) return null;
                
                return { x, y };
            };
            
            // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –∫ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–º—É —á–∏—Å–ª—É
            const applyUserFunction = (z) => {
                try {
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–≤–æ—Ä–æ—Ç –∫ z
                    const rotatedZ = math.multiply(z, math.complex(Math.cos(theta), Math.sin(theta)));
                    
                    let result;
                    
                    if (inputMode === "z") {
                        // –†–µ–∂–∏–º z - –ø—Ä–∏–º–µ–Ω—è–µ–º –æ–¥–Ω—É —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç z
                        result = evaluateWithParser(compiledFunction, { 
                            z: rotatedZ, 
                            i: math.complex(0, 1), 
                            e: math.e, 
                            pi: math.pi 
                        });
                    } else {
                        // –†–µ–∂–∏–º (x,y) - –ø—Ä–∏–º–µ–Ω—è–µ–º –¥–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç x –∏ y
                        const x = rotatedZ.re;
                        const y = rotatedZ.im;
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º Re –∏ Im —á–∞—Å—Ç–∏
                        const reResult = evaluateWithParser(compiledReFunction, { 
                            x: x,
                            y: y,
                            i: math.complex(0, 1), 
                            e: math.e, 
                            pi: math.pi 
                        });
                        
                        const imResult = evaluateWithParser(compiledImFunction, { 
                            x: x,
                            y: y,
                            i: math.complex(0, 1), 
                            e: math.e, 
                            pi: math.pi 
                        });
                        
                        // –°–æ–∑–¥–∞–µ–º –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —á–∏—Å–ª–æ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                        result = math.complex(reResult, imResult);
                    }
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ç–æ—Ä–æ–π –ø–æ–≤–æ—Ä–æ—Ç –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
                    return math.multiply(result, math.complex(Math.cos(phi), Math.sin(phi)));
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏:", error);
                    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null
                    return null;
                }
            };
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ª–∏–Ω–∏–∏ —Å —É—á–µ—Ç–æ–º —Ä–∞–∑—Ä—ã–≤–æ–≤
            const drawContinuousLine = (points, color) => {
                if (points.length < 2) return;
                
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                
                // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –ª–∏–Ω–∏—é
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                
                // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é, —Ä–∞–∑–±–∏–≤–∞—è –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç—ã –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö —Ä–∞–∑—Ä—ã–≤–∞—Ö
                for (let i = 1; i < points.length; i++) {
                    const dx = points[i].x - points[i-1].x;
                    const dy = points[i].y - points[i-1].y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    
                    // –ï—Å–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ, –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –ª–∏–Ω–∏—é
                    if (distance > Math.max(width, height) / 20) {
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(points[i].x, points[i].y);
                    } else {
                        ctx.lineTo(points[i].x, points[i].y);
                    }
                }
                
                ctx.stroke();
            };
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–ø–µ–π—Å–∏–Ω–≥–∞ —Å–µ—Ç–∫–∏
            const gridSpacingX = (x_max - x_min) / currentGridDensity;
            const gridSpacingY = (y_max - y_min) / currentGridDensity;
            
            // –†–∞—Å—á–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            let totalSteps = 0;
            let currentStep = 0;
            
            if (currentGridType === "rectangular") {
                totalSteps = 2 * currentGridDensity;
            } else if (currentGridType === "polar") {
                totalSteps = currentGridDensity * 2; // –ö—Ä—É–≥–∏ + –ª—É—á–∏
            } else if (currentGridType === "chessboard") {
                totalSteps = currentGridDensity * currentGridDensity;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
            document.getElementById('function-name').textContent = 
                `${customFunction} (${getGridTypeString()} —Ä–µ—à—ë—Ç–∫–∞ ${currentGridDensity}x${currentGridDensity})`;
            
            // –†–∏—Å—É–µ–º —Ä–µ—à—ë—Ç–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
            if (currentGridType === "rectangular") {
                // –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è —Ä–µ—à—ë—Ç–∫–∞
                
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ - –ø–µ—Ä–≤—ã–π —Ü–≤–µ—Ç
                for (let j = 0; j <= currentGridDensity; j++) {
                    const y = y_min + j * (y_max - y_min) / currentGridDensity;
                    const points = [];
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å —Ç–æ—á–µ–∫ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
                    const numPoints = width * 2;
                    
                    for (let i = 0; i <= numPoints; i++) {
                        const x = x_min + i * (x_max - x_min) / numPoints;
                        const z = math.complex(x, y);
                        const transformedZ = applyUserFunction(z);
                        
                        if (transformedZ) {
                            const canvasPoint = complexToCanvas(transformedZ);
                            if (canvasPoint) {
                                points.push(canvasPoint);
                            }
                        }
                    }
                    
                    // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é - –ø–µ—Ä–≤—ã–π —Ü–≤–µ—Ç –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö –ª–∏–Ω–∏–π
                    drawContinuousLine(points, color1);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    currentStep++;
                    updateProgressBar((currentStep / totalSteps) * 100);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—Ç–º–µ–Ω—É
                    if (renderingCancelled) return;
                }
                
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ - –≤—Ç–æ—Ä–æ–π —Ü–≤–µ—Ç
                for (let i = 0; i <= currentGridDensity; i++) {
                    const x = x_min + i * (x_max - x_min) / currentGridDensity;
                    const points = [];
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å —Ç–æ—á–µ–∫ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
                    const numPoints = height * 2;
                    
                    for (let j = 0; j <= numPoints; j++) {
                        const y = y_min + j * (y_max - y_min) / numPoints;
                        const z = math.complex(x, y);
                        const transformedZ = applyUserFunction(z);
                        
                        if (transformedZ) {
                            const canvasPoint = complexToCanvas(transformedZ);
                            if (canvasPoint) {
                                points.push(canvasPoint);
                            }
                        }
                    }
                    
                    // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é - –≤—Ç–æ—Ä–æ–π —Ü–≤–µ—Ç –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö –ª–∏–Ω–∏–π
                    drawContinuousLine(points, color2);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    currentStep++;
                    updateProgressBar((currentStep / totalSteps) * 100);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—Ç–º–µ–Ω—É
                    if (renderingCancelled) return;
                }
            } 
            else if (currentGridType === "polar") {
                // –ü–æ–ª—è—Ä–Ω–∞—è —Ä–µ—à—ë—Ç–∫–∞
                
                // –¶–µ–Ω—Ç—Ä –æ–±–ª–∞—Å—Ç–∏
                const centerX = (x_min + x_max) / 2;
                const centerY = (y_min + y_max) / 2;
                
                // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–¥–∏—É—Å
                const maxRadius = Math.max(
                    Math.abs(x_max - centerX),
                    Math.abs(y_max - centerY)
                ) * 1.5;
                
                // –†–∏—Å—É–µ–º –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–∏ - –≤—Ç–æ—Ä–æ–π —Ü–≤–µ—Ç
                for (let r = 0; r <= maxRadius; r += gridSpacingX) {
                    if (r < 0.001) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É
                    
                    const points = [];
                    const numPoints = 360; // –¢–æ—á–∫–∏ —á–µ—Ä–µ–∑ –∫–∞–∂–¥—ã–π –≥—Ä–∞–¥—É—Å
                    
                    for (let i = 0; i <= numPoints; i++) {
                        const angle = (i / numPoints) * 2 * Math.PI;
                        const x = centerX + r * Math.cos(angle);
                        const y = centerY + r * Math.sin(angle);
                        
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–æ—á–∫–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –æ–±–ª–∞—Å—Ç–∏
                        if (x < x_min || x > x_max || y < y_min || y > y_max) continue;
                        
                        const z = math.complex(x, y);
                        const transformedZ = applyUserFunction(z);
                        
                        if (transformedZ) {
                            const canvasPoint = complexToCanvas(transformedZ);
                            if (canvasPoint) {
                                points.push(canvasPoint);
                            }
                        }
                    }
                    
                    // –ö—Ä—É–≥–æ–≤—ã–µ –ª–∏–Ω–∏–∏ - –≤—Ç–æ—Ä–æ–π —Ü–≤–µ—Ç
                    drawContinuousLine(points, color2);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    currentStep++;
                    updateProgressBar((currentStep / totalSteps) * 100);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—Ç–º–µ–Ω—É
                    if (renderingCancelled) return;
                }
                
                // –†–∏—Å—É–µ–º –ª—É—á–∏ - –ø–µ—Ä–≤—ã–π —Ü–≤–µ—Ç
                for (let i = 0; i < currentGridDensity; i++) {
                    const angle = (i / currentGridDensity) * 2 * Math.PI;
                    const points = [];
                    
                    // –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫–∏ –≤–¥–æ–ª—å –ª—É—á–∞
                    const numPoints = 200; // –ë–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
                    
                    for (let r = 0; r <= maxRadius; r += maxRadius / numPoints) {
                        const x = centerX + r * Math.cos(angle);
                        const y = centerY + r * Math.sin(angle);
                        
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–æ—á–∫–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –æ–±–ª–∞—Å—Ç–∏
                        if (x < x_min || x > x_max || y < y_min || y > y_max) continue;
                        
                        const z = math.complex(x, y);
                        const transformedZ = applyUserFunction(z);
                        
                        if (transformedZ) {
                            const canvasPoint = complexToCanvas(transformedZ);
                            if (canvasPoint) {
                                points.push(canvasPoint);
                            }
                        }
                    }
                    
                    // –õ—É—á–∏ - –ø–µ—Ä–≤—ã–π —Ü–≤–µ—Ç
                    drawContinuousLine(points, color1);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    currentStep++;
                    updateProgressBar((currentStep / totalSteps) * 100);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—Ç–º–µ–Ω—É
                    if (renderingCancelled) return;
                }
            } 
            else if (currentGridType === "chessboard") {
                // –®–∞—Ö–º–∞—Ç–Ω–æ–µ –ø–æ–ª–µ
                
                // –†–∞–∑–º–µ—Ä —è—á–µ–µ–∫ —à–∞—Ö–º–∞—Ç–Ω–æ–π –¥–æ—Å–∫–∏
                const cellWidth = (x_max - x_min) / currentGridDensity;
                const cellHeight = (y_max - y_min) / currentGridDensity;
                
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–æ —è—á–µ–π–∫–∞–º
                for (let i = 0; i < currentGridDensity; i++) {
                    for (let j = 0; j < currentGridDensity; j++) {
                        // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–≥–ª–æ–≤ –∫–ª–µ—Ç–∫–∏
                        const x1 = x_min + i * cellWidth;
                        const y1 = y_min + j * cellHeight;
                        const x2 = x1 + cellWidth;
                        const y2 = y1 + cellHeight;
                        
                        // –¶–≤–µ—Ç –∫–ª–µ—Ç–∫–∏
                        const cellColor = (i + j) % 2 === 0 ? color1 : color2;
                        
                        // –†–∏—Å—É–µ–º –∫–æ–Ω—Ç—É—Ä –∫–ª–µ—Ç–∫–∏
                        const contourPoints = [];
                        
                        // –ù–∏–∂–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞
                        for (let k = 0; k <= 20; k++) {
                            const x = x1 + (k / 20) * cellWidth;
                            const z = math.complex(x, y1);
                            const transformedZ = applyUserFunction(z);
                            
                            if (transformedZ) {
                                const canvasPoint = complexToCanvas(transformedZ);
                                if (canvasPoint) {
                                    contourPoints.push(canvasPoint);
                                }
                            }
                        }
                        
                        // –ü—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞
                        for (let k = 0; k <= 20; k++) {
                            const y = y1 + (k / 20) * cellHeight;
                            const z = math.complex(x2, y);
                            const transformedZ = applyUserFunction(z);
                            
                            if (transformedZ) {
                                const canvasPoint = complexToCanvas(transformedZ);
                                if (canvasPoint) {
                                    contourPoints.push(canvasPoint);
                                }
                            }
                        }
                        
                        // –í–µ—Ä—Ö–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ (–≤ –æ–±—Ä–∞—Ç–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏)
                        for (let k = 20; k >= 0; k--) {
                            const x = x1 + (k / 20) * cellWidth;
                            const z = math.complex(x, y2);
                            const transformedZ = applyUserFunction(z);
                            
                            if (transformedZ) {
                                const canvasPoint = complexToCanvas(transformedZ);
                                if (canvasPoint) {
                                    contourPoints.push(canvasPoint);
                                }
                            }
                        }
                        
                        // –õ–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ (–≤ –æ–±—Ä–∞—Ç–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏)
                        for (let k = 20; k >= 0; k--) {
                            const y = y1 + (k / 20) * cellHeight;
                            const z = math.complex(x1, y);
                            const transformedZ = applyUserFunction(z);
                            
                            if (transformedZ) {
                                const canvasPoint = complexToCanvas(transformedZ);
                                if (canvasPoint) {
                                    contourPoints.push(canvasPoint);
                                }
                            }
                        }
                        
                        // –†–∏—Å—É–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç—É—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–µ–∫
                        if (contourPoints.length > 2) {
                            ctx.beginPath();
                            ctx.moveTo(contourPoints[0].x, contourPoints[0].y);
                            
                            for (let k = 1; k < contourPoints.length; k++) {
                                const dx = contourPoints[k].x - contourPoints[k-1].x;
                                const dy = contourPoints[k].y - contourPoints[k-1].y;
                                const distance = Math.sqrt(dx*dx + dy*dy);
                                
                                // –ï—Å–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –Ω–µ–±–æ–ª—å—à–æ–µ, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É –∫ –∫–æ–Ω—Ç—É—Ä—É
                                if (distance < Math.max(width, height) / 10) {
                                    ctx.lineTo(contourPoints[k].x, contourPoints[k].y);
                                } else {
                                    // –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç
                                    ctx.stroke();
                                    ctx.beginPath();
                                    ctx.moveTo(contourPoints[k].x, contourPoints[k].y);
                                }
                            }
                            
                            // –ó–∞–º—ã–∫–∞–µ–º –∫–æ–Ω—Ç—É—Ä
                            ctx.closePath();
                            
                            // –ó–∞–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç–æ–º
                            ctx.fillStyle = cellColor;
                            ctx.fill();
                            
                            // –û–±–≤–æ–¥–∏–º –∫–æ–Ω—Ç—É—Ä
                            ctx.strokeStyle = "rgba(0, 0, 0, 0.3)";
                            ctx.lineWidth = 1;
                            ctx.stroke();
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                        currentStep++;
                        updateProgressBar((currentStep / totalSteps) * 100);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—Ç–º–µ–Ω—É
                        if (renderingCancelled) return;
                    }
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ 100%
            updateProgressBar(100);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        function updateVisualization() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
            s = parseFloat(document.getElementById('sValue').value);
            d = parseFloat(document.getElementById('dValue').value);
            l = parseFloat(document.getElementById('lValue').value);
            p = parseFloat(document.getElementById('pValue').value);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–æ—Ä–º–Ω—ã—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–π
            if (vizMode === "conformalMap") {
                gridType = document.getElementById('gridType').value;
                gridDensity = parseInt(document.getElementById('gridDensityValue').value);
                gridLineWidth = parseInt(document.getElementById('gridLineWidthValue').value);
                gridColor1 = document.getElementById('gridColor1').value;
                gridColor2 = document.getElementById('gridColor2').value;
            }
            
            // –î–û–ë–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç –≥—Ä–∞–Ω–∏—Ü
            if (linkSWithDomain) {
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è s
                updateDomainFromS();
            } else {
                // –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ, —Å—á–∏—Ç—ã–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
                xMin = parseFloat(document.getElementById('xMin').value);
                xMax = parseFloat(document.getElementById('xMax').value);
                yMin = parseFloat(document.getElementById('yMin').value);
                yMax = parseFloat(document.getElementById('yMax').value);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª–∑—É–Ω–∫–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
            if (thetaSlider) thetaSlider.update(theta);
            if (phiSlider) phiSlider.update(phi);
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            const canvas = document.getElementById('screen');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –°—á–∏—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ä–µ–∂–∏–º–æ–º
            if (inputMode === "z") {
                customFunction = document.getElementById('customFunctionInput').value;
            } else {
                reFunction = document.getElementById('reFunction').value;
                imFunction = document.getElementById('imFunction').value;
            }
            
            // –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ–¥ –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π
            compileUserFunction();
            
            if (debugMode) {
                updateDebugInfo();
            }
            
            // –û—Ç—Ç—è–≥–∏–≤–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
            setTimeout(function() {
                // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
                drawComplex();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                updateMetadata();
            }, 50);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
        function changeTab(event, tabId) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å
            const tabContents = document.getElementsByClassName('template-tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            const tabs = document.getElementsByClassName('template-tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É math.js
            if (typeof math !== 'undefined') {
                initializePage();
            } else {
                // –ï—Å–ª–∏ math.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∂–¥–µ–º –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
                console.error("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ math.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –æ–∂–∏–¥–∞–µ–º...");
                setTimeout(function() {
                    if (typeof math !== 'undefined') {
                        console.log("math.js –∑–∞–≥—Ä—É–∂–µ–Ω —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...");
                        initializePage();
                    } else {
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É math.js. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                    }
                }, 2000);
            }

            const headers = document.querySelectorAll('.collapsible-header');
                headers.forEach(header => {
                    header.addEventListener('click', function() {
                        this.classList.toggle('collapsed');
                        const content = this.nextElementSibling;
                        content.classList.toggle('visible');
                    });
                });

        });
        
        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function initializePage() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±–µ—Ä—Ç–∫—É –¥–ª—è canvas
            const canvas = document.getElementById('screen');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ canvas —É–∂–µ –≤ –æ–±–µ—Ä—Ç–∫–µ
            if (!canvas.parentElement.classList.contains('canvas-wrapper')) {
                // –°–æ–∑–¥–∞–µ–º –æ–±–µ—Ä—Ç–∫—É –¥–ª—è canvas
                const wrapper = document.createElement('div');
                wrapper.classList.add('canvas-wrapper');
                wrapper.style.position = 'relative';
                
                // –í—Å—Ç–∞–≤–ª—è–µ–º –æ–±–µ—Ä—Ç–∫—É –ø–µ—Ä–µ–¥ canvas
                canvas.parentNode.insertBefore(wrapper, canvas);
                
                // –ü–æ–º–µ—â–∞–µ–º canvas –≤–Ω—É—Ç—Ä—å –æ–±–µ—Ä—Ç–∫–∏
                wrapper.appendChild(canvas);
                
                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤–Ω—É—Ç—Ä—å –æ–±–µ—Ä—Ç–∫–∏
                const progressContainer = document.getElementById('progress-container');
                if (progressContainer) {
                    wrapper.appendChild(progressContainer);
                }
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
            defineCustomMathFunctions();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            updateMethodControls();
            initCircularSliders();

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–º —Ö–æ–ª—Å—Ç–∞
            document.getElementById('canvasSizePreset').addEventListener('change', setCanvasSize);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—è –¥–ª—è –æ–±–ª–∞—Å—Ç–µ–π –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏
            document.getElementById('xMin').value = xMin.toFixed(2);
            document.getElementById('xMax').value = xMax.toFixed(2);
            document.getElementById('yMin').value = yMin.toFixed(2);
            document.getElementById('yMax').value = yMax.toFixed(2);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            updateMetadata();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π focus –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            document.getElementById('reFunction').addEventListener('focus', function() {
                activeInputField = 'reFunction';
                highlightActiveField();
                if (debugMode) console.log("–ê–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞: Re(x,y)");
            });
            
            document.getElementById('imFunction').addEventListener('focus', function() {
                activeInputField = 'imFunction';
                highlightActiveField();
                if (debugMode) console.log("–ê–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞: Im(x,y)");
            });
            
            document.getElementById('customFunctionInput').addEventListener('focus', function() {
                activeInputField = 'customFunctionInput';
                highlightActiveField();
                if (debugMode) console.log("–ê–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞: —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç z");
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
            document.getElementById('keepAspectRatioCheckbox').checked = keepAspectRatio;
            toggleAspectRatioMode();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è s —Å –æ–±–ª–∞—Å—Ç—å—é
            document.getElementById('linkSWithDomainCheckbox').checked = linkSWithDomain;
            toggleSLinkMode(); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è, —á—Ç–æ–±—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ

            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –æ–±–ª–∞—Å—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤–æ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π
            adjustComplexDomainAspectRatio(false); // false - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ

            // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            highlightActiveField();

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–Ω–∞—á–µ–Ω–∏—è s
            updateDomainFromS();

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Ä–µ–∂–∏–º–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–Ω—Ñ–æ—Ä–º–Ω—ã—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–π
            document.getElementById('gridBackgroundColor').value = gridBackgroundColor;
            document.getElementById('gridColor1').value = gridColor1;
            document.getElementById('gridColor2').value = gridColor2;
            document.getElementById('gridDensitySlider').value = gridDensity;
            document.getElementById('gridDensityValue').value = gridDensity;
            document.getElementById('gridLineWidthSlider').value = gridLineWidth;
            document.getElementById('gridLineWidthValue').value = gridLineWidth;
            document.getElementById('gridType').value = gridType;
            document.getElementById('domainColoringRadio').checked = true;
            document.getElementById('conformalMapRadio').checked = false;
            toggleVizMode(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∂–∏–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏            
            
            updateVisualization();
        }
    </script>
</body>
</html>