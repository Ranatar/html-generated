<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>易經 Гадание по И-Цзин - Стебли тысячелистника</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 50%, #fecaca 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            color: #1f2937;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-family: serif;
        }

        .header p {
            font-size: 1.25rem;
            color: #374151;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .panel-hexagram {
            border: 4px solid #92400e;
        }

        .panel-process {
            border: 4px solid #991b1b;
        }

        .panel-help {
            border: 4px solid #92400e;
            max-height: 600px;
            overflow-y: auto;
        }

        .panel h2 {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 1rem;
            color: #1f2937;
        }

        .hexagram-container {
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .hexagram-line {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
        }

        .line-number {
            font-size: 0.875rem;
            color: #6b7280;
            width: 4rem;
            text-align: right;
        }

        .line-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 2rem;
            width: 8rem;
        }

        .line-yang {
            height: 0.5rem;
            width: 100%;
            border-radius: 0.25rem;
            background-color: #1f2937;
        }

        .line-yin {
            display: flex;
            width: 100%;
            justify-content: space-between;
        }

        .line-yin-part {
            height: 0.5rem;
            width: 45%;
            border-radius: 0.25rem;
            background-color: #1f2937;
        }

        .line-changing {
            background-color: #dc2626 !important;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .line-empty {
            height: 2rem;
            width: 8rem;
            border: 2px dashed #d1d5db;
            border-radius: 0.25rem;
        }

        .line-label {
            font-size: 0.75rem;
            color: #6b7280;
            width: 6rem;
        }

        .info-box {
            background: linear-gradient(to right, #fef3c7, #fed7aa);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 2px solid #d97706;
            text-align: center;
        }

        .info-text {
            font-weight: 500;
            color: #1f2937;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .progress-container {
            margin-bottom: 1rem;
            text-align: center;
        }

        .progress-text {
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 0.5rem;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #dc2626;
            transition: width 0.5s ease;
        }

        .stalks-container {
            margin: 1rem 0;
        }

        .stalks-pile {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 1rem 0;
        }

        .stalks-visual {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2px;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }

        .stalks-visual.in-hand {
            background-color: #fef3c7;
        }

        .stalk {
            width: 3px;
            height: 3rem;
            background-color: #92400e;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .stalk.in-hand {
            background-color: #dc2626;
            transform: rotate(-10deg);
        }

        .stalks-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #92400e;
        }

        .stalks-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stalks-grid-three {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
        }

        .manipulation-info {
            text-align: center;
            font-size: 0.875rem;
            background-color: #fef2f2;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #fca5a5;
            margin-top: 0.75rem;
        }

        .result-check {
            text-align: center;
            margin: 2rem 0;
        }

        .result-check-icon {
            font-size: 4rem;
            margin-bottom: 0.5rem;
        }

        .result-check-text {
            font-size: 1.125rem;
            font-weight: bold;
            color: #15803d;
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-primary {
            flex: 1;
            background-color: #991b1b;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #7f1d1d;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:disabled {
            background-color: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #4b5563;
            color: white;
            padding: 0.75rem;
        }

        .btn-secondary:hover {
            background-color: #374151;
        }

        .help-section {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            color: #374151;
        }

        .help-section h3 {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .help-section p, .help-section ul, .help-section ol {
            line-height: 1.6;
        }

        .help-section ul, .help-section ol {
            margin-left: 1rem;
            margin-top: 0.5rem;
        }

        .help-section li {
            margin-bottom: 0.25rem;
        }

        .help-amber { background-color: #fef3c7; border-left: 4px solid #d97706; }
        .help-orange { background-color: #ffedd5; border-left: 4px solid #ea580c; }
        .help-red { background-color: #fef2f2; border-left: 4px solid #dc2626; }
        .help-purple { background-color: #faf5ff; border-left: 4px solid #9333ea; }
        .help-blue { background-color: #eff6ff; border-left: 4px solid #2563eb; }
        .help-green { background-color: #f0fdf4; border-left: 4px solid #16a34a; }

        .completion-banner {
            margin-top: 2rem;
            background: linear-gradient(to right, #dc2626, #ea580c);
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .completion-banner.show {
            display: block;
        }

        .completion-banner h2 {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            color: white;
        }

        .completion-banner p {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }

        .completion-banner .small {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-top: 0.75rem;
        }

        .hexagram-note {
            text-align: center;
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #fef3c7;
            border-radius: 0.25rem;
        }

        .icon {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Заголовок -->
        <div class="header">
            <h1>易經 Гадание по И-Цзин</h1>
            <p>Традиционный метод со стеблями тысячелистника</p>
        </div>

        <div class="main-grid">
            <!-- Левая панель - Гексаграмма -->
            <div class="panel panel-hexagram">
                <h2>Гексаграмма</h2>
                <div class="hexagram-container" id="hexagramContainer">
                    <!-- Черты будут добавляться динамически -->
                </div>
                <div class="hexagram-note">
                    Черты строятся снизу вверх
                </div>
            </div>

            <!-- Центральная панель - Процесс -->
            <div class="panel panel-process">
                <h2>Процесс гадания</h2>
                
                <!-- Информационное окно -->
                <div class="info-box">
                    <p class="info-text" id="infoText">Нажмите "Начать гадание" для начала процесса</p>
                </div>

                <!-- Прогресс -->
                <div class="progress-container">
                    <div class="progress-text" id="progressText">Черта: 0/6 | Манипуляция: 0/3</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Визуализация стеблей -->
                <div class="stalks-container" id="stalksContainer">
                    <!-- Стебли будут отображаться здесь -->
                </div>

                <!-- Кнопки управления -->
                <div class="controls">
                    <button class="btn btn-primary" id="startBtn" onclick="performManipulation()">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span id="btnText">Начать гадание</span>
                    </button>
                    <button class="btn btn-secondary" onclick="reset()">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Правая панель - Справка -->
            <div class="panel panel-help">
                <h2>Справка</h2>
                
                <div class="help-section help-amber">
                    <h3>🌿 Начальная подготовка</h3>
                    <p>50 стеблей тысячелистника. Один откладывается (символ Тай-цзи). Остаётся 49 для работы.</p>
                </div>

                <div class="help-section help-orange">
                    <h3>🔄 Три манипуляции</h3>
                    <p>Для каждой черты выполняется 3 манипуляции:</p>
                    <ol>
                        <li>Разделение на 2 кучки (Небо и Земля)</li>
                        <li>1 стебель между пальцами (Человек)</li>
                        <li>Отсчёт обеих кучек по 4 (сезоны)</li>
                        <li>Остатки откладываются</li>
                    </ol>
                </div>

                <div class="help-section help-red">
                    <h3>📊 Результаты</h3>
                    <ul>
                        <li><strong>36 стеблей (6)</strong>: Старая Инь ⚋ →</li>
                        <li><strong>32 стебля (7)</strong>: Молодая Ян ⚊</li>
                        <li><strong>28 стеблей (8)</strong>: Молодая Инь ⚋</li>
                        <li><strong>24 стебля (9)</strong>: Старая Ян ⚊ →</li>
                    </ul>
                </div>

                <div class="help-section help-purple">
                    <h3>🎯 Меняющиеся черты</h3>
                    <p>Старые черты (6 и 9) - меняющиеся. Они показывают динамику и создают вторичную гексаграмму.</p>
                </div>

                <div class="help-section help-blue">
                    <h3>⏱️ Время процесса</h3>
                    <p>Традиционное гадание занимает около 20 минут. Это время медитации и концентрации на вопросе.</p>
                </div>

                <div class="help-section help-green">
                    <h3>☯️ Философия</h3>
                    <p>Процесс гадания - не просто генерация случайности, а синхронизация сознания с космическими ритмами через символические действия.</p>
                </div>
            </div>
        </div>

        <!-- Баннер завершения -->
        <div class="completion-banner" id="completionBanner">
            <h2>✨ Гадание завершено! ✨</h2>
            <p>Ваша гексаграмма построена из 6 черт</p>
            <p id="changingLinesText"></p>
            <p class="small">Теперь обратитесь к тексту И-Цзин для толкования</p>
        </div>

        <!-- Панель толкования гексаграммы -->
        <div class="interpretation-panel" id="interpretationPanel">
            <h2>Толкование гексаграммы</h2>
            
            <div class="hexagram-info">
                <h3 id="hexagramName" class="hexagram-name"></h3>
                <h4 id="hexagramTitle" class="hexagram-title"></h4>
            </div>

            <div class="hexagram-text-section">
                <h4 class="section-header">🔮 Общий афоризм (卦辞 Гуа-цы)</h4>
                <p id="hexagramText" class="hexagram-main-text"></p>
            </div>

            <div class="hexagram-lines-section" id="hexagramLinesSection">
                <h4 class="section-header">📜 Афоризмы к чертам (爻辞 Яо-цы)</h4>
                <div id="hexagramLines"></div>
            </div>

            <div class="changing-lines-note" id="changingNote" style="display: none;">
                <p><strong>Обратите внимание:</strong> Меняющиеся черты (отмечены красным) особенно важны для толкования!</p>
            </div>
        </div>
    </div>

    <style>
        .interpretation-panel {
            margin-top: 2rem;
            background: white;
            border-radius: 0.5rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 4px solid #92400e;
            display: none;
        }

        .interpretation-panel.show {
            display: block;
        }

        .hexagram-info {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
            border-radius: 0.5rem;
        }

        .hexagram-name {
            font-size: 2rem;
            font-weight: bold;
            color: #92400e;
            margin-bottom: 0.5rem;
            font-family: serif;
        }

        .hexagram-title {
            font-size: 1.5rem;
            color: #374151;
            margin: 0;
        }

        .hexagram-text-section,
        .hexagram-lines-section {
            margin: 1.5rem 0;
        }

        .section-header {
            font-size: 1.125rem;
            font-weight: bold;
            color: #991b1b;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #fecaca;
        }

        .hexagram-main-text {
            font-size: 1.125rem;
            line-height: 1.8;
            color: #1f2937;
            padding: 1rem;
            background: #fef2f2;
            border-left: 4px solid #dc2626;
            border-radius: 0.25rem;
            margin: 0;
        }

        .line-interpretation {
            margin: 1rem 0;
            padding: 1rem;
            background: #fffbeb;
            border-radius: 0.25rem;
            border-left: 4px solid #d97706;
        }

        .line-interpretation.changing {
            background: #fef2f2;
            border-left: 4px solid #dc2626;
        }

        .line-number-label {
            font-weight: bold;
            color: #92400e;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .line-interpretation.changing .line-number-label {
            color: #dc2626;
        }

        .line-text {
            color: #374151;
            line-height: 1.6;
            font-size: 0.9375rem;
        }

        .changing-lines-note {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #fef2f2;
            border: 2px solid #fca5a5;
            border-radius: 0.5rem;
            text-align: center;
        }

        .changing-lines-note p {
            margin: 0;
            color: #991b1b;
            font-size: 0.9375rem;
        }
    </style>

    <script>
        // База данных гексаграмм
        const hexagramData = {
            1: { name: '乾 Цянь', title: 'Творчество', text: 'Изначальное свершение: благоприятна стойкость.', lines: ['Нырнувший дракон. - Не действуй.', 'Появившийся дракон находится на поле. - Благоприятно свидание с великим человеком.', 'Благородный человек до конца дня деятелен. Вечером он осмотрителен, точно в опасности. - Хулы не будет.', 'Точно прыжок в бездне. - Хулы не будет.', 'Летящий дракон находится в небе. -Благоприятно свидание с великим человеком.', 'Возгордившийся дракон. - Будет раскаяние.'] },
            2: { name: '坤 Кунь', title: 'Исполнение', text: 'Изначальное свершение: благоприятна стойкость кобылицы.', lines: ['(Если ты) наступил на иней, (значит) близок и крепкий лед.', 'Прямота, повсеместность, величие. - И без упражнения не будет (ничего, что бы) не (было) благоприятно.', 'Тая (свои) проявления, надо бы быть стойким.', 'Завязанный мешок. - Не будет хулы, не будет хвалы.', 'Желтая юбка. - Изначальное счастье.', 'Драконы бьются на окраине. - Их кровь синя и желта.'] },
            3: { name: '屯 Чжунь', title: 'Начальная трудность', text: 'Изначальное свершение: благоприятна стойкость.', lines: ['Нерешительное кружение на месте.- Благоприятно пребывание в стойкости.', 'В трудности, в нерешительности четверка коней тянет в разные стороны!', 'Выйдешь на оленя без ловчего - лишь (попусту) войдешь в лес.', 'Четверка коней тянет в разные стороны! Добивайся брака.- В дальнейшем счастье.', 'Трудно ее милостям.- В малом - стойкость к счастью.', 'Четверка коней тянет в разные стороны! Слезы до крови - льются сплошным потоком.'] },
            4: { name: '蒙 Мэн', title: 'Недоразвитость', text: 'Свершение. Не я ищу юношей; юноши ищут меня.', lines: ['Развитие недоразвитого. - Благоприятно для применения казней.', 'Приятие недоразвитых - к счастью.', 'Незачем брать жену. (Она) увидит богача и не соблюдет себя.', 'Стеснение от недоразвитости.- Сожаление.', 'Недоразвитость юноши.- Счастье.', 'Удар по недоразвитости. - Не благоприятствует (тому, чтобы) быть разбойником.'] },
            5: { name: '需 Сюй', title: 'Необходимость ждать', text: 'Обладателю правды - изначальное свершение.', lines: ['Ожидание на окраине. - Благоприятно применение постоянства.', 'Ожидание на (прибрежном) песке.- Предстоят незначительные разговоры.', 'Ожидание в тине.- Близится приход разбойников.', 'Ожидание в крови.- Выйди из пещеры.', 'Ожидание за вином и яствами.- Стойкость к счастью.', 'Войдешь в пещеру, и будет приход трех неторопливых гостей.'] },
            6: { name: '訟 Сун', title: 'Тяжба', text: 'Обладателю правды - препятствие.', lines: ['Не навеки будет то, в чем усердствуешь.', 'Не одолеешь в тяжбе.- Поверни - и беги.', 'Кормись от обретенного встарь.', 'Не одолеешь в тяжбе. (Если) опять подчинишься приказу.', 'Тяжба. - Изначальное счастье.', 'Быть может, будешь пожалован парадным поясом.'] },
            7: { name: '師 Ши', title: 'Войско', text: 'Стойкость. Возмужалому человеку - счастье.', lines: ['Выводи войско, руководясь законом.', 'Пребывание в войске.- Счастье. Хулы не будет.', 'В войске, быть может, воз трупов.- Несчастье.', 'Войско отступает на постоянные квартиры.- Хулы не будет.', 'На поле есть дичь. Благоприятно сдержать слово.', 'Великий государь владеет судьбами.'] },
            8: { name: '比 Би', title: 'Приближение', text: 'Счастье. Вникни в гадание.', lines: ['Обладание правдой - приближайся к нему.', 'Приближайся к нему изнутри.- Стойкость - к счастью.', 'Приближайся к нему - злодей.', 'Внешне приближайся к нему.- Стойкость - к счастью.', 'Явленное приближение.', 'Приближение к нему - лишено главного.- Несчастье.'] },
            9: { name: '小畜 Сяо Чу', title: 'Воспитание малым', text: 'Свершение. Плотные тучи - и нет дождя.', lines: ['Возврат исходит из Пути.- Какая может быть в этом хула?', 'Привлечение к возврату.- Счастье.', 'У телеги выпали спицы.- Муж и жена отворачивают взгляды.', 'Обладай правдой. От кровопролития уходи.', 'Обладай правдой - (она) об\'единяет.', 'Уже идет дождь. Уже (найдено подобающее) место.'] },
            10: { name: '履 Ли', title: 'Наступление', text: '(Наступи на) хвост тигра; если не укусит тебя - свершение.', lines: ['Первичное наступление.- В выступлении хулы не будет.', 'Наступай по пути - ровно-ровно.', 'И кривой может видеть, и хромой может наступать.', 'Наступаешь на хвост тигра.- Ху-ху!', 'Решительное наступление.- Будь стойким в опастности.', 'Рассматривай (прежние) поступки, исследуй лучшее (в них).'] },
            11: { name: '泰 Тай', title: 'Расцвет', text: 'Малое отходит, великое приходит. Счастье, развитие.', lines: ['(Когда) рвут тростник, (другие) стебли (тянутся за ним).', 'Охвати и окраины. Надо всплыть на реке.', 'Нет глади,(которая осталась бы)без выбоин.', 'Стремительный полет.- Не разбогатеешь из-за своих соседей.', 'Государь И отправлял невесту, и от этого была благословенность.', 'Городской вал опять (обрушится) в ров.'] },
            12: { name: '否 Пи', title: 'Упадок', text: 'Негодные люди упадка не благоприятствуют стойкости.', lines: ['(Когда) рвут тростник, (другие) стебли (тянутся за ним).', 'Охвати примыкающих (к тебе).', '(Будешь) охвачен стыдом.', 'Будет веление свыше - хулы не будет.', 'Останови упадок.- Великому человеку - счастье.', 'Низвержение упадка.- Сначала упадок, (а) потом веселье.'] },
            13: { name: '同人 Тун Жэнь', title: 'Родня', text: '(Родня) на полях. Свершение.', lines: ['Родня в воротах.- Хулы не будет.', 'Родня в храме предков.- Сожаление.', 'Спрячь оружие в зарослях.', 'Поднимутся на самый вал и не смогут напасть.', 'Родня сначала (издает) крики и вопли, а потом смеется.', 'Родня в пригороде.- Раскаяния не будет.'] },
            14: { name: '大有 Да Ю', title: 'Обладание великим', text: 'Изначальное свершение.', lines: ['Нет связи с вредным.- Не то чтоб была хула.', 'Большая колесница -для грузов.-Есть куда выступить.', 'Князю нужно проникнуть к сыну неба.', '(Если) не будет у тебя роскоши, хулы не будет.', 'Такая правдивость. (В ней будешь) связан (со всеми).', 'От неба благословение этому.- Счастье.'] },
            15: { name: '謙 Цянь', title: 'Смирение', text: 'Свершение. Благородному человеку - обладать законченностью.', lines: ['Смиренный из смиренных благородный человек.', 'Провозгласи смирение.- Стойкость - к счастью.', 'Трудись над смирением.', 'Ничего неблагоприятного. Возвысь смирение.', 'Не разбогатеешь из-за своих соседей.', 'Провозгласи смирение.'] },
            16: { name: '豫 Юй', title: 'Вольность', text: 'Благоприятно возведению князей и движению войск.', lines: ['(Если) провозгласишь вольность - (будет) несчастье.', 'Будь крепче камня, но не до конца дня.', 'Засмотришься на вольность - (будет) раскаяние.', 'Исходя из вольности, многое будет достигнуто.', 'Стойкость - к болезни. (В) постоянстве не умрешь.', 'Померкнувшая вольность. Совершаемое минует.'] },
            17: { name: '隨 Суй', title: 'Последование', text: 'Изначальное свершение; благоприятна стойкость.', lines: ['В службе будет перемещение. Стойкость - к счастью.', 'Сблизишься с малыми детьми - потеряешь возмужалых людей.', 'Сблизишься с возмужалыми людьми - потеряешь малых детей.', '(Если) в последовании и захватишь что-нибудь.', 'Правдивость по отношению к прекрасному.- Счастье.', 'То, что взято,- сблизься с ним.'] },
            18: { name: '蠱 Гу', title: '(Исправление) порчи', text: 'Изначальное свершение.', lines: ['Исправление испорченного отцом.', 'Исправление испорченного матерью.- Невозможна стойкость.', 'Исправление испорченного отцом.', 'Свободное отношение к испорченному отцом.', 'Исправление испорченного отцом.- Необходима хвала.', 'Не служи ни царю, ни князю.'] },
            19: { name: '臨 Линь', title: 'Посещение', text: 'Изначальное свершение: благоприятна стойкость.', lines: ['Всеобщее посещение.- Стойкость - к счастью.', 'Всеобщее посещение.- Счастье, ничего неблагоприятного.', 'Услаждающее посещение.- Ничего благоприятного!', 'Достигающее посещение.- Хулы не буюет.', 'Познанное посещение. Подобающее великому государю.', 'Искреннее посещение.- Счастье. Хулы не будет.'] },
            20: { name: '觀 Гуань', title: 'Созерцание', text: 'Умыв руки, не приноси жертв; владея правдой, будь нелицеприятен и строг.', lines: ['Юношеское созерцание.', 'Созерцание сквозь (щель).', 'Созерцай продвижение и отступление нашей жизни.', 'Созерцай блеск страны.', 'Созерцай нашу жизнь.- Благородному человеку хулы не будет.', 'Созерцай их (других людей) жизнь.'] },
            21: { name: '噬嗑 Ши Хо', title: 'Стиснутые зубы', text: 'Свершение. Благоприятствует (тому, чтобы) применять тюрьмы.', lines: ['(Когда) надевают колодки, гибнут пальцы на ногах.', 'Вырви брюшину; уничтожь нос.- Хулы не будет.', 'Вырвешь окостеневшее мясо, (но) встретишь яд.', 'Вырвешь мясо, присохшее к кости.', 'Вырвешь засохшее мясо. Получишь желтое золото.', 'Возложишь колодку (на шею) и уничтожишь уши.'] },
            22: { name: '賁 Би', title: 'Убранство', text: 'Свершение. Малому благоприятно иметь, куда выступить.', lines: ['Украсишь эти пальцы ног.', 'Укрась эти бороду и усы.', 'Разубранность! Разукрашенность!', 'Разубранность! Белизна! Белый конь - точно летит!', 'Убранство в саду на холме.', 'Белое убранство.- Хулы не будет.'] },
            23: { name: '剝 Бо', title: 'Разрушение', text: 'Неблагоприятно иметь, куда выступить.', lines: ['У ложа разрушены ножки.', 'У ложа разрушены перекладины.', 'Разрушат его.- Хулы не будет.', 'У ложа разрушена обивка.- Несчастье.', 'Рыбная ловля. Через придворных женщин - милость.', 'Огромный плод не с\'еден.'] },
            24: { name: '復 Фу', title: 'Возврат', text: 'Свершение. Выходу и входу не будет вреда.', lines: ['Возвращение не издалека.', 'Прекрасное возвращение.- Счастье.', 'Постепенное возвращение.- Опасность, но хулы не будет.', 'Верное движение. Самостоятельное возвращение.', 'Полноценное возвращение.- Раскаяния не будет.', 'Заблуждающееся возвращение.- Несчастье.'] },
            25: { name: '無妄 У Ван', title: 'Беспорочность', text: 'Изначальное свершение; благоприятна стойкость.', lines: ['Беспорочное выступление.- Счастье.', 'Если, и не запахав поле, соберешь урожай.', 'Беспорочному - стихийное бедствие.', '(Если) сможешь быть стойким, хулы не будет.', 'Болезнь беспорочного.- Не принимай лекарств.', 'Беспорочность уходит.- Будет беда (по своей вине).'] },
            26: { name: '大畜 Да Чу', title: 'Воспитание великим', text: 'Благоприятна стойкость.', lines: ['Будет опасность.', 'У воза выпали спицы.', 'Погоня на хорошем коне.', 'Защитная доска (от рогов) теленка.', 'Клыки выхолощенного вепря.- Счастье.', 'Какие могут дороги на небе? - Свершение.'] },
            27: { name: '頤 И', title: 'Питание', text: 'Стойкость - к счастью.', lines: ['Ты забросишь свою волшебную черепаху.', 'Питание навыворот.', 'Сбившееся питание.- Стойкость - к несчастью.', 'Питание навыворот.- Счастье.', 'Отклонишься от основы. (Но если) пребудешь в стойкости.', 'Исходи из питания.- (Хотя и) опасно, (но будет) счастье.'] },
            28: { name: '大過 Да Го', title: 'Переразвитие великого', text: 'Стропила прогибаются.', lines: ['Для подстилки пользуйся белым камышом.', 'На иссохшем тополе вырастают почки.', 'Стропила прогибаются.- Несчастье.', 'Стропила великолепны.- Счастье.', 'На иссохшем тополе вырастают цветы.', 'При переходе вброд (зайдешь так глубоко).'] },
            29: { name: '坎 Си Кань', title: 'Двойная бездна', text: 'Обладателю правды - только в сердце свершение.', lines: ['Двойная бездна. Войдешь в пещеру в бездне.', 'В бездне есть опасность.', 'Придешь или уйдешь - (будет) бездна за бездной.', '(Всего) кружка вина и чаша (еды).', 'Бездна не наполняется.', 'Для связывания нужен канат и аркан.'] },
            30: { name: '離 Ли', title: 'Сияние', text: 'Благоприятна стойкость. Свершение.', lines: ['Путаница поступков.', 'Желтое сияние.- Изначальное счастье.', 'Сияние солнечного заката.', 'Внезапно наступает это! Сгорание, отмирание, отвержение!', 'Выступившие слезы льются потоком.', 'Царю надо выступить в карательный поход.'] },
            31: { name: '咸 Сянь', title: 'Взаимодействие', text: 'Свершение; благоприятна стойкость.', lines: ['Взаимодействие.(Оно касается лишь) твоего большого пальца.', 'Взаимодействие.(Оно касается лишь) твоих голеней.', 'Взаимодействие. (Оно касается лишь) твоих бедер.', 'Стойкость к счастью. Раскаяние исчезнет.', 'Взаимодействие. (Оно касается лишь) твоей спины.', 'Взаимодействие.(Оно касается лишь) твоих скул, щек и языка.'] },
            32: { name: '恆 Хэн', title: 'Постоянство', text: 'Свершение. Хулы не будет.', lines: ['Углубление в постоянство.', 'Раскаяние исчезнет.', 'Не будешь постоянным в своих достоинствах.', 'На поле нет дичи.', 'Будешь постоянным в своих достоинствах.', 'Нарушенное постоянство.- Несчастье.'] },
            33: { name: '遯 Дунь', title: 'Бегство', text: 'Свершение. Малому - благоприятна стойкость.', lines: ['При бегстве - хвост в опасности.', '(Чтоб) удержать его (бегущего), нужна кожа желтого быка.', 'Связанному беглецу будет болезнь и опасность.', 'Хорошее бегство.- Благородному человеку - счастье.', 'Счастливое бегство.- Стойкость - к счастью.', 'Летящее бегство.- Ничего неблагоприятного.'] },
            34: { name: '大壯 Да Чжуан', title: 'Мощь великого', text: 'Благоприятна стойкость.', lines: ['Мощь в пальцах ног.', 'Стойкость - к счастью.', 'Ничтожному человеку придется быть мощным.', 'Стойкость - к счастью. Раскаяние исчезнет.', 'Утратишь козла (даже) в легких (обстоятельствах).', 'Козел бодает изгородь.'] },
            35: { name: '晉 Цзинь', title: 'Восход', text: 'Сиятельному князю надо жаловать коней.', lines: ['В выдвижении и в отступлении!', 'В выдвижении и в подавленности!', 'Доверие многих.- Раскаяние исчезнет.', '(Если) выдвинешься, как хомяк.', 'Раскаяние исчезнет. Ни принимай близко к сердцу.', 'Выставляй свои рога лишь для того, чтобы покарать (свой) город.'] },
            36: { name: '明夷 Мин И', title: 'Поражение света', text: 'Благоприятна в трудности стойкость.', lines: ['Поражение света: у него в полете опускаются крылья.', 'Поражение света: он поражен в левое бедро.', 'Свет поражен на южной охоте.', 'Вонзится в левую (часть) живота.', 'Поражение света (вождя) Цзи-Цзы.', 'Не просветишься, (а) померкнешь.'] },
            37: { name: '家人 Цзя Жэнь', title: 'Домашние', text: 'Благоприятна женщине стойкость.', lines: ['Замкнись и заведи (свой) дом.', '(Ей) не за кем следовать.', '(Когда среди) домашних суровые оклики.', 'Обогащение дома.- Великое счастье.', 'Царь приближается к обладателю семьи.', 'В обладании правдой - сила.'] },
            38: { name: '睽 Куй', title: 'Разлад', text: 'В незначительных делах - счастье.', lines: ['Раскаяние исчезнет. (Когда) утратишь коня, не гонись за ним.', 'Встретишься с господином в закоулке - хулы не будет.', 'Увидишь, что воз оттягивают вспять.', 'Разлад и одиночество.', 'Раскаяние исчезнет. Этот (твой) сообщник прокусит кожу.', 'Разлад и одиночество. Увидишь свинью.'] },
            39: { name: '蹇 Цзянь', title: 'Препятствие', text: 'Благоприятен юго-запад, неблагоприятен северо-восток.', lines: ['Уйдешь - (будут) препятствия. Придешь - (будет) хвала.', 'Царскому слуге - препятствие за препятствием.', 'Уйдешь - (будут) препятствия.Придешь - вернешься (на правый путь).', 'Уйдешь - (будут) препятствия. Придешь - (будет) связь.', 'Великие препятствия. Друзья придут.', 'Уйдешь - (будут) препятствия. Придешь - (будешь) велик.'] },
            40: { name: '解 Цзе', title: 'Разрешение', text: 'Благоприятен юго-запад.', lines: ['Хулы не будет.', 'На охоте добудешь трех лисиц.', 'Носильщик - а едет (на другом.', 'Разреши (путы на) твоих больших пальцах на ногах.', 'Благородный человек - лишь (для него) есть разрешение.', 'Князю надо стрелять в ястреба на высокой стене.'] },
            41: { name: '損 Сунь', title: 'Убыль', text: 'Обладателю правды - изначальное счастье - хулы не будет.', lines: ['Прекрати (свои) дела и скорее выступай.', 'Благоприятна стойкость.- Поход - к несчастью.', 'Если идут трое, то (они) убудут на одного человека.', 'Убавь свою торопливость.', 'Можно и приумножить то, (в чем недостаток).', 'Приумножь то, что не убавляешь.'] },
            42: { name: '益 И', title: 'Приумножение', text: 'Благоприятно иметь, куда выступить.', lines: ['Благоприятствует необходимость вершить великие дела.', 'Можно и приумножить то, (в чем недостаток).', 'Если приумножить это, то с необходимостью (накличешь) несчастья.', '(Если), идя верным путем, заявишь (об этом) князю.', 'Обладая правдой, облагодетельствуешь сердца (людей).', 'Ничто не преумножит это, (а), пожалуй, разобьет это.'] },
            43: { name: '夬 Гуай', title: 'Выход', text: 'Поднимешься до царского двора.', lines: ['Мощь в передней (части) пальцев на ногах.', 'Опасливо возглашай. В сумерках и ночью (будет) действие оружия.', 'Мощь в скулах.- Будет несчастье.', '(У кого на) ягодицах нет мышц, тот идет с большим трудом.', 'Холм, (поросший) бурьяном. Решись на выход.', 'Безгласность.- В конце концов будет несчастье.'] },
            44: { name: '姤 Гоу', title: 'Перечение', text: 'У женщины - сила.', lines: ['Привяжи к металлическому тормозу.', 'В охапке есть рыба.- Хулы не будет.', '(У кого на) ягодицах нет мышц, тот идет с большим трудом.', 'В охапке нет рыбы.- Восставать - к несчастью.', 'Ивой покрыты дыни. Затаи (свой) блеск.', 'Перечение - это рога.- Сожаление, (но) хулы не будет.'] },
            45: { name: '萃 Цуй', title: 'Воссоединение', text: 'Свершение. Царь подходит к обладателям храма.', lines: ['(Если) обладаешь правдой, (но) не до конца.', '(Дашь себя) увлечь - (и будет) счастье.', 'Воссоединение - и вздохи! Ничего благоприятного.', 'Великое счастье. Хулы не будет.', 'Воссоединение (у того, кто) занимает престол.', 'Жалобы и стоны, и слезы до насморка.'] },
            46: { name: '升 Шэн', title: 'Подъем', text: 'Изначальное свершение.', lines: ['Как подобает, поднимайся.- Великое счастье.', 'Будь правдив, тогда благоприятно принести (даже малую) жертву.', 'Поднимешься в пустой город.', 'Царю надо проникнуть к горе Ци.', 'Стойкость - к счастью. Подъем на ступени.', 'Скрывающийся из виду подъем.'] },
            47: { name: '困 Кунь', title: 'Истощение', text: 'Свершение. Стойкость.', lines: ['Свидание затруднено на пне.', 'Затруднения с вином и с пищей.', 'Преткнешься о камень и (будешь) держаться на терниях.', 'Приход медлителен. Затруднишься из-за металлической повозки.', '(Казня), отрежут нос и ноги.', '(Будет) затруднение в запутанных зарослях.'] },
            48: { name: '井 Цзин', title: 'Колодец', text: 'Меняют города, (но) не меняют колодец.', lines: ['В колодце - ил, (им) не напитаешься.', '(Вода в) колодце падает, просвечивают рыбы (на дне).', 'Колодец очищен, (но из него) не напитаешься.', 'Колодец облицован черепицей.- Хулы не будет.', 'Колодец чист, (как) холодный ключ.', 'Из колодца берут (воду), не закрывай его.'] },
            49: { name: '革 Гэ', title: 'Смена', text: '(Если до) последнего дня будешь (полон) правды.', lines: ['Для защиты примени кожу желтого быка.', '(Лишь по) окончании дня (производи) смену.', 'Поход - к несчастью. Стойкость - опасна.', 'Раскаяние исчезнет. Обладая правдой, изменишь судьбу.', 'Великий человек подвижен, (как) тигр.', 'Благородный человек подвижен, (как) барс.'] },
            50: { name: '鼎 Дин', title: 'Жертвенник', text: 'Изначальное счастье. Свершение.', lines: ['Жертвенник опрокинут вверх ногами.', 'Жертвенник наполнен. У моих противников нужда.', 'Ушки жертвенника изменены.', 'У жертвенника подломилась нога.', 'У жертвенника желтые ушки и золотая дужка.', 'У жертвенника яшмовая дужка.'] },
            51: { name: '震 Чжэнь', title: 'Молния', text: 'Свершение. Молния приходит, (и воскликнешь испуганно): о! о!', lines: ['Молния приходит, (и воскликнешь испуганно): о! о!', '(Когда) молния приходит, (она) опасна.', 'От молнии растеряешься.', 'Молния попадает в ил.', 'Молния отходит и приходит. Опасно.', 'От молнии потеряешь самообладание.'] },
            52: { name: '艮 Гэнь', title: 'Сосредоточенность', text: '(Сосредоточишься на) своей спине.', lines: ['Сосредоточенность в своих пальцах ног.', 'Сосредоточенность в своих икрах.', 'Остановка в своих бедрах.', 'Сосредоточенность в своем туловище.- Хулы не будет.', 'Остановка в своих скулах.', 'Укрепи сосредоточенность.- Счастье.'] },
            53: { name: '漸 Цзянь', title: 'Течение', text: 'Женщина уходит (к мужу). Счастье.', lines: ['Лебедь приближается к берегу.', 'Лебедь приближается к скале.', 'Лебедь приближается к суше.', 'Лебедь приближается к дереву.', 'Лебедь приближается к холму.', 'Лебедь приближается к суше.'] },
            54: { name: '歸妹 Гуй Мэй', title: 'Невеста', text: '(В) походе - несчастье.', lines: ['(Если) отправляют невесту, (то) - с сестрицей.', '(И) кривой может видеть.', '(Если) отправляют невесту, (то) - со служанками.', '(Если в) отправлении невесты будет упущен срок.', 'Государь И отправлял невесту.', 'Женщина подносит корзину, (но она) не наполнена.'] },
            55: { name: '豐 Фэн', title: 'Изобилие', text: 'Свершение. Царь приближается к нему.', lines: ['Встретишь подобного тебе хозяина.', 'Сделаешь обильными свои занавеси.', 'Сделаешь обильным свой полог.', 'Сделаешь обильными свои занавеси.', 'Придешь с блеском. Будет поддержка и хвала.', 'Сделаешь обильным свое жилище.'] },
            56: { name: '旅 Люй', title: 'Странствие', text: 'Малому - развитие.', lines: ['(Если) в странствии (будешь) труслив в мелочах.', 'В странствии восстановишь порядок.', 'В странствии спалишь этот порядок.', 'В странствии пребудешь на месте.', 'Выстрелишь в фазана, и одна стрела погибнет.', 'Птицам спалили их гнезда.'] },
            57: { name: '巽 Сунь', title: 'Проникновение', text: 'Малому - развитие.', lines: ['(В) продвижении и отступлении.', 'Проникновение находится ниже ложа.', 'Многократное проникновение.- Сожаление.', 'Раскаяние исчезнет. На охоте добудешь троякое.', 'Стойкость - к счастью. Раскаяние исчезнет.', 'Проникновение находится ниже ложа.'] },
            58: { name: '兌 Дуй', title: 'Радость', text: 'Свершение. Благоприятна стойкость.', lines: ['Радость - от согласия.- Счастье.', 'Радость - от правды.- Счастье.', 'Радость - от прихода.- Несчастье.', 'Радость - от договоренности.', '(Если) оправдаешь разорителей, (это) будет опасно.', 'Влекущая радость.'] },
            59: { name: '渙 Хуань', title: 'Раздробление', text: 'Свершение. Царь приближается к обладателям храма.', lines: ['Необходимо спасение. Лошадь сильна.', 'При раздроблении беги к своей опоре.', 'Раздробишь свое тело.- Раскаяния не будет.', 'Раздробишь свое стадо. - Изначальное счастье.', 'При раздроблении выступит пот (от) своих громких воплей.', 'При раздроблении твоя кровь уйдет.'] },
            60: { name: '節 Цзе', title: 'Ограничение', text: 'Свершение. Горе ограничено.', lines: ['Не выйдешь из внутреннего двора.', 'Не выйдешь из внешнего двора.- Несчастье.', '(Если) не (будешь) ограничиваться, то (будет, о чем) вздыхать.', 'Успокоишься в ограничении.- Свершение.', 'Сладкое ограничение.- Счастье.', 'Горькое ограничение.- Стойкость - к несчастью.'] },
            61: { name: '中孚 Чжун Фу', title: 'Внутренняя правда', text: '(Даже) вепрям и рыбам - счастье.', lines: ['(Если будет) соразмерность, (то будет) счастье.', 'Кричащий журавль находится в тени.', 'Обретешь противника.', 'Луна почти в полнолунии.', 'Обладай правдой - (она) обьединяет.', 'Голоса пернатых поднимаются в небо.'] },
            62: { name: '小過 Сяо Го', title: 'Переразвитие малого', text: 'Свершение; благоприятна стойкость.', lines: ['Летящая птица, и потому - несчастье.', 'Пройдешь мимо своего праотца.', '(Если), проходя мимо, не защитишься.', 'Хулы не будет. (Если) не пройдешь мимо.', 'Плотные тучи - и нет дождя.', 'Не встретишься и пройдешь мимо.'] },
            63: { name: '既濟 Цзи Цзи', title: 'Уже конец', text: 'Свершение. Малому - благоприятна стойкость.', lines: ['Затормозишь свои колеса - подмочишь свой хвост.', 'Женщина утратит свой занавес (на колеснице).', 'Высокий предок напал на страну бесов.', 'Промокнешь. (Ибо) платье в лохмотьях.', 'Бык, убитый у восточных соседей.', 'Промочишь голову.- Ужасная опасность.'] },
            64: { name: '未濟 Вэй Цзи', title: 'Еще не конец', text: 'Свершение. Молодой лис почти переправился.', lines: ['Промочишь свой хвост.- Сожаление.', 'Затормози свои колеса.- Стойкость - к счастью.', 'Еще не конец.- Поход - к несчастью.', 'Стойкость - к счастью. Раскаяние исчезает.', 'Стойкость - к счастью. Раскаяния не будет.', 'Обладай правдой, когда пьешь вино.'] }
        };

        // Состояние приложения
        let state = {
            stage: 'initial',
            currentLine: 0,
            currentManipulation: 0,
            stalks: 49,
            leftPile: 0,
            rightPile: 0,
            handStalk: 0,
            leftRemainder: 0,
            rightRemainder: 0,
            setAside: [],
            hexagram: [],
            isAnimating: false
        };

        const lineNames = {
            6: 'Старая Инь ⚋ → (меняющаяся)',
            7: 'Молодая Ян ⚊',
            8: 'Молодая Инь ⚋',
            9: 'Старая Ян ⚊ → (меняющаяся)'
        };

        // Функция задержки
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Сброс состояния
        function reset() {
            state = {
                stage: 'initial',
                currentLine: 0,
                currentManipulation: 0,
                stalks: 49,
                leftPile: 0,
                rightPile: 0,
                handStalk: 0,
                leftRemainder: 0,
                rightRemainder: 0,
                setAside: [],
                hexagram: [],
                isAnimating: false
            };
            
            updateInfo('Нажмите "Начать гадание" для начала процесса');
            updateProgress();
            updateHexagram();
            updateStalks();
            updateButton();
            document.getElementById('completionBanner').classList.remove('show');
            document.getElementById('interpretationPanel').classList.remove('show');
            document.getElementById('changingNote').style.display = 'none';
        }

        // Обновление информационного текста
        function updateInfo(text) {
            document.getElementById('infoText').textContent = text;
        }

        // Обновление прогресса
        function updateProgress() {
            const progressText = `Черта: ${state.currentLine + 1}/6 | Манипуляция: ${state.currentManipulation + 1}/3`;
            document.getElementById('progressText').textContent = progressText;
            
            const progress = ((state.currentLine * 3 + state.currentManipulation) / 18) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // Обновление отображения гексаграммы
        function updateHexagram() {
            const container = document.getElementById('hexagramContainer');
            container.innerHTML = '';
            
            // Существующие черты
            state.hexagram.forEach((line, index) => {
                container.appendChild(createHexagramLine(line, index + 1, false));
            });
            
            // Пустые черты
            for (let i = state.hexagram.length; i < 6; i++) {
                container.appendChild(createHexagramLine(null, i + 1, true));
            }
        }

        // Создание элемента черты гексаграммы
        function createHexagramLine(value, lineNum, isEmpty) {
            const lineDiv = document.createElement('div');
            lineDiv.className = 'hexagram-line';
            
            const lineNumber = document.createElement('span');
            lineNumber.className = 'line-number';
            lineNumber.textContent = `Черта ${lineNum}:`;
            if (isEmpty) lineNumber.style.color = '#d1d5db';
            
            const lineVisual = document.createElement('div');
            lineVisual.className = 'line-visual';
            
            if (isEmpty) {
                const emptyLine = document.createElement('div');
                emptyLine.className = 'line-empty';
                lineVisual.appendChild(emptyLine);
            } else {
                const isYang = value === 7 || value === 9;
                const isChanging = value === 6 || value === 9;
                
                if (isYang) {
                    const yangLine = document.createElement('div');
                    yangLine.className = 'line-yang' + (isChanging ? ' line-changing' : '');
                    lineVisual.appendChild(yangLine);
                } else {
                    const yinContainer = document.createElement('div');
                    yinContainer.className = 'line-yin';
                    
                    const yinPart1 = document.createElement('div');
                    yinPart1.className = 'line-yin-part' + (isChanging ? ' line-changing' : '');
                    
                    const yinPart2 = document.createElement('div');
                    yinPart2.className = 'line-yin-part' + (isChanging ? ' line-changing' : '');
                    
                    yinContainer.appendChild(yinPart1);
                    yinContainer.appendChild(yinPart2);
                    lineVisual.appendChild(yinContainer);
                }
            }
            
            const lineLabel = document.createElement('span');
            lineLabel.className = 'line-label';
            lineLabel.textContent = isEmpty ? 'ожидание...' : lineNames[value];
            if (isEmpty) lineLabel.style.color = '#d1d5db';
            
            lineDiv.appendChild(lineNumber);
            lineDiv.appendChild(lineVisual);
            lineDiv.appendChild(lineLabel);
            
            return lineDiv;
        }

        // Отрисовка стеблей
        function renderStalks(count, label, isInHand = false) {
            const pileDiv = document.createElement('div');
            pileDiv.className = 'stalks-pile';
            
            const visualDiv = document.createElement('div');
            visualDiv.className = 'stalks-visual' + (isInHand ? ' in-hand' : '');
            
            const maxStalks = Math.min(count, 50);
            for (let i = 0; i < maxStalks; i++) {
                const stalk = document.createElement('div');
                stalk.className = 'stalk' + (isInHand ? ' in-hand' : '');
                visualDiv.appendChild(stalk);
            }
            
            const labelDiv = document.createElement('div');
            labelDiv.className = 'stalks-label';
            labelDiv.textContent = `${label}: ${count}`;
            
            pileDiv.appendChild(visualDiv);
            pileDiv.appendChild(labelDiv);
            
            return pileDiv;
        }

        // Обновление отображения стеблей
        function updateStalks() {
            const container = document.getElementById('stalksContainer');
            container.innerHTML = '';
            
            if (state.stage === 'initial' && state.stalks > 0) {
                container.appendChild(renderStalks(state.stalks, 'Стебли для работы'));
                
                if (state.currentManipulation > 0) {
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'manipulation-info';
                    const totalSetAside = state.setAside.reduce((a, b) => a + b, 0);
                    infoDiv.textContent = `Отложено за прошлые манипуляции: ${totalSetAside} стеблей`;
                    container.appendChild(infoDiv);
                }
            } else if (state.stage === 'dividing') {
                const gridDiv = document.createElement('div');
                gridDiv.className = 'stalks-grid';
                gridDiv.appendChild(renderStalks(state.leftPile, 'Левая кучка'));
                gridDiv.appendChild(renderStalks(state.rightPile, 'Правая кучка'));
                container.appendChild(gridDiv);
            } else if (state.stage === 'counting') {
                const gridDiv = document.createElement('div');
                gridDiv.className = 'stalks-grid-three';
                gridDiv.appendChild(renderStalks(state.leftRemainder, 'Остаток слева', true));
                gridDiv.appendChild(renderStalks(state.handStalk, 'В руке', true));
                gridDiv.appendChild(renderStalks(state.rightRemainder, 'Остаток справа', true));
                container.appendChild(gridDiv);
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'manipulation-info';
                infoDiv.textContent = `Отложено в этой манипуляции: ${state.handStalk + state.leftRemainder + state.rightRemainder}`;
                container.appendChild(infoDiv);
            } else if (state.stage === 'result') {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result-check';
                resultDiv.innerHTML = `
                    <div class="result-check-icon">✓</div>
                    <div class="result-check-text">Черта ${state.currentLine + 1} определена!</div>
                `;
                container.appendChild(resultDiv);
            }
        }

        // Обновление кнопки
        function updateButton() {
            const btn = document.getElementById('startBtn');
            const btnText = document.getElementById('btnText');
            
            if (state.isAnimating || state.hexagram.length === 6) {
                btn.disabled = true;
            } else {
                btn.disabled = false;
            }
            
            if (state.hexagram.length === 0) {
                btnText.textContent = 'Начать гадание';
            } else if (state.currentManipulation === 0) {
                btnText.textContent = 'Следующая черта';
            } else {
                btnText.textContent = 'Следующая манипуляция';
            }
        }

        // Определение номера гексаграммы по чертам
        function getHexagramNumber(lines) {
            // Таблица соответствия триграмм
            const trigramValues = {
                '111': 1, // Цянь (Небо)
                '110': 2, // Дуй (Водоём)
                '101': 3, // Ли (Огонь)
                '100': 4, // Чжэнь (Гром)
                '011': 5, // Сюнь (Ветер)
                '010': 6, // Кань (Вода)
                '001': 7, // Гэнь (Гора)
                '000': 8  // Кунь (Земля)
            };

            // Таблица гексаграмм (верхняя триграмма × нижняя триграмма)
            const hexagramTable = [
                [1, 34, 5, 26, 11, 9, 14, 43],    // Цянь
                [10, 58, 38, 54, 61, 60, 41, 19], // Дуй
                [13, 49, 30, 55, 37, 63, 22, 36], // Ли
                [25, 17, 21, 51, 42, 3, 27, 24],  // Чжэнь
                [44, 28, 50, 32, 57, 48, 18, 46], // Сюнь
                [6, 47, 64, 40, 59, 29, 4, 7],    // Кань
                [33, 31, 56, 62, 53, 39, 52, 15], // Гэнь
                [12, 45, 35, 16, 20, 8, 23, 2]    // Кунь
            ];

            // Конвертируем черты в Ян (1) и Инь (0)
            let lower = '';
            let upper = '';
            
            for (let i = 0; i < 3; i++) {
                const lineValue = lines[i];
                lower += (lineValue === 7 || lineValue === 9) ? '1' : '0';
            }
            
            for (let i = 3; i < 6; i++) {
                const lineValue = lines[i];
                upper += (lineValue === 7 || lineValue === 9) ? '1' : '0';
            }

            const lowerIndex = trigramValues[lower] - 1;
            const upperIndex = trigramValues[upper] - 1;

            return hexagramTable[upperIndex][lowerIndex];
        }

        // Отображение толкования гексаграммы
        function displayInterpretation() {
            const hexNum = getHexagramNumber(state.hexagram);
            const hexData = hexagramData[hexNum];
            
            if (!hexData) return;

            // Отображаем название и заголовок
            document.getElementById('hexagramName').textContent = hexData.name;
            document.getElementById('hexagramTitle').textContent = hexData.title;
            
            // Отображаем основной текст
            document.getElementById('hexagramText').textContent = hexData.text;

            // Отображаем афоризмы к чертам
            const linesContainer = document.getElementById('hexagramLines');
            linesContainer.innerHTML = '';
            
            let hasChangingLines = false;

            state.hexagram.forEach((lineValue, index) => {
                const isChanging = lineValue === 6 || lineValue === 9;
                if (isChanging) hasChangingLines = true;

                const lineDiv = document.createElement('div');
                lineDiv.className = 'line-interpretation' + (isChanging ? ' changing' : '');
                
                const lineLabel = document.createElement('div');
                lineLabel.className = 'line-number-label';
                lineLabel.textContent = `Черта ${index + 1}${isChanging ? ' (меняющаяся)' : ''}:`;
                
                const lineText = document.createElement('div');
                lineText.className = 'line-text';
                lineText.textContent = hexData.lines[index];
                
                lineDiv.appendChild(lineLabel);
                lineDiv.appendChild(lineText);
                linesContainer.appendChild(lineDiv);
            });

            // Показываем примечание о меняющихся чертах
            if (hasChangingLines) {
                document.getElementById('changingNote').style.display = 'block';
            }

            // Показываем панель толкования
            document.getElementById('interpretationPanel').classList.add('show');
        }

        // Основная функция выполнения манипуляции
        async function performManipulation() {
            if (state.isAnimating) return;
            state.isAnimating = true;
            updateButton();

            // Разделение на две кучки
            updateInfo(`Черта ${state.currentLine + 1}, Манипуляция ${state.currentManipulation + 1}: Разделяем стебли на две кучки...`);
            state.stage = 'dividing';
            updateStalks();
            await sleep(1000);

            const split = Math.floor(Math.random() * (state.stalks - 2)) + 1;
            state.leftPile = split;
            state.rightPile = state.stalks - split;
            updateStalks();
            await sleep(1500);

            // Откладываем один стебель
            updateInfo('Откладываем один стебель между пальцами (символ Человека)...');
            state.rightPile -= 1;
            state.handStalk = 1;
            updateStalks();
            await sleep(1500);

            // Отсчет левой кучки
            updateInfo('Отсчитываем левую кучку по 4 стебля (четыре сезона)...');
            state.stage = 'counting';
            updateStalks();
            await sleep(1000);
            
            const leftMod = state.leftPile % 4;
            state.leftRemainder = leftMod === 0 ? 4 : leftMod;
            updateStalks();
            await sleep(1500);

            // Отсчет правой кучки
            updateInfo('Отсчитываем правую кучку по 4 стебля...');
            await sleep(1000);
            
            const rightMod = (state.rightPile - 1) % 4;
            state.rightRemainder = rightMod === 0 ? 4 : rightMod;
            updateStalks();
            await sleep(1500);

            // Подсчет отложенных
            const totalSetAside = state.handStalk + state.leftRemainder + state.rightRemainder;
            state.setAside.push(totalSetAside);
            updateInfo(`Отложено стеблей: ${totalSetAside}`);
            await sleep(1000);

            // Остаток для следующей манипуляции
            const remaining = state.stalks - totalSetAside;
            state.stalks = remaining;

            if (state.currentManipulation < 2) {
                // Следующая манипуляция
                state.currentManipulation++;
                state.leftPile = 0;
                state.rightPile = 0;
                state.handStalk = 0;
                state.leftRemainder = 0;
                state.rightRemainder = 0;
                state.stage = 'initial';
                updateInfo(`Переходим к манипуляции ${state.currentManipulation + 1}`);
                updateProgress();
                updateStalks();
                state.isAnimating = false;
                updateButton();
            } else {
                // Определяем значение черты
                let lineType;
                
                // Определяем тип черты по количеству оставшихся стеблей
                if (remaining === 36) lineType = 6; // Старая Инь
                else if (remaining === 32) lineType = 7; // Молодая Ян
                else if (remaining === 28) lineType = 8; // Молодая Инь
                else if (remaining === 24) lineType = 9; // Старая Ян
                else {
                    // Если получилось неправильное значение, выводим информацию
                    console.error('Неправильное количество стеблей:', remaining);
                    console.log('История манипуляций:', state.setAside);
                    // Используем ближайшее корректное значение
                    if (remaining > 34) lineType = 6;
                    else if (remaining > 30) lineType = 7;
                    else if (remaining > 26) lineType = 8;
                    else lineType = 9;
                }

                state.hexagram.push(lineType);
                updateHexagram();
                updateInfo(`Черта ${state.currentLine + 1} готова! Осталось ${remaining} стеблей = ${lineNames[lineType]}`);
                state.stage = 'result';
                updateStalks();
                await sleep(3000);

                if (state.currentLine < 5) {
                    // Следующая черта
                    state.currentLine++;
                    state.currentManipulation = 0;
                    state.stalks = 49;
                    state.leftPile = 0;
                    state.rightPile = 0;
                    state.handStalk = 0;
                    state.leftRemainder = 0;
                    state.rightRemainder = 0;
                    state.setAside = [];
                    state.stage = 'initial';
                    updateInfo(`Начинаем построение черты ${state.currentLine + 1}`);
                    updateProgress();
                    updateStalks();
                    state.isAnimating = false;
                    updateButton();
                } else {
                    // Гадание завершено
                    updateInfo('Гадание завершено! Гексаграмма построена.');
                    
                    const changingLines = state.hexagram.filter(l => l === 6 || l === 9).length;
                    const changingText = changingLines > 0 
                        ? `Меняющихся черт: ${changingLines}`
                        : 'Все черты стабильные (без изменений)';
                    document.getElementById('changingLinesText').textContent = changingText;
                    document.getElementById('completionBanner').classList.add('show');
                    
                    // Отображаем толкование
                    displayInterpretation();
                    
                    state.isAnimating = false;
                    updateButton();
                }
            }
        }

        // Инициализация при загрузке страницы
        window.onload = function() {
            updateHexagram();
            updateProgress();
            updateStalks();
            updateButton();
        };
    </script>
</body>
</html>
