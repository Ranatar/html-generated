<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сад антропологических согласований</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --gold: #ffd700;
            --cosmic-blue: #1a1a2e;
            --deep-purple: #0f0f1e;
            --light-purple: #16213e;
            --text-light: #e0e0e0;
            --text-dim: #a0a0a0;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-hover: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, var(--cosmic-blue) 0%, var(--deep-purple) 50%, var(--light-purple) 100%);
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Космический фон с множественными слоями */
        .cosmic-layers {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .cosmic-layer {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .stars {
            background: 
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent);
            background-size: 200px 200px;
            animation: drift 100s linear infinite;
            opacity: 0.6;
        }

        .nebula {
            background: 
                radial-gradient(ellipse at top, rgba(255, 100, 100, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(100, 100, 255, 0.1) 0%, transparent 50%);
            animation: pulse 30s ease-in-out infinite;
            opacity: 0.4;
        }

        .quantum-field {
            background: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255, 255, 255, 0.03) 2px, rgba(255, 255, 255, 0.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(255, 255, 255, 0.03) 2px, rgba(255, 255, 255, 0.03) 4px);
            animation: quantumFlux 5s linear infinite;
            opacity: 0.3;
        }

        @keyframes drift {
            from { transform: rotate(0deg) translateX(0); }
            to { transform: rotate(360deg) translateX(100px); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        @keyframes quantumFlux {
            from { transform: translateX(0) translateY(0); }
            to { transform: translateX(4px) translateY(4px); }
        }

        /* Навигационная карта сада */
        .garden-map-overlay {
            position: fixed;
            top: 2rem;
            right: 2rem;
            width: 300px;
            height: 300px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--border);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .garden-map-overlay.expanded {
            width: 450px;
            height: 450px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
        }

        .garden-map-overlay.collapsed {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            overflow: hidden;
        }

        .garden-map-overlay.collapsed .map-content {
            opacity: 0;
            pointer-events: none;
        }

        .map-toggle-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 30px;
            height: 30px;
            background: var(--gold);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            color: var(--deep-purple);
        }

        .map-toggle-btn:hover {
            transform: rotate(180deg);
            box-shadow: 0 0 20px var(--gold);
        }

        .garden-map-overlay.collapsed .map-toggle-btn {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .garden-map-overlay.collapsed .map-toggle-btn:hover {
            transform: translate(-50%, -50%) rotate(180deg);
        }

        .map-content {
            padding: 1rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .map-title {
            color: var(--gold);
            font-size: 0.9rem;
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }

        .map-legend {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            right: 0.5rem;
            display: flex;
            justify-content: space-around;
            font-size: 0.7rem;
            color: var(--text-dim);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .garden-map-overlay.expanded .map-legend {
            opacity: 1;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gold);
        }

        .interactive-map {
            position: relative;
            width: 100%;
            flex-grow: 1;
            background: radial-gradient(circle at center, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            overflow: visible;
            margin-bottom: 2rem;
        }

        /* Элементы карты */
        .map-element {
            position: absolute;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .map-center {
            width: 30px;
            height: 30px;
            background: var(--gold);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px var(--gold);
            animation: centralPulse 2s ease-in-out infinite;
        }

        @keyframes centralPulse {
            0%, 100% { box-shadow: 0 0 20px var(--gold); }
            50% { box-shadow: 0 0 40px var(--gold), 0 0 60px var(--gold); }
        }

        .map-ring {
            position: absolute;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .map-ring-1 { width: 80px; height: 80px; }
        .map-ring-2 { width: 120px; height: 120px; }
        .map-ring-3 { width: 160px; height: 160px; }
        .map-ring-4 { width: 200px; height: 200px; }

        .map-section {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--gold);
        }

        .map-section:hover {
            transform: scale(1.2);
            background: rgba(255, 215, 0, 0.2);
            box-shadow: 0 0 20px var(--gold);
        }

        .map-section-genesis { top: 20%; left: 50%; transform: translateX(-50%); }
        .map-section-covenant { top: 50%; right: 10%; }
        .map-section-incarnation { bottom: 20%; left: 50%; transform: translateX(-50%); }
        .map-section-apocalypse { top: 50%; left: 10%; }

        /* Дополнительные элементы карты */
        .map-section-secondary {
            position: absolute;
            width: 25px;
            height: 25px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: var(--gold);
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .map-section-secondary:hover {
            opacity: 1;
            transform: scale(1.3);
            background: rgba(255, 215, 0, 0.15);
        }

        /* Позиции вторичных элементов */
        .map-transition-1 { top: 35%; left: 25%; }
        .map-transition-2 { top: 35%; right: 25%; }
        .map-transition-3 { bottom: 35%; left: 25%; }
        .map-transition-4 { bottom: 35%; right: 25%; }

        /* Анимированные пути */
        .map-path-animated {
            stroke-dasharray: 5, 5;
            animation: pathPulse 2s linear infinite;
        }

        @keyframes pathPulse {
            from { stroke-dashoffset: 0; }
            to { stroke-dashoffset: 10; }
        }

        /* Информационная панель */
        .map-info-panel {
            position: absolute;
            bottom: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--gold);
            border-radius: 10px;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            color: var(--text-light);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .map-info-panel.active {
            opacity: 1;
            bottom: -50px;
        }

        /* Пульсирующие точки активности */
        .activity-pulse {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--gold);
            border-radius: 50%;
            opacity: 0.8;
        }

        .activity-pulse::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid var(--gold);
            border-radius: 50%;
            animation: pulsate 2s ease-out infinite;
        }

        @keyframes pulsate {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }

        /* Пути между секциями */
        .map-path {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
            transform-origin: left center;
            animation: pathFlow 3s linear infinite;
        }

        @keyframes pathFlow {
            from { background-position: -100px 0; }
            to { background-position: 100px 0; }
        }

        /* Основной контент */
        header {
            text-align: center;
            padding: 4rem 2rem;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.05) 0%, transparent 50%);
            animation: headerGlow 10s ease-in-out infinite;
        }

        @keyframes headerGlow {
            0%, 100% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
        }

        h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            position: relative;
            z-index: 1;
        }

        .subtitle {
            font-size: 1.3rem;
            color: var(--text-dim);
            font-style: italic;
            position: relative;
            z-index: 1;
        }

        /* Система переходов */
        .transitions-system {
            max-width: 1600px;
            margin: 4rem auto;
            padding: 0 2rem;
        }

        .transition-diagram {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 3rem;
            margin-bottom: 4rem;
            backdrop-filter: blur(10px);
        }

        .transition-title {
            font-size: 2rem;
            color: var(--gold);
            text-align: center;
            margin-bottom: 2rem;
        }

        .transition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .transition-node {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .transition-node::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
            animation: scanLine 3s linear infinite;
        }

        @keyframes scanLine {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }

        .node-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            display: block;
            text-align: center;
        }

        .node-title {
            color: var(--gold);
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        /* Детальные секции */
        .section-detailed {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 3rem;
            margin-bottom: 4rem;
            position: relative;
            overflow: hidden;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }

        .section-icon-large {
            font-size: 4rem;
            color: var(--gold);
            filter: drop-shadow(0 0 20px var(--gold));
        }

        .section-info h2 {
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 0.5rem;
        }

        .section-subtitle {
            color: var(--text-dim);
            font-style: italic;
        }

        /* Таблица согласований */
        .concordance-table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        .concordance-table th {
            background: rgba(255, 215, 0, 0.1);
            color: var(--gold);
            padding: 1rem;
            text-align: left;
            border-bottom: 2px solid var(--gold);
        }

        .concordance-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }

        .concordance-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Путь посетителя */
        .visitor-path {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid var(--gold);
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .path-title {
            color: var(--gold);
            font-size: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .path-steps {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }

        .path-step {
            background: var(--glass);
            padding: 1rem 1.5rem;
            border-radius: 25px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .path-step:hover {
            background: var(--glass-hover);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .step-number {
            background: var(--gold);
            color: var(--cosmic-blue);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Архитектурные детали */
        .architectural-detail {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, transparent 50%);
            border-left: 3px solid var(--gold);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 10px 10px 0;
        }

        .detail-title {
            color: var(--gold);
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        /* Интерактивные элементы */
        .interactive-element {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .interactive-element:hover {
            background: var(--glass-hover);
            transform: translateX(10px);
            border-color: var(--gold);
        }

        .interactive-element::after {
            content: '→';
            position: absolute;
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gold);
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }

        .interactive-element:hover::after {
            transform: translateY(-50%) translateX(5px);
        }

        /* Мобильная адаптация */
        @media (max-width: 768px) {
            .garden-map-overlay {
                width: 150px;
                height: 150px;
                right: 1rem;
                top: 1rem;
            }

            h1 {
                font-size: 2rem;
            }

            .section-header {
                flex-direction: column;
                text-align: center;
            }

            .concordance-table {
                font-size: 0.9rem;
            }

            .path-steps {
                flex-direction: column;
            }

            .garden-map-overlay {
                width: 200px;
                height: 200px;
                right: 1rem;
                top: 1rem;
            }

            .garden-map-overlay.expanded {
                width: calc(100vw - 2rem);
                height: calc(100vw - 2rem);
                max-width: 350px;
                max-height: 350px;
            }

            .garden-map-overlay.collapsed {
                width: 50px;
                height: 50px;
            }

            .map-legend {
                font-size: 0.6rem;
            }

            .map-section {
                width: 30px;
                height: 30px;
                font-size: 1rem;
            }

            .map-section-secondary {
                width: 20px;
                height: 20px;
                font-size: 0.7rem;
            }

        }

        /* Специальные эффекты */
        .glow-text {
            color: var(--gold);
            text-shadow: 0 0 10px var(--gold);
            animation: textGlow 2s ease-in-out infinite;
        }

        @keyframes textGlow {
            0%, 100% { text-shadow: 0 0 10px var(--gold); }
            50% { text-shadow: 0 0 20px var(--gold), 0 0 30px var(--gold); }
        }

        .sacred-geometry {
            position: absolute;
            width: 200px;
            height: 200px;
            opacity: 0.1;
            pointer-events: none;
        }

        .sacred-geometry svg {
            width: 100%;
            height: 100%;
            animation: sacredRotate 60s linear infinite;
        }

        @keyframes sacredRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Дополнительные анимации для улучшенной карты */
        @keyframes floatAnimation {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .garden-map-overlay.expanded .map-center {
            animation: centralPulse 2s ease-in-out infinite, floatAnimation 3s ease-in-out infinite;
        }

        .garden-map-overlay.expanded .map-section {
            animation-duration: 4s;
            animation-timing-function: ease-in-out;
            animation-iteration-count: infinite;
        }

        .garden-map-overlay.expanded .map-section:nth-child(odd) {
            animation-name: floatAnimation;
            animation-delay: 0s;
        }

        .garden-map-overlay.expanded .map-section:nth-child(even) {
            animation-name: floatAnimation;
            animation-delay: 2s;
        }

        /* Эффект свечения при наведении на карту */
        .garden-map-overlay::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--gold), transparent, var(--gold));
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .garden-map-overlay:hover::before {
            opacity: 0.5;
            animation: glowRotate 3s linear infinite;
        }

        @keyframes glowRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Модальное окно приветствия */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--cosmic-blue);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 3rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
        }

        .welcome-modal {
            width: 900px;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            color: var(--gold);
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .modal-subtitle {
            color: var(--text-dim);
            font-style: italic;
        }

        .visitor-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .visitor-type {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .visitor-type::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .visitor-type:hover {
            transform: translateY(-5px);
            border-color: var(--gold);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .visitor-type:hover::before {
            opacity: 1;
        }

        .visitor-type.selected {
            border-color: var(--gold);
            background: rgba(255, 215, 0, 0.1);
        }

        .type-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 1rem;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
        }

        .visitor-type h3 {
            color: var(--gold);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .visitor-type p {
            color: var(--text-dim);
            margin-bottom: 1rem;
            text-align: center;
            font-style: italic;
        }

        .visitor-type ul {
            list-style: none;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .visitor-type ul li {
            padding: 0.25rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .visitor-type ul li::before {
            content: '✦';
            position: absolute;
            left: 0;
            color: var(--gold);
        }

        .modal-footer {
            text-align: center;
            margin-top: 1rem;
        }

        .footer-note {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        /* Профиль посетителя */
        .visitor-profile {
            position: fixed;
            top: 2rem;
            left: 2rem;
            z-index: 999;
        }

        .profile-toggle {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--gold);
            border-radius: 25px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-toggle:hover {
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .profile-icon {
            font-size: 1.2rem;
        }

        .profile-type {
            color: var(--gold);
            font-size: 0.9rem;
        }

        .profile-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 0.5rem;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid var(--gold);
            border-radius: 15px;
            padding: 1.5rem;
            min-width: 250px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .profile-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .profile-menu h4 {
            color: var(--gold);
            margin-bottom: 1rem;
            text-align: center;
        }

        .profile-current {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
        }

        .current-icon {
            font-size: 2rem;
        }

        .current-type {
            color: var(--text-light);
        }

        .change-path-btn {
            width: 100%;
            background: var(--gold);
            color: var(--cosmic-blue);
            border: none;
            border-radius: 10px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .change-path-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .profile-stats p {
            color: var(--text-dim);
            font-size: 0.85rem;
            margin: 0.25rem 0;
        }

        /* Адаптивные классы для разных типов посетителей */
        body.pilgrim-path .concordance-table { opacity: 0.7; }
        body.pilgrim-path .architectural-detail:not(.sacred) { opacity: 0.8; }
        body.scholar-path .interactive-element { border-color: var(--gold); }
        body.scholar-path .concordance-table { box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); }
        body.mystic-path .section-icon-large { animation: pulse 3s ease-in-out infinite; }
        body.artist-path .transition-node { background: rgba(255, 215, 0, 0.05); }

        @media (max-width: 768px) {
            .visitor-types {
                grid-template-columns: 1fr;
            }
            
            .welcome-modal {
                width: 95vw;
                padding: 1.5rem;
            }
        }

        /* Контекстные подсказки */
        .context-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid var(--gold);
            border-radius: 15px;
            padding: 1.5rem;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.9);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .context-tooltip.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }

        .tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .tooltip-title {
            color: var(--gold);
            margin: 0;
            font-size: 1.1rem;
        }

        .tooltip-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .tooltip-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--gold);
        }

        .tooltip-content {
            color: var(--text-light);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .tooltip-content strong {
            color: var(--gold);
        }

        .tooltip-content em {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .tooltip-footer {
            display: flex;
            justify-content: flex-end;
        }

        .tooltip-category {
            font-size: 0.8rem;
            color: var(--text-dim);
            padding: 0.25rem 0.75rem;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 15px;
        }

        /* Термины для подсказок */
        .term-highlight {
            border-bottom: 1px dotted var(--gold);
            cursor: help;
            position: relative;
            transition: all 0.3s ease;
        }

        .term-highlight:hover {
            color: var(--gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* Персональная мандала */
        .mandala-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .mandala-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .mandala-container {
            background: var(--cosmic-blue);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
        }

        .mandala-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .mandala-header h2 {
            color: var(--gold);
            margin-bottom: 0.5rem;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .mandala-subtitle {
            color: var(--text-dim);
            font-style: italic;
        }

        .mandala-canvas-wrapper {
            position: relative;
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        #personalMandala {
            border: 1px solid var(--border);
            border-radius: 50%;
            background: radial-gradient(circle at center, rgba(255, 215, 0, 0.05) 0%, transparent 70%);
            max-width: 100%;
            height: auto;
        }

        .mandala-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: none;
        }

        .mandala-loading.active {
            display: block;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .mandala-interpretation {
            margin-bottom: 2rem;
        }

        .mandala-interpretation h3 {
            color: var(--gold);
            margin-bottom: 1rem;
            text-align: center;
        }

        .interpretation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .interpretation-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .interpretation-symbol {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .interpretation-text {
            flex: 1;
        }

        .interpretation-text h4 {
            color: var(--gold);
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .interpretation-text p {
            color: var(--text-dim);
            font-size: 0.85rem;
            margin: 0;
        }

        .mandala-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .mandala-actions button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            color: var(--text-light);
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mandala-actions button:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--gold);
            color: var(--gold);
            transform: translateY(-2px);
        }

        .mandala-download {
            background: var(--gold) !important;
            color: var(--cosmic-blue) !important;
            font-weight: bold;
        }

        .mandala-btn {
            width: 100%;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 0.5rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .mandala-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .context-tooltip {
                max-width: 90vw;
            }
            
            .mandala-container {
                padding: 1rem;
            }
            
            #personalMandala {
                width: 300px;
                height: 300px;
            }
        }

        /* Подсветка для разных типов посетителей */
        .visitor-highlight {
            position: relative;
        }

        .visitor-highlight::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 2px solid var(--gold);
            border-radius: inherit;
            opacity: 0.3;
            pointer-events: none;
            animation: highlightPulse 2s ease-in-out infinite;
        }

        @keyframes highlightPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        .visitor-highlight-subtle {
            position: relative;
        }

        .visitor-emphasis {
            position: relative;
            font-weight: 600;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* Специфичные стили для каждого типа */
        body.pilgrim-path .visitor-emphasis { color: #ffeb3b; }
        body.scholar-path .visitor-emphasis { color: #ffc107; }
        body.mystic-path .visitor-emphasis { color: #ff9800; }
        body.artist-path .visitor-emphasis { color: #ffd700; }

        /* 3D визуализация */
        .garden-3d-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10002;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .garden-3d-overlay.active {
            display: flex;
            opacity: 1;
            align-items: center;
            justify-content: center;
        }

        .garden-3d-container {
            width: 90vw;
            height: 90vh;
            background: var(--cosmic-blue);
            border: 2px solid var(--gold);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
        }

        .garden-3d-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.3);
        }

        .garden-3d-header h2 {
            color: var(--gold);
            margin: 0;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .close-3d {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-3d:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--gold);
            transform: rotate(90deg);
        }

        .threejs-container {
            flex: 1;
            position: relative;
            background: radial-gradient(ellipse at center, #0a0a0f 0%, #000000 100%);
        }

        .garden-3d-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: rgba(0, 0, 0, 0.5);
            border-top: 1px solid var(--border);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-btn:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--gold);
            color: var(--gold);
        }

        .control-btn.active {
            background: var(--gold);
            color: var(--cosmic-blue);
        }

        .control-group label {
            color: var(--text-dim);
        }

        .control-group input[type="range"] {
            width: 150px;
        }

        #timeDisplay {
            color: var(--gold);
            min-width: 50px;
            text-align: center;
        }

        .location-info {
            position: absolute;
            bottom: 2rem;
            left: 50rem;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--gold);
            border-radius: 15px;
            padding: 1.5rem;
            max-width: 300px;
            backdrop-filter: blur(10px);
        }

        .location-info h3 {
            color: var(--gold);
            margin: 0 0 0.5rem 0;
        }

        .location-info p {
            color: var(--text-dim);
            margin: 0;
            font-size: 0.9rem;
        }

        .map-3d-btn {
            background: var(--gold);
            color: var(--cosmic-blue);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 1rem;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .map-3d-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        /* Аудио контролы */
        .audio-controls {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 999;
        }

        .audio-toggle {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--gold);
            border-radius: 25px;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .audio-toggle:hover {
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .audio-icon {
            font-size: 1.5rem;
            animation: musicPulse 2s ease-in-out infinite;
        }

        @keyframes musicPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .audio-status {
            color: var(--text-dim);
        }

        .audio-controls.active .audio-status {
            color: var(--gold);
        }

        .audio-panel {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 1rem;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid var(--gold);
            border-radius: 15px;
            padding: 1.5rem;
            min-width: 250px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .audio-panel.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .audio-panel h4 {
            color: var(--gold);
            margin: 0 0 1rem 0;
            text-align: center;
        }

        .audio-settings {
            margin-bottom: 1rem;
        }

        .audio-option {
            margin: 0.75rem 0;
        }

        .audio-option label {
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .audio-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .audio-option input[type="range"] {
            width: 100%;
            margin-top: 0.5rem;
        }

        .current-soundscape {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            padding: 0.75rem;
            margin-top: 1rem;
        }

        .current-soundscape p {
            margin: 0.25rem 0;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .current-soundscape span {
            color: var(--gold);
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .garden-3d-container {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
            }
            
            .garden-3d-controls {
                flex-direction: column;
                gap: 1rem;
            }
            
            .location-info {
                left: 1rem;
                right: 1rem;
                max-width: none;
            }
        }

        /* Система частиц */
        .particles-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0.6;
        }

        /* Ритуалы - общие стили */
        .rituals-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9000;
        }

        .ritual-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 2rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: auto;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
        }

        .ritual-container.active {
            opacity: 1;
            visibility: visible;
        }

        .ritual-content {
            text-align: center;
            max-width: 600px;
        }

        .ritual-title {
            color: var(--gold);
            margin-bottom: 1rem;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .ritual-description {
            color: var(--text-dim);
            margin-bottom: 2rem;
            font-style: italic;
        }

        /* Ритуал очищения */
        .water-basin {
            position: relative;
            width: 400px;
            height: 400px;
            margin: 0 auto 2rem;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--gold);
            box-shadow: inset 0 0 30px rgba(0, 100, 200, 0.3);
        }

        #waterCanvas {
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .ripple-effect {
            position: absolute;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            animation: ripple 2s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            from {
                width: 0;
                height: 0;
                opacity: 1;
            }
            to {
                width: 300px;
                height: 300px;
                opacity: 0;
            }
        }

        /* Ритуал свечей */
        .candles-container {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
        }

        .candle {
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .candle:hover {
            transform: scale(1.1);
        }

        .candle-body {
            width: 80px;
            height: 150px;
            background: linear-gradient(to bottom, #f4e4c1 0%, #e8d4a1 100%);
            border-radius: 5px 5px 10px 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .candle-wick {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 20px;
            background: #333;
            border-radius: 1px;
        }

        .candle-flame {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 40px;
            background: radial-gradient(ellipse at bottom, #fff 0%, #ff9800 20%, #ff5722 60%, transparent 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            opacity: 0;
            transition: opacity 0.5s ease;
            animation: flicker 1.5s ease-in-out infinite;
            filter: blur(1px);
        }

        .candle[data-lit="true"] .candle-flame {
            opacity: 1;
        }

        @keyframes flicker {
            0%, 100% { transform: translateX(-50%) scale(1) rotate(-2deg); }
            50% { transform: translateX(-50%) scale(1.1) rotate(2deg); }
        }

        .intention-input {
            margin: 2rem 0;
        }

        .intention-input textarea {
            width: 100%;
            min-height: 100px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            color: var(--text-light);
            resize: none;
        }

        /* Молитвенные флаги */
        .flag-creator {
            margin: 2rem 0;
        }

        #flagCanvas {
            border: 2px solid var(--border);
            border-radius: 5px;
            margin-bottom: 1rem;
            background: white;
        }

        .flag-colors {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .color-option:hover {
            transform: scale(1.2);
        }

        .color-option.active {
            border-color: var(--gold);
            box-shadow: 0 0 20px currentColor;
        }

        #flagMessage {
            width: 100%;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text-light);
        }

        .community-flags {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 2rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .flag-item {
            width: 60px;
            height: 40px;
            border-radius: 3px;
            position: relative;
            animation: flagWave 3s ease-in-out infinite;
            cursor: pointer;
        }

        @keyframes flagWave {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }

        /* Коллективная медитация */
        .meditation-circle {
            position: relative;
            width: 500px;
            height: 500px;
            margin: 0 auto;
        }

        #meditationCanvas {
            width: 100%;
            height: 100%;
        }

        .participants-count {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--gold);
            font-size: 1.2rem;
            text-align: center;
            pointer-events: none;
        }

        .meditation-timer {
            font-size: 2rem;
            color: var(--gold);
            margin: 1rem 0;
        }

        /* Кнопки доступа к ритуалам */
        .ritual-access-buttons {
            position: fixed;
            left: 2rem;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 900;
        }

        .ritual-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--gold);
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ritual-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        /* Калейдоскоп */
        .kaleidoscope-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 10003;
        }

        .kaleidoscope-overlay.active {
            display: flex;
        }

        #kaleidoscopeCanvas {
            border: 2px solid var(--gold);
            border-radius: 50%;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
        }

        .kaleidoscope-controls {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
        }

        .kaleidoscope-controls button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .kaleidoscope-controls button:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.05);
        }

        /* Кнопки ритуалов */
        .ritual-complete,
        .light-candle-btn,
        .create-flag-btn,
        .meditation-btn {
            background: var(--gold);
            color: var(--cosmic-blue);
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .ritual-complete:hover,
        .light-candle-btn:hover,
        .create-flag-btn:hover,
        .meditation-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        .meditation-btn.active {
            background: var(--cosmic-blue);
            color: var(--gold);
            border: 2px solid var(--gold);
        }

        @media (max-width: 768px) {
            .ritual-container {
                width: 90vw;
                padding: 1rem;
            }
            
            .water-basin,
            .meditation-circle {
                width: 300px;
                height: 300px;
            }
            
            #waterCanvas,
            #meditationCanvas {
                width: 300px;
                height: 300px;
            }
        }

        /* Общие стили для оверлеев инструментов */
        .sandbox-overlay,
        .association-overlay,
        .database-overlay,
        .generator-overlay,
        .analysis-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10004;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .sandbox-overlay.active,
        .association-overlay.active,
        .database-overlay.active,
        .generator-overlay.active,
        .analysis-overlay.active {
            display: flex;
        }

        /* Песочница Юнга */
        .sandbox-container {
            width: 90vw;
            max-width: 1200px;
            height: 90vh;
            background: var(--cosmic-blue);
            border: 2px solid var(--gold);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sandbox-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            text-align: center;
            position: relative;
        }

        .sandbox-header h2 {
            color: var(--gold);
            margin-bottom: 0.5rem;
        }

        .close-sandbox,
        .close-association,
        .close-database,
        .close-generator,
        .close-analysis {
            position: absolute;
            right: 1rem;
            top: 1rem;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-sandbox:hover,
        .close-association:hover,
        .close-database:hover,
        .close-generator:hover,
        .close-analysis:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--gold);
            transform: rotate(90deg);
        }

        .sandbox-workspace {
            flex: 1;
            display: flex;
            gap: 2rem;
            padding: 2rem;
            overflow: auto;
        }

        #sandboxCanvas {
            background: linear-gradient(to bottom, #f5deb3 0%, #d2b48c 100%);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: crosshair;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.2);
        }

        .archetype-palette {
            width: 200px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 1rem;
        }

        .archetype-palette h3 {
            color: var(--gold);
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .archetype-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .archetype-item {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: grab;
            transition: all 0.3s ease;
        }

        .archetype-item:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--gold);
            transform: scale(1.1);
        }

        .archetype-item.selected {
            background: var(--gold);
            color: var(--cosmic-blue);
        }

        .sandbox-tools {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .tool-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            color: var(--text-light);
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tool-btn:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--gold);
        }

        .tool-btn.active {
            background: var(--gold);
            color: var(--cosmic-blue);
        }

        .sandbox-interpretation {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.3);
        }

        #sandboxAnalysis {
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            min-height: 100px;
        }

        /* Тест ассоциаций */
        .association-container {
            width: 800px;
            max-width: 90vw;
            background: var(--cosmic-blue);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 2rem;
        }

        .test-progress {
            margin: 2rem 0;
        }

        .progress-bar {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gold);
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            display: block;
            text-align: center;
            margin-top: 0.5rem;
            color: var(--text-dim);
        }

        .association-question h3 {
            color: var(--gold);
            margin-bottom: 2rem;
            text-align: center;
        }

        .association-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .option-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            color: var(--text-light);
        }

        .option-btn:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--gold);
            transform: translateY(-3px);
        }

        .option-btn.selected {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--gold);
        }

        /* База данных согласований */
        .database-container {
            width: 90vw;
            max-width: 1000px;
            max-height: 90vh;
            background: var(--cosmic-blue);
            border: 2px solid var(--gold);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .database-search {
            padding: 2rem;
            border-bottom: 1px solid var(--border);
        }

        #concordanceSearch {
            width: 100%;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-light);
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .search-filters {
            display: flex;
            gap: 2rem;
            justify-content: center;
        }

        .search-filters label {
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .database-results {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            border-color: var(--gold);
            background: rgba(255, 215, 0, 0.05);
        }

        .result-category {
            color: var(--gold);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .result-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        /* Генератор связей */
        .generator-container {
            width: 900px;
            max-width: 90vw;
            background: var(--cosmic-blue);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 2rem;
            max-height: 90vh;
            overflow-y: auto;
        }

        .generator-input {
            display: flex;
            gap: 2rem;
            align-items: flex-end;
            margin: 2rem 0;
        }

        .concept-input {
            flex: 1;
        }

        .concept-input label {
            display: block;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .concept-input input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text-light);
        }

        .generate-connection {
            background: var(--gold);
            color: var(--cosmic-blue);
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .generate-connection:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        /* Инструменты анализа */
        .analysis-container {
            width: 90vw;
            max-width: 1000px;
            height: 90vh;
            background: var(--cosmic-blue);
            border: 2px solid var(--gold);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .analysis-tabs {
            display: flex;
            padding: 1rem 2rem 0;
            gap: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn:hover {
            color: var(--text-light);
        }

        .tab-btn.active {
            color: var(--gold);
            border-bottom-color: var(--gold);
        }

        .analysis-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            color: var(--gold);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-dim);
        }

        /* Кнопки доступа к инструментам */
        .tools-access-buttons {
            position: fixed;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 900;
        }

        .tool-access-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--gold);
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-access-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        @media (max-width: 768px) {
            .sandbox-workspace {
                flex-direction: column;
            }
            
            #sandboxCanvas {
                width: 100%;
                height: 400px;
            }
            
            .archetype-palette {
                width: 100%;
            }
            
            .tools-access-buttons {
                flex-direction: row;
                right: 50%;
                top: auto;
                bottom: 2rem;
                transform: translateX(50%);
            }
        }

    </style>
</head>
<body>

    <!-- Модальное окно входной анкеты -->
    <div id="welcomeModal" class="modal-overlay">
        <div class="modal-content welcome-modal">
            <div class="modal-header">
                <h2 class="modal-title">Добро пожаловать в Сад антропологических согласований</h2>
                <p class="modal-subtitle">Выберите путь, который резонирует с вашей душой</p>
            </div>
            
            <div class="visitor-types">
                <div class="visitor-type" data-type="pilgrim">
                    <div class="type-icon">🕊️</div>
                    <h3>Путь Пилигрима</h3>
                    <p>Для искателей духовного опыта и трансцендентного единства</p>
                    <ul>
                        <li>Акцент на сакральной символике</li>
                        <li>Медитативные практики</li>
                        <li>Мистические откровения</li>
                    </ul>
                </div>
                
                <div class="visitor-type" data-type="scholar">
                    <div class="type-icon">📚</div>
                    <h3>Путь Учёного</h3>
                    <p>Для исследователей междисциплинарных связей и согласований</p>
                    <ul>
                        <li>Детальные таблицы соответствий</li>
                        <li>Научные параллели</li>
                        <li>Аналитические инструменты</li>
                    </ul>
                </div>
                
                <div class="visitor-type" data-type="mystic">
                    <div class="type-icon">🌙</div>
                    <h3>Путь Мистика</h3>
                    <p>Для практиков созерцания и внутренней трансформации</p>
                    <ul>
                        <li>Глубинная психология</li>
                        <li>Архетипические образы</li>
                        <li>Трансперсональный опыт</li>
                    </ul>
                </div>
                
                <div class="visitor-type" data-type="artist">
                    <div class="type-icon">🎨</div>
                    <h3>Путь Художника</h3>
                    <p>Для творческих душ, ищущих вдохновение и красоту</p>
                    <ul>
                        <li>Эстетические переживания</li>
                        <li>Символические образы</li>
                        <li>Творческие интерпретации</li>
                    </ul>
                </div>
            </div>
            
            <div class="modal-footer">
                <p class="footer-note">Вы всегда сможете изменить свой путь в настройках</p>
            </div>
        </div>
    </div>

    <!-- Панель профиля посетителя -->
    <div id="visitorProfile" class="visitor-profile">
        <div class="profile-toggle" id="profileToggle">
            <span class="profile-icon">👤</span>
            <span class="profile-type"></span>
        </div>
        <div class="profile-menu" id="profileMenu">
            <h4>Ваш путь</h4>
            <div class="profile-current">
                <span class="current-icon"></span>
                <span class="current-type"></span>
            </div>
            <button class="change-path-btn" onclick="visitorProfile.showWelcomeModal()">Изменить путь</button>
            <div class="profile-stats">
                <p>Время в саду: <span id="timeSpent">0:00</span></p>
                <p>Посещённые зоны: <span id="zonesVisited">0/5</span></p>
            </div>
            <!-- Кнопка открытия мандалы в профиле -->
            <button class="mandala-btn" onclick="mandalaSystem.showMandala()">
                <span>🔮</span> Моя мандала
            </button>
        </div>
    </div>

    <!-- Контекстные подсказки -->
    <div id="contextTooltip" class="context-tooltip">
        <div class="tooltip-header">
            <h4 class="tooltip-title"></h4>
            <button class="tooltip-close">×</button>
        </div>
        <div class="tooltip-content"></div>
        <div class="tooltip-footer">
            <span class="tooltip-category"></span>
        </div>
    </div>

    <!-- Генератор персональной мандалы -->
    <div id="mandalaGenerator" class="mandala-overlay">
        <div class="mandala-container">
            <div class="mandala-header">
                <h2>Ваша персональная мандала</h2>
                <p class="mandala-subtitle">Визуализация вашего путешествия через сад</p>
            </div>
            <div class="mandala-canvas-wrapper">
                <canvas id="personalMandala" width="600" height="600"></canvas>
                <div class="mandala-loading">
                    <div class="loading-spinner"></div>
                    <p>Создаём вашу уникальную мандалу...</p>
                </div>
            </div>
            <div class="mandala-interpretation">
                <h3>Интерпретация элементов</h3>
                <div id="mandalaInterpretation" class="interpretation-grid"></div>
            </div>
            <div class="mandala-actions">
                <button class="mandala-download" onclick="mandalaSystem.downloadMandala()">
                    <span>💾</span> Сохранить мандалу
                </button>
                <button class="mandala-regenerate" onclick="mandalaSystem.regenerateMandala()">
                    <span>🔄</span> Обновить
                </button>
                <button class="mandala-close" onclick="mandalaSystem.closeMandala()">
                    Закрыть
                </button>
            </div>
        </div>
    </div>

    <!-- 3D визуализация сада -->
    <div id="garden3D" class="garden-3d-overlay">
        <div class="garden-3d-container">
            <div class="garden-3d-header">
                <h2>Трёхмерная модель сада</h2>
                <button class="close-3d" onclick="garden3D.close()">×</button>
            </div>
            <div id="threejs-container" class="threejs-container"></div>
            <div class="garden-3d-controls">
                <div class="control-group">
                    <button class="control-btn" onclick="garden3D.toggleFlightMode()">
                        <span>✈️</span> Режим полёта
                    </button>
                    <button class="control-btn" onclick="garden3D.resetCamera()">
                        <span>🎯</span> Сброс вида
                    </button>
                    <button class="control-btn" onclick="garden3D.toggleLabels()">
                        <span>🏷️</span> Подписи
                    </button>
                </div>
                <div class="control-group">
                    <label>Время суток:</label>
                    <input type="range" id="timeOfDay" min="0" max="24" value="12" step="0.5" 
                           oninput="garden3D.setTimeOfDay(this.value)">
                    <span id="timeDisplay">12:00</span>
                </div>
            </div>
            <div class="location-info">
                <h3 id="currentLocation">Центральная ось</h3>
                <p id="locationDescription">Нажмите на объекты для получения информации</p>
            </div>
        </div>
    </div>

    <!-- Кнопка 3D в навигационной карте -->
    <!-- Добавить в .map-legend перед закрывающим </div> -->
    <button class="map-3d-btn" onclick="garden3D.open()">
        <span>🌐</span> 3D вид
    </button>

    <!-- Аудио контролы -->
    <div id="audioControls" class="audio-controls">
        <div class="audio-toggle" onclick="audioSystem.togglePanel()">
            <span class="audio-icon">🎵</span>
            <span class="audio-status">Звук выкл</span>
        </div>
        <div class="audio-panel">
            <h4>Звуковой ландшафт</h4>
            <div class="audio-settings">
                <div class="audio-option">
                    <label>
                        <input type="checkbox" id="spatialAudio" onchange="audioSystem.toggleSpatial(this.checked)">
                        Пространственное аудио
                    </label>
                </div>
                <div class="audio-option">
                    <label>
                        <input type="checkbox" id="generativeMusic" onchange="audioSystem.toggleGenerative(this.checked)">
                        Генеративная музыка
                    </label>
                </div>
                <div class="audio-option">
                    <label>
                        <input type="checkbox" id="binauralBeats" onchange="audioSystem.toggleBinaural(this.checked)">
                        Бинауральные ритмы
                    </label>
                </div>
                <div class="audio-option">
                    <label>Громкость:</label>
                    <input type="range" id="masterVolume" min="0" max="100" value="50" 
                           oninput="audioSystem.setMasterVolume(this.value)">
                </div>
            </div>
            <div class="current-soundscape">
                <p>Текущая зона: <span id="currentZoneName">-</span></p>
                <p>Частота: <span id="currentFrequency">-</span></p>
            </div>
        </div>
    </div>

    <!-- Система частиц -->
    <canvas id="particlesCanvas" class="particles-canvas"></canvas>

    <!-- Интерактивные ритуалы -->
    <div id="ritualsOverlay" class="rituals-overlay">
        <!-- Церемония очищения -->
        <div id="purificationRitual" class="ritual-container purification-ritual">
            <div class="ritual-content">
                <h2 class="ritual-title">Ритуал очищения</h2>
                <p class="ritual-description">Прежде чем войти в сад, очистите свой разум и сердце</p>
                
                <div class="water-basin">
                    <canvas id="waterCanvas" width="400" height="400"></canvas>
                    <div class="ripple-effect"></div>
                </div>
                
                <div class="ritual-instructions">
                    <p>Проведите рукой над водой, чтобы создать очищающие волны</p>
                </div>
                
                <button class="ritual-complete" onclick="ritualSystem.completePurification()">
                    Я очищен(а) и готов(а) войти
                </button>
            </div>
        </div>
        
        <!-- Зажжение свечей -->
        <div id="candleLighting" class="ritual-container candle-ritual">
            <div class="ritual-content">
                <h2 class="ritual-title">Зажжение свечи намерения</h2>
                <p class="ritual-description">Зажгите свечу, вложив в неё своё намерение</p>
                
                <div class="candles-container">
                    <div class="candle" data-lit="false">
                        <div class="candle-body"></div>
                        <div class="candle-wick"></div>
                        <div class="candle-flame"></div>
                    </div>
                </div>
                
                <div class="intention-input">
                    <textarea id="intentionText" placeholder="Введите своё намерение или молитву..."></textarea>
                </div>
                
                <button class="light-candle-btn" onclick="ritualSystem.lightCandle()">
                    Зажечь свечу
                </button>
            </div>
        </div>
        
        <!-- Молитвенные флаги -->
        <div id="prayerFlags" class="ritual-container flags-ritual">
            <div class="ritual-content">
                <h2 class="ritual-title">Молитвенные флаги</h2>
                <p class="ritual-description">Создайте флаг с вашим посланием миру</p>
                
                <div class="flag-creator">
                    <canvas id="flagCanvas" width="300" height="200"></canvas>
                    <div class="flag-colors">
                        <div class="color-option" style="background: #ff6b6b" data-color="#ff6b6b"></div>
                        <div class="color-option" style="background: #4ecdc4" data-color="#4ecdc4"></div>
                        <div class="color-option" style="background: #45b7d1" data-color="#45b7d1"></div>
                        <div class="color-option" style="background: #f9ca24" data-color="#f9ca24"></div>
                        <div class="color-option" style="background: #f0b429" data-color="#f0b429"></div>
                    </div>
                    <input type="text" id="flagMessage" placeholder="Ваше послание..." maxlength="50">
                </div>
                
                <button class="create-flag-btn" onclick="ritualSystem.createFlag()">
                    Развесить флаг
                </button>
                
                <div class="community-flags" id="communityFlags">
                    <!-- Здесь будут отображаться флаги других посетителей -->
                </div>
            </div>
        </div>
        
        <!-- Коллективная медитация -->
        <div id="collectiveMeditation" class="ritual-container meditation-ritual">
            <div class="ritual-content">
                <h2 class="ritual-title">Коллективная медитация</h2>
                <p class="ritual-description">Присоединитесь к глобальной медитации</p>
                
                <div class="meditation-circle">
                    <canvas id="meditationCanvas" width="500" height="500"></canvas>
                    <div class="participants-count">
                        <span id="participantCount">0</span> участников онлайн
                    </div>
                </div>
                
                <div class="meditation-timer">
                    <span id="meditationTime">00:00</span>
                </div>
                
                <button class="meditation-btn" id="meditationToggle" onclick="ritualSystem.toggleMeditation()">
                    Присоединиться к медитации
                </button>
            </div>
        </div>
    </div>

    <!-- Цифровая песочница Юнга -->
    <div id="jungianSandbox" class="sandbox-overlay">
        <div class="sandbox-container">
            <div class="sandbox-header">
                <h2>Цифровая песочница Юнга</h2>
                <p>Создайте свой внутренний ландшафт с помощью архетипических символов</p>
                <button class="close-sandbox" onclick="sandboxSystem.close()">×</button>
            </div>
            
            <div class="sandbox-workspace">
                <canvas id="sandboxCanvas" width="800" height="600"></canvas>
                
                <div class="archetype-palette">
                    <h3>Архетипы</h3>
                    <div class="archetype-grid">
                        <div class="archetype-item" data-archetype="hero" title="Герой">🗡️</div>
                        <div class="archetype-item" data-archetype="shadow" title="Тень">🌑</div>
                        <div class="archetype-item" data-archetype="anima" title="Анима/Анимус">☯️</div>
                        <div class="archetype-item" data-archetype="sage" title="Мудрец">🧙</div>
                        <div class="archetype-item" data-archetype="mother" title="Мать">👑</div>
                        <div class="archetype-item" data-archetype="child" title="Ребёнок">🌟</div>
                        <div class="archetype-item" data-archetype="trickster" title="Трикстер">🎭</div>
                        <div class="archetype-item" data-archetype="tree" title="Древо">🌳</div>
                        <div class="archetype-item" data-archetype="mandala" title="Мандала">⭕</div>
                        <div class="archetype-item" data-archetype="water" title="Вода">💧</div>
                        <div class="archetype-item" data-archetype="fire" title="Огонь">🔥</div>
                        <div class="archetype-item" data-archetype="mountain" title="Гора">⛰️</div>
                    </div>
                    
                    <h3>Инструменты</h3>
                    <div class="sandbox-tools">
                        <button class="tool-btn active" data-tool="place">Разместить</button>
                        <button class="tool-btn" data-tool="move">Переместить</button>
                        <button class="tool-btn" data-tool="remove">Удалить</button>
                        <button class="tool-btn" data-tool="clear">Очистить</button>
                    </div>
                </div>
            </div>
            
            <div class="sandbox-interpretation">
                <h3>Интерпретация вашего ландшафта</h3>
                <div id="sandboxAnalysis"></div>
                <button class="save-sandbox" onclick="sandboxSystem.save()">Сохранить композицию</button>
            </div>
        </div>
    </div>

    <!-- Тест ассоциаций -->
    <div id="associationTest" class="association-overlay">
        <div class="association-container">
            <div class="association-header">
                <h2>Тест личных согласований</h2>
                <p>Откройте ваши уникальные связи между традициями</p>
                <button class="close-association" onclick="associationTest.close()">×</button>
            </div>
            
            <div class="association-content">
                <div class="test-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="testProgress"></div>
                    </div>
                    <span class="progress-text"><span id="currentQuestion">1</span> / <span id="totalQuestions">12</span></span>
                </div>
                
                <div class="association-question" id="questionContainer">
                    <h3 id="questionText"></h3>
                    <div class="association-options" id="optionsContainer"></div>
                </div>
                
                <div class="association-results" id="resultsContainer" style="display: none;">
                    <h3>Ваш профиль согласований</h3>
                    <canvas id="resultsChart" width="600" height="400"></canvas>
                    <div id="resultsInterpretation"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- База данных согласований -->
    <div id="concordanceDatabase" class="database-overlay">
        <div class="database-container">
            <div class="database-header">
                <h2>База данных согласований</h2>
                <button class="close-database" onclick="databaseSystem.close()">×</button>
            </div>
            
            <div class="database-search">
                <input type="text" id="concordanceSearch" placeholder="Поиск по всем согласованиям...">
                <div class="search-filters">
                    <label><input type="checkbox" data-filter="biblical" checked> Библейское</label>
                    <label><input type="checkbox" data-filter="psychoanalytic" checked> Психоаналитическое</label>
                    <label><input type="checkbox" data-filter="cosmological" checked> Космологическое</label>
                    <label><input type="checkbox" data-filter="mystical" checked> Мистическое</label>
                </div>
            </div>
            
            <div class="database-results" id="databaseResults"></div>
            
            <div class="database-visualizer">
                <h3>Визуализация связей</h3>
                <canvas id="connectionsCanvas" width="800" height="400"></canvas>
            </div>
        </div>
    </div>

    <!-- Генератор связей -->
    <div id="connectionGenerator" class="generator-overlay">
        <div class="generator-container">
            <div class="generator-header">
                <h2>Генератор неочевидных связей</h2>
                <button class="close-generator" onclick="connectionGenerator.close()">×</button>
            </div>
            
            <div class="generator-input">
                <div class="concept-input">
                    <label>Концепция 1:</label>
                    <input type="text" id="concept1" placeholder="Например: Древо познания">
                </div>
                <div class="concept-input">
                    <label>Концепция 2:</label>
                    <input type="text" id="concept2" placeholder="Например: Квантовая запутанность">
                </div>
                <button class="generate-connection" onclick="connectionGenerator.generate()">
                    Найти связи
                </button>
            </div>
            
            <div class="connection-results" id="connectionResults"></div>
            
            <div class="connection-map">
                <svg id="connectionSvg" width="800" height="500"></svg>
            </div>
        </div>
    </div>

    <!-- Инструменты анализа -->
    <div id="analysisTools" class="analysis-overlay">
        <div class="analysis-container">
            <div class="analysis-header">
                <h2>Аналитические инструменты</h2>
                <button class="close-analysis" onclick="analysisTools.close()">×</button>
            </div>
            
            <div class="analysis-tabs">
                <button class="tab-btn active" data-tab="statistics">Статистика</button>
                <button class="tab-btn" data-tab="patterns">Паттерны</button>
                <button class="tab-btn" data-tab="journey">Анализ путешествия</button>
                <button class="tab-btn" data-tab="insights">Инсайты</button>
            </div>
            
            <div class="analysis-content">
                <div class="tab-content active" id="statisticsTab">
                    <h3>Статистика вашего путешествия</h3>
                    <div class="stats-grid" id="statsGrid"></div>
                    <canvas id="statsChart" width="700" height="400"></canvas>
                </div>
                
                <div class="tab-content" id="patternsTab">
                    <h3>Обнаруженные паттерны</h3>
                    <div id="patternsContent"></div>
                </div>
                
                <div class="tab-content" id="journeyTab">
                    <h3>Карта вашего путешествия</h3>
                    <canvas id="journeyMap" width="700" height="500"></canvas>
                </div>
                
                <div class="tab-content" id="insightsTab">
                    <h3>Персональные инсайты</h3>
                    <div id="insightsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Кнопки доступа к инструментам -->
    <div class="tools-access-buttons">
        <button class="tool-access-btn" onclick="sandboxSystem.open()" title="Песочница Юнга">
            🏖️
        </button>
        <button class="tool-access-btn" onclick="associationTest.open()" title="Тест ассоциаций">
            🧩
        </button>
        <button class="tool-access-btn" onclick="databaseSystem.open()" title="База согласований">
            📚
        </button>
        <button class="tool-access-btn" onclick="connectionGenerator.open()" title="Генератор связей">
            🔗
        </button>
        <button class="tool-access-btn" onclick="analysisTools.open()" title="Анализ">
            📊
        </button>
    </div>

    <!-- Кнопки доступа к ритуалам -->
    <div class="ritual-access-buttons">
        <button class="ritual-btn" onclick="ritualSystem.showRitual('purification')" title="Ритуал очищения">
            💧
        </button>
        <button class="ritual-btn" onclick="ritualSystem.showRitual('candle')" title="Зажжение свечи">
            🕯️
        </button>
        <button class="ritual-btn" onclick="ritualSystem.showRitual('flags')" title="Молитвенные флаги">
            🚩
        </button>
        <button class="ritual-btn" onclick="ritualSystem.showRitual('meditation')" title="Коллективная медитация">
            🧘
        </button>
    </div>

    <!-- Калейдоскопический генератор -->
    <div id="kaleidoscopeOverlay" class="kaleidoscope-overlay">
        <canvas id="kaleidoscopeCanvas" width="800" height="800"></canvas>
        <div class="kaleidoscope-controls">
            <button onclick="kaleidoscopeSystem.regenerate()">Новый паттерн</button>
            <button onclick="kaleidoscopeSystem.save()">Сохранить</button>
            <button onclick="kaleidoscopeSystem.close()">Закрыть</button>
        </div>
    </div>

    <!-- Космические слои фона -->
    <div class="cosmic-layers">
        <div class="cosmic-layer stars"></div>
        <div class="cosmic-layer nebula"></div>
        <div class="cosmic-layer quantum-field"></div>
    </div>

    <!-- Интерактивная карта сада -->
    <div class="garden-map-overlay" id="gardenMap">
        <button class="map-toggle-btn" id="mapToggle" title="Свернуть/развернуть карту">
            <span id="toggleIcon">◐</span>
        </button>
        
        <div class="map-content">
            <div class="map-header">
                <h3 class="map-title">Навигационная карта сада</h3>
            </div>
            
            <div class="interactive-map" id="interactiveMap">
                <!-- Центральная ось -->
                <div class="map-center" title="Центральная ось: Древо познания" data-info="Вертикаль бытия - 33 метра"></div>
                
                <!-- Концентрические кольца -->
                <div class="map-ring map-ring-1"></div>
                <div class="map-ring map-ring-2"></div>
                <div class="map-ring map-ring-3"></div>
                <div class="map-ring map-ring-4"></div>
                
                <!-- Основные секции -->
                <div class="map-section map-section-genesis" title="Круг Бытия" data-info="7 террас творения">🌀</div>
                <div class="map-section map-section-covenant" title="Террасы Завета" data-info="10 заповедей - 40м">⛰️</div>
                <div class="map-section map-section-incarnation" title="Лабиринт Воплощения" data-info="33 станции пути">🌟</div>
                <div class="map-section map-section-apocalypse" title="Врата Откровения" data-info="12 порталов будущего">🚪</div>
                
                <!-- Вторичные переходные зоны -->
                <div class="map-section-secondary map-transition-1" title="Ось Генезиса" data-info="Переход: Центр → Круг">↗</div>
                <div class="map-section-secondary map-transition-2" title="Путь Восхождения" data-info="Переход: Круг → Террасы">↖</div>
                <div class="map-section-secondary map-transition-3" title="Мост Преображения" data-info="Переход: Террасы → Лабиринт">↘</div>
                <div class="map-section-secondary map-transition-4" title="Туннель Воскресения" data-info="Переход: Лабиринт → Врата">↙</div>
                
                <!-- Пульсирующие точки активности -->
                <div class="activity-pulse" style="top: 30%; left: 40%;"></div>
                <div class="activity-pulse" style="top: 60%; right: 35%;"></div>
                <div class="activity-pulse" style="bottom: 25%; left: 45%;"></div>
                
                <!-- SVG пути между секциями -->
                <svg style="position: absolute; width: 100%; height: 100%; pointer-events: none; overflow: visible;">
                    <!-- Основные пути -->
                    <line x1="50%" y1="50%" x2="50%" y2="20%" stroke="gold" stroke-width="2" opacity="0.7" class="map-path-animated"/>
                    <line x1="50%" y1="50%" x2="90%" y2="50%" stroke="gold" stroke-width="2" opacity="0.7" class="map-path-animated"/>
                    <line x1="50%" y1="50%" x2="50%" y2="80%" stroke="gold" stroke-width="2" opacity="0.7" class="map-path-animated"/>
                    <line x1="50%" y1="50%" x2="10%" y2="50%" stroke="gold" stroke-width="2" opacity="0.7" class="map-path-animated"/>
                    
                    <!-- Диагональные пути -->
                    <line x1="50%" y1="20%" x2="90%" y2="50%" stroke="gold" stroke-width="1" opacity="0.3" stroke-dasharray="3,3"/>
                    <line x1="90%" y1="50%" x2="50%" y2="80%" stroke="gold" stroke-width="1" opacity="0.3" stroke-dasharray="3,3"/>
                    <line x1="50%" y1="80%" x2="10%" y2="50%" stroke="gold" stroke-width="1" opacity="0.3" stroke-dasharray="3,3"/>
                    <line x1="10%" y1="50%" x2="50%" y2="20%" stroke="gold" stroke-width="1" opacity="0.3" stroke-dasharray="3,3"/>
                    
                    <!-- Круговой путь -->
                    <circle cx="50%" cy="50%" r="35%" fill="none" stroke="gold" stroke-width="1" opacity="0.2" stroke-dasharray="10,5"/>
                </svg>
                
                <!-- Информационная панель -->
                <div class="map-info-panel" id="mapInfoPanel"></div>
            </div>
            
            <!-- Легенда -->
            <div class="map-legend">
                <div class="legend-item">
                    <div class="legend-dot"></div>
                    <span>Основные зоны</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: rgba(255, 215, 0, 0.5);"></div>
                    <span>Переходы</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--gold); animation: pulsate 2s infinite;"></div>
                    <span>Активные точки</span>
                </div>
            </div>
        </div>
    </div>

    <header>
        <h1>Сад антропологических согласований</h1>
        <p class="subtitle">Архитектурно-символическое пространство единства духовных традиций</p>
    </header>

    <main class="transitions-system">
        <!-- Система переходов и согласований -->
        <section class="transition-diagram">
            <h2 class="transition-title">Матрица универсальных согласований</h2>
            <p style="text-align: center; margin-bottom: 2rem; color: var(--text-dim);">
                Каждый элемент сада представляет точку пересечения четырёх измерений познания
            </p>
            
            <div class="transition-grid">
                <div class="transition-node">
                    <span class="node-icon">📖</span>
                    <h3 class="node-title">Ветхозаветное измерение</h3>
                    <p>Архетипические структуры первичного откровения: Творение, Грехопадение, Завет, Исход</p>
                </div>
                
                <div class="transition-node">
                    <span class="node-icon">✝️</span>
                    <h3 class="node-title">Новозаветное измерение</h3>
                    <p>Христологическая трансформация: Воплощение, Преображение, Кенозис, Воскресение</p>
                </div>
                
                <div class="transition-node">
                    <span class="node-icon">🧠</span>
                    <h3 class="node-title">Психоаналитическое измерение</h3>
                    <p>Топография психики: Бессознательное, Эдипов комплекс, Сублимация, Индивидуация</p>
                </div>
                
                <div class="transition-node">
                    <span class="node-icon">🌌</span>
                    <h3 class="node-title">Космологическое измерение</h3>
                    <p>Физика универсума: Сингулярность, Инфляция, Энтропия, Мультивселенная</p>
                </div>
            </div>
        </section>

        <!-- Детальное описание Центральной оси -->
        <section class="section-detailed" id="central-axis-detailed">
            <div class="section-header">
                <span class="section-icon-large">🔮</span>
                <div class="section-info">
                    <h2>Центральная ось: Древо познания и космическая сингулярность</h2>
                    <p class="section-subtitle">Вертикаль бытия как ось универсальных трансформаций</p>
                </div>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Архитектурное решение</h4>
                <p>Монументальная спиральная башня высотой 33 метра (символическое соответствие годам земной жизни Христа) выполнена из чередующихся слоёв обсидиана и кристаллического кварца. Структура имеет форму двойной спирали, закручивающейся против часовой стрелки (регрессия к истокам) и по часовой стрелке (эволюционное восхождение).</p>
                <p>Внутреннее пространство оси представляет собой вертикальную шахту с голографическими проекциями, визуализирующими:</p>
                <ul style="margin-left: 2rem; margin-top: 0.5rem;">
                    <li>Квантовые флуктуации вакуума (уровень основания)</li>
                    <li>Формирование первых атомов (3-7 метры)</li>
                    <li>Зарождение жизни (8-15 метры)</li>
                    <li>Эволюцию сознания (16-25 метры)</li>
                    <li>Трансцендентное единство (26-33 метры)</li>
                </ul>
            </div>

            <h3 style="color: var(--gold); margin: 2rem 0;">Таблица согласований Центральной оси</h3>
            <table class="concordance-table">
                <thead>
                    <tr>
                        <th>Уровень</th>
                        <th>Ветхий Завет</th>
                        <th>Новый Завет</th>
                        <th>Психоанализ</th>
                        <th>Космология</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>0-5 м</strong><br>Основание</td>
                        <td>Техом (תְּהוֹם)<br>Первичные воды хаоса</td>
                        <td>"В начале было Слово"<br>(Ин. 1:1)</td>
                        <td>Океаническое чувство<br>Первичный нарциссизм</td>
                        <td>Планковская эпоха<br>10⁻⁴³ секунды</td>
                    </tr>
                    <tr>
                        <td><strong>5-10 м</strong><br>Разделение</td>
                        <td>"Да будет свет"<br>(Быт. 1:3)</td>
                        <td>Логос как принцип<br>различения</td>
                        <td>Первичная репрессия<br>Я/не-Я</td>
                        <td>Нарушение симметрии<br>Отделение сил</td>
                    </tr>
                    <tr>
                        <td><strong>10-15 м</strong><br>Формирование</td>
                        <td>Шесть дней творения</td>
                        <td>Христос как новый Адам</td>
                        <td>Стадии психосексуального<br>развития</td>
                        <td>Нуклеосинтез<br>Формирование элементов</td>
                    </tr>
                    <tr>
                        <td><strong>15-20 м</strong><br>Сознание</td>
                        <td>Древо познания<br>добра и зла</td>
                        <td>Преображение<br>(Мф. 17:1-9)</td>
                        <td>Формирование<br>Супер-Эго</td>
                        <td>Возникновение<br>наблюдателя</td>
                    </tr>
                    <tr>
                        <td><strong>20-25 м</strong><br>Кризис</td>
                        <td>Грехопадение<br>Изгнание из рая</td>
                        <td>Гефсимания<br>Голгофа</td>
                        <td>Эдипов комплекс<br>Кастрационная тревога</td>
                        <td>Энтропийный кризис<br>Тепловая смерть</td>
                    </tr>
                    <tr>
                        <td><strong>25-33 м</strong><br>Трансценденция</td>
                        <td>Лестница Иакова<br>Меркава Иезекииля</td>
                        <td>Вознесение<br>Второе пришествие</td>
                        <td>Индивидуация<br>Самость (Юнг)</td>
                        <td>Омега-точка<br>Финальная сингулярность</td>
                    </tr>
                </tbody>
            </table>

            <div class="visitor-path">
                <h3 class="path-title">
                    <span>🚶</span>
                    <span>Путь посетителя по Центральной оси</span>
                </h3>
                <p>Восхождение начинается из подземного грота, символизирующего первичный хаос и материнское лоно. Посетитель проходит через:</p>
                <div class="path-steps">
                    <div class="path-step">
                        <span class="step-number">1</span>
                        <span>Врата Начала - тёмный тоннель с квантовыми визуализациями</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">2</span>
                        <span>Спиральный подъём с 7 платформами созерцания</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">3</span>
                        <span>Камера Преображения на высоте 20 метров</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">4</span>
                        <span>Финальное восхождение к Куполу Единства</span>
                    </div>
                </div>
            </div>

            <div class="interactive-element">
                <h4>Интерактивный опыт: Зеркало сознания</h4>
                <p>На уровне 17 метров расположена камера с системой биометрических сенсоров, создающих персонализированную мандалу на основе сердечного ритма, мозговых волн и дыхания посетителя - визуализация личного пути от хаоса к порядку.</p>
            </div>
        </section>

        <!-- Детальное описание Круга Бытия -->
        <section class="section-detailed" id="genesis-circle-detailed">
            <div class="section-header">
                <span class="section-icon-large">🌀</span>
                <div class="section-info">
                    <h2>Круг Бытия: Семь террас творения</h2>
                    <p class="section-subtitle">Космогоническая спираль развёртывания реальности</p>
                </div>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Пространственная организация</h4>
                <p>Вокруг Центральной оси расположены семь концентрических террас общим диаметром 144 метра (12×12 - число полноты в квадрате). Каждая терраса имеет уникальный ландшафтный дизайн, отражающий соответствующий день творения и этап космической эволюции.</p>
                <p>Террасы соединены 49 радиальными путями (7×7), символизирующими множественность путей познания при единстве цели. Материалы террас меняются от вулканического базальта (первая) до полупрозрачного оникса (седьмая).</p>
            </div>

            <h3 style="color: var(--gold); margin: 2rem 0;">Детальное описание каждой террасы</h3>

            <div class="architectural-detail">
                <h4 class="detail-title">Первая терраса: Свет и Тьма (День 1)</h4>
                <p><strong>Диаметр:</strong> 144 метра | <strong>Ширина:</strong> 10 метров</p>
                <p><strong>Материалы:</strong> Чёрный обсидиан и белый кварц в шахматном порядке</p>
                <p><strong>Элементы:</strong></p>
                <ul style="margin-left: 2rem;">
                    <li>Фотонный фонтан с лазерной инсталляцией</li>
                    <li>Акустические резонаторы, настроенные на частоту 432 Гц</li>
                    <li>Сад теневых проекций с движущимися световыми паттернами</li>
                </ul>
                <p><strong>Согласования:</strong> "Да будет свет" = Большой взрыв = Озарение сознания = Первичная дифференциация Эго</p>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Вторая терраса: Разделение вод (День 2)</h4>
                <p><strong>Диаметр:</strong> 124 метра | <strong>Ширина:</strong> 9 метров</p>
                <p><strong>Материалы:</strong> Голубой лазурит и прозрачное стекло</p>
                <p><strong>Элементы:</strong></p>
                <ul style="margin-left: 2rem;">
                    <li>Система каскадных бассейнов с эффектом левитации воды</li>
                    <li>Туманные завесы, создающие иллюзию парящих островов</li>
                    <li>Звуковая инсталляция с записями космического излучения</li>
                </ul>
                <p><strong>Согласования:</strong> Разделение вод = Формирование галактик = Отделение сознательного от бессознательного</p>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Третья терраса: Суша и растения (День 3)</h4>
                <p><strong>Диаметр:</strong> 106 метра | <strong>Ширина:</strong> 8 метров</p>
                <p><strong>Материалы:</strong> Терракота, живая почва, корни деревьев в стекле</p>
                <p><strong>Элементы:</strong></p>
                <ul style="margin-left: 2rem;">
                    <li>Палеоботанический сад с древними видами растений</li>
                    <li>Геологическая экспозиция с образцами всех эпох Земли</li>
                    <li>Лабиринт из живых изгородей в форме фрактала</li>
                </ul>
                <p><strong>Согласования:</strong> Произрастание = Планетарная аккреция = Укоренение либидо в объектах</p>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Четвёртая терраса: Светила (День 4)</h4>
                <p><strong>Диаметр:</strong> 90 метра | <strong>Ширина:</strong> 7 метров</p>
                <p><strong>Материалы:</strong> Полированная медь, золото, метеоритное железо</p>
                <p><strong>Элементы:</strong></p>
                <ul style="margin-left: 2rem;">
                    <li>Планетарий под открытым небом с механическим оррери</li>
                    <li>Солнечные часы всех исторических типов</li>
                    <li>Обсерватория с телескопами для дневных и ночных наблюдений</li>
                </ul>
                <p><strong>Согласования:</strong> Установление времён = Звёздный нуклеосинтез = Циркадные ритмы психики</p>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Пятая терраса: Морские твари и птицы (День 5)</h4>
                <p><strong>Диаметр:</strong> 76 метра | <strong>Ширина:</strong> 6 метров</p>
                <p><strong>Материалы:</strong> Коралловый известняк, перламутр, иридесцентное стекло</p>
                <p><strong>Элементы:</strong></p>
                <ul style="margin-left: 2rem;">
                    <li>Аквариумы с первичными формами жизни</li>
                    <li>Вольеры с тропическими птицами</li>
                    <li>Кинетические скульптуры, имитирующие полёт и плавание</li>
                </ul>
                <p><strong>Согласования:</strong> Кишащие воды = Кембрийский взрыв = Океанические фантазии бессознательного</p>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Шестая терраса: Земные животные и человек (День 6)</h4>
                <p><strong>Диаметр:</strong> 64 метра | <strong>Ширина:</strong> 5 метров</p>
                <p><strong>Материалы:</strong> Розовый гранит, бронза, дерево акации</p>
                <p><strong>Элементы:</strong></p>
                <ul style="margin-left: 2rem;">
                    <li>Скульптурная галерея эволюции от приматов к человеку</li>
                    <li>Интерактивная песочница для юнгианской песочной терапии</li>
                    <li>Зеркальный лабиринт самопознания</li>
                </ul>
                <p><strong>Согласования:</strong> Образ и подобие = Возникновение сознания = Зеркальная стадия (Лакан)</p>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Седьмая терраса: Суббота покоя (День 7)</h4>
                <p><strong>Диаметр:</strong> 54 метра | <strong>Ширина:</strong> 4 метра</p>
                <p><strong>Материалы:</strong> Белый оникс, хрусталь, левитирующие магнитные платформы</p>
                <p><strong>Элементы:</strong></p>
                <ul style="margin-left: 2rem;">
                    <li>Медитационные капсулы с сенсорной депривацией</li>
                    <li>Сад камней в стиле дзен с квантовыми паттернами</li>
                    <li>Храм тишины с идеальной акустической изоляцией</li>
                </ul>
                <p><strong>Согласования:</strong> Божественный покой = Энтропийное равновесие = Нирвана = Завершение индивидуации</p>
            </div>

            <div class="visitor-path">
                <h3 class="path-title">
                    <span>🚶</span>
                    <span>Маршруты по Кругу Бытия</span>
                </h3>
                <p>Посетители могут выбрать один из трёх маршрутов:</p>
                <div class="path-steps">
                    <div class="path-step">
                        <span class="step-number">A</span>
                        <span><strong>Путь Творения:</strong> От внешней террасы к центру (инволюция)</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">B</span>
                        <span><strong>Путь Эволюции:</strong> От центра к периферии (эволюция)</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">C</span>
                        <span><strong>Спиральный путь:</strong> По радиальным дорожкам между террасами</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Детальное описание Террас Завета -->
        <section class="section-detailed" id="covenant-terraces-detailed">
            <div class="section-header">
                <span class="section-icon-large">⛰️</span>
                <div class="section-info">
                    <h2>Террасы Завета: Синайское восхождение</h2>
                    <p class="section-subtitle">Архитектура морального космоса и структуры Супер-Эго</p>
                </div>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Общая концепция</h4>
                <p>Искусственная гора высотой 40 метров (символ 40 дней Моисея на Синае, 40 дней искушения Христа, 40 недель внутриутробного развития) возвышается на восточной стороне сада. Гора имеет форму усечённой пирамиды с десятью террасами, каждая посвящена одной заповеди.</p>
                <p>Восхождение организовано через три пути различной сложности: Путь Закона (прямой, крутой), Путь Милосердия (спиральный, пологий) и Путь Мудрости (с остановками для размышления).</p>
            </div>

            <h3 style="color: var(--gold); margin: 2rem 0;">Система десяти террас-заповедей</h3>

            <table class="concordance-table">
                <thead>
                    <tr>
                        <th>Терраса</th>
                        <th>Заповедь</th>
                        <th>Психоаналитический принцип</th>
                        <th>Космологическое соответствие</th>
                        <th>Архитектурный элемент</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>1</strong><br>0-4 м</td>
                        <td>"Я Господь, Бог твой"</td>
                        <td>Первичная идентификация<br>с отцовской фигурой</td>
                        <td>Антропный принцип</td>
                        <td>Врата Признания<br>Обсидиановое зеркало</td>
                    </tr>
                    <tr>
                        <td><strong>2</strong><br>4-8 м</td>
                        <td>"Не сотвори себе кумира"</td>
                        <td>Преодоление нарциссизма</td>
                        <td>Запрет на теорию всего</td>
                        <td>Сад разбитых идолов<br>Деконструированные статуи</td>
                    </tr>
                    <tr>
                        <td><strong>3</strong><br>8-12 м</td>
                        <td>"Не произноси имени<br>Господа напрасно"</td>
                        <td>Символическая кастрация<br>Власть означающего</td>
                        <td>Принцип неопределённости</td>
                        <td>Храм молчания<br>Звукопоглощающие стены</td>
                    </tr>
                    <tr>
                        <td><strong>4</strong><br>12-16 м</td>
                        <td>"Помни день субботний"</td>
                        <td>Ритм труда и отдыха<br>Принцип реальности</td>
                        <td>Космические циклы</td>
                        <td>Хронологический сад<br>Солнечные и водяные часы</td>
                    </tr>
                    <tr>
                        <td><strong>5</strong><br>16-20 м</td>
                        <td>"Почитай отца и мать"</td>
                        <td>Разрешение Эдипова<br>комплекса</td>
                        <td>Наследование информации</td>
                        <td>Галерея предков<br>Генеалогическое древо света</td>
                    </tr>
                    <tr>
                        <td><strong>6</strong><br>20-24 м</td>
                        <td>"Не убивай"</td>
                        <td>Сублимация агрессии</td>
                        <td>Сохранение энергии</td>
                        <td>Мемориал жизни<br>Вечный огонь в воде</td>
                    </tr>
                    <tr>
                        <td><strong>7</strong><br>24-28 м</td>
                        <td>"Не прелюбодействуй"</td>
                        <td>Генитальная организация<br>либидо</td>
                        <td>Генетическая верность</td>
                        <td>Сад верности<br>Переплетённые деревья</td>
                    </tr>
                    <tr>
                        <td><strong>8</strong><br>28-32 м</td>
                        <td>"Не кради"</td>
                        <td>Уважение границ Другого</td>
                        <td>Закон сохранения</td>
                        <td>Лабиринт собственности<br>Прозрачные стены</td>
                    </tr>
                    <tr>
                        <td><strong>9</strong><br>32-36 м</td>
                        <td>"Не лжесвидетельствуй"</td>
                        <td>Этика речи<br>Истина бессознательного</td>
                        <td>Информационная<br>целостность</td>
                        <td>Зал истины<br>Акустические фокусы</td>
                    </tr>
                    <tr>
                        <td><strong>10</strong><br>36-40 м</td>
                        <td>"Не желай"</td>
                        <td>Преодоление зависти<br>Принятие кастрации</td>
                        <td>Энтропийное принятие</td>
                        <td>Платформа созерцания<br>360° панорама</td>
                    </tr>
                </tbody>
            </table>

            <div class="visitor-path">
                <h3 class="path-title">
                    <span>🚶</span>
                    <span>Ритуал восхождения</span>
                </h3>
                <p>Восхождение начинается с ритуального омовения в Микве Очищения у подножия горы. Каждая терраса требует символического действия:</p>
                <div class="path-steps">
                    <div class="path-step">
                        <span class="step-number">1</span>
                        <span>Снятие обуви (земля святая)</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">2</span>
                        <span>Разбивание глиняной таблички (отказ от идолов)</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">3</span>
                        <span>Минута абсолютного молчания</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">4</span>
                        <span>Медитация на восходе/закате</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">5-10</span>
                        <span>Последовательные акты признания и отречения</span>
                    </div>
                </div>
            </div>

            <div class="interactive-element">
                <h4>Скрижали Света</h4>
                <p>На вершине установлены две монолитные плиты из прозрачного сапфира с лазерной гравировкой заповедей на 70 языках. При определённом угле освещения проявляются скрытые формулы: уравнения квантовой механики, структура ДНК, мандалы бессознательного.</p>
            </div>
        </section>

        <!-- Детальное описание Лабиринта Воплощения -->
        <section class="section-detailed" id="incarnation-labyrinth-detailed">
            <div class="section-header">
                <span class="section-icon-large">🌟</span>
                <div class="section-info">
                    <h2>Лабиринт Воплощения: Христологическая спираль</h2>
                    <p class="section-subtitle">Мистерия божественного кенозиса в структуре пространства-времени</p>
                </div>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Архитектурная концепция</h4>
                <p>Лабиринт занимает западную четверть сада и представляет собой сложную структуру, объединяющую форму двойной спирали ДНК с христианским крестом. Общая длина пути составляет 3,3 километра (символические 33 года), проходя через 12 основных поворотов (12 апостолов) и 33 станции contemplatio.</p>
                <p>Стены лабиринта высотой от 2 до 7 метров выполнены из полированной нержавеющей стали с вкраплениями оптоволокна, создающего эффект звёздного неба. По мере продвижения плотность "звёзд" меняется, отражая космологическую эволюцию.</p>
            </div>

            <h3 style="color: var(--gold); margin: 2rem 0;">33 станции Воплощения</h3>

            <div class="architectural-detail">
                <h4 class="detail-title">Преддверие: Станции 1-11 (Предвечное существование)</h4>
                <p><strong>Станция 1: Логос до времён</strong> - Чёрная сфера с проекцией космического микроволнового фона</p>
                <p><strong>Станции 2-4: Троичная пульсация</strong> - Три резонирующие камеры с частотами 111, 222 и 333 Гц</p>
                <p><strong>Станции 5-7: Творение мира</strong> - Голографические диорамы шести дней творения</p>
                <p><strong>Станции 8-11: Ветхозаветные прообразы</strong> - Скульптуры Адама, Ноя, Авраама, Моисея</p>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Воплощение: Станции 12-22 (Земная жизнь)</h4>
                <p><strong>Станция 12: Благовещение</strong> - Камера с эффектом квантовой суперпозиции света</p>
                <p><strong>Станция 13: Рождество</strong> - Грот с метеоритом возрастом 4,6 млрд лет</p>
                <p><strong>Станции 14-16: Детство</strong> - Интерактивные инсталляции развития сознания</p>
                <p><strong>Станции 17-19: Служение</strong> - Водные сады с системой преломления света (чудеса)</p>
                <p><strong>Станции 20-22: Страстная неделя</strong> - Нарастающее сужение пространства</p>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Мистерия: Станции 23-33 (Смерть и Воскресение)</h4>
                <p><strong>Станция 23: Гефсимания</strong> - Сад с деревьями, меняющими цвет от зелёного к красному</p>
                <p><strong>Станция 24: Суд</strong> - Зеркальный зал множественных отражений</p>
                <p><strong>Станции 25-27: Крестный путь</strong> - Подъём с увеличивающейся гравитацией (магнитное поле)</p>
                <p><strong>Станция 28: Распятие</strong> - Точка максимального сжатия, чёрная дыра света</p>
                <p><strong>Станция 29: Погребение</strong> - Абсолютная темнота и тишина</p>
                <p><strong>Станция 30: Сошествие во ад</strong> - Спуск в подземную камеру с инверсией гравитации</p>
                <p><strong>Станция 31: Воскресение</strong> - Взрыв света, выход в открытое пространство</p>
                <p><strong>Станция 32: Вознесение</strong> - Левитирующая платформа с видом на весь сад</p>
                <p><strong>Станция 33: Второе пришествие</strong> - Портал в Зал Откровения</p>
            </div>

            <div class="visitor-path">
                <h3 class="path-title">
                    <span>🚶</span>
                    <span>Навигация по Лабиринту</span>
                </h3>
                <p>Лабиринт предлагает три режима прохождения:</p>
                <div class="path-steps">
                    <div class="path-step">
                        <span class="step-number">Via Contemplativa</span>
                        <span>3-4 часа медитативного прохождения всех станций</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">Via Activa</span>
                        <span>1-2 часа с интерактивными заданиями</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">Via Mystica</span>
                        <span>Ночное прохождение при свете звёзд</span>
                    </div>
                </div>
            </div>

            <table class="concordance-table" style="margin-top: 2rem;">
                <thead>
                    <tr>
                        <th>Аспект Лабиринта</th>
                        <th>Христологический смысл</th>
                        <th>Психоаналитическая интерпретация</th>
                        <th>Космологическая параллель</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Форма двойной спирали</td>
                        <td>Две природы Христа</td>
                        <td>Сознательное/бессознательное</td>
                        <td>ДНК как код жизни</td>
                    </tr>
                    <tr>
                        <td>33 станции</td>
                        <td>Годы земной жизни</td>
                        <td>Стадии индивидуации</td>
                        <td>Резонансы струн</td>
                    </tr>
                    <tr>
                        <td>Центральное сжатие</td>
                        <td>Крестная смерть</td>
                        <td>Травма рождения</td>
                        <td>Чёрная дыра</td>
                    </tr>
                    <tr>
                        <td>Финальное расширение</td>
                        <td>Воскресение</td>
                        <td>Трансценденция Эго</td>
                        <td>Белая дыра</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Детальное описание Врат Откровения -->
        <section class="section-detailed" id="apocalypse-gates-detailed">
            <div class="section-header">
                <span class="section-icon-large">🚪</span>
                <div class="section-info">
                    <h2>Врата Откровения: Эсхатологический портал</h2>
                    <p class="section-subtitle">Архитектура финальной трансформации космоса и сознания</p>
                </div>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Монументальная структура</h4>
                <p>Врата Откровения представляют собой титаническую арку высотой 21 метр (3×7 - совершенство Троицы, умноженное на полноту творения) и шириной 12 метров (число полноты). Конструкция выполнена из сплава титана и иридия с нанопокрытием, меняющим цвет в зависимости от угла зрения.</p>
                <p>Поверхность врат покрыта фрактальными узорами, основанными на множестве Мандельброта, где каждый уровень приближения раскрывает новые символические структуры: от альфы и омеги до спиралей галактик и структуры белков.</p>
            </div>

            <h3 style="color: var(--gold); margin: 2rem 0;">Семь печатей Апокалипсиса</h3>

            <div class="architectural-detail">
                <h4 class="detail-title">Преддверие: Зал приготовления</h4>
                <p>Перед вратами расположен круглый зал диаметром 49 метров с семью нишами, каждая из которых представляет одну из печатей Откровения. Посетители проходят ритуал "снятия печатей" через интерактивные инсталляции:</p>
                
                <p><strong>Первая печать (Белый конь):</strong> Голографическая проекция расширяющейся Вселенной</p>
                <p><strong>Вторая печать (Рыжий конь):</strong> Камера с визуализацией энтропии</p>
                <p><strong>Третья печать (Вороной конь):</strong> Весы, измеряющие тёмную материю</p>
                <p><strong>Четвёртая печать (Бледный конь):</strong> Криогенная камера абсолютного нуля</p>
                <p><strong>Пятая печать (Души убиенных):</strong> Мемориал исчезнувших цивилизаций</p>
                <p><strong>Шестая печать (Космические катастрофы):</strong> Симулятор коллапса звёзд</p>
                <p><strong>Седьмая печать (Безмолвие):</strong> Камера квантовой тишины</p>
            </div>

            <h3 style="color: var(--gold); margin: 2rem 0;">Структура Небесного Иерусалима</h3>

            <div class="architectural-detail">
                <h4 class="detail-title">Главный зал: Пространство финального синтеза</h4>
                <p>За вратами открывается сферический зал диаметром 144 метра (12×12 - совершенное число оснований Нового Иерусалима). Пространство организовано как голографическая модель мультивселенной с центральным кубом из чистого кристалла размером 12×12×12 метров, парящим в центре без видимой опоры (магнитная левитация).</p>
            </div>

            <table class="concordance-table">
                <thead>
                    <tr>
                        <th>Элемент Небесного Иерусалима</th>
                        <th>Библейский источник</th>
                        <th>Психоаналитическое значение</th>
                        <th>Космологическое воплощение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>12 оснований</td>
                        <td>12 камней первосвященника<br>12 апостолов (Откр. 21:14)</td>
                        <td>12 архетипов коллективного<br>бессознательного</td>
                        <td>12 фундаментальных<br>частиц Стандартной модели</td>
                    </tr>
                    <tr>
                        <td>Кристальная структура</td>
                        <td>"Чистое золото, подобное<br>чистому стеклу" (Откр. 21:18)</td>
                        <td>Прозрачность<br>интегрированной психики</td>
                        <td>Кристаллическая решётка<br>пространства-времени</td>
                    </tr>
                    <tr>
                        <td>Река жизни</td>
                        <td>"Чистая река воды жизни"<br>(Откр. 22:1)</td>
                        <td>Поток либидо в<br>сублимированной форме</td>
                        <td>Квантовый поток<br>информации</td>
                    </tr>
                    <tr>
                        <td>Древо жизни</td>
                        <td>"По ту и по другую сторону<br>реки" (Откр. 22:2)</td>
                        <td>Объединение<br>противоположностей</td>
                        <td>Фрактальная структура<br>мультивселенной</td>
                    </tr>
                    <tr>
                        <td>Отсутствие храма</td>
                        <td>"Господь Бог Вседержитель -<br>храм его" (Откр. 21:22)</td>
                        <td>Преодоление<br>невроза религии</td>
                        <td>Нелокальность<br>квантового сознания</td>
                    </tr>
                    <tr>
                        <td>Вечный свет</td>
                        <td>"Не будет нужды в светильнике"<br>(Откр. 22:5)</td>
                        <td>Просветлённое<br>сознание</td>
                        <td>Преодоление<br>термодинамической смерти</td>
                    </tr>
                </tbody>
            </table>

            <div class="architectural-detail" style="margin-top: 1.5rem; font-size: 1rem;">
                <h4 class="detail-title">Двенадцать врат-порталов</h4>
                <p>По периметру сферического зала расположены 12 порталов, каждый из которых ведёт в отдельное пространство, представляющее возможный сценарий эволюции Вселенной:</p>
                
                <div style="margin-top: 1.5rem;">
                    <p style="margin: 0.8rem 0;"><strong>Врата Жемчужные (Север):</strong> Сценарий Большого разрыва - визуализация ускоряющегося расширения</p>
                    <p style="margin: 0.8rem 0;"><strong>Врата Сапфировые (Северо-восток):</strong> Сценарий Большого схлопывания - обратное сжатие в точку</p>
                    <p style="margin: 0.8rem 0;"><strong>Врата Халцедоновые (Восток):</strong> Сценарий тепловой смерти - максимальная энтропия</p>
                    <p style="margin: 0.8rem 0;"><strong>Врата Изумрудные (Юго-восток):</strong> Сценарий квантового туннелирования в новую вселенную</p>
                    <p style="margin: 0.8rem 0;"><strong>Врата Сардониксовые (Юг):</strong> Сценарий фазового перехода вакуума</p>
                    <p style="margin: 0.8rem 0;"><strong>Врата Сердоликовые (Юго-запад):</strong> Сценарий слияния с параллельными вселенными</p>
                    <p style="margin: 0.8rem 0;"><strong>Врата Хризолитовые (Запад):</strong> Сценарий эволюции в высшие измерения</p>
                    <p style="margin: 0.8rem 0;"><strong>Врата Вирилловые (Северо-запад):</strong> Сценарий превращения материи в чистую информацию</p>
                    <p style="margin: 0.8rem 0;"><strong>Врата Топазовые (Верх):</strong> Сценарий трансценденции времени</p>
                    <p style="margin: 0.8rem 0;"><strong>Врата Хрисопразовые (Низ):</strong> Сценарий квантовой запутанности всего сущего</p>
                    <p style="margin: 0.8rem 0;"><strong>Врата Гиацинтовые (Центр-верх):</strong> Сценарий возникновения космического сознания</p>
                    <p style="margin: 0.8rem 0;"><strong>Врата Аметистовые (Центр-низ):</strong> Сценарий окончательного единства наблюдателя и наблюдаемого</p>
                </div>
            </div>

            <div class="visitor-path">
                <h3 class="path-title">
                    <span>🚶</span>
                    <span>Финальный ритуал перехода</span>
                </h3>
                <p>Прохождение через Врата Откровения завершается тремя этапами трансформации:</p>
                <div class="path-steps">
                    <div class="path-step">
                        <span class="step-number">Α</span>
                        <span><strong>Альфа:</strong> Воспоминание начала - проекция личной истории на космическую</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">Μ</span>
                        <span><strong>Мю:</strong> Переживание настоящего - квантовая суперпозиция всех возможностей</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">Ω</span>
                        <span><strong>Омега:</strong> Предвосхищение конца - выбор личного эсхатона</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Система переходов между пространствами -->
        <section class="section-detailed" id="transitions-detailed">
            <div class="section-header">
                <span class="section-icon-large">🔄</span>
                <div class="section-info">
                    <h2>Архитектура переходов: Связующие пути</h2>
                    <p class="section-subtitle">Система коридоров, мостов и порталов между основными пространствами</p>
                </div>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Общая концепция связности</h4>
                <p>Все пять основных пространств сада соединены сложной системой переходов, которые сами по себе являются местами трансформации и созерцания. Переходы организованы на трёх уровнях: подземном (бессознательное), наземном (сознание) и воздушном (сверхсознание).</p>
            </div>

            <h3 style="color: var(--gold); margin: 2rem 0;">Главные переходные артерии</h3>

            <div class="architectural-detail">
                <h4 class="detail-title">1. Ось Генезиса (Центр → Круг Бытия)</h4>
                <p><strong>Форма:</strong> Семь радиальных лучей из обсидиана и кварца</p>
                <p><strong>Длина:</strong> 72 метра каждый</p>
                <p><strong>Особенности:</strong></p>
                <ul style="margin-left: 2rem;">
                    <li>Постепенное изменение материала от чёрного к белому</li>
                    <li>Звуковые порталы с записями первичных звуков Вселенной</li>
                    <li>Световые инсталляции, имитирующие рождение звёзд</li>
                </ul>
                <p><strong>Символика:</strong> Эманация творческой энергии из центра к периферии</p>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">2. Путь Восхождения (Круг Бытия → Террасы Завета)</h4>
                <p><strong>Форма:</strong> Спиральная дорога, поднимающаяся на 40 метров</p>
                <p><strong>Длина:</strong> 618 метров (золотое сечение × 1000)</p>
                <p><strong>Особенности:</strong></p>
                <ul style="margin-left: 2rem;">
                    <li>33 остановки для размышления (годы Христа)</li>
                    <li>Постепенное сужение пути от 7 до 3 метров</li>
                    <li>Боковые часовни с реликвиями духовных традиций</li>
                </ul>
                <p><strong>Символика:</strong> Моральное восхождение через усилие и ограничение</p>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">3. Мост Преображения (Террасы Завета → Лабиринт Воплощения)</h4>
                <p><strong>Форма:</strong> Парящий мост без видимых опор (магнитная левитация)</p>
                <p><strong>Длина:</strong> 144 метра</p>
                <p><strong>Высота:</strong> 33 метра над землёй</p>
                <p><strong>Особенности:</strong></p>
                <ul style="margin-left: 2rem;">
                    <li>Прозрачный пол из закалённого стекла</li>
                    <li>Голографические облака, окружающие идущих</li>
                    <li>Изменение гравитации по мере продвижения</li>
                </ul>
                <p><strong>Символика:</strong> Переход от Закона к Благодати через веру</p>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">4. Туннель Смерти-Воскресения (Лабиринт → Врата Откровения)</h4>
                <p><strong>Форма:</strong> Подземный переход с переменным сечением</p>
                <p><strong>Длина:</strong> 300 метров</p>
                <p><strong>Глубина:</strong> До 12 метров под землёй</p>
                <p><strong>Особенности:</strong></p>
                <ul style="margin-left: 2rem;">
                    <li>Полная темнота в центральной трети пути</li>
                    <li>Постепенное появление света к выходу</li>
                    <li>Акустический эффект "умирания" и "рождения" звука</li>
                </ul>
                <p><strong>Символика:</strong> Необходимость символической смерти для трансформации</p>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">5. Квантовый портал (Врата Откровения → Центр)</h4>
                <p><strong>Форма:</strong> Система телепортационных кабин</p>
                <p><strong>Механизм:</strong> Оптическая иллюзия мгновенного перемещения</p>
                <p><strong>Особенности:</strong></p>
                <ul style="margin-left: 2rem;">
                    <li>Дезинтеграция и реинтеграция визуального образа</li>
                    <li>Переживание "квантового скачка" сознания</li>
                    <li>Выход в разных точках Центральной оси</li>
                </ul>
                <p><strong>Символика:</strong> Цикличность времени и вечное возвращение</p>
            </div>

            <h3 style="color: var(--gold); margin: 2rem 0;">Вспомогательные переходы</h3>

            <div class="transition-grid">
                <div class="transition-node">
                    <span class="node-icon">🌉</span>
                    <h3 class="node-title">Акведук Слёз</h3>
                    <p>Водный путь между Кругом Бытия и Лабиринтом, символизирующий очищение через страдание</p>
                </div>
                
                <div class="transition-node">
                    <span class="node-icon">🚇</span>
                    <h3 class="node-title">Катакомбы Памяти</h3>
                    <p>Подземная сеть, соединяющая все пространства, хранилище коллективной памяти</p>
                </div>
                
                <div class="transition-node">
                    <span class="node-icon">🚡</span>
                    <h3 class="node-title">Небесная дорога</h3>
                    <p>Канатная дорога между вершинами структур для панорамного обзора</p>
                </div>
                
                <div class="transition-node">
                    <span class="node-icon">🌀</span>
                    <h3 class="node-title">Вихревые врата</h3>
                    <p>Спиральные переходы для быстрого перемещения между уровнями</p>
                </div>
            </div>
        </section>

        <!-- Интегральный опыт посещения -->
        <section class="section-detailed" id="integral-experience">
            <div class="section-header">
                <span class="section-icon-large">🎭</span>
                <div class="section-info">
                    <h2>Интегральный опыт: Полное погружение</h2>
                    <p class="section-subtitle">Рекомендуемые маршруты и режимы посещения сада</p>
                </div>
            </div>

            <h3 style="color: var(--gold); margin: 2rem 0;">Четыре пути познания</h3>

            <div class="architectural-detail">
                <h4 class="detail-title">1. Путь Пилигрима (1-2 дня)</h4>
                <p><strong>Для кого:</strong> Искатели духовного опыта</p>
                <p><strong>Маршрут:</strong></p>
                <ol style="margin-left: 2rem;">
                    <li>Рассвет у Центральной оси - медитация на начало</li>
                    <li>Обход семи террас Круга Бытия по спирали</li>
                    <li>Полуденное восхождение на Террасы Завета</li>
                    <li>Вечернее прохождение Лабиринта Воплощения</li>
                    <li>Ночное бдение у Врат Откровения</li>
                    <li>Встреча рассвета в Небесном Иерусалиме</li>
                </ol>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">2. Путь Учёного (3-5 дней)</h4>
                <p><strong>Для кого:</strong> Исследователи междисциплинарных связей</p>
                <p><strong>Программа:</strong></p>
                <ul style="margin-left: 2rem;">
                    <li>Детальное изучение таблиц согласований</li>
                    <li>Участие в семинарах в каждой зоне</li>
                    <li>Работа с интерактивными инсталляциями</li>
                    <li>Создание личной карты соответствий</li>
                </ul>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">3. Путь Мистика (7 дней)</h4>
                <p><strong>Для кого:</strong> Практики созерцания и медитации</p>
                <p><strong>Особенности:</strong></p>
                <ul style="margin-left: 2rem;">
                    <li>Проживание в келье при саде</li>
                    <li>Ежедневные медитации на каждом уровне</li>
                    <li>Ночные бдения в ключевых точках</li>
                    <li>Пост и молчание в определённые дни</li>
                </ul>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">4. Путь Художника (время не ограничено)</h4>
                <p><strong>Для кого:</strong> Творческие личности, ищущие вдохновения</p>
                <p><strong>Возможности:</strong></p>
                <ul style="margin-left: 2rem;">
                    <li>Создание произведений в любой точке сада</li>
                    <li>Участие в перформансах и инсталляциях</li>
                    <li>Резиденция для долгосрочных проектов</li>
                    <li>Выставочные пространства для презентации работ</li>
                </ul>
            </div>

            <div class="visitor-path">
                <h3 class="path-title">
                    <span>📱</span>
                    <span>Технологическое сопровождение</span>
                </h3>
                <p>Каждый посетитель получает квантовый браслет, который:</p>
                <div class="path-steps">
                    <div class="path-step">
                        <span class="step-number">📍</span>
                        <span>Отслеживает местоположение и предлагает персональные маршруты</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">🎧</span>
                        <span>Предоставляет аудиогиды на 70 языках</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">🧠</span>
                        <span>Считывает биометрические данные для персонализации опыта</span>
                    </div>
                    <div class="path-step">
                        <span class="step-number">💫</span>
                        <span>Сохраняет личный путь для последующего анализа</span>
                    </div>
                </div>
            </div>

            <div class="interactive-element">
                <h4>Финальная интеграция: Зал Синтеза</h4>
                <p>В геометрическом центре всего комплекса, на пересечении всех путей, находится подземный Зал Синтеза - сферическое пространство, где посетитель может пережить голографическую реконструкцию своего путешествия, увидеть персональную мандалу согласований и получить "свиток памяти" - уникальный артефакт, кодирующий индивидуальный опыт прохождения сада.</p>
            </div>
        </section>

        <!-- Философское заключение -->
        <section class="section-detailed" id="philosophical-conclusion">
            <div class="section-header">
                <span class="section-icon-large">∞</span>
                <div class="section-info">
                    <h2>Философия проекта: Единство в многообразии</h2>
                    <p class="section-subtitle">Метафизические основания Сада антропологических согласований</p>
                </div>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Принцип универсального соответствия</h4>
                <p>Сад антропологических согласований основан на фундаментальной идее о том, что различные системы человеческого знания и опыта являются не противоречащими друг другу фрагментами, но гранями единого кристалла истины. Библейское откровение, психоаналитическое исследование глубин психики и научное познание структуры космоса представляют собой различные языки описания одной и той же предельной реальности.</p>
                
                <p>Архитектура сада материализует эту идею через создание пространства, где физическое движение посетителя становится одновременно духовным паломничеством, психологическим путешествием в глубины собственного существа и интеллектуальным постижением законов мироздания.</p>
            </div>

            <div class="interactive-element">
                <h4>Живой организм сада</h4>
                <p>Сад задуман не как статичный памятник, но как живая, развивающаяся система. Интерактивные элементы реагируют на коллективное бессознательное посетителей, создавая уникальные паттерны света, звука и пространства. Каждое прохождение через сад оставляет след в его квантовой памяти, постепенно формируя новые уровни смысла и новые пути согласования.</p>
            </div>

            <div class="architectural-detail">
                <h4 class="detail-title">Эсхатологическая перспектива</h4>
                <p>В конечном счёте, Сад антропологических согласований представляет собой попытку предвосхитить то состояние космоса и сознания, когда противоречия между верой и знанием, материей и духом, индивидуальным и универсальным будут окончательно преодолены. Это архитектурная икона будущего единства, материальное пророчество о финальном согласовании всех измерений бытия.</p>
            </div>
        </section>
    </main>

    <footer style="background: rgba(0, 0, 0, 0.8); padding: 3rem; text-align: center; margin-top: 4rem; border-top: 1px solid var(--border);">
        <p style="color: var(--text-dim); font-style: italic;">
            "И увидел я новое небо и новую землю, ибо прежнее небо и прежняя земля миновали" (Откр. 21:1)
        </p>
        <p style="color: var(--gold); margin-top: 1rem;">
            Сад антропологических согласований - пространство, где конец становится началом
        </p>
    </footer>

    <script>
        // Интерактивная карта сада - улучшенная версия
        const gardenMap = {
            overlay: document.getElementById('gardenMap'),
            toggleBtn: document.getElementById('mapToggle'),
            toggleIcon: document.getElementById('toggleIcon'),
            infoPanel: document.getElementById('mapInfoPanel'),
            isCollapsed: false,
            isExpanded: false,
            
            init() {
                // Обработчик кнопки сворачивания/разворачивания
                this.toggleBtn.addEventListener('click', () => this.toggleMap());
                
                // Обработчик наведения для автоматического расширения
                this.overlay.addEventListener('mouseenter', () => {
                    if (!this.isCollapsed) {
                        this.expand();
                    }
                });
                
                this.overlay.addEventListener('mouseleave', () => {
                    if (!this.isCollapsed) {
                        this.contract();
                    }
                });
                
                // Обработчики для всех интерактивных элементов
                this.setupSectionHandlers();
                this.setupInfoPanels();
                
                // Анимация пульсирующих точек
                this.animateActivityPoints();
            },
            
            toggleMap() {
                this.isCollapsed = !this.isCollapsed;
                
                if (this.isCollapsed) {
                    this.overlay.classList.add('collapsed');
                    this.overlay.classList.remove('expanded');
                    this.toggleIcon.textContent = '⊕';
                    this.hideInfoPanel();
                } else {
                    this.overlay.classList.remove('collapsed');
                    this.toggleIcon.textContent = '◐';
                    
                    // Небольшая задержка перед возможностью расширения
                    setTimeout(() => {
                        this.isExpanded = false;
                    }, 300);
                }
            },
            
            expand() {
                if (!this.isCollapsed && !this.isExpanded) {
                    this.overlay.classList.add('expanded');
                    this.isExpanded = true;
                }
            },
            
            contract() {
                if (!this.isCollapsed) {
                    this.overlay.classList.remove('expanded');
                    this.isExpanded = false;
                    this.hideInfoPanel();
                }
            },
            
            setupSectionHandlers() {
                const sections = document.querySelectorAll('.map-section, .map-section-secondary, .map-center');
                
                sections.forEach(section => {
                    section.addEventListener('click', () => {
                        if (!this.isCollapsed) {
                            this.handleSectionClick(section);
                        }
                    });
                    
                    section.addEventListener('mouseenter', () => {
                        if (!this.isCollapsed) {
                            this.showSectionInfo(section);
                        }
                    });
                    
                    section.addEventListener('mouseleave', () => {
                        this.hideInfoPanel();
                    });
                });
            },
            
            handleSectionClick(section) {
                const sectionMap = {
                    'map-center': 'central-axis-detailed',
                    'map-section-genesis': 'genesis-circle-detailed',
                    'map-section-covenant': 'covenant-terraces-detailed',
                    'map-section-incarnation': 'incarnation-labyrinth-detailed',
                    'map-section-apocalypse': 'apocalypse-gates-detailed',
                    'map-transition-1': 'transitions-detailed',
                    'map-transition-2': 'transitions-detailed',
                    'map-transition-3': 'transitions-detailed',
                    'map-transition-4': 'transitions-detailed'
                };
                
                const classes = section.className.split(' ');
                let targetId = null;
                
                for (let className of classes) {
                    if (sectionMap[className]) {
                        targetId = sectionMap[className];
                        break;
                    }
                }
                
                if (targetId) {
                    // Добавляем эффект пульсации при клике
                    section.style.animation = 'none';
                    setTimeout(() => {
                        section.style.animation = 'centralPulse 1s ease-out';
                    }, 10);
                    
                    // Плавная прокрутка к секции
                    document.getElementById(targetId).scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                    
                    // Сворачиваем карту после клика
                    setTimeout(() => {
                        this.toggleMap();
                    }, 500);
                }
            },
            
            showSectionInfo(section) {
                const info = section.getAttribute('data-info');
                if (info && this.infoPanel) {
                    this.infoPanel.textContent = info;
                    this.infoPanel.classList.add('active');
                    
                    // Позиционирование панели относительно элемента
                    const rect = section.getBoundingClientRect();
                    const mapRect = this.overlay.getBoundingClientRect();
                    const relativeTop = rect.top - mapRect.top + rect.height / 2;
                    const relativeLeft = rect.left - mapRect.left + rect.width / 2;
                    
                    this.infoPanel.style.top = relativeTop + 'px';
                    this.infoPanel.style.left = relativeLeft + 'px';
                    this.infoPanel.style.transform = 'translateX(-50%)';
                }
            },
            
            hideInfoPanel() {
                if (this.infoPanel) {
                    this.infoPanel.classList.remove('active');
                }
            },
            
            setupInfoPanels() {
                // Создаем дополнительные визуальные подсказки
                const center = document.querySelector('.map-center');
                if (center) {
                    center.innerHTML += '<span style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; color: var(--gold); white-space: nowrap;">Центр</span>';
                }
            },
            
            animateActivityPoints() {
                const points = document.querySelectorAll('.activity-pulse');
                points.forEach((point, index) => {
                    // Задержка анимации для каждой точки
                    point.style.animationDelay = `${index * 0.5}s`;
                    
                    // Случайное перемещение точек
                    setInterval(() => {
                        if (!this.isCollapsed) {
                            const top = 20 + Math.random() * 60;
                            const left = 20 + Math.random() * 60;
                            point.style.transition = 'all 3s ease';
                            point.style.top = `${top}%`;
                            point.style.left = `${left}%`;
                        }
                    }, 5000 + index * 1000);
                });
            }
        };

        // Инициализация карты
        gardenMap.init();

        // Анимация центральной точки карты
        const mapCenter = document.querySelector('.map-center');
        mapCenter.addEventListener('click', function() {
            document.getElementById('central-axis-detailed').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        });

        // Создание священной геометрии
        function createSacredGeometry() {
            const geometryElements = document.querySelectorAll('.section-detailed');
            geometryElements.forEach((element, index) => {
                if (index % 2 === 0) {
                    const sacred = document.createElement('div');
                    sacred.className = 'sacred-geometry';
                    sacred.style.top = '10%';
                    sacred.style.right = '5%';
                    sacred.innerHTML = `
                        <svg viewBox="0 0 200 200">
                            <circle cx="100" cy="100" r="90" fill="none" stroke="gold" stroke-width="0.5" opacity="0.5"/>
                            <polygon points="100,10 190,150 10,150" fill="none" stroke="gold" stroke-width="0.5" opacity="0.5"/>
                            <polygon points="100,190 10,50 190,50" fill="none" stroke="gold" stroke-width="0.5" opacity="0.5"/>
                        </svg>
                    `;
                    element.appendChild(sacred);
                }
            });
        }
        
        createSacredGeometry();

        // Эффект параллакса для космических слоёв
        let ticking = false;
        function updateParallax() {
            const scrolled = window.pageYOffset;
            const stars = document.querySelector('.stars');
            const nebula = document.querySelector('.nebula');
            const quantum = document.querySelector('.quantum-field');
            
            if (stars) stars.style.transform = `translateY(${scrolled * 0.5}px)`;
            if (nebula) nebula.style.transform = `translateY(${scrolled * 0.3}px)`;
            if (quantum) quantum.style.transform = `translateY(${scrolled * 0.1}px)`;
            
            ticking = false;
        }

        function requestTick() {
            if (!ticking) {
                window.requestAnimationFrame(updateParallax);
                ticking = true;
            }
        }

        window.addEventListener('scroll', requestTick);

        // Интерактивные элементы - раскрытие дополнительной информации
        document.querySelectorAll('.interactive-element').forEach(element => {
            element.addEventListener('click', function() {
                this.classList.toggle('expanded');
                if (this.classList.contains('expanded')) {
                    this.style.maxHeight = this.scrollHeight + 'px';
                } else {
                    this.style.maxHeight = null;
                }
            });
        });

        // Анимация появления элементов при прокрутке
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const fadeInObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        // Применяем наблюдатель ко всем секциям
        document.querySelectorAll('.section-detailed, .architectural-detail, .transition-node').forEach(el => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(30px)';
            el.style.transition = 'opacity 0.8s ease, transform 0.8s ease';
            fadeInObserver.observe(el);
        });

        // Создание эффекта свечения при наведении на таблицы
        document.querySelectorAll('.concordance-table tr').forEach(row => {
            row.addEventListener('mouseenter', function() {
                this.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.3)';
            });
            row.addEventListener('mouseleave', function() {
                this.style.boxShadow = 'none';
            });
        });

        // Динамическое обновление времени посещения
        const visitStart = new Date();
        setInterval(() => {
            const now = new Date();
            const elapsed = Math.floor((now - visitStart) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            
            // Можно добавить отображение времени посещения в интерфейс
        }, 1000);

        // Система профилей посетителя
        const visitorProfile = {
            types: {
                pilgrim: {
                    name: 'Пилигрим',
                    icon: '🕊️',
                    focus: ['spiritual', 'meditation', 'sacred'],
                    contentModifiers: {
                        emphasisWords: ['священный', 'духовный', 'трансцендентный', 'божественный'],
                        highlightSections: ['visitor-path', 'architectural-detail'], // Реальные классы
                        highlightElements: {
                            'architectural-detail': {
                                filter: (el) => el.textContent.toLowerCase().includes('священ') || 
                                               el.textContent.toLowerCase().includes('духовн')
                            }
                        }
                    }
                },
                scholar: {
                    name: 'Учёный',
                    icon: '📚',
                    focus: ['analysis', 'concordance', 'research'],
                    contentModifiers: {
                        emphasisWords: ['исследование', 'анализ', 'соответствие', 'параллель'],
                        highlightSections: ['concordance-table', 'transition-node'],
                        highlightElements: {}
                    }
                },
                mystic: {
                    name: 'Мистик',
                    icon: '🌙',
                    focus: ['psychology', 'archetype', 'unconscious'],
                    contentModifiers: {
                        emphasisWords: ['архетип', 'бессознательное', 'символ', 'трансформация'],
                        highlightSections: ['interactive-element', 'path-step'],
                        highlightElements: {
                            'td': {
                                filter: (el) => el.textContent.includes('Психоанализ') || 
                                               el.textContent.includes('психо')
                            }
                        }
                    }
                },
                artist: {
                    name: 'Художник',
                    icon: '🎨',
                    focus: ['aesthetic', 'creative', 'beauty'],
                    contentModifiers: {
                        emphasisWords: ['красота', 'гармония', 'образ', 'творение'],
                        highlightSections: ['section-header', 'interactive-element'],
                        highlightElements: {}
                    }
                }
            },
            
            currentType: null,
            startTime: Date.now(),
            visitedZones: new Set(),
            
            init() {
                // Проверяем, есть ли сохранённый профиль
                const saved = localStorage.getItem('visitorType');
                if (saved && this.types[saved]) {
                    this.setType(saved);
                    this.updateProfileDisplay();
                    // ВАЖНО: Применяем адаптацию контента при загрузке
                    this.applyContentAdaptation();
                } else {
                    this.showWelcomeModal();
                }
                
                // Инициализация обработчиков
                this.setupEventHandlers();
                this.trackVisitorProgress();
                
                // Обновление времени каждую секунду
                setInterval(() => this.updateTimeSpent(), 1000);
            },
            
            showWelcomeModal() {
                const modal = document.getElementById('welcomeModal');
                modal.classList.add('active');
                
                // Обработчики выбора типа
                document.querySelectorAll('.visitor-type').forEach(type => {
                    type.addEventListener('click', (e) => {
                        const selectedType = type.dataset.type;
                        this.setType(selectedType);
                        modal.classList.remove('active');
                        this.applyContentAdaptation();
                    });
                });
            },
            
            setType(type) {
                this.currentType = type;
                localStorage.setItem('visitorType', type);
                
                // Удаляем старые классы пути
                document.body.className = document.body.className.replace(/\w+-path/g, '');
                document.body.classList.add(`${type}-path`);
                
                this.updateProfileDisplay();
                
                // Применяем адаптацию контента при смене типа
                this.applyContentAdaptation();
            },
            
            updateProfileDisplay() {
                if (!this.currentType) return;
                
                const profile = this.types[this.currentType];
                document.querySelector('.profile-type').textContent = profile.name;
                document.querySelector('.current-icon').textContent = profile.icon;
                document.querySelector('.current-type').textContent = profile.name;
            },
            
            setupEventHandlers() {
                const toggle = document.getElementById('profileToggle');
                const menu = document.getElementById('profileMenu');
                
                toggle.addEventListener('click', () => {
                    menu.classList.toggle('active');
                });
                
                // Закрытие меню при клике вне
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.visitor-profile')) {
                        menu.classList.remove('active');
                    }
                });
            },
            
            trackVisitorProgress() {
                // Отслеживание посещённых секций
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const sectionId = entry.target.id;
                            if (sectionId) {
                                this.visitedZones.add(sectionId);
                                this.updateZonesCount();
                            }
                        }
                    });
                }, { threshold: 0.5 });
                
                // Наблюдаем за основными секциями
                document.querySelectorAll('.section-detailed').forEach(section => {
                    observer.observe(section);
                });
            },
            
            updateTimeSpent() {
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const timeString = hours > 0 ? `${hours}:${minutes.toString().padStart(2, '0')}` : `${minutes}:${(elapsed % 60).toString().padStart(2, '0')}`;
                document.getElementById('timeSpent').textContent = timeString;
            },
            
            updateZonesCount() {
                const totalZones = document.querySelectorAll('.section-detailed').length;
                document.getElementById('zonesVisited').textContent = `${this.visitedZones.size}/${totalZones}`;
            },
            
            applyContentAdaptation() {
                if (!this.currentType) return;
                
                // Сначала очищаем все предыдущие подсветки
                this.clearAllHighlights();
                
                const modifiers = this.types[this.currentType].contentModifiers;
                
                // Подсветка релевантных секций
                modifiers.highlightSections.forEach(className => {
                    document.querySelectorAll(`.${className}`).forEach(el => {
                        el.classList.add('visitor-highlight');
                        el.style.borderColor = 'var(--gold)';
                        el.style.boxShadow = '0 0 10px rgba(255, 215, 0, 0.2)';
                        el.style.transition = 'all 0.3s ease';
                    });
                });
                
                // Подсветка специфических элементов с фильтрами
                if (modifiers.highlightElements) {
                    Object.entries(modifiers.highlightElements).forEach(([selector, config]) => {
                        document.querySelectorAll(selector).forEach(el => {
                            if (!config.filter || config.filter(el)) {
                                el.classList.add('visitor-highlight-subtle');
                                el.style.backgroundColor = 'rgba(255, 215, 0, 0.05)';
                                el.style.transition = 'all 0.3s ease';
                            }
                        });
                    });
                }
                
                // Добавление контекстных подсказок
                // Используем setTimeout чтобы не конфликтовать с tooltipSystem
                setTimeout(() => {
                    this.addContextualTooltips();
                }, 100);
            },

            clearAllHighlights() {
                // Удаляем классы подсветки
                document.querySelectorAll('.visitor-highlight').forEach(el => {
                    el.classList.remove('visitor-highlight');
                    el.style.borderColor = '';
                    el.style.boxShadow = '';
                });
                
                document.querySelectorAll('.visitor-highlight-subtle').forEach(el => {
                    el.classList.remove('visitor-highlight-subtle');
                    el.style.backgroundColor = '';
                });
                
                // Удаляем подсветку слов
                document.querySelectorAll('.visitor-emphasis').forEach(el => {
                    const parent = el.parentNode;
                    parent.replaceChild(document.createTextNode(el.textContent), el);
                    parent.normalize(); // Объединяем соседние текстовые узлы
                });
            },
            
            // Обновление функции addContextualTooltips в visitorProfile
            addContextualTooltips() {
                const typeSpecificTerms = {
                    pilgrim: ['священный', 'духовный', 'божественный', 'трансцендентный'],
                    scholar: ['согласование', 'соответствие', 'параллель', 'структура'],
                    mystic: ['архетип', 'бессознательное', 'символ', 'трансформация'],
                    artist: ['красота', 'гармония', 'образ', 'творение']
                };
                
                const terms = typeSpecificTerms[this.currentType] || [];
                
                document.querySelectorAll('p, li, td').forEach(element => {
                    // Пропускаем элементы, уже обработанные системой подсказок
                    if (element.querySelector('.term-highlight') || 
                        element.querySelector('.visitor-emphasis')) return;
                    
                    let html = element.innerHTML;
                    let modified = false;
                    
                    terms.forEach(term => {
                        // Экранируем специальные символы
                        const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const regex = new RegExp(`(${escapedTerm})`, 'gi');
                        
                        html = html.replace(regex, (match) => {
                            modified = true;
                            return `<span class="visitor-emphasis glow-text">${match}</span>`;
                        });
                    });
                    
                    if (modified) {
                        element.innerHTML = html;
                    }
                });
            }
        };

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            visitorProfile.init();
        });

        // Система контекстных подсказок
        const tooltipSystem = {
            terms: {
                // Психоаналитические термины
                'океаническое чувство': {
                    title: 'Океаническое чувство',
                    content: 'Термин Фрейда, описывающий чувство безграничности и единства с миром, характерное для младенческого состояния до формирования Эго.',
                    category: 'Психоанализ'
                },
                'первичный нарциссизм': {
                    title: 'Первичный нарциссизм',
                    content: 'Состояние младенца, когда либидо полностью направлено на себя, предшествующее способности различать себя и внешний мир.',
                    category: 'Психоанализ'
                },
                'эдипов комплекс': {
                    title: 'Эдипов комплекс',
                    content: 'Центральный комплекс в психоанализе, описывающий бессознательное желание ребёнка к родителю противоположного пола и соперничество с родителем того же пола.',
                    category: 'Психоанализ'
                },
                'индивидуация': {
                    title: 'Индивидуация',
                    content: 'Процесс психологического развития по Юнгу, в ходе которого человек интегрирует различные аспекты психики и становится целостной личностью.',
                    category: 'Аналитическая психология'
                },
                'кастрационная тревога': {
                    title: 'Кастрационная тревога',
                    content: 'Бессознательный страх утраты фаллической силы, играющий ключевую роль в формировании Супер-Эго.',
                    category: 'Психоанализ'
                },
                // Космологические термины
                'планковская эпоха': {
                    title: 'Планковская эпоха',
                    content: 'Первые 10⁻⁴³ секунды после Большого взрыва, когда квантовые эффекты гравитации доминировали, и классическая физика не применима.',
                    category: 'Космология'
                },
                'нуклеосинтез': {
                    title: 'Нуклеосинтез',
                    content: 'Процесс образования атомных ядер из протонов и нейтронов в первые минуты после Большого взрыва и в недрах звёзд.',
                    category: 'Космология'
                },
                'энтропия': {
                    title: 'Энтропия',
                    content: 'Мера беспорядка в системе. Второй закон термодинамики утверждает, что энтропия замкнутой системы всегда возрастает.',
                    category: 'Физика'
                },
                // Библейские термины
                'техом': {
                    title: 'Техом (תְּהוֹם)',
                    content: 'Древнееврейское слово, обозначающее первичные воды хаоса, бездну, существовавшую до творения.',
                    category: 'Библеистика'
                },
                'кенозис': {
                    title: 'Кенозис',
                    content: 'Самоопустошение Христа, добровольный отказ от божественных атрибутов ради воплощения и спасения человечества.',
                    category: 'Христология'
                },
                'меркава': {
                    title: 'Меркава',
                    content: 'Божественная колесница из видения пророка Иезекииля, ставшая основой еврейской мистической традиции.',
                    category: 'Мистика'
                }
            },
            
            init() {
                this.setupTooltips();
                this.highlightTerms();
            },
            
            highlightTerms() {
                const contentElements = document.querySelectorAll('p, td, li');
                
                contentElements.forEach(element => {
                    // Пропускаем элементы, уже содержащие подсветку
                    if (element.querySelector('.term-highlight')) return;
                    
                    let html = element.innerHTML;
                    let modified = false;
                    
                    Object.keys(this.terms).forEach(term => {
                        // Экранируем специальные символы
                        const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        // Простое регулярное выражение без границ слов
                        const regex = new RegExp(`(${escapedTerm})`, 'gi');
                        
                        html = html.replace(regex, (match) => {
                            modified = true;
                            return `<span class="term-highlight" data-term="${term.toLowerCase()}">${match}</span>`;
                        });
                    });
                    
                    if (modified) {
                        element.innerHTML = html;
                    }
                });
            },
            
            setupTooltips() {
                const tooltip = document.getElementById('contextTooltip');
                const closeBtn = tooltip.querySelector('.tooltip-close');
                
                closeBtn.addEventListener('click', () => this.hideTooltip());
                
                // Делегирование событий для динамических элементов
                document.addEventListener('mouseover', (e) => {
                    if (e.target.classList.contains('term-highlight')) {
                        this.showTooltip(e.target);
                    }
                });
                
                document.addEventListener('mouseout', (e) => {
                    if (e.target.classList.contains('term-highlight')) {
                        this.hideTooltip();
                    }
                });
            },
            
            showTooltip(element) {
                const term = element.dataset.term;
                const termData = this.terms[term];
                
                if (!termData) return;
                
                const tooltip = document.getElementById('contextTooltip');
                const rect = element.getBoundingClientRect();
                
                // Заполнение содержимого
                tooltip.querySelector('.tooltip-title').textContent = termData.title;
                tooltip.querySelector('.tooltip-content').innerHTML = termData.content;
                tooltip.querySelector('.tooltip-category').textContent = termData.category;
                
                // Позиционирование
                let top = rect.bottom + 10;
                let left = rect.left + rect.width / 2 - 200; // Центрирование
                
                // Проверка границ экрана
                if (left < 10) left = 10;
                if (left + 400 > window.innerWidth) left = window.innerWidth - 410;
                if (top + 200 > window.innerHeight) top = rect.top - 210;
                
                tooltip.style.top = `${top}px`;
                tooltip.style.left = `${left}px`;
                tooltip.classList.add('active');
            },
            
            hideTooltip() {
                document.getElementById('contextTooltip').classList.remove('active');
            }
        };

        // Система генерации персональной мандалы
        const mandalaSystem = {
            canvas: null,
            ctx: null,
            visitData: {
                zones: {},
                paths: [],
                interactions: [],
                timeDistribution: {}
            },
            
            init() {
                this.canvas = document.getElementById('personalMandala');
                this.ctx = this.canvas.getContext('2d');
                this.trackUserJourney();
            },
            
            trackUserJourney() {
                // Отслеживание времени в каждой зоне
                let currentZone = null;
                let zoneStartTime = null;
                
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            if (currentZone) {
                                const timeSpent = Date.now() - zoneStartTime;
                                if (!this.visitData.zones[currentZone]) {
                                    this.visitData.zones[currentZone] = 0;
                                }
                                this.visitData.zones[currentZone] += timeSpent;
                            }
                            
                            currentZone = entry.target.id;
                            zoneStartTime = Date.now();
                            this.visitData.paths.push(currentZone);
                        }
                    });
                }, { threshold: 0.5 });
                
                document.querySelectorAll('.section-detailed').forEach(section => {
                    observer.observe(section);
                });
                
                // Отслеживание кликов
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.interactive-element, .transition-node, .map-section')) {
                        this.visitData.interactions.push({
                            element: e.target.textContent.slice(0, 30),
                            timestamp: Date.now()
                        });
                    }
                });
            },
            
            showMandala() {
                const overlay = document.getElementById('mandalaGenerator');
                overlay.classList.add('active');
                
                // Показать загрузку
                document.querySelector('.mandala-loading').classList.add('active');
                
                // Генерация мандалы с задержкой для эффекта
                setTimeout(() => {
                    this.generateMandala();
                    document.querySelector('.mandala-loading').classList.remove('active');
                }, 1500);
            },
            
            closeMandala() {
                document.getElementById('mandalaGenerator').classList.remove('active');
            },
            
            generateMandala() {
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                const maxRadius = Math.min(centerX, centerY) - 20;
                
                // Очистка холста
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Фоновый градиент
                const gradient = this.ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, maxRadius);
                gradient.addColorStop(0, 'rgba(255, 215, 0, 0.1)');
                gradient.addColorStop(0.5, 'rgba(255, 215, 0, 0.05)');
                gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
                
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Генерация слоёв мандалы на основе данных посещения
                this.drawCenterCore(centerX, centerY);
                this.drawZoneRings(centerX, centerY, maxRadius);
                this.drawPathConnections(centerX, centerY, maxRadius);
                this.drawInteractionPoints(centerX, centerY, maxRadius);
                this.drawPersonalSymbols(centerX, centerY, maxRadius);
                
                // Обновление интерпретации
                this.updateInterpretation();
            },
            
            drawCenterCore(cx, cy) {
                // Центральное ядро - тип посетителя
                const visitorType = visitorProfile.currentType || 'pilgrim';
                const typeData = visitorProfile.types[visitorType];
                
                // Золотое ядро
                this.ctx.beginPath();
                this.ctx.arc(cx, cy, 30, 0, Math.PI * 2);
                this.ctx.fillStyle = '#ffd700';
                this.ctx.fill();
                
                // Символ типа
                this.ctx.font = '24px Georgia';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillStyle = '#1a1a2e';
                this.ctx.fillText(typeData.icon, cx, cy);
            },
            
            drawZoneRings(cx, cy, maxRadius) {
                const zones = Object.keys(this.visitData.zones);
                const totalTime = Object.values(this.visitData.zones).reduce((a, b) => a + b, 1);
                
                let currentRadius = 50;
                const radiusStep = (maxRadius - 50) / Math.max(zones.length, 1);
                
                zones.forEach((zone, index) => {
                    const timeRatio = this.visitData.zones[zone] / totalTime;
                    const opacity = 0.3 + timeRatio * 0.7;
                    
                    // Кольцо зоны
                    this.ctx.beginPath();
                    this.ctx.arc(cx, cy, currentRadius, 0, Math.PI * 2);
                    this.ctx.strokeStyle = `rgba(255, 215, 0, ${opacity})`;
                    this.ctx.lineWidth = 10 + timeRatio * 20;
                    this.ctx.stroke();
                    
                    // Декоративные элементы
                    const segments = 8 + index * 4;
                    for (let i = 0; i < segments; i++) {
                        const angle = (Math.PI * 2 / segments) * i;
                        const x = cx + Math.cos(angle) * currentRadius;
                        const y = cy + Math.sin(angle) * currentRadius;
                        
                        this.ctx.beginPath();
                        this.ctx.arc(x, y, 3 + timeRatio * 5, 0, Math.PI * 2);
                        this.ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
                        this.ctx.fill();
                    }
                    
                    currentRadius += radiusStep;
                });
            },
            
            drawPathConnections(cx, cy, maxRadius) {
                // Спиральные пути между зонами
                const paths = this.visitData.paths.slice(-10); // Последние 10 переходов
                
                paths.forEach((path, index) => {
                    const angle = (index / paths.length) * Math.PI * 2;
                    const innerRadius = 60 + index * 15;
                    const outerRadius = innerRadius + 30;
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(
                        cx + Math.cos(angle) * innerRadius,
                        cy + Math.sin(angle) * innerRadius
                    );
                    
                    // Спиральная линия
                    for (let t = 0; t <= 1; t += 0.1) {
                        const r = innerRadius + (outerRadius - innerRadius) * t;
                        const a = angle + t * Math.PI / 4;
                        this.ctx.lineTo(
                            cx + Math.cos(a) * r,
                            cy + Math.sin(a) * r
                        );
                    }
                    
                    this.ctx.strokeStyle = `rgba(255, 215, 0, ${0.3 + index * 0.05})`;
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                });
            },
            
            drawInteractionPoints(cx, cy, maxRadius) {
                // Точки взаимодействия как звёзды
                const interactions = this.visitData.interactions.slice(-20);
                
                interactions.forEach((interaction, index) => {
                    const angle = Math.random() * Math.PI * 2;
                    const radius = 80 + Math.random() * (maxRadius - 100);
                    const x = cx + Math.cos(angle) * radius;
                    const y = cy + Math.sin(angle) * radius;
                    
                    // Звезда
                    this.drawStar(x, y, 5, 3, 5);
                });
            },
            
            drawStar(cx, cy, spikes, outerRadius, innerRadius) {
                let rot = Math.PI / 2 * 3;
                let x = cx;
                let y = cy;
                const step = Math.PI / spikes;
                
                this.ctx.beginPath();
                this.ctx.moveTo(cx, cy - outerRadius);
                
                for (let i = 0; i < spikes; i++) {
                    x = cx + Math.cos(rot) * outerRadius;
                    y = cy + Math.sin(rot) * outerRadius;
                    this.ctx.lineTo(x, y);
                    rot += step;
                    
                    x = cx + Math.cos(rot) * innerRadius;
                    y = cy + Math.sin(rot) * innerRadius;
                    this.ctx.lineTo(x, y);
                    rot += step;
                }
                
                this.ctx.lineTo(cx, cy - outerRadius);
                this.ctx.closePath();
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                this.ctx.fill();
            },
            
            drawPersonalSymbols(cx, cy, maxRadius) {
                // Персональные символы на основе профиля
                const visitorType = visitorProfile.currentType || 'pilgrim';
                const symbols = {
                    pilgrim: ['✦', '◉', '☥', '✡'],
                    scholar: ['◈', '⬡', '◊', '▣'],
                    mystic: ['☽', '☆', '◯', '◈'],
                    artist: ['❋', '✿', '◉', '✧']
                };
                
                const typeSymbols = symbols[visitorType];
                
                typeSymbols.forEach((symbol, index) => {
                    const angle = (Math.PI * 2 / typeSymbols.length) * index;
                    const x = cx + Math.cos(angle) * (maxRadius - 30);
                    const y = cy + Math.sin(angle) * (maxRadius - 30);
                    
                    this.ctx.font = '20px Georgia';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillStyle = 'rgba(255, 215, 0, 0.8)';
                    this.ctx.fillText(symbol, x, y);
                });
            },
            
            updateInterpretation() {
                const interpretationGrid = document.getElementById('mandalaInterpretation');
                interpretationGrid.innerHTML = '';
                
                const interpretations = [
                    {
                        color: '#ffd700',
                        symbol: '◉',
                        title: 'Центральное ядро',
                        description: 'Ваш выбранный путь и основная мотивация'
                    },
                    {
                        color: '#ffffff',
                        symbol: '○',
                        title: 'Кольца времени',
                        description: 'Глубина погружения в каждую зону сада'
                    },
                    {
                        color: '#ffd70080',
                        symbol: '〜',
                        title: 'Пути познания',
                        description: 'Ваши переходы между пространствами'
                    },
                    {
                        color: '#ffffff99',
                        symbol: '✦',
                        title: 'Точки озарения',
                        description: 'Моменты особого взаимодействия'
                    }
                ];
                
                interpretations.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'interpretation-item';
                    div.innerHTML = `
                        <div class="interpretation-symbol" style="background: ${item.color};">
                            ${item.symbol}
                        </div>
                        <div class="interpretation-text">
                            <h4>${item.title}</h4>
                            <p>${item.description}</p>
                        </div>
                    `;
                    interpretationGrid.appendChild(div);
                });
            },
            
            regenerateMandala() {
                // Добавляем случайные вариации
                this.visitData.interactions.push({
                    element: 'Regeneration',
                    timestamp: Date.now()
                });
                
                this.generateMandala();
            },
            
            downloadMandala() {
                const link = document.createElement('a');
                link.download = `mandala-${visitorProfile.currentType}-${Date.now()}.png`;
                link.href = this.canvas.toDataURL();
                link.click();
            }
        };
        
        // Инициализация новых систем
        document.addEventListener('DOMContentLoaded', () => {
            tooltipSystem.init();
            mandalaSystem.init();
        });

        // 3D визуализация сада
        const garden3D = {
            scene: null,
            camera: null,
            renderer: null,
            controls: null,
            objects: {},
            labels: [],
            flightMode: false,
            clock: null,
            mixer: null,
            
            init() {
                // Загрузка Three.js динамически
                if (typeof THREE === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
                    script.onload = () => {
                        this.setupScene();
                    };
                    document.head.appendChild(script);
                } else {
                    this.setupScene();
                }
            },
            
            open() {
                const overlay = document.getElementById('garden3D');
                overlay.classList.add('active');
                
                if (!this.renderer) {
                    this.init();
                } else {
                    this.onWindowResize();
                }
            },
            
            close() {
                document.getElementById('garden3D').classList.remove('active');
            },
            
            setupScene() {
                const container = document.getElementById('threejs-container');
                
                // Сцена
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.FogExp2(0x0a0a0f, 0.002);
                
                // Камера
                this.camera = new THREE.PerspectiveCamera(
                    75,
                    container.clientWidth / container.clientHeight,
                    0.1,
                    1000
                );
                this.camera.position.set(200, 150, 200);
                this.camera.far = 2000;
                this.camera.lookAt(0, 0, 0);
                
                // Рендерер
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(container.clientWidth, container.clientHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                container.appendChild(this.renderer.domElement);
                
                // Освещение
                this.setupLighting();
                
                // Создание структур сада
                this.createGardenStructures();
                
                // Контролы (упрощённая версия OrbitControls)
                this.setupControls();
                
                // Звёздное небо
                this.createStarfield();
                
                // Анимация
                this.clock = new THREE.Clock();
                this.animate();
                
                // Обработчик изменения размера
                window.addEventListener('resize', () => this.onWindowResize());
            },
            
            setupLighting() {
                // Амбиентное освещение
                const ambientLight = new THREE.AmbientLight(0x404040, 0.3);
                this.scene.add(ambientLight);
                
                // Основное солнце/луна
                this.sunLight = new THREE.DirectionalLight(0xffd700, 0.8);
                this.sunLight.position.set(100, 200, 100);
                this.sunLight.castShadow = true;
                this.sunLight.shadow.camera.left = -200;
                this.sunLight.shadow.camera.right = 200;
                this.sunLight.shadow.camera.top = 200;
                this.sunLight.shadow.camera.bottom = -200;
                this.sunLight.shadow.camera.near = 0.1;
                this.sunLight.shadow.camera.far = 500;
                this.sunLight.shadow.mapSize.width = 2048;
                this.sunLight.shadow.mapSize.height = 2048;
                this.scene.add(this.sunLight);
                
                // Точечный свет в центре
                const centerLight = new THREE.PointLight(0xffd700, 1, 100);
                centerLight.position.set(0, 50, 0);
                centerLight.castShadow = true;
                this.scene.add(centerLight);
                
                // Прожекторы для каждой основной структуры
                const spotLights = [
                    { pos: [0, 100, 0], target: [0, 0, 0], color: 0xffd700 },     // Центр
                    { pos: [100, 80, 0], target: [100, 0, 0], color: 0xff6b6b }, // Террасы
                    { pos: [-100, 80, 0], target: [-100, 0, 0], color: 0x4ecdc4 }, // Лабиринт
                    { pos: [0, 80, -100], target: [0, 0, -100], color: 0x9932cc } // Врата
                ];
                
                spotLights.forEach(config => {
                    const spotLight = new THREE.SpotLight(config.color, 0.5, 200, Math.PI / 6, 0.5);
                    spotLight.position.set(...config.pos);
                    spotLight.target.position.set(...config.target);
                    spotLight.castShadow = true;
                    this.scene.add(spotLight);
                    this.scene.add(spotLight.target);
                });
                
                // Полусферический свет для неба
                const hemiLight = new THREE.HemisphereLight(0x0000ff, 0x00ff00, 0.2);
                this.scene.add(hemiLight);
            },
            
            createGardenStructures() {
                // Основание
                const groundGeometry = new THREE.CircleGeometry(300, 128);
                const groundMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x1a1a2e,
                    roughness: 0.8,
                    metalness: 0.2
                });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.receiveShadow = true;
                this.scene.add(ground);
                
                // Центральная ось
                this.createCentralAxis();
                
                // Круг Бытия
                this.createGenesisCircles();
                
                // Террасы Завета
                this.createCovenantTerraces();
                
                // Лабиринт Воплощения
                this.createIncarnationLabyrinth();
                
                // Врата Откровения
                this.createApocalypseGates();
            },
            
            createCentralAxis() {
                const group = new THREE.Group();
                
                // Параметры двойной спирали
                const height = 33;
                const baseRadius = 5;
                const topRadius = 3;
                const spiralSegments = 200;
                
                // Создание двойной спирали ДНК
                const spiral1Points = [];
                const spiral2Points = [];
                
                for (let i = 0; i <= spiralSegments; i++) {
                    const t = i / spiralSegments;
                    const y = t * height;
                    const angle = t * Math.PI * 8; // 4 полных оборота
                    const radius = baseRadius - (baseRadius - topRadius) * t;
                    
                    // Первая спираль
                    spiral1Points.push(new THREE.Vector3(
                        Math.cos(angle) * radius,
                        y,
                        Math.sin(angle) * radius
                    ));
                    
                    // Вторая спираль (сдвинута на 180°)
                    spiral2Points.push(new THREE.Vector3(
                        Math.cos(angle + Math.PI) * radius,
                        y,
                        Math.sin(angle + Math.PI) * radius
                    ));
                }
                
                // Создание геометрии спиралей
                const spiral1Curve = new THREE.CatmullRomCurve3(spiral1Points);
                const spiral2Curve = new THREE.CatmullRomCurve3(spiral2Points);
                
                const tubeGeometry1 = new THREE.TubeGeometry(spiral1Curve, 200, 0.3, 8, false);
                const tubeGeometry2 = new THREE.TubeGeometry(spiral2Curve, 200, 0.3, 8, false);
                
                // Материалы - чередование обсидиана и кварца
                const obsidianMaterial = new THREE.MeshStandardMaterial({
                    color: 0x0a0a0a,
                    metalness: 0.9,
                    roughness: 0.1,
                    emissive: 0x220022,
                    emissiveIntensity: 0.1
                });
                
                const quartzMaterial = new THREE.MeshStandardMaterial({
                    color: 0xffffff,
                    metalness: 0.3,
                    roughness: 0.2,
                    transparent: true,
                    opacity: 0.8,
                    emissive: 0xffd700,
                    emissiveIntensity: 0.1
                });
                
                const spiral1 = new THREE.Mesh(tubeGeometry1, obsidianMaterial);
                const spiral2 = new THREE.Mesh(tubeGeometry2, quartzMaterial);
                
                group.add(spiral1);
                group.add(spiral2);
                
                // Соединительные мосты между спиралями (как в ДНК)
                for (let i = 0; i < 33; i++) {
                    const t = i / 33;
                    const angle = t * Math.PI * 8;
                    const y = t * height;
                    const radius = baseRadius - (baseRadius - topRadius) * t;
                    
                    const bridgeGeometry = new THREE.CylinderGeometry(0.1, 0.1, radius * 2);
                    const bridgeMaterial = new THREE.MeshStandardMaterial({
                        color: 0xffd700,
                        emissive: 0xffd700,
                        emissiveIntensity: 0.3
                    });
                    
                    const bridge = new THREE.Mesh(bridgeGeometry, bridgeMaterial);
                    bridge.position.y = y;
                    bridge.rotation.z = Math.PI / 2;
                    bridge.rotation.y = angle;
                    
                    group.add(bridge);
                }
                
                // Голографические уровни внутри
                const levels = [
                    { height: 2, color: 0x0000ff, name: 'Квантовые флуктуации' },
                    { height: 5, color: 0x00ff00, name: 'Первые атомы' },
                    { height: 11, color: 0xffff00, name: 'Зарождение жизни' },
                    { height: 20, color: 0xff00ff, name: 'Эволюция сознания' },
                    { height: 29, color: 0xffffff, name: 'Трансцендентное единство' }
                ];
                
                levels.forEach(level => {
                    const hologramGeometry = new THREE.RingGeometry(0.5, 4, 32);
                    const hologramMaterial = new THREE.MeshBasicMaterial({
                        color: level.color,
                        transparent: true,
                        opacity: 0.3,
                        side: THREE.DoubleSide
                    });
                    
                    const hologram = new THREE.Mesh(hologramGeometry, hologramMaterial);
                    hologram.position.y = level.height;
                    hologram.rotation.x = -Math.PI / 2;
                    
                    // Анимация вращения для голограмм
                    hologram.userData.rotationSpeed = 0.01 + Math.random() * 0.02;
                    group.add(hologram);
                });
                
                // Купол единства на вершине
                const domeGeometry = new THREE.SphereGeometry(5, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2);
                const domeMaterial = new THREE.MeshStandardMaterial({
                    color: 0xffd700,
                    metalness: 0.8,
                    roughness: 0.2,
                    emissive: 0xffd700,
                    emissiveIntensity: 0.5
                });
                
                const dome = new THREE.Mesh(domeGeometry, domeMaterial);
                dome.position.y = height;
                group.add(dome);
                
                group.userData = { 
                    name: 'Центральная ось',
                    description: 'Вертикаль бытия - 33 метра космической эволюции'
                };
                
                this.objects.centralAxis = group;
                this.scene.add(group);
            },
            
            createGenesisCircles() {
                const group = new THREE.Group();
                
                // Параметры террас согласно описанию
                const terraces = [
                    { radius: 72, width: 10, height: 0.5, color: 0x000000, material: 'obsidian' },
                    { radius: 62, width: 9, height: 1, color: 0x0080ff, material: 'lazurite' },
                    { radius: 53, width: 8, height: 1.5, color: 0x8b4513, material: 'terracotta' },
                    { radius: 45, width: 7, height: 2, color: 0xffd700, material: 'copper' },
                    { radius: 38, width: 6, height: 2.5, color: 0xf0e68c, material: 'coral' },
                    { radius: 32, width: 5, height: 3, color: 0xffc0cb, material: 'granite' },
                    { radius: 27, width: 4, height: 3.5, color: 0xffffff, material: 'onyx' }
                ];
                
                terraces.forEach((terrace, index) => {
                    // Основная геометрия террасы
                    const geometry = new THREE.RingGeometry(
                        terrace.radius - terrace.width,
                        terrace.radius,
                        64,
                        8
                    );
                    
                    // Материалы с уникальными свойствами
                    let material;
                    switch(terrace.material) {
                        case 'obsidian':
                            material = new THREE.MeshStandardMaterial({
                                color: terrace.color,
                                metalness: 0.9,
                                roughness: 0.1
                            });
                            break;
                        case 'onyx':
                            material = new THREE.MeshStandardMaterial({
                                color: terrace.color,
                                metalness: 0.3,
                                roughness: 0.2,
                                transparent: true,
                                opacity: 0.8
                            });
                            break;
                        default:
                            material = new THREE.MeshStandardMaterial({
                                color: terrace.color,
                                metalness: 0.2,
                                roughness: 0.7
                            });
                    }
                    
                    const ring = new THREE.Mesh(geometry, material);
                    ring.rotation.x = -Math.PI / 2;
                    ring.position.y = terrace.height;
                    ring.receiveShadow = true;
                    group.add(ring);
                    
                    // Добавляем элементы для каждой террасы
                    if (index === 0) {
                        // Фотонный фонтан на первой террасе
                        const fountainGeometry = new THREE.ConeGeometry(2, 5, 32);
                        const fountainMaterial = new THREE.MeshBasicMaterial({
                            color: 0xffffff,
                            transparent: true,
                            opacity: 0.6
                        });
                        const fountain = new THREE.Mesh(fountainGeometry, fountainMaterial);
                        fountain.position.set(terrace.radius - terrace.width/2, terrace.height + 2.5, 0);
                        group.add(fountain);
                    }
                    
                    if (index === 2) {
                        // Деревья на третьей террасе
                        for (let i = 0; i < 8; i++) {
                            const angle = (i / 8) * Math.PI * 2;
                            const treeRadius = terrace.radius - terrace.width/2;
                            
                            const treeGeometry = new THREE.ConeGeometry(1, 4, 8);
                            const treeMaterial = new THREE.MeshStandardMaterial({ color: 0x228b22 });
                            const tree = new THREE.Mesh(treeGeometry, treeMaterial);
                            
                            tree.position.x = Math.cos(angle) * treeRadius;
                            tree.position.z = Math.sin(angle) * treeRadius;
                            tree.position.y = terrace.height + 2;
                            
                            group.add(tree);
                        }
                    }
                });
                
                // 49 радиальных путей (7 путей × 7 террас)
                const pathMaterial = new THREE.MeshStandardMaterial({
                    color: 0xd4af37,
                    metalness: 0.6,
                    roughness: 0.4
                });
                
                // Создаем пути между каждой парой соседних террас
                for (let terraceIndex = 0; terraceIndex < 6; terraceIndex++) {
                    const innerTerrace = terraces[terraceIndex + 1];
                    const outerTerrace = terraces[terraceIndex];
                    
                    // Смещение для каждого уровня террас (чтобы пути не совпадали)
                    const angleOffset = (terraceIndex * Math.PI / 7);
                    
                    for (let pathIndex = 0; pathIndex < 7; pathIndex++) {
                        // Угол для текущего пути с учетом смещения
                        const angle = (pathIndex / 7) * Math.PI * 2 + angleOffset;
                        
                        // Начальная и конечная точки пути
                        const innerRadius = innerTerrace.radius - innerTerrace.width / 2;
                        const outerRadius = outerTerrace.radius - outerTerrace.width / 2;
                        
                        // Длина пути
                        const pathLength = outerRadius - innerRadius;
                        
                        // Создаем путь
                        const pathGeometry = new THREE.BoxGeometry(0.5, 0.1, pathLength);
                        const path = new THREE.Mesh(pathGeometry, pathMaterial);
                        
                        // Позиционируем путь
                        const centerRadius = (innerRadius + outerRadius) / 2;
                        path.position.x = Math.cos(angle) * centerRadius;
                        path.position.z = Math.sin(angle) * centerRadius;
                        path.position.y = (innerTerrace.height + outerTerrace.height) / 2;
                        
                        // Поворачиваем путь так, чтобы он был направлен радиально
                        path.rotation.y = angle;
                        
                        group.add(path);
                    }
                }
                
                // Добавляем 7 путей от центра к самой внутренней террасе
                const centralPaths = 7;
                const firstTerrace = terraces[6]; // Самая внутренняя терраса
                
                for (let i = 0; i < centralPaths; i++) {
                    const angle = (i / centralPaths) * Math.PI * 2;
                    const innerRadius = 0;
                    const outerRadius = firstTerrace.radius - firstTerrace.width / 2;
                    const pathLength = outerRadius;
                    
                    const pathGeometry = new THREE.BoxGeometry(0.5, 0.1, pathLength);
                    const path = new THREE.Mesh(pathGeometry, pathMaterial);
                    
                    path.position.x = Math.cos(angle) * (pathLength / 2);
                    path.position.z = Math.sin(angle) * (pathLength / 2);
                    path.position.y = firstTerrace.height / 2;
                    path.rotation.y = angle;
                    
                    group.add(path);
                }                
                group.userData = {
                    name: 'Круг Бытия',
                    description: 'Семь дней творения в концентрических террасах'
                };
                
                this.objects.genesisCircles = group;
                this.scene.add(group);
            },
            
            createCovenantTerraces() {
                const group = new THREE.Group();
                group.position.set(100, 0, 0);
                
                // 10 террас по 4 метра каждая
                const terraceElements = [
                    { symbol: '✡', color: 0x000000 }, // Врата признания
                    { symbol: '🗿', color: 0x4a4a4a }, // Разбитые идолы
                    { symbol: '🤫', color: 0x333333 }, // Молчание
                    { symbol: '⏰', color: 0x8b7355 }, // Время
                    { symbol: '👥', color: 0xdaa520 }, // Предки
                    { symbol: '🔥', color: 0xff4500 }, // Жизнь
                    { symbol: '💑', color: 0xff69b4 }, // Верность
                    { symbol: '🏛️', color: 0xc0c0c0 }, // Собственность
                    { symbol: '⚖️', color: 0xffd700 }, // Истина
                    { symbol: '🕊️', color: 0xffffff }  // Принятие
                ];
                
                terraceElements.forEach((element, index) => {
                    const size = 40 - index * 3;
                    const height = index * 4;
                    
                    // Основание террасы
                    const geometry = new THREE.BoxGeometry(size, 0.5, size);
                    const material = new THREE.MeshStandardMaterial({
                        color: element.color,
                        metalness: 0.2,
                        roughness: 0.8
                    });
                    
                    const terrace = new THREE.Mesh(geometry, material);
                    terrace.position.y = height;
                    terrace.castShadow = true;
                    terrace.receiveShadow = true;
                    group.add(terrace);
                    
                    // Стены террасы
                    const wallHeight = 3.5;
                    const wallThickness = 0.5;
                    
                    // Четыре стены
                    const wallPositions = [
                        { x: 0, z: size/2 - wallThickness/2, rotY: 0 },
                        { x: 0, z: -size/2 + wallThickness/2, rotY: 0 },
                        { x: size/2 - wallThickness/2, z: 0, rotY: Math.PI/2 },
                        { x: -size/2 + wallThickness/2, z: 0, rotY: Math.PI/2 }
                    ];
                    
                    wallPositions.forEach(pos => {
                        const wallGeometry = new THREE.BoxGeometry(
                            pos.rotY === 0 ? size : wallThickness,
                            wallHeight,
                            pos.rotY === 0 ? wallThickness : size
                        );
                        const wall = new THREE.Mesh(wallGeometry, material);
                        wall.position.set(pos.x, height + wallHeight/2, pos.z);
                        wall.castShadow = true;
                        group.add(wall);
                    });
                    
                    // Скрижали на вершине
                    if (index === 9) {
                        const tabletGeometry = new THREE.BoxGeometry(5, 8, 1);
                        const tabletMaterial = new THREE.MeshStandardMaterial({
                            color: 0x4169e1,
                            emissive: 0x4169e1,
                            emissiveIntensity: 0.3,
                            transparent: true,
                            opacity: 0.8
                        });
                        
                        const tablet1 = new THREE.Mesh(tabletGeometry, tabletMaterial);
                        tablet1.position.set(-3, height + 5, 0);
                        tablet1.rotation.y = -0.2;
                        
                        const tablet2 = new THREE.Mesh(tabletGeometry, tabletMaterial);
                        tablet2.position.set(3, height + 5, 0);
                        tablet2.rotation.y = 0.2;
                        
                        group.add(tablet1, tablet2);
                    }
                });
                
                // Три пути восхождения
                const pathTypes = [
                    { name: 'Закон', offset: 0, color: 0xff0000 },
                    { name: 'Милосердие', offset: 120, color: 0x00ff00 },
                    { name: 'Мудрость', offset: 240, color: 0x0000ff }
                ];
                
                pathTypes.forEach(pathType => {
                    const pathGroup = new THREE.Group();
                    const angleRad = (pathType.offset * Math.PI) / 180;
                    
                    for (let i = 0; i < 10; i++) {
                        const stairGeometry = new THREE.BoxGeometry(2, 0.4, 4);
                        const stairMaterial = new THREE.MeshStandardMaterial({
                            color: pathType.color,
                            metalness: 0.3,
                            roughness: 0.7
                        });
                        
                        const stair = new THREE.Mesh(stairGeometry, stairMaterial);
                        const radius = 25 - i * 1.5;
                        stair.position.x = Math.cos(angleRad) * radius;
                        stair.position.z = Math.sin(angleRad) * radius;
                        stair.position.y = i * 4 - 0.2;
                        stair.rotation.y = angleRad;
                        
                        pathGroup.add(stair);
                    }
                    
                    group.add(pathGroup);
                });
                
                group.userData = {
                    name: 'Террасы Завета',
                    description: 'Десять заповедей, восходящих к небу'
                };
                
                this.objects.covenantTerraces = group;
                this.scene.add(group);
            },
            
            createIncarnationLabyrinth() {
                const group = new THREE.Group();
                group.position.set(-100, 0, 0);
                
                // Параметры двойной спирали ДНК с крестом
                const stations = 33;
                const totalLength = 3300; // метры пути
                const maxRadius = 50;
                
                // Создание пути лабиринта
                const pathPoints = [];
                
                for (let i = 0; i <= stations; i++) {
                    const t = i / stations;
                    const angle = t * Math.PI * 12; // 6 полных оборотов
                    const radius = 10 + t * (maxRadius - 10);
                    
                    // Форма креста в плане
                    const crossModulation = Math.abs(Math.sin(angle * 2)) * 0.3 + 0.7;
                    
                    pathPoints.push(new THREE.Vector3(
                        Math.cos(angle) * radius * crossModulation,
                        0,
                        Math.sin(angle) * radius * crossModulation
                    ));
                }
                
                // Стены лабиринта с изменяющейся высотой
                const wallMaterial = new THREE.MeshStandardMaterial({
                    color: 0x4a4a4a,
                    metalness: 0.7,
                    roughness: 0.3,
                    emissive: 0x0000ff,
                    emissiveIntensity: 0.1
                });
                
                pathPoints.forEach((point, index) => {
                    if (index < pathPoints.length - 1) {
                        const nextPoint = pathPoints[index + 1];
                        const direction = new THREE.Vector3().subVectors(nextPoint, point).normalize();
                        const perpendicular = new THREE.Vector3(-direction.z, 0, direction.x);
                        
                        // Высота стен меняется от 2 до 7 метров
                        const wallHeight = 2 + Math.sin(index / stations * Math.PI) * 5;
                        
                        // Левая стена
                        const leftWallGeometry = new THREE.BoxGeometry(
                            point.distanceTo(nextPoint),
                            wallHeight,
                            0.5
                        );
                        const leftWall = new THREE.Mesh(leftWallGeometry, wallMaterial);
                        
                        const leftPosition = point.clone().add(perpendicular.clone().multiplyScalar(3));
                        leftWall.position.copy(leftPosition);
                        leftWall.position.y = wallHeight / 2;
                        leftWall.lookAt(nextPoint.clone().add(perpendicular.clone().multiplyScalar(3)));
                        
                        // Правая стена
                        const rightWall = leftWall.clone();
                        const rightPosition = point.clone().add(perpendicular.clone().multiplyScalar(-3));
                        rightWall.position.copy(rightPosition);
                        rightWall.position.y = wallHeight / 2;
                        rightWall.lookAt(nextPoint.clone().add(perpendicular.clone().multiplyScalar(-3)));
                        
                        group.add(leftWall, rightWall);
                        
                        // Оптоволокно (звёзды) в стенах
                        if (index % 3 === 0) {
                            const starsGeometry = new THREE.BufferGeometry();
                            const starsVertices = [];
                            
                            for (let s = 0; s < 20; s++) {
                                starsVertices.push(
                                    leftPosition.x + (Math.random() - 0.5) * 2,
                                    Math.random() * wallHeight,
                                    leftPosition.z + (Math.random() - 0.5) * 2
                                );
                            }
                            
                            starsGeometry.setAttribute('position', 
                                new THREE.Float32BufferAttribute(starsVertices, 3)
                            );
                            
                            const starsMaterial = new THREE.PointsMaterial({
                                color: 0xffffff,
                                size: 0.1,
                                emissive: 0xffffff,
                                emissiveIntensity: 1
                            });
                            
                            const stars = new THREE.Points(starsGeometry, starsMaterial);
                            group.add(stars);
                        }
                    }
                    
                    // Станции созерцания
                    if (index > 0 && index < stations && index % 3 === 0) {
                        const stationGeometry = new THREE.CylinderGeometry(2, 2, 0.5, 32);
                        const stationMaterial = new THREE.MeshStandardMaterial({
                            color: 0xffd700,
                            metalness: 0.8,
                            roughness: 0.2,
                            emissive: 0xffd700,
                            emissiveIntensity: 0.3
                        });
                        
                        const station = new THREE.Mesh(stationGeometry, stationMaterial);
                        station.position.copy(point);
                        station.position.y = 0.25;
                        
                        // Номер станции
                        const stationNumber = Math.floor(index / 3);
                        station.userData = { stationNumber: stationNumber };
                        
                        group.add(station);
                    }
                });
                
                // Особые точки лабиринта
                // Станция 28: Распятие - чёрная дыра света
                const blackHoleGeometry = new THREE.SphereGeometry(3, 32, 32);
                const blackHoleMaterial = new THREE.MeshBasicMaterial({
                    color: 0x000000,
                    transparent: true,
                    opacity: 0.9
                });
                const blackHole = new THREE.Mesh(blackHoleGeometry, blackHoleMaterial);
                blackHole.position.copy(pathPoints[28]);
                blackHole.position.y = 3;
                group.add(blackHole);
                
                // Станция 31: Воскресение - взрыв света
                const resurrectionGeometry = new THREE.SphereGeometry(5, 32, 32);
                const resurrectionMaterial = new THREE.MeshBasicMaterial({
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.7,
                    emissive: 0xffffff,
                    emissiveIntensity: 1
                });
                const resurrection = new THREE.Mesh(resurrectionGeometry, resurrectionMaterial);
                resurrection.position.copy(pathPoints[31]);
                resurrection.position.y = 5;
                group.add(resurrection);
                
                group.userData = {
                    name: 'Лабиринт Воплощения',
                    description: '33 станции христологического пути'
                };
                
                this.objects.incarnationLabyrinth = group;
                this.scene.add(group);
            },
            
            createApocalypseGates() {
                const group = new THREE.Group();
                group.position.set(0, 0, -100);
                
                // Основная арка 21м высотой
                const archWidth = 12;
                const archHeight = 21;
                const pillarWidth = 4;
                
                // Материал с изменяющимся цветом
                const gateMaterial = new THREE.ShaderMaterial({
                    uniforms: {
                        time: { value: 0 },
                        color1: { value: new THREE.Color(0xffd700) },
                        color2: { value: new THREE.Color(0xff00ff) }
                    },
                    vertexShader: `
                        varying vec2 vUv;
                        void main() {
                            vUv = uv;
                            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                        }
                    `,
                    fragmentShader: `
                        uniform float time;
                        uniform vec3 color1;
                        uniform vec3 color2;
                        varying vec2 vUv;
                        void main() {
                            vec3 color = mix(color1, color2, sin(time + vUv.y * 10.0) * 0.5 + 0.5);
                            gl_FragColor = vec4(color, 1.0);
                        }
                    `
                });
                
                // Левый столб
                const leftPillarGeometry = new THREE.BoxGeometry(pillarWidth, archHeight, archWidth);
                const leftPillar = new THREE.Mesh(leftPillarGeometry, gateMaterial);
                leftPillar.position.set(-8, archHeight/2, 0);
                leftPillar.castShadow = true;
                
                // Правый столб
                const rightPillar = leftPillar.clone();
                rightPillar.position.set(8, archHeight/2, 0);
                
                // Верхняя балка
                const topBeamGeometry = new THREE.BoxGeometry(20, 4, archWidth);
                const topBeam = new THREE.Mesh(topBeamGeometry, gateMaterial);
                topBeam.position.set(0, archHeight - 2, 0);
                topBeam.castShadow = true;
                
                group.add(leftPillar, rightPillar, topBeam);
                
                // Фрактальные узоры на поверхности
                const fractalTexture = this.generateFractalTexture();
                const fractalMaterial = new THREE.MeshBasicMaterial({
                    map: fractalTexture,
                    transparent: true,
                    opacity: 0.5,
                    emissive: 0xffffff,
                    emissiveIntensity: 0.3
                });
                
                const fractalPlane = new THREE.Mesh(
                    new THREE.PlaneGeometry(16, archHeight - 4),
                    fractalMaterial
                );
                fractalPlane.position.set(0, archHeight/2, -archWidth/2 - 0.1);
                group.add(fractalPlane);
                
                // 12 врат-порталов вокруг основной структуры
                const portalRadius = 50;
                const portalNames = [
                    'Жемчужные', 'Сапфировые', 'Халцедоновые', 'Изумрудные',
                    'Сардониксовые', 'Сердоликовые', 'Хризолитовые', 'Вирилловые',
                    'Топазовые', 'Хрисопразовые', 'Гиацинтовые', 'Аметистовые'
                ];
                
                const portalColors = [
                    0xffffff, 0x0000ff, 0x87ceeb, 0x00ff00,
                    0xff6347, 0xff7f50, 0x9acd32, 0x40e0d0,
                    0xffd700, 0x32cd32, 0xff1493, 0x9932cc
                ];
                
                portalNames.forEach((name, index) => {
                    const angle = (index / 12) * Math.PI * 2;
                    const x = Math.cos(angle) * portalRadius;
                    const z = Math.sin(angle) * portalRadius;
                    
                    const portalGeometry = new THREE.TorusGeometry(3, 0.5, 8, 32);
                    const portalMaterial = new THREE.MeshStandardMaterial({
                        color: portalColors[index],
                        emissive: portalColors[index],
                        emissiveIntensity: 0.5,
                        metalness: 0.8,
                        roughness: 0.2
                    });
                    
                    const portal = new THREE.Mesh(portalGeometry, portalMaterial);
                    portal.position.set(x, 5, z);
                    portal.lookAt(0, 5, 0);
                    portal.userData = { name: name, scenario: `Сценарий ${index + 1}` };
                    
                    group.add(portal);
                    
                    // Энергетические линии от порталов к центру
                    const lineGeometry = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(x, 5, z),
                        new THREE.Vector3(0, archHeight, 0)
                    ]);
                    const lineMaterial = new THREE.LineBasicMaterial({
                        color: portalColors[index],
                        transparent: true,
                        opacity: 0.3
                    });
                    const line = new THREE.Line(lineGeometry, lineMaterial);
                    group.add(line);
                });
                
                // Сферический зал за вратами
                const hallGeometry = new THREE.SphereGeometry(72, 32, 32, 0, Math.PI);
                const hallMaterial = new THREE.MeshStandardMaterial({
                    color: 0x1a1a2e,
                    side: THREE.BackSide,
                    transparent: true,
                    opacity: 0.3
                });
                const hall = new THREE.Mesh(hallGeometry, hallMaterial);
                hall.position.set(0, 0, -80);
                hall.rotation.y = Math.PI / 2;
                group.add(hall);
                
                // Центральный куб в зале
                const cubeGeometry = new THREE.BoxGeometry(12, 12, 12);
                const cubeMaterial = new THREE.MeshStandardMaterial({
                    color: 0xffffff,
                    metalness: 0.9,
                    roughness: 0.1,
                    transparent: true,
                    opacity: 0.8,
                    emissive: 0xffffff,
                    emissiveIntensity: 0.3
                });
                const centralCube = new THREE.Mesh(cubeGeometry, cubeMaterial);
                centralCube.position.set(0, 12, -80);
                
                // Анимация вращения куба
                centralCube.userData.rotationSpeed = 0.005;
                group.add(centralCube);
                
                group.userData = {
                    name: 'Врата Откровения',
                    description: 'Портал в эсхатологическое будущее'
                };
                
                // Сохраняем ссылку на материал для анимации
                this.objects.gateMaterial = gateMaterial;
                this.objects.centralCube = centralCube;
                
                this.objects.apocalypseGates = group;
                this.scene.add(group);
            },
            
            generateFractalTexture() {
                const canvas = document.createElement('canvas');
                canvas.width = 512;
                canvas.height = 512;
                const ctx = canvas.getContext('2d');
                
                // Простая реализация фрактала
                const imageData = ctx.createImageData(512, 512);
                const data = imageData.data;
                
                for (let x = 0; x < 512; x++) {
                    for (let y = 0; y < 512; y++) {
                        let zx = (x - 256) / 128;
                        let zy = (y - 256) / 128;
                        let i = 0;
                        const maxIterations = 100;
                        
                        while (zx * zx + zy * zy < 4 && i < maxIterations) {
                            const tmp = zx * zx - zy * zy + zx;
                            zy = 2 * zx * zy + zy;
                            zx = tmp;
                            i++;
                        }
                        
                        const index = (y * 512 + x) * 4;
                        const color = i === maxIterations ? 0 : (i / maxIterations) * 255;
                        
                        data[index] = color;
                        data[index + 1] = color * 0.7;
                        data[index + 2] = color * 0.3;
                        data[index + 3] = 255;
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
                
                const texture = new THREE.CanvasTexture(canvas);
                texture.needsUpdate = true;
                
                return texture;
            },
            
            createStarfield() {
                const geometry = new THREE.BufferGeometry();
                const vertices = [];
                
                for (let i = 0; i < 10000; i++) {
                    vertices.push(
                        (Math.random() - 0.5) * 2000,
                        (Math.random() - 0.5) * 2000,
                        (Math.random() - 0.5) * 2000
                    );
                }
                
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
                
                const material = new THREE.PointsMaterial({
                    color: 0xffffff,
                    size: 2,
                    transparent: true,
                    opacity: 0.8
                });
                
                const starfield = new THREE.Points(geometry, material);
                this.scene.add(starfield);
            },
            
            setupControls() {
                // Простое управление камерой
                let mouseX = 0, mouseY = 0;
                let targetX = 0, targetY = 0;
                const windowHalfX = window.innerWidth / 2;
                const windowHalfY = window.innerHeight / 2;
                
                document.addEventListener('mousemove', (event) => {
                    if (this.flightMode) {
                        mouseX = (event.clientX - windowHalfX) / windowHalfX;
                        mouseY = (event.clientY - windowHalfY) / windowHalfY;
                    }
                });
                
                // Обновление позиции камеры в animate()
                this.updateCamera = () => {
                    if (this.flightMode) {
                        targetX = mouseX * 200;
                        targetY = mouseY * 100 + 50;
                        
                        this.camera.position.x += (targetX - this.camera.position.x) * 0.05;
                        this.camera.position.y += (targetY - this.camera.position.y) * 0.05;
                        
                        this.camera.lookAt(0, 0, 0);
                    } else {
                        // Орбитальное вращение
                        const time = Date.now() * 0.0005;
                        this.camera.position.x = Math.cos(time) * 150;
                        this.camera.position.z = Math.sin(time) * 150;
                        this.camera.position.y = 80;
                        this.camera.lookAt(0, 0, 0);
                    }
                };
                
                // Управление колесом мыши для приближения/отдаления
                this.renderer.domElement.addEventListener('wheel', (event) => {
                    const delta = event.deltaY * 0.05;
                    const distance = this.camera.position.length();
                    const newDistance = Math.max(50, Math.min(500, distance + delta));
                    
                    this.camera.position.normalize().multiplyScalar(newDistance);
                    this.camera.lookAt(0, 0, 0);
                });
                
                // Обработка кликов на объекты
                const raycaster = new THREE.Raycaster();
                const mouse = new THREE.Vector2();
                
                this.renderer.domElement.addEventListener('click', (event) => {
                    const rect = this.renderer.domElement.getBoundingClientRect();
                    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                    
                    raycaster.setFromCamera(mouse, this.camera);
                    
                    const intersects = raycaster.intersectObjects(
                        Object.values(this.objects).map(obj => obj.children).flat()
                    );
                    
                    if (intersects.length > 0) {
                        const object = intersects[0].object.parent;
                        if (object.userData.name) {
                            this.showLocationInfo(object.userData.name, object.userData.description);
                        }
                    }
                });
            },
            
            toggleFlightMode() {
                this.flightMode = !this.flightMode;
                const btn = document.querySelector('.control-btn');
                btn.classList.toggle('active', this.flightMode);
            },
            
            resetCamera() {
                this.camera.position.set(100, 100, 100);
                this.camera.lookAt(0, 0, 0);
            },
            
            toggleLabels() {
                // Функция для включения/выключения подписей (будет расширена)
                console.log('Переключение подписей');
            },
            
            setTimeOfDay(value) {
                const hours = Math.floor(value);
                const minutes = Math.floor((value - hours) * 60);
                document.getElementById('timeDisplay').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                
                // Изменение освещения
                const sunAngle = (value / 24) * Math.PI * 2 - Math.PI / 2;
                this.sunLight.position.x = Math.cos(sunAngle) * 100;
                this.sunLight.position.y = Math.sin(sunAngle) * 100 + 50;
                
                // Изменение интенсивности
                const intensity = Math.max(0, Math.sin(sunAngle));
                this.sunLight.intensity = intensity;
                
                // Изменение цвета неба
                const skyColor = new THREE.Color();
                if (value >= 6 && value <= 18) {
                    skyColor.setHSL(0.6, 0.5, 0.5 * intensity);
                } else {
                    skyColor.setHSL(0.6, 0.5, 0.05);
                }
                this.scene.fog.color = skyColor;
            },
            
            showLocationInfo(name, description) {
                document.getElementById('currentLocation').textContent = name;
                document.getElementById('locationDescription').textContent = description;
            },
            
            animate() {
                requestAnimationFrame(() => this.animate());
                
                const delta = this.clock.getDelta();
                const time = this.clock.getElapsedTime();
                
                // Обновление камеры
                this.updateCamera();
                
                // Анимация центральной оси - вращение голограмм
                if (this.objects.centralAxis) {
                    this.objects.centralAxis.children.forEach(child => {
                        if (child.userData.rotationSpeed) {
                            child.rotation.z += child.userData.rotationSpeed;
                        }
                    });
                }
                
                // Анимация врат откровения
                if (this.objects.gateMaterial) {
                    this.objects.gateMaterial.uniforms.time.value = time;
                }
                
                if (this.objects.centralCube) {
                    this.objects.centralCube.rotation.x += this.objects.centralCube.userData.rotationSpeed;
                    this.objects.centralCube.rotation.y += this.objects.centralCube.userData.rotationSpeed;
                    
                    // Левитация куба
                    this.objects.centralCube.position.y = 12 + Math.sin(time) * 2;
                }
                
                // Анимация частиц в лабиринте
                if (this.objects.incarnationLabyrinth) {
                    this.objects.incarnationLabyrinth.children.forEach(child => {
                        if (child.type === 'Points') {
                            child.rotation.y += 0.001;
                        }
                    });
                }
                
                // Рендеринг
                this.renderer.render(this.scene, this.camera);
            },
            
            onWindowResize() {
                const container = document.getElementById('threejs-container');
                if (container && this.camera && this.renderer) {
                    this.camera.aspect = container.clientWidth / container.clientHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(container.clientWidth, container.clientHeight);
                }
            }
        };

        // Пространственная аудио система
        const audioSystem = {
            isActive: false,
            context: null,
            masterGain: null,
            zones: {},
            currentZone: null,
            spatialEnabled: false,
            generativeEnabled: false,
            binauralEnabled: false,
            
            init() {
                // Создание аудио контекста при первом взаимодействии
                document.addEventListener('click', () => {
                    if (!this.context) {
                        this.setupAudio();
                    }
                }, { once: true });
            },
            
            setupAudio() {
                try {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.context.createGain();
                    this.masterGain.connect(this.context.destination);
                    this.masterGain.gain.value = 0.5;
                    
                    // Определение звуковых зон
                    this.defineZones();
                    
                    // Отслеживание текущей зоны
                    this.trackZone();
                    
                } catch (error) {
                    console.error('Ошибка инициализации аудио:', error);
                }
            },
            
            defineZones() {
                this.zones = {
                    'central-axis-detailed': {
                        name: 'Центральная ось',
                        baseFreq: 111, // Гц - космическая частота
                        type: 'cosmic',
                        soundscape: 'deep-space'
                    },
                    'genesis-circle-detailed': {
                        name: 'Круг Бытия',
                        baseFreq: 528, // Гц - частота трансформации
                        type: 'creation',
                        soundscape: 'primordial'
                    },
                    'covenant-terraces-detailed': {
                        name: 'Террасы Завета',
                        baseFreq: 396, // Гц - освобождение от страха
                        type: 'sacred',
                        soundscape: 'mountain'
                    },
                    'incarnation-labyrinth-detailed': {
                        name: 'Лабиринт Воплощения',
                        baseFreq: 639, // Гц - гармонизация отношений
                        type: 'journey',
                        soundscape: 'mystical'
                    },
                    'apocalypse-gates-detailed': {
                        name: 'Врата Откровения',
                        baseFreq: 852, // Гц - пробуждение интуиции
                        type: 'transcendent',
                        soundscape: 'ethereal'
                    }
                };
            },
            
            trackZone() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting && this.zones[entry.target.id]) {
                            this.enterZone(entry.target.id);
                        }
                    });
                }, { threshold: 0.3 });
                
                Object.keys(this.zones).forEach(zoneId => {
                    const element = document.getElementById(zoneId);
                    if (element) observer.observe(element);
                });
            },
            
            enterZone(zoneId) {
                this.currentZone = zoneId;
                const zone = this.zones[zoneId];
                
                // Обновление UI
                document.getElementById('currentZoneName').textContent = zone.name;
                document.getElementById('currentFrequency').textContent = `${zone.baseFreq} Гц`;
                
                // Изменение звукового ландшафта
                if (this.isActive) {
                    this.transitionToZone(zone);
                }
            },
            
            transitionToZone(zone) {
                if (!this.context) return;
                
                // Плавный переход между зонами
                if (this.spatialEnabled) {
                    this.updateSpatialAudio(zone);
                }
                
                if (this.generativeEnabled) {
                    this.updateGenerativeMusic(zone);
                }
                
                if (this.binauralEnabled) {
                    this.updateBinauralBeats(zone);
                }
            },
            
            updateSpatialAudio(zone) {
                // Создание 3D звукового пространства
                // В реальной реализации здесь бы использовался Web Audio API PannerNode
                console.log(`Пространственное аудио для зоны: ${zone.name}`);
            },
            
            updateGenerativeMusic(zone) {
                // Генерация музыки на основе характеристик зоны
                if (!this.oscillator) {
                    this.oscillator = this.context.createOscillator();
                    this.oscillator.connect(this.masterGain);
                    this.oscillator.start();
                }
                
                // Плавное изменение частоты
                this.oscillator.frequency.exponentialRampToValueAtTime(
                    zone.baseFreq,
                    this.context.currentTime + 1
                );
            },
            
            updateBinauralBeats(zone) {
                // Создание бинауральных ритмов
                const leftFreq = zone.baseFreq;
                const rightFreq = zone.baseFreq + 7; // Разница 7 Гц для тета-волн
                
                console.log(`Бинауральные ритмы: ${leftFreq} Гц / ${rightFreq} Гц`);
            },
            
            togglePanel() {
                const panel = document.querySelector('.audio-panel');
                panel.classList.toggle('active');
            },
            
            toggleSpatial(enabled) {
                this.spatialEnabled = enabled;
                if (enabled && this.currentZone) {
                    this.updateSpatialAudio(this.zones[this.currentZone]);
                }
            },
            
            toggleGenerative(enabled) {
                this.generativeEnabled = enabled;
                this.isActive = enabled || this.binauralEnabled;
                
                if (enabled && this.currentZone) {
                    this.updateGenerativeMusic(this.zones[this.currentZone]);
                } else if (this.oscillator) {
                    this.oscillator.stop();
                    this.oscillator = null;
                }
                
                this.updateAudioStatus();
            },
            
            toggleBinaural(enabled) {
                this.binauralEnabled = enabled;
                this.isActive = enabled || this.generativeEnabled;
                
                if (enabled && this.currentZone) {
                    this.updateBinauralBeats(this.zones[this.currentZone]);
                }
                
                this.updateAudioStatus();
            },
            
            setMasterVolume(value) {
                if (this.masterGain) {
                    this.masterGain.gain.value = value / 100;
                }
            },
            
            updateAudioStatus() {
                const status = document.querySelector('.audio-status');
                const icon = document.querySelector('.audio-icon');
                const controls = document.querySelector('.audio-controls');
                
                if (this.isActive) {
                    status.textContent = 'Звук вкл';
                    controls.classList.add('active');
                } else {
                    status.textContent = 'Звук выкл';
                    controls.classList.remove('active');
                }
            }
        };

        // Инициализация новых систем
        document.addEventListener('DOMContentLoaded', () => {
            audioSystem.init();
        });

        // Система частиц
        const particleSystem = {
            canvas: null,
            ctx: null,
            particles: [],
            mouseX: 0,
            mouseY: 0,
            
            init() {
                this.canvas = document.getElementById('particlesCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                
                window.addEventListener('resize', () => this.resize());
                document.addEventListener('mousemove', (e) => this.updateMouse(e));
                
                this.createParticles();
                this.animate();
            },
            
            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },
            
            updateMouse(e) {
                this.mouseX = e.clientX;
                this.mouseY = e.clientY;
            },
            
            createParticles() {
                const particleCount = 100;
                
                for (let i = 0; i < particleCount; i++) {
                    this.particles.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        size: Math.random() * 3 + 1,
                        speedX: Math.random() * 2 - 1,
                        speedY: Math.random() * 2 - 1,
                        color: `hsl(${Math.random() * 60 + 30}, 100%, 50%)`,
                        life: 1,
                        maxLife: Math.random() * 100 + 100
                    });
                }
            },
            
            updateParticles() {
                this.particles.forEach((particle, index) => {
                    // Притяжение к курсору
                    const dx = this.mouseX - particle.x;
                    const dy = this.mouseY - particle.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 100) {
                        const force = (100 - distance) / 100;
                        particle.speedX += (dx / distance) * force * 0.5;
                        particle.speedY += (dy / distance) * force * 0.5;
                    }
                    
                    // Обновление позиции
                    particle.x += particle.speedX;
                    particle.y += particle.speedY;
                    
                    // Затухание скорости
                    particle.speedX *= 0.98;
                    particle.speedY *= 0.98;
                    
                    // Границы экрана
                    if (particle.x < 0 || particle.x > this.canvas.width) particle.speedX *= -1;
                    if (particle.y < 0 || particle.y > this.canvas.height) particle.speedY *= -1;
                    
                    // Жизненный цикл
                    particle.life--;
                    if (particle.life <= 0) {
                        // Респавн частицы
                        particle.x = Math.random() * this.canvas.width;
                        particle.y = Math.random() * this.canvas.height;
                        particle.life = particle.maxLife;
                    }
                });
            },
            
            drawParticles() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.particles.forEach(particle => {
                    const opacity = particle.life / particle.maxLife;
                    
                    this.ctx.beginPath();
                    this.ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    this.ctx.fillStyle = particle.color.replace('50%', `${50 * opacity}%`);
                    this.ctx.fill();
                    
                    // Свечение
                    this.ctx.shadowBlur = 10;
                    this.ctx.shadowColor = particle.color;
                    this.ctx.fill();
                    this.ctx.shadowBlur = 0;
                });
                
                // Соединяющие линии
                this.particles.forEach((p1, i) => {
                    this.particles.slice(i + 1).forEach(p2 => {
                        const distance = Math.sqrt(
                            Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)
                        );
                        
                        if (distance < 100) {
                            this.ctx.beginPath();
                            this.ctx.moveTo(p1.x, p1.y);
                            this.ctx.lineTo(p2.x, p2.y);
                            this.ctx.strokeStyle = `rgba(255, 215, 0, ${0.2 * (1 - distance / 100)})`;
                            this.ctx.stroke();
                        }
                    });
                });
            },
            
            animate() {
                this.updateParticles();
                this.drawParticles();
                requestAnimationFrame(() => this.animate());
            }
        };

        // Система ритуалов
        const ritualSystem = {
            activeRitual: null,
            waterAnimation: null,
            meditationActive: false,
            meditationTimer: null,
            meditationParticipants: 0,
            
            showRitual(type) {
                // Скрыть все ритуалы
                document.querySelectorAll('.ritual-container').forEach(r => {
                    r.classList.remove('active');
                });
                
                // Показать выбранный
                const ritualMap = {
                    'purification': 'purificationRitual',
                    'candle': 'candleLighting',
                    'flags': 'prayerFlags',
                    'meditation': 'collectiveMeditation'
                };
                
                const ritual = document.getElementById(ritualMap[type]);
                if (ritual) {
                    ritual.classList.add('active');
                    this.activeRitual = type;
                    
                    // Инициализация специфичных для ритуала функций
                    if (type === 'purification') this.initWaterRitual();
                    if (type === 'meditation') this.initMeditationCircle();
                    if (type === 'flags') this.initFlagCreator();
                }
            },
            
            hideRitual() {
                if (this.activeRitual) {
                    document.querySelectorAll('.ritual-container').forEach(r => {
                        r.classList.remove('active');
                    });
                    this.activeRitual = null;
                }
            },
            
            // Ритуал очищения
            initWaterRitual() {
                const canvas = document.getElementById('waterCanvas');
                const ctx = canvas.getContext('2d');
                const ripples = [];
                
                // Градиент воды
                const gradient = ctx.createRadialGradient(200, 200, 0, 200, 200, 200);
                gradient.addColorStop(0, 'rgba(100, 150, 200, 0.8)');
                gradient.addColorStop(0.5, 'rgba(50, 100, 150, 0.6)');
                gradient.addColorStop(1, 'rgba(20, 50, 100, 0.4)');
                
                canvas.addEventListener('mousemove', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    ripples.push({
                        x: x,
                        y: y,
                        radius: 0,
                        maxRadius: 100,
                        opacity: 1
                    });
                    
                    // Визуальная рябь
                    this.createRippleElement(x, y);
                });
                
                const animateWater = () => {
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, 400, 400);
                    
                    // Анимация ряби
                    ripples.forEach((ripple, index) => {
                        ripple.radius += 2;
                        ripple.opacity = 1 - (ripple.radius / ripple.maxRadius);
                        
                        ctx.beginPath();
                        ctx.arc(ripple.x, ripple.y, ripple.radius, 0, Math.PI * 2);
                        ctx.strokeStyle = `rgba(255, 255, 255, ${ripple.opacity * 0.5})`;
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        
                        if (ripple.radius > ripple.maxRadius) {
                            ripples.splice(index, 1);
                        }
                    });
                    
                    this.waterAnimation = requestAnimationFrame(animateWater);
                };
                
                animateWater();
            },
            
            createRippleElement(x, y) {
                const basin = document.querySelector('.water-basin');
                const ripple = document.createElement('div');
                ripple.className = 'ripple-effect';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                basin.appendChild(ripple);
                
                setTimeout(() => ripple.remove(), 2000);
            },
            
            completePurification() {
                // Эффект завершения
                const canvas = document.getElementById('waterCanvas');
                const ctx = canvas.getContext('2d');
                
                // Вспышка света
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.fillRect(0, 0, 400, 400);
                
                setTimeout(() => {
                    this.hideRitual();
                    cancelAnimationFrame(this.waterAnimation);
                    
                    // Уведомление
                    this.showNotification('Вы очищены и готовы к путешествию');
                }, 500);
            },
            
            // Ритуал свечи
            lightCandle() {
                const candle = document.querySelector('.candle');
                const intention = document.getElementById('intentionText').value;
                
                if (!intention.trim()) {
                    this.showNotification('Пожалуйста, введите ваше намерение');
                    return;
                }
                
                candle.setAttribute('data-lit', 'true');
                
                // Сохранение намерения
                const intentions = JSON.parse(localStorage.getItem('candleIntentions') || '[]');
                intentions.push({
                    text: intention,
                    date: new Date().toISOString(),
                    visitorType: visitorProfile.currentType
                });
                localStorage.setItem('candleIntentions', JSON.stringify(intentions));
                
                setTimeout(() => {
                    this.showNotification('Ваша свеча зажжена. Намерение услышано.');
                    setTimeout(() => this.hideRitual(), 2000);
                }, 1000);
            },
            
            // Молитвенные флаги
            initFlagCreator() {
                const canvas = document.getElementById('flagCanvas');
                const ctx = canvas.getContext('2d');
                let selectedColor = '#ff6b6b';
                
                // Очистка холста
                ctx.fillStyle = selectedColor;
                ctx.fillRect(0, 0, 300, 200);
                
                // Обработчики выбора цвета
                document.querySelectorAll('.color-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
                        option.classList.add('active');
                        selectedColor = option.dataset.color;
                        
                        ctx.fillStyle = selectedColor;
                        ctx.fillRect(0, 0, 300, 200);
                    });
                });
                
                // Загрузка существующих флагов
                this.loadCommunityFlags();
            },
            
            createFlag() {
                const message = document.getElementById('flagMessage').value;
                if (!message.trim()) {
                    this.showNotification('Пожалуйста, введите послание для флага');
                    return;
                }
                
                const canvas = document.getElementById('flagCanvas');
                const ctx = canvas.getContext('2d');
                
                // Добавление текста на флаг
                ctx.fillStyle = 'white';
                ctx.font = '20px Georgia';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(message, 150, 100);
                
                // Сохранение флага
                const flags = JSON.parse(localStorage.getItem('prayerFlags') || '[]');
                flags.push({
                    color: document.querySelector('.color-option.active').dataset.color,
                    message: message,
                    date: new Date().toISOString()
                });
                localStorage.setItem('prayerFlags', JSON.stringify(flags));
                
                this.showNotification('Ваш флаг развевается на ветру вечности');
                this.loadCommunityFlags();
                
                // Очистка
                document.getElementById('flagMessage').value = '';
            },
            
            loadCommunityFlags() {
                const container = document.getElementById('communityFlags');
                const flags = JSON.parse(localStorage.getItem('prayerFlags') || '[]');
                
                container.innerHTML = '<h4 style="color: var(--gold); width: 100%;">Флаги сообщества:</h4>';
                
                flags.slice(-10).forEach(flag => {
                    const flagEl = document.createElement('div');
                    flagEl.className = 'flag-item';
                    flagEl.style.background = flag.color;
                    flagEl.title = flag.message;
                    container.appendChild(flagEl);
                });
            },
            
            // Коллективная медитация
            initMeditationCircle() {
                const canvas = document.getElementById('meditationCanvas');
                const ctx = canvas.getContext('2d');
                
                // Симуляция участников
                this.meditationParticipants = Math.floor(Math.random() * 50) + 10;
                document.getElementById('participantCount').textContent = this.meditationParticipants;
                
                const drawMeditationCircle = () => {
                    ctx.clearRect(0, 0, 500, 500);
                    
                    // Центральный круг
                    const centerX = 250;
                    const centerY = 250;
                    
                    // Пульсирующие круги
                    for (let i = 0; i < 5; i++) {
                        const radius = 50 + i * 40 + Math.sin(Date.now() * 0.001 + i) * 10;
                        const opacity = 0.3 - i * 0.05;
                        
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                        ctx.strokeStyle = `rgba(255, 215, 0, ${opacity})`;
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                    
                    // Точки участников
                    for (let i = 0; i < this.meditationParticipants; i++) {
                        const angle = (i / this.meditationParticipants) * Math.PI * 2;
                        const radius = 180 + Math.sin(Date.now() * 0.002 + i) * 20;
                        const x = centerX + Math.cos(angle) * radius;
                        const y = centerY + Math.sin(angle) * radius;
                        
                        ctx.beginPath();
                        ctx.arc(x, y, 5, 0, Math.PI * 2);
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                        ctx.fill();
                    }
                    
                    if (this.meditationActive) {
                        requestAnimationFrame(drawMeditationCircle);
                    }
                };
                
                drawMeditationCircle();
            },
            
            toggleMeditation() {
                this.meditationActive = !this.meditationActive;
                const btn = document.getElementById('meditationToggle');
                
                if (this.meditationActive) {
                    btn.classList.add('active');
                    btn.textContent = 'Покинуть медитацию';
                    this.startMeditationTimer();
                    this.initMeditationCircle();
                } else {
                    btn.classList.remove('active');
                    btn.textContent = 'Присоединиться к медитации';
                    this.stopMeditationTimer();
                }
            },
            
            startMeditationTimer() {
                let seconds = 0;
                this.meditationTimer = setInterval(() => {
                    seconds++;
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    document.getElementById('meditationTime').textContent = 
                        `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }, 1000);
            },
            
            stopMeditationTimer() {
                clearInterval(this.meditationTimer);
                document.getElementById('meditationTime').textContent = '00:00';
            },
            
            showNotification(message) {
                // Создание уведомления
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.9);
                    border: 1px solid var(--gold);
                    color: var(--gold);
                    padding: 1rem 2rem;
                    border-radius: 10px;
                    z-index: 10000;
                    animation: slideDown 0.3s ease;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => notification.remove(), 3000);
            }
        };

        // Калейдоскопическая система
        const kaleidoscopeSystem = {
            canvas: null,
            ctx: null,
            segments: 12,
            
            init() {
                this.canvas = document.getElementById('kaleidoscopeCanvas');
                this.ctx = this.canvas.getContext('2d');
            },
            
            open() {
                document.getElementById('kaleidoscopeOverlay').classList.add('active');
                if (!this.canvas) this.init();
                this.generate();
            },
            
            close() {
                document.getElementById('kaleidoscopeOverlay').classList.remove('active');
            },
            
            generate() {
                const centerX = 400;
                const centerY = 400;
                const radius = 350;
                
                // Очистка
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, 800, 800);
                
                // Создание одного сегмента
                this.ctx.save();
                this.ctx.translate(centerX, centerY);
                
                for (let i = 0; i < this.segments; i++) {
                    this.ctx.save();
                    this.ctx.rotate((Math.PI * 2 / this.segments) * i);
                    
                    // Зеркальное отражение для чётных сегментов
                    if (i % 2 === 0) {
                        this.ctx.scale(-1, 1);
                    }
                    
                    this.drawSegment();
                    this.ctx.restore();
                }
                
                this.ctx.restore();
            },
            
            drawSegment() {
                const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24'];
                
                // Случайные формы
                for (let i = 0; i < 20; i++) {
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    const x = Math.random() * 200;
                    const y = (Math.random() - 0.5) * 100;
                    const size = Math.random() * 20 + 5;
                    
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, size, 0, Math.PI * 2);
                    this.ctx.fillStyle = color + '80';
                    this.ctx.fill();
                    
                    // Соединяющие линии
                    if (i > 0) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(x, y);
                        this.ctx.lineTo(x + Math.random() * 50, y + Math.random() * 50);
                        this.ctx.strokeStyle = color + '40';
                        this.ctx.stroke();
                    }
                }
            },
            
            regenerate() {
                this.generate();
            },
            
            save() {
                const link = document.createElement('a');
                link.download = `kaleidoscope-${Date.now()}.png`;
                link.href = this.canvas.toDataURL();
                link.click();
            }
        };

        // Добавление кнопки калейдоскопа в профиль
        document.addEventListener('DOMContentLoaded', () => {
            particleSystem.init();
            
            // Добавить кнопку калейдоскопа в меню профиля
            const kaleidoscopeBtn = document.createElement('button');
            kaleidoscopeBtn.className = 'mandala-btn';
            kaleidoscopeBtn.innerHTML = '<span>✨</span> Калейдоскоп';
            kaleidoscopeBtn.onclick = () => kaleidoscopeSystem.open();
            
            const profileMenu = document.querySelector('.profile-menu');
            if (profileMenu) {
                profileMenu.appendChild(kaleidoscopeBtn);
            }
        });

        // CSS анимация для уведомлений
        const style = document.createElement('style');
        style.textContent = `
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        `;
        document.head.appendChild(style);

        // Цифровая песочница Юнга
        const sandboxSystem = {
            canvas: null,
            ctx: null,
            currentTool: 'place',
            selectedArchetype: null,
            placedObjects: [],
            
            open() {
                document.getElementById('jungianSandbox').classList.add('active');
                if (!this.canvas) {
                    this.init();
                }
            },
            
            close() {
                document.getElementById('jungianSandbox').classList.remove('active');
            },
            
            init() {
                this.canvas = document.getElementById('sandboxCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                // Обработчики архетипов
                document.querySelectorAll('.archetype-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.archetype-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        this.selectedArchetype = item.dataset.archetype;
                        this.setTool('place');
                    });
                });
                
                // Обработчики инструментов
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.setTool(btn.dataset.tool);
                    });
                });
                
                // Обработчик canvas
                this.canvas.addEventListener('click', (e) => this.handleCanvasClick(e));
                
                // Начальная отрисовка
                this.draw();
            },
            
            setTool(tool) {
                this.currentTool = tool;
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tool === tool);
                });
                
                if (tool === 'clear') {
                    this.clearSandbox();
                }
            },
            
            handleCanvasClick(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (this.currentTool === 'place' && this.selectedArchetype) {
                    this.placeArchetype(x, y);
                } else if (this.currentTool === 'remove') {
                    this.removeArchetype(x, y);
                }
            },
            
            placeArchetype(x, y) {
                const archetypeData = {
                    type: this.selectedArchetype,
                    x: x,
                    y: y,
                    size: 40,
                    symbol: document.querySelector(`[data-archetype="${this.selectedArchetype}"]`).textContent
                };
                
                this.placedObjects.push(archetypeData);
                this.draw();
                this.updateInterpretation();
            },
            
            removeArchetype(x, y) {
                this.placedObjects = this.placedObjects.filter(obj => {
                    const distance = Math.sqrt(Math.pow(obj.x - x, 2) + Math.pow(obj.y - y, 2));
                    return distance > obj.size;
                });
                this.draw();
                this.updateInterpretation();
            },
            
            clearSandbox() {
                this.placedObjects = [];
                this.draw();
                this.updateInterpretation();
            },
            
            draw() {
                // Очистка
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Фон песка
                const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                gradient.addColorStop(0, '#f5deb3');
                gradient.addColorStop(1, '#d2b48c');
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Эффект песка
                for (let i = 0; i < 1000; i++) {
                    const x = Math.random() * this.canvas.width;
                    const y = Math.random() * this.canvas.height;
                    const opacity = Math.random() * 0.3;
                    this.ctx.fillStyle = `rgba(139, 69, 19, ${opacity})`;
                    this.ctx.fillRect(x, y, 1, 1);
                }
                
                // Отрисовка объектов
                this.placedObjects.forEach(obj => {
                    // Тень
                    this.ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                    this.ctx.shadowBlur = 10;
                    this.ctx.shadowOffsetX = 5;
                    this.ctx.shadowOffsetY = 5;
                    
                    // Круг фона
                    this.ctx.beginPath();
                    this.ctx.arc(obj.x, obj.y, obj.size, 0, Math.PI * 2);
                    this.ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    this.ctx.fill();
                    
                    // Символ
                    this.ctx.shadowBlur = 0;
                    this.ctx.font = '30px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillStyle = '#333';
                    this.ctx.fillText(obj.symbol, obj.x, obj.y);
                });
            },
            
            updateInterpretation() {
                const analysis = document.getElementById('sandboxAnalysis');
                
                if (this.placedObjects.length === 0) {
                    analysis.innerHTML = '<p style="color: var(--text-dim);">Разместите архетипы для начала анализа...</p>';
                    return;
                }
                
                // Анализ композиции
                const archetypeCounts = {};
                let centerX = 0, centerY = 0;
                
                this.placedObjects.forEach(obj => {
                    archetypeCounts[obj.type] = (archetypeCounts[obj.type] || 0) + 1;
                    centerX += obj.x;
                    centerY += obj.y;
                });
                
                centerX /= this.placedObjects.length;
                centerY /= this.placedObjects.length;
                
                // Интерпретация
                let interpretation = '<h4>Анализ вашего внутреннего ландшафта:</h4>';
                
                // Доминирующие архетипы
                const dominant = Object.entries(archetypeCounts).sort((a, b) => b[1] - a[1])[0];
                interpretation += `<p><strong>Доминирующий архетип:</strong> ${this.getArchetypeName(dominant[0])} (${dominant[1]} раз)</p>`;
                
                // Позиционный анализ
                const quadrants = this.analyzeQuadrants();
                interpretation += '<p><strong>Распределение по квадрантам:</strong></p><ul>';
                quadrants.forEach(q => {
                    if (q.count > 0) {
                        interpretation += `<li>${q.name}: ${q.count} архетипов - ${q.meaning}</li>`;
                    }
                });
                interpretation += '</ul>';
                
                // Специфические интерпретации
                if (archetypeCounts.shadow) {
                    interpretation += '<p><em>Присутствие Тени указывает на работу с подавленными аспектами личности.</em></p>';
                }
                if (archetypeCounts.mandala && archetypeCounts.tree) {
                    interpretation += '<p><em>Сочетание Мандалы и Древа говорит о стремлении к целостности и росту.</em></p>';
                }
                
                analysis.innerHTML = interpretation;
            },
            
            getArchetypeName(type) {
                const names = {
                    hero: 'Герой',
                    shadow: 'Тень',
                    anima: 'Анима/Анимус',
                    sage: 'Мудрец',
                    mother: 'Великая Мать',
                    child: 'Божественный Ребёнок',
                    trickster: 'Трикстер',
                    tree: 'Мировое Древо',
                    mandala: 'Мандала',
                    water: 'Вода',
                    fire: 'Огонь',
                    mountain: 'Гора'
                };
                return names[type] || type;
            },
            
            analyzeQuadrants() {
                const quadrants = [
                    { name: 'Верхний левый', x: 0, y: 0, w: 400, h: 300, count: 0, meaning: 'прошлое и бессознательное' },
                    { name: 'Верхний правый', x: 400, y: 0, w: 400, h: 300, count: 0, meaning: 'будущее и сознательные цели' },
                    { name: 'Нижний левый', x: 0, y: 300, w: 400, h: 300, count: 0, meaning: 'инстинкты и телесность' },
                    { name: 'Нижний правый', x: 400, y: 300, w: 400, h: 300, count: 0, meaning: 'социальная адаптация' }
                ];
                
                this.placedObjects.forEach(obj => {
                    quadrants.forEach(q => {
                        if (obj.x >= q.x && obj.x < q.x + q.w && obj.y >= q.y && obj.y < q.y + q.h) {
                            q.count++;
                        }
                    });
                });
                
                return quadrants;
            },
            
            save() {
                const data = {
                    objects: this.placedObjects,
                    date: new Date().toISOString(),
                    visitorType: visitorProfile.currentType
                };
                
                const saved = JSON.parse(localStorage.getItem('sandboxSaves') || '[]');
                saved.push(data);
                localStorage.setItem('sandboxSaves', JSON.stringify(saved));
                
                ritualSystem.showNotification('Композиция сохранена');
            }
        };

        // Тест ассоциаций
        const associationTest = {
            questions: [
                {
                    text: 'Что для вас означает "начало"?',
                    options: [
                        { text: 'Большой взрыв', type: 'cosmological' },
                        { text: 'Сотворение мира', type: 'biblical' },
                        { text: 'Рождение сознания', type: 'psychoanalytic' },
                        { text: 'Первичная пустота', type: 'mystical' }
                    ]
                },
                {
                    text: 'Как вы понимаете "трансформацию"?',
                    options: [
                        { text: 'Эволюция видов', type: 'cosmological' },
                        { text: 'Духовное преображение', type: 'biblical' },
                        { text: 'Индивидуация', type: 'psychoanalytic' },
                        { text: 'Алхимическое превращение', type: 'mystical' }
                    ]
                },
                {
                    text: 'Что такое "тень" в вашем понимании?',
                    options: [
                        { text: 'Отсутствие света', type: 'cosmological' },
                        { text: 'Зло и грех', type: 'biblical' },
                        { text: 'Вытесненное бессознательное', type: 'psychoanalytic' },
                        { text: 'Непроявленный потенциал', type: 'mystical' }
                    ]
                },
                {
                    text: 'Как вы воспринимаете "единство"?',
                    options: [
                        { text: 'Квантовая запутанность', type: 'cosmological' },
                        { text: 'Единство в Боге', type: 'biblical' },
                        { text: 'Интеграция личности', type: 'psychoanalytic' },
                        { text: 'Недвойственность', type: 'mystical' }
                    ]
                },
                {
                    text: 'Что означает "жертва"?',
                    options: [
                        { text: 'Энтропийная плата', type: 'cosmological' },
                        { text: 'Искупление грехов', type: 'biblical' },
                        { text: 'Отказ от желания', type: 'psychoanalytic' },
                        { text: 'Самоотдача', type: 'mystical' }
                    ]
                },
                {
                    text: 'Как вы понимаете "время"?',
                    options: [
                        { text: 'Четвёртое измерение', type: 'cosmological' },
                        { text: 'Божий промысел', type: 'biblical' },
                        { text: 'Субъективное переживание', type: 'psychoanalytic' },
                        { text: 'Иллюзия сознания', type: 'mystical' }
                    ]
                },
                {
                    text: 'Что такое "свет"?',
                    options: [
                        { text: 'Электромагнитное излучение', type: 'cosmological' },
                        { text: 'Божественное присутствие', type: 'biblical' },
                        { text: 'Осознание', type: 'psychoanalytic' },
                        { text: 'Просветление', type: 'mystical' }
                    ]
                },
                {
                    text: 'Как вы видите "конец"?',
                    options: [
                        { text: 'Тепловая смерть вселенной', type: 'cosmological' },
                        { text: 'Страшный суд', type: 'biblical' },
                        { text: 'Принятие смертности', type: 'psychoanalytic' },
                        { text: 'Растворение в абсолюте', type: 'mystical' }
                    ]
                },
                {
                    text: 'Что означает "любовь"?',
                    options: [
                        { text: 'Биохимическая реакция', type: 'cosmological' },
                        { text: 'Божественная заповедь', type: 'biblical' },
                        { text: 'Либидинальная энергия', type: 'psychoanalytic' },
                        { text: 'Космическая сила', type: 'mystical' }
                    ]
                },
                {
                    text: 'Как вы понимаете "истину"?',
                    options: [
                        { text: 'Научный факт', type: 'cosmological' },
                        { text: 'Божественное откровение', type: 'biblical' },
                        { text: 'Подавленное знание', type: 'psychoanalytic' },
                        { text: 'Прямое переживание', type: 'mystical' }
                    ]
                },
                {
                    text: 'Что такое "путь"?',
                    options: [
                        { text: 'Траектория в пространстве-времени', type: 'cosmological' },
                        { text: 'Следование заповедям', type: 'biblical' },
                        { text: 'Процесс индивидуации', type: 'psychoanalytic' },
                        { text: 'Духовная практика', type: 'mystical' }
                    ]
                },
                {
                    text: 'Как вы видите "целостность"?',
                    options: [
                        { text: 'Системная полнота', type: 'cosmological' },
                        { text: 'Единение с Богом', type: 'biblical' },
                        { text: 'Интегрированная психика', type: 'psychoanalytic' },
                        { text: 'Космическое сознание', type: 'mystical' }
                    ]
                }
            ],
            
            currentQuestion: 0,
            answers: [],
            
            open() {
                document.getElementById('associationTest').classList.add('active');
                this.reset();
                this.showQuestion();
            },
            
            close() {
                document.getElementById('associationTest').classList.remove('active');
            },
            
            reset() {
                this.currentQuestion = 0;
                this.answers = [];
                document.getElementById('resultsContainer').style.display = 'none';
                document.getElementById('questionContainer').style.display = 'block';
            },
            
            showQuestion() {
                const question = this.questions[this.currentQuestion];
                document.getElementById('questionText').textContent = question.text;
                document.getElementById('currentQuestion').textContent = this.currentQuestion + 1;
                document.getElementById('totalQuestions').textContent = this.questions.length;
                
                // Прогресс
                const progress = ((this.currentQuestion + 1) / this.questions.length) * 100;
                document.getElementById('testProgress').style.width = progress + '%';
                
                // Опции
                const container = document.getElementById('optionsContainer');
                container.innerHTML = '';
                
                question.options.forEach((option, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = option.text;
                    btn.onclick = () => this.selectAnswer(index);
                    container.appendChild(btn);
                });
            },
            
            selectAnswer(index) {
                const question = this.questions[this.currentQuestion];
                this.answers.push(question.options[index].type);
                
                if (this.currentQuestion < this.questions.length - 1) {
                    this.currentQuestion++;
                    this.showQuestion();
                } else {
                    this.showResults();
                }
            },
            
            showResults() {
                document.getElementById('questionContainer').style.display = 'none';
                document.getElementById('resultsContainer').style.display = 'block';
                
                // Подсчёт результатов
                const counts = {
                    cosmological: 0,
                    biblical: 0,
                    psychoanalytic: 0,
                    mystical: 0
                };
                
                this.answers.forEach(type => counts[type]++);
                
                // Визуализация результатов
                this.drawResultsChart(counts);
                this.showInterpretation(counts);
            },
            
            drawResultsChart(counts) {
                const canvas = document.getElementById('resultsChart');
                const ctx = canvas.getContext('2d');
                
                // Очистка
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Данные
                const types = Object.keys(counts);
                const values = Object.values(counts);
                const maxValue = Math.max(...values);
                
                // Параметры графика
                const barWidth = 100;
                const barSpacing = 50;
                const startX = 50;
                const startY = 350;
                const maxHeight = 250;
                
                // Отрисовка столбцов
                types.forEach((type, index) => {
                    const x = startX + index * (barWidth + barSpacing);
                    const height = (values[index] / maxValue) * maxHeight;
                    const y = startY - height;
                    
                    // Градиент
                    const gradient = ctx.createLinearGradient(x, y, x, startY);
                    gradient.addColorStop(0, '#ffd700');
                    gradient.addColorStop(1, '#ff8c00');
                    
                    // Столбец
                    ctx.fillStyle = gradient;
                    ctx.fillRect(x, y, barWidth, height);
                    
                    // Значение
                    ctx.fillStyle = '#ffd700';
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(values[index], x + barWidth / 2, y - 10);
                    
                    // Подпись
                    ctx.fillStyle = '#e0e0e0';
                    ctx.font = '14px Arial';
                    ctx.save();
                    ctx.translate(x + barWidth / 2, startY + 20);
                    ctx.rotate(-Math.PI / 6);
                    ctx.textAlign = 'right';
                    ctx.fillText(this.getTypeName(type), 0, 0);
                    ctx.restore();
                });
            },
            
            getTypeName(type) {
                const names = {
                    cosmological: 'Космологическое',
                    biblical: 'Библейское',
                    psychoanalytic: 'Психоаналитическое',
                    mystical: 'Мистическое'
                };
                return names[type];
            },
            
            showInterpretation(counts) {
                const container = document.getElementById('resultsInterpretation');
                const dominant = Object.entries(counts).sort((a, b) => b[1] - a[1])[0][0];
                
                const interpretations = {
                    cosmological: 'Вы воспринимаете мир через призму научного познания. Для вас важны объективные законы, причинно-следственные связи и рациональное понимание реальности.',
                    biblical: 'Ваше мировосприятие укоренено в духовной традиции. Вы видите мир как священное пространство, наполненное смыслом и божественным присутствием.',
                    psychoanalytic: 'Вы склонны к глубинному самопознанию. Для вас важны внутренние процессы, символы бессознательного и психологическая трансформация.',
                    mystical: 'Вы ищете прямого переживания единства. Ваш путь лежит через непосредственный опыт, выходящий за пределы рациональных категорий.'
                };
                
                let html = `<h4>Ваш доминирующий тип восприятия: ${this.getTypeName(dominant)}</h4>`;
                html += `<p>${interpretations[dominant]}</p>`;
                
                // Баланс
                const balance = Object.values(counts).every(v => v >= 2);
                if (balance) {
                    html += '<p><strong>Особое достижение:</strong> У вас сбалансированное восприятие всех четырёх измерений познания!</p>';
                }
                
                container.innerHTML = html;
            }
        };

        // База данных согласований
        const databaseSystem = {
            concordances: [
                {
                    category: 'Творение',
                    biblical: 'Да будет свет (Быт. 1:3)',
                    psychoanalytic: 'Первичная дифференциация Я/не-Я',
                    cosmological: 'Большой взрыв - начало пространства-времени',
                    mystical: 'Эманация Единого'
                },
                {
                    category: 'Падение',
                    biblical: 'Вкушение от древа познания',
                    psychoanalytic: 'Травма рождения, утрата океанического чувства',
                    cosmological: 'Нарушение симметрии, рост энтропии',
                    mystical: 'Иллюзия отделённости'
                },
                {
                    category: 'Спасение',
                    biblical: 'Искупительная жертва Христа',
                    psychoanalytic: 'Интеграция Тени, индивидуация',
                    cosmological: 'Негэнтропия, самоорганизация',
                    mystical: 'Пробуждение, просветление'
                },
                {
                    category: 'Конец',
                    biblical: 'Второе пришествие, Новый Иерусалим',
                    psychoanalytic: 'Завершение индивидуации',
                    cosmological: 'Омега-точка, финальная сингулярность',
                    mystical: 'Растворение в Абсолюте'
                }
            ],
            
            open() {
                document.getElementById('concordanceDatabase').classList.add('active');
                this.displayAll();
                this.initSearch();
            },
            
            close() {
                document.getElementById('concordanceDatabase').classList.remove('active');
            },
            
            displayAll() {
                const container = document.getElementById('databaseResults');
                container.innerHTML = '';
                
                this.concordances.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    div.innerHTML = `
                        <h3 class="result-category">${item.category}</h3>
                        <div class="result-content">
                            <div><strong>Библейское:</strong> ${item.biblical}</div>
                            <div><strong>Психоаналитическое:</strong> ${item.psychoanalytic}</div>
                            <div><strong>Космологическое:</strong> ${item.cosmological}</div>
                            <div><strong>Мистическое:</strong> ${item.mystical}</div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            },
            
            initSearch() {
                const searchInput = document.getElementById('concordanceSearch');
                searchInput.addEventListener('input', () => this.search(searchInput.value));
                
                document.querySelectorAll('.search-filters input').forEach(filter => {
                    filter.addEventListener('change', () => this.search(searchInput.value));
                });
            },
            
            search(query) {
                const filters = Array.from(document.querySelectorAll('.search-filters input:checked'))
                    .map(f => f.dataset.filter);
                
                const results = this.concordances.filter(item => {
                    const searchMatch = !query || 
                        Object.values(item).some(val => 
                            val.toLowerCase().includes(query.toLowerCase())
                        );
                    
                    const filterMatch = filters.length === 0 ||
                        filters.some(filter => item[filter]);
                    
                    return searchMatch && filterMatch;
                });
                
                const container = document.getElementById('databaseResults');
                container.innerHTML = '';
                
                if (results.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-dim);">Не найдено согласований по вашему запросу</p>';
                } else {
                    results.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'result-item';
                        div.innerHTML = `
                            <h3 class="result-category">${item.category}</h3>
                            <div class="result-content">
                                ${filters.includes('biblical') || filters.length === 0 ? `<div><strong>Библейское:</strong> ${item.biblical}</div>` : ''}
                                ${filters.includes('psychoanalytic') || filters.length === 0 ? `<div><strong>Психоаналитическое:</strong> ${item.psychoanalytic}</div>` : ''}
                                ${filters.includes('cosmological') || filters.length === 0 ? `<div><strong>Космологическое:</strong> ${item.cosmological}</div>` : ''}
                                ${filters.includes('mystical') || filters.length === 0 ? `<div><strong>Мистическое:</strong> ${item.mystical}</div>` : ''}
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
            }
        };

        // Генератор связей
        const connectionGenerator = {
            open() {
                document.getElementById('connectionGenerator').classList.add('active');
            },
            
            close() {
                document.getElementById('connectionGenerator').classList.remove('active');
            },
            
            generate() {
                const concept1 = document.getElementById('concept1').value;
                const concept2 = document.getElementById('concept2').value;
                
                if (!concept1 || !concept2) {
                    ritualSystem.showNotification('Введите обе концепции');
                    return;
                }
                
                // Генерация связей
                const connections = this.findConnections(concept1, concept2);
                this.displayConnections(connections);
                this.drawConnectionMap(concept1, concept2, connections);
            },
            
            findConnections(c1, c2) {
                // Симуляция поиска связей
                return [
                    {
                        path: 'Через архетип трансформации',
                        steps: [c1, 'Изменение состояния', 'Переходный процесс', c2]
                    },
                    {
                        path: 'Через принцип единства',
                        steps: [c1, 'Часть целого', 'Взаимосвязанность', c2]
                    },
                    {
                        path: 'Через символическое соответствие',
                        steps: [c1, 'Символ порядка', 'Структура реальности', c2]
                    }
                ];
            },
            
            displayConnections(connections) {
                const container = document.getElementById('connectionResults');
                let html = '<h3>Обнаруженные пути связи:</h3>';
                
                connections.forEach((conn, index) => {
                    html += `
                        <div class="connection-path">
                            <h4>Путь ${index + 1}: ${conn.path}</h4>
                            <div class="path-steps">
                                ${conn.steps.map((step, i) => 
                                    `<span class="step">${step}</span>${i < conn.steps.length - 1 ? ' → ' : ''}`
                                ).join('')}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            drawConnectionMap(c1, c2, connections) {
                // Простая визуализация связей
                const svg = document.getElementById('connectionSvg');
                svg.innerHTML = '';
                
                // Центральные узлы
                const node1 = { x: 150, y: 250, label: c1 };
                const node2 = { x: 650, y: 250, label: c2 };
                
                // Промежуточные узлы
                const middleNodes = connections.map((conn, i) => ({
                    x: 400,
                    y: 100 + i * 150,
                    label: conn.path
                }));
                
                // Отрисовка связей
                middleNodes.forEach(node => {
                    // Линии
                    svg.innerHTML += `
                        <line x1="${node1.x}" y1="${node1.y}" x2="${node.x}" y2="${node.y}" 
                              stroke="#ffd700" stroke-width="2" opacity="0.5"/>
                        <line x1="${node.x}" y1="${node.y}" x2="${node2.x}" y2="${node2.y}" 
                              stroke="#ffd700" stroke-width="2" opacity="0.5"/>
                    `;
                });
                
                // Отрисовка узлов
                [node1, node2, ...middleNodes].forEach(node => {
                    svg.innerHTML += `
                        <circle cx="${node.x}" cy="${node.y}" r="30" fill="#1a1a2e" 
                                stroke="#ffd700" stroke-width="2"/>
                        <text x="${node.x}" y="${node.y}" text-anchor="middle" 
                              dominant-baseline="middle" fill="#ffd700" font-size="12">
                            ${node.label.length > 20 ? node.label.substring(0, 20) + '...' : node.label}
                        </text>
                    `;
                });
            }
        };

        // Инструменты анализа
        const analysisTools = {
            open() {
                document.getElementById('analysisTools').classList.add('active');
                this.showStatistics();
            },
            
            close() {
                document.getElementById('analysisTools').classList.remove('active');
            },
            
            initTabs() {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Переключение вкладок
                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        btn.classList.add('active');
                        document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
                        
                        // Загрузка контента вкладки
                        if (btn.dataset.tab === 'statistics') this.showStatistics();
                        if (btn.dataset.tab === 'patterns') this.showPatterns();
                        if (btn.dataset.tab === 'journey') this.showJourneyMap();
                        if (btn.dataset.tab === 'insights') this.showInsights();
                    });
                });
            },
            
            showStatistics() {
                const stats = {
                    timeSpent: Math.floor((Date.now() - visitorProfile.startTime) / 1000 / 60),
                    zonesVisited: visitorProfile.visitedZones.size,
                    ritualsCompleted: Object.keys(localStorage).filter(k => k.includes('ritual')).length,
                    mandalasCreated: JSON.parse(localStorage.getItem('mandalas') || '[]').length
                };
                
                // Отображение статистики
                const grid = document.getElementById('statsGrid');
                grid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.timeSpent}</div>
                        <div class="stat-label">минут в саду</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.zonesVisited}</div>
                        <div class="stat-label">зон посещено</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.ritualsCompleted}</div>
                        <div class="stat-label">ритуалов выполнено</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.mandalasCreated}</div>
                        <div class="stat-label">мандал создано</div>
                    </div>
                `;
                
                // График
                this.drawStatsChart();
            },
            
            drawStatsChart() {
                const canvas = document.getElementById('statsChart');
                const ctx = canvas.getContext('2d');
                
                // Пример данных для графика времени по зонам
                const zoneData = mandalaSystem.visitData.zones;
                const zones = Object.keys(zoneData);
                const times = Object.values(zoneData);
                
                if (zones.length === 0) return;
                
                // Очистка
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Параметры
                const maxTime = Math.max(...times);
                const barWidth = 60;
                const startX = 50;
                const startY = 350;
                
                // Отрисовка
                zones.forEach((zone, i) => {
                    const x = startX + i * (barWidth + 20);
                    const height = (times[i] / maxTime) * 250;
                    const y = startY - height;
                    
                    ctx.fillStyle = '#ffd700';
                    ctx.fillRect(x, y, barWidth, height);
                    
                    // Подпись
                    ctx.save();
                    ctx.translate(x + barWidth / 2, startY + 10);
                    ctx.rotate(-Math.PI / 4);
                    ctx.fillStyle = '#e0e0e0';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'right';
                    ctx.fillText(zone.substring(0, 15), 0, 0);
                    ctx.restore();
                });
            },
            
            showPatterns() {
                const content = document.getElementById('patternsContent');
                content.innerHTML = '<h4>Анализ паттернов вашего путешествия:</h4>';
                
                // Анализ последовательности посещений
                const paths = mandalaSystem.visitData.paths;
                
                if (paths.length > 2) {
                    // Поиск повторяющихся паттернов
                    const patterns = {};
                    for (let i = 0; i < paths.length - 1; i++) {
                        const pattern = `${paths[i]} → ${paths[i + 1]}`;
                        patterns[pattern] = (patterns[pattern] || 0) + 1;
                    }
                    
                    const repeated = Object.entries(patterns).filter(([_, count]) => count > 1);
                    
                    if (repeated.length > 0) {
                        content.innerHTML += '<p><strong>Повторяющиеся переходы:</strong></p><ul>';
                        repeated.forEach(([pattern, count]) => {
                            content.innerHTML += `<li>${pattern} (${count} раз)</li>`;
                        });
                        content.innerHTML += '</ul>';
                    }
                }
                
                // Анализ времени суток
                const hour = new Date().getHours();
                const timeOfDay = hour < 6 ? 'ночь' : hour < 12 ? 'утро' : hour < 18 ? 'день' : 'вечер';
                
                content.innerHTML += `<p><strong>Время посещения:</strong> ${timeOfDay} - это влияет на ваше восприятие символов.</p>`;
            },
            
            showJourneyMap() {
                // Визуализация пути через сад
                const canvas = document.getElementById('journeyMap');
                const ctx = canvas.getContext('2d');
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Рисуем карту путешествия
                const centerX = 350;
                const centerY = 250;
                
                // Основные зоны
                const zones = [
                    { name: 'Центр', x: centerX, y: centerY, visited: false },
                    { name: 'Круг', x: centerX - 150, y: centerY - 100, visited: false },
                    { name: 'Террасы', x: centerX + 150, y: centerY - 100, visited: false },
                    { name: 'Лабиринт', x: centerX - 150, y: centerY + 100, visited: false },
                    { name: 'Врата', x: centerX + 150, y: centerY + 100, visited: false }
                ];
                
                // Отметка посещённых
                visitorProfile.visitedZones.forEach(zoneId => {
                    zones.forEach(zone => {
                        if (zoneId.includes(zone.name.toLowerCase())) {
                            zone.visited = true;
                        }
                    });
                });
                
                // Отрисовка зон
                zones.forEach(zone => {
                    ctx.beginPath();
                    ctx.arc(zone.x, zone.y, 40, 0, Math.PI * 2);
                    ctx.fillStyle = zone.visited ? '#ffd700' : '#333';
                    ctx.fill();
                    ctx.strokeStyle = '#ffd700';
                    ctx.stroke();
                    
                    ctx.fillStyle = zone.visited ? '#1a1a2e' : '#e0e0e0';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(zone.name, zone.x, zone.y);
                });
                
                // Линии пути
                const visitedZones = zones.filter(z => z.visited);
                if (visitedZones.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(visitedZones[0].x, visitedZones[0].y);
                    visitedZones.slice(1).forEach(zone => {
                        ctx.lineTo(zone.x, zone.y);
                    });
                    ctx.strokeStyle = '#ffd70080';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
            },
            
            showInsights() {
                const content = document.getElementById('insightsContent');
                const visitorType = visitorProfile.currentType;
                const visitedCount = visitorProfile.visitedZones.size;
                
                let insights = '<h4>Персональные инсайты:</h4>';
                
                // Инсайты на основе типа посетителя
                if (visitorType === 'pilgrim' && visitedCount > 3) {
                    insights += '<p>🕊️ <strong>Путь пилигрима:</strong> Ваше духовное путешествие раскрывает глубинные связи между традициями. Продолжайте следовать внутреннему зову.</p>';
                }
                
                if (visitorType === 'scholar' && localStorage.getItem('concordanceSearches')) {
                    insights += '<p>📚 <strong>Исследовательский подход:</strong> Ваш аналитический ум находит неочевидные параллели. База согласований раскрывает новые измерения понимания.</p>';
                }
                
                if (visitorType === 'mystic' && localStorage.getItem('meditationTime')) {
                    insights += '<p>🌙 <strong>Мистическое погружение:</strong> Медитативные практики открывают врата к прямому переживанию единства всех традиций.</p>';
                }
                
                if (visitorType === 'artist' && localStorage.getItem('mandalas')) {
                    insights += '<p>🎨 <strong>Творческое видение:</strong> Ваши мандалы отражают уникальное восприятие космической гармонии.</p>';
                }
                
                // Общие инсайты
                if (visitedCount === 5) {
                    insights += '<p>⭐ <strong>Полное путешествие:</strong> Вы прошли через все основные пространства сада. Теперь вы готовы к глубинной интеграции опыта.</p>';
                }
                
                content.innerHTML = insights;
            }
        };

        // Инициализация новых систем
        document.addEventListener('DOMContentLoaded', () => {
            analysisTools.initTabs();
        });

        // Добавление стилей для новых элементов
        const additionalStyles = document.createElement('style');
        additionalStyles.textContent = `
        .connection-path {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .path-steps {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .step {
            background: rgba(255, 215, 0, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 1px solid var(--gold);
        }
        `;
        document.head.appendChild(additionalStyles);

    </script>
</body>
</html>