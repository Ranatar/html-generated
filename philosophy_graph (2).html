<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Расширенный граф философских концепций</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            overflow: hidden;
        }

        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #graph {
            width: 100%;
            height: 100%;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            filter: brightness(1.3);
        }

        .node circle {
            stroke-width: 3px;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.4));
        }

        .node.dimmed {
            opacity: 0.2;
        }

        .node.highlighted {
            opacity: 1;
        }

        .node.highlighted circle {
            stroke-width: 5px;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.8));
        }

        .node.selected circle {
            stroke-width: 6px;
            stroke: #ffd700 !important;
            filter: drop-shadow(0 0 15px #ffd700);
        }

        .node text {
            font-size: 10px;
            font-weight: 600;
            pointer-events: none;
            text-shadow: 0 0 4px black, 0 0 4px black, 0 0 4px black;
            fill: #fff;
        }

        .link {
            fill: none;
            stroke-width: 2px;
            opacity: 0.4;
            transition: opacity 0.3s, stroke-width 0.3s;
        }

        .link:hover {
            opacity: 0.9;
            stroke-width: 3.5px;
        }

        .link.dimmed {
            opacity: 0.1;
        }

        .link.highlighted {
            opacity: 1;
            stroke-width: 4px;
            filter: drop-shadow(0 0 5px currentColor);
        }

        .link.bidirectional {
            stroke-dasharray: 5, 5;
        }

        #legend {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.97);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            max-width: 340px;
            backdrop-filter: blur(10px);
            max-height: 85vh;
            overflow-y: auto;
        }
        
        #legend h3 {
            margin: 0 0 15px 0;
            color: #1a1a2e;
            font-size: 19px;
            border-bottom: 3px solid #6c5ce7;
            padding-bottom: 10px;
        }
        
        .legend-section {
            margin-bottom: 18px;
        }
        
        .legend-section h4 {
            margin: 0 0 10px 0;
            color: #2d3436;
            font-size: 13px;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Стили для radio buttons */
        .legend-item input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #6c5ce7;
        }
        
        .filter-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .filter-controls button {
            flex: 1;
            background: #95a5a6;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .filter-controls button:hover {
            background: #7f8c8d;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .legend-item:hover {
            background: rgba(108, 92, 231, 0.1);
        }
        
        .legend-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #6c5ce7;
        }
        
        .legend-item label {
            cursor: pointer;
            font-size: 11px;
            color: #2d3436;
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #2d3436;
            flex-shrink: 0;
        }
        
        .legend-line {
            width: 35px;
            height: 2.5px;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .filter-stats {
            font-size: 10px;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }
        
        #legend::-webkit-scrollbar {
            width: 6px;
        }
        
        #legend::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        
        #legend::-webkit-scrollbar-thumb {
            background: #6c5ce7;
            border-radius: 10px;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.92);
            color: white;
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
            max-width: 280px;
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 1000;
        }

        .tooltip strong {
            font-size: 15px;
            display: block;
            margin-bottom: 5px;
            color: #a29bfe;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.97);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        #controls button {
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin: 3px;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s;
        }

        #controls button:hover {
            background: #5f4fd1;
        }

        #controls button.active {
            background: #00b894;
        }

        #info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.97);
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 13px;
            color: #2d3436;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            font-weight: 500;
        }
        
        #detailModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.92);
            color: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
            max-width: 550px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 2000;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        #detailModal.show {
            display: block;
        }
        
        #modalOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
        }
        
        #modalOverlay.show {
            display: block;
        }
        
        #detailModal h2 {
            margin: 0 0 8px 0;
            color: #a29bfe;
            font-size: 22px;
            font-weight: 600;
        }
        
        #detailModal .philosopher-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            margin-bottom: 12px;
            opacity: 0.9;
        }
        
        #detailModal .description {
            color: #e0e0e0;
            margin-bottom: 18px;
            line-height: 1.5;
            font-size: 13px;
        }
        
        #detailModal .rubric-section {
            background: rgba(255, 255, 255, 0.08);
            padding: 18px;
            border-radius: 10px;
            border-left: 3px solid #a29bfe;
        }
        
        #detailModal .rubric-title {
            font-size: 15px;
            font-weight: 700;
            color: #a29bfe;
            margin-bottom: 6px;
        }
        
        #detailModal .rubric-description {
            font-size: 12px;
            color: #b0b0b0;
            margin-bottom: 14px;
            font-style: italic;
        }
        
        #detailModal .related-concepts {
            margin-top: 12px;
        }
        
        #detailModal .related-title {
            font-size: 13px;
            font-weight: 700;
            color: #e0e0e0;
            margin-bottom: 8px;
        }
        
        #detailModal .concept-item {
            display: flex;
            align-items: center;
            padding: 7px 10px;
            margin: 4px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #detailModal .concept-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
            border-color: rgba(162, 155, 254, 0.4);
        }
        
        #detailModal .concept-color {
            width: 11px;
            height: 11px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
            box-shadow: 0 0 8px currentColor;
        }
        
        #detailModal .concept-name {
            font-size: 13px;
            color: #e0e0e0;
            flex-grow: 1;
        }
        
        #detailModal .concept-philosopher {
            font-size: 10px;
            color: #a0a0a0;
            font-style: italic;
        }
        
        #detailModal .close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            transition: all 0.2s;
        }
        
        #detailModal .close-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg);
        }
        
        #detailModal::-webkit-scrollbar {
            width: 6px;
        }
        
        #detailModal::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        #detailModal::-webkit-scrollbar-thumb {
            background: #a29bfe;
            border-radius: 10px;
        }
        
        #detailModal::-webkit-scrollbar-thumb:hover {
            background: #8b7fe6;
        }
        
        /* Панель поиска пути */
        #pathFinder {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.97);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            max-width: 320px;
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        
        #pathFinder h3 {
            margin: 0 0 15px 0;
            color: #1a1a2e;
            font-size: 17px;
            border-bottom: 3px solid #e74c3c;
            padding-bottom: 10px;
        }
        
        .path-select-group {
            margin-bottom: 15px;
        }
        
        .path-select-group label {
            display: block;
            font-size: 12px;
            font-weight: 700;
            color: #2d3436;
            margin-bottom: 5px;
        }
        
        .path-select-group select {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #dfe6e9;
            border-radius: 8px;
            font-size: 12px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .path-select-group select:focus {
            outline: none;
            border-color: #e74c3c;
        }
        
        #findPathBtn {
            width: 100%;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
            margin-bottom: 10px;
        }
        
        #findPathBtn:hover {
            background: #c0392b;
        }
        
        #pathResult {
            margin-top: 15px;
            padding: 12px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            border-left: 3px solid #e74c3c;
            display: none;
        }
        
        #pathResult.show {
            display: block;
        }
        
        #pathResult .path-length {
            font-size: 12px;
            font-weight: 700;
            color: #e74c3c;
            margin-bottom: 8px;
        }
        
        #pathResult .path-chain {
            font-size: 11px;
            color: #2d3436;
            line-height: 1.6;
        }
        
        #pathResult .path-node {
            display: inline-block;
            padding: 3px 8px;
            background: white;
            border-radius: 4px;
            margin: 2px;
            border: 1px solid #e74c3c;
        }
        
        #pathResult .path-arrow {
            color: #e74c3c;
            margin: 0 5px;
        }
        
        /* Панель статистики */
        #statsPanel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.97);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            max-width: 320px;
            max-height: 450px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        #statsPanel h3 {
            margin: 0 0 15px 0;
            color: #1a1a2e;
            font-size: 17px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        .stats-section {
            margin-bottom: 20px;
        }
        
        .stats-section h4 {
            font-size: 13px;
            font-weight: 700;
            color: #2d3436;
            margin: 0 0 10px 0;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin: 4px 0;
            background: rgba(52, 152, 219, 0.08);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .stat-item:hover {
            background: rgba(52, 152, 219, 0.18);
            transform: translateX(3px);
        }
        
        .stat-rank {
            font-size: 13px;
            font-weight: 700;
            color: #3498db;
            min-width: 25px;
        }
        
        .stat-name {
            flex-grow: 1;
            font-size: 11px;
            color: #2d3436;
        }
        
        .stat-value {
            font-size: 11px;
            font-weight: 600;
            color: #7f8c8d;
        }
        
        .stat-philosopher {
            font-size: 9px;
            color: #95a5a6;
            font-style: italic;
            margin-left: 5px;
        }
        
        #statsPanel::-webkit-scrollbar {
            width: 6px;
        }
        
        #statsPanel::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        
        #statsPanel::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 10px;
        }
        
        /* Улучшенные связи с весами */
        .link.weight-weak {
            stroke-width: 2px;
        }
        
        .link.weight-medium {
            stroke-width: 3px;
        }
        
        .link.weight-strong {
            stroke-width: 5px;
        }
        
        .link.path-highlight {
            stroke-width: 6px !important;
            opacity: 1 !important;
            filter: drop-shadow(0 0 8px currentColor);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* Стили для внутренних противоречий */
        .link.internal-contradiction {
            stroke-dasharray: 8, 4;
            animation: dash 20s linear infinite;
        }
        
        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }
        
        /* Легенда весов */
        .weight-legend {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }
        
        .weight-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 10px;
            color: #7f8c8d;
        }
        
        .weight-line {
            height: 2px;
            margin-right: 10px;
            background: #95a5a6;
            flex-shrink: 0;
        }
        
        .weight-line.weak { width: 20px; height: 2px; }
        .weight-line.medium { width: 20px; height: 3px; }
        .weight-line.strong { width: 20px; height: 5px; }
        
    </style>
</head>
<body>
    <div id="container">
        <svg id="graph"></svg>
        
        <div id="modalOverlay"></div>
            <div id="detailModal">
                <button class="close-btn" onclick="closeDetailModal()">×</button>
                <div id="modalContent"></div>
            </div>
        
        <div id="legend">
            <h3>🔍 Фильтры и легенда</h3>
            
            <div class="legend-section">
                <h4>
                    <span>Философы:</span>
                </h4>
                <div class="filter-controls">
                    <button onclick="selectAllPhilosophers()">Все</button>
                    <button onclick="deselectAllPhilosophers()">Сбросить</button>
                </div>
                <div id="philosopherFilters"></div>
            </div>
        
            <div class="legend-section">
                <h4>
                    <span>Режим фильтрации:</span>
                </h4>
                <div class="legend-item">
                    <input type="radio" id="filterAll" name="filterMode" value="all" checked onchange="changeFilterMode('all')">
                    <label for="filterAll" style="font-size: 11px;">
                        <span>Только выбранные философы</span>
                    </label>
                </div>
                <div class="legend-item">
                    <input type="radio" id="filterInternal" name="filterMode" value="internal" onchange="changeFilterMode('internal')">
                    <label for="filterInternal" style="font-size: 11px;">
                        <span>Только внутренние связи</span>
                    </label>
                </div>
                <div class="legend-item">
                    <input type="radio" id="filterContext" name="filterMode" value="context" onchange="changeFilterMode('context')">
                    <label for="filterContext" style="font-size: 11px;">
                        <span>С соседними узлами</span>
                    </label>
                </div>
                <div style="font-size: 10px; color: #7f8c8d; margin-top: 8px; padding: 8px; background: rgba(108, 92, 231, 0.05); border-radius: 5px; line-height: 1.4;">
                    <strong>Режимы:</strong><br>
                    • <em>Только выбранные</em> - узлы и связи между ними<br>
                    • <em>Только внутренние</em> - связи внутри систем<br>
                    • <em>С соседними</em> - включая связанные узлы других философов
                </div>
            </div>
        
            <div class="legend-section">
                <h4>
                    <span>Типы связей:</span>
                </h4>
                <div class="filter-controls">
                    <button onclick="selectAllRelations()">Все</button>
                    <button onclick="deselectAllRelations()">Сбросить</button>
                </div>
                <div id="relationFilters"></div>
                <div class="weight-legend">
                    <div class="weight-item">
                        <div class="weight-line weak"></div>
                        <span>Слабое влияние</span>
                    </div>
                    <div class="weight-item">
                        <div class="weight-line medium"></div>
                        <span>Среднее влияние</span>
                    </div>
                    <div class="weight-item">
                        <div class="weight-line strong"></div>
                        <span>Сильное влияние</span>
                    </div>
                </div>
            </div>
        
            <div class="filter-stats" id="filterStats">
                Показано: все концепции и связи
            </div>
        </div>
        
        <!-- Панель поиска пути -->
        <div id="pathFinder">
            <h3>🔍 Путь между концепциями</h3>
            <div class="path-select-group">
                <label for="sourceSelect">От концепции:</label>
                <select id="sourceSelect">
                    <option value="">Выберите концепцию...</option>
                </select>
            </div>
            <div class="path-select-group">
                <label for="targetSelect">К концепции:</label>
                <select id="targetSelect">
                    <option value="">Выберите концепцию...</option>
                </select>
            </div>
            <button id="findPathBtn" onclick="findAndShowPath()">Найти путь</button>
            
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dfe6e9;">
                <div style="font-size: 11px; margin-bottom: 8px;">
                    <label style="display: flex; align-items: center; margin-bottom: 5px; cursor: pointer;">
                        <input type="checkbox" id="respectChronology" checked style="margin-right: 8px;">
                        <span>Учитывать хронологию</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="respectDirection" checked style="margin-right: 8px;">
                        <span>Учитывать направленность связей</span>
                    </label>
                </div>
            </div>
            
            <div id="pathResult"></div>
        </div>
        
        <!-- Панель статистики -->
        <div id="statsPanel">
            <h3>📊 Аналитика графа</h3>
            <div class="stats-section">
                <h4>Самые влиятельные концепции:</h4>
                <div id="topConcepts"></div>
            </div>
            <div class="stats-section">
                <h4>Узлы-мосты (betweenness):</h4>
                <div id="bridgeNodes"></div>
            </div>
        </div>

        <div id="controls">
            <button onclick="resetSimulation()">🔄 Перезапустить</button>
            <button onclick="centerGraph()">🎯 Центрировать</button>
            <button id="groupBtn" onclick="toggleGrouping()">📦 Группировать</button>
            <div id="exportButtons">
                <button onclick="exportToPNG()">💾 PNG</button>
                <button onclick="exportToSVG()">💾 SVG</button>
            </div>
        </div>

        <div id="info">
            💡 Клик - подсветка • Ctrl+клик - множественный выбор • Двойной клик - детали • Перетаскивайте • Колесо - масштаб
        </div>

        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        const philosopherConcepts = {
            "Сократ": { color: "#e74c3c", years: "469-399 до н.э." },
            "Платон": { color: "#c0392b", years: "428-348 до н.э." },
            "Аристотель": { color: "#3498db", years: "384-322 до н.э." },
            "Августин": { color: "#8e44ad", years: "354-430" },
            "Фома Аквинский": { color: "#9b59b6", years: "1225-1274" },
            "Декарт": { color: "#2ecc71", years: "1596-1650" },
            "Спиноза": { color: "#27ae60", years: "1632-1677" },
            "Лейбниц": { color: "#16a085", years: "1646-1716" },
            "Юм": { color: "#1abc9c", years: "1711-1776" },
            "Кант": { color: "#f39c12", years: "1724-1804" },
            "Фихте": { color: "#d35400", years: "1762-1814" },
            "Гегель": { color: "#e67e22", years: "1770-1831" },
            "Шопенгауэр": { color: "#95a5a6", years: "1788-1860" },
            "Кьеркегор": { color: "#7f8c8d", years: "1813-1855" },
            "Маркс": { color: "#c0392b", years: "1818-1883" },
            "Ницше": { color: "#2c3e50", years: "1844-1900" },
            "Гуссерль": { color: "#34495e", years: "1859-1938" },
            "Хайдеггер": { color: "#e67e22", years: "1889-1976" },
            "Витгенштейн": { color: "#2980b9", years: "1889-1951" },
            "Сартр": { color: "#8e44ad", years: "1905-1980" },
            "Фуко": { color: "#16a085", years: "1926-1984" },
            "Делёз": { color: "#27ae60", years: "1925-1995" }
        };
        
        // Порядковые номера для хронологического сравнения
        const philosopherOrder = {
            "Сократ": -469,
            "Платон": -428,
            "Аристотель": -384,
            "Августин": 354,
            "Фома Аквинский": 1225,
            "Декарт": 1596,
            "Спиноза": 1632,
            "Лейбниц": 1646,
            "Юм": 1711,
            "Кант": 1724,
            "Фихте": 1762,
            "Гегель": 1770,
            "Шопенгауэр": 1788,
            "Кьеркегор": 1813,
            "Маркс": 1818,
            "Ницше": 1844,
            "Гуссерль": 1859,
            "Хайдеггер": 1889,
            "Витгенштейн": 1889,
            "Сартр": 1905,
            "Делёз": 1925,
            "Фуко": 1926
        };
        const relationTypes = {
            "oppose": { color: "#e74c3c", label: "противопоставление" },
            "ground": { color: "#3498db", label: "обосновывает" },
            "develop": { color: "#2ecc71", label: "развивает" },
            "critique": { color: "#f39c12", label: "критикует" },
            "synthesize": { color: "#9b59b6", label: "синтезирует" },
            "influence": { color: "#1abc9c", label: "влияет" },
            "dialogue": { color: "#95a5a6", label: "диалог" },
            "internal_contradiction": { color: "#e74c3c", label: "внутреннее противоречие" }
        };
        // Рубрики для группировки концепций
        const rubrics = {
            "Бытие/Существование": {
                concepts: ["form", "matter_ar", "categories", "essence_existence", "substance_spinoza", "modes", 
                           "thing_itself", "phenomenon", "sein", "dasein", "existence", "in_itself", "for_itself", "act_potency", "das_man"],
                description: "Фундаментальные вопросы о природе реальности и существования"
            },
            "Свобода": {
                concepts: ["autonomy", "determinism", "striving", "absolute_ego", "freedom_sartre", 
                           "bad_faith", "will_power", "anxiety", "leap_faith"],
                description: "Природа человеческой свободы и её ограничений"
            },
            "Истина/Познание": {
                concepts: ["maieutics", "know_nothing", "ideas", "eidos", "anamnesis", "cave",
                           "clear_distinct", "innate_ideas", "impressions", "ideas_hume", "causality_critique",
                           "apriori", "synthetic_apriori", "transcendental", "aletheia", "perspectivism",
                           "intentionality", "epoché", "eidetic", "picture_theory", "limits_language", "eros", "antinomies"],
                description: "Вопросы познания, истины и её критериев"
            },
            "Субъект/Сознание/Я": {
                concepts: ["soul", "cogito", "res_cogitans", "bundle_theory", "absolute_ego", "non_ego", 
                           "transcendental_ego", "dasein", "for_itself", "nothingness"],
                description: "Природа сознания, самосознания и субъективности"
            },
            "Тело/Материя": {
                concepts: ["matter_ar", "res_extensa", "substance_spinoza", "attributes", 
                           "representation", "body_without_organs"],
                description: "Материальное измерение реальности"
            },
            "Время": {
                concepts: ["time_augustine", "sein_zum_tode", "eternal_return"],
                description: "Природа времени и темпоральности"
            },
            "Мораль/Этика": {
                concepts: ["virtue_knowledge", "care_soul", "golden_mean", "grace", "original_sin",
                           "natural_law", "categorical", "is_ought", "master_morality", "slave_morality",
                           "compassion", "care_self", "ressentiment"],
                description: "Вопросы добра, зла и правильного действия"
            },
            "Власть/Политика": {
                concepts: ["ideal_state", "two_cities", "praxis", "class_struggle", "base_superstructure",
                           "alienation", "ideology", "power_knowledge", "discipline", "biopower"],
                description: "Социальные и политические отношения"
            },
            "Язык": {
                concepts: ["language_game", "picture_theory", "limits_language", "family_resemblance",
                           "form_of_life", "archaeology", "episteme"],
                description: "Роль языка в познании и коммуникации"
            },
            "Бог/Абсолют": {
                concepts: ["demiurge", "unmoved_mover", "grace", "faith_reason", "five_ways",
                           "substance_spinoza", "intellectual_love", "absolute_idea", "weltgeist",
                           "god_dead", "good"],
                description: "Божественное, абсолютное и метафизическое"
            },
            "Диалектика/Процесс": {
                concepts: ["dialectic", "aufhebung", "master_slave", "cunning_reason",
                           "difference", "deterritorialization", "rhizome", "entfremdung"],
                description: "Динамика развития и преобразования"
            },
            "Воля/Желание": {
                concepts: ["conatus", "will_schop", "denial_will", "will_power", "desiring_machines", "dionysian", "apollonian"],
                description: "Волевое и желающее измерение существования"
            },
            "Метод": {
                concepts: ["maieutics", "method", "epoché", "archaeology"],
                description: "Философские методы и подходы"
            }
        };

        // Создаём обратный индекс: концепция -> рубрика
        const conceptToRubric = {};
        Object.keys(rubrics).forEach(rubricName => {
            rubrics[rubricName].concepts.forEach(conceptId => {
                conceptToRubric[conceptId] = rubricName;
            });
        });

        const nodes = [
            // Сократ
            { id: "maieutics", label: "Майевтика", concept: "Сократ", description: "Метод извлечения знания через вопросы" },
            { id: "know_nothing", label: "Знаю, что ничего не знаю", concept: "Сократ", description: "Осознание границ собственного знания" },
            { id: "virtue_knowledge", label: "Добродетель = знание", concept: "Сократ", description: "Единство морали и познания" },
            { id: "daimonion", label: "Даймоний", concept: "Сократ", description: "Внутренний голос совести" },
            { id: "care_soul", label: "Забота о душе", concept: "Сократ", description: "Приоритет духовного развития" },
            { id: "soul", label: "Душа", concept: "Сократ", description: "Бессмертная сущность человека, объект заботы" },

            
            // Платон
            { id: "ideas", label: "Мир идей", concept: "Платон", description: "Вечный мир совершенных форм" },
            { id: "eidos", label: "Эйдос", concept: "Платон", description: "Идеальная сущность вещи" },
            { id: "anamnesis", label: "Анамнесис", concept: "Платон", description: "Воспоминание души об идеях" },
            { id: "demiurge", label: "Демиург", concept: "Платон", description: "Творец материального мира" },
            { id: "cave", label: "Миф о пещере", concept: "Платон", description: "Аллегория познания истины" },
            { id: "ideal_state", label: "Идеальное государство", concept: "Платон", description: "Справедливое политическое устройство" },
            { id: "tripartite_soul", label: "Трёхчастная душа", concept: "Платон", description: "Разум, воля, чувства" },
            { id: "good", label: "Благо", concept: "Платон", description: "Высшая идея, источник бытия и познания" },
            { id: "eros", label: "Эрос", concept: "Платон", description: "Любовное восхождение к прекрасному и истине" },
            { id: "methexis", label: "Метексис", concept: "Платон", description: "Участие вещей в идеях, связь между мирами" },
            { id: "mimesis", label: "Мимесис", concept: "Платон", description: "Подражание, копирование идей" },
            { id: "chora", label: "Хора", concept: "Платон", description: "Пространство-вместилище, восприемница становления" },

            
            // Аристотель
            { id: "form", label: "Форма", concept: "Аристотель", description: "Активное начало, определяющее вещь" },
            { id: "matter_ar", label: "Материя", concept: "Аристотель", description: "Пассивное начало, субстрат" },
            { id: "entelechy", label: "Энтелехия", concept: "Аристотель", description: "Внутренняя цель, осуществление" },
            { id: "four_causes", label: "Четыре причины", concept: "Аристотель", description: "Материальная, формальная, движущая, целевая" },
            { id: "unmoved_mover", label: "Перводвигатель", concept: "Аристотель", description: "Неподвижный источник движения" },
            { id: "golden_mean", label: "Золотая середина", concept: "Аристотель", description: "Этический принцип умеренности" },
            { id: "categories", label: "Категории", concept: "Аристотель", description: "Основные роды бытия" },
            { id: "act_potency", label: "Акт и потенция", concept: "Аристотель", description: "Энергия и возможность: фундаментальная пара бытия" },
            { id: "phronesis", label: "Phronesis", concept: "Аристотель", description: "Практическая мудрость, благоразумие" },
            { id: "eudaimonia", label: "Eudaimonia", concept: "Аристотель", description: "Благоденствие, счастье как цель жизни" },
            { id: "logos", label: "Логос", concept: "Аристотель", description: "Разумное начало, слово, принцип" },

            
            // Августин
            { id: "grace", label: "Благодать", concept: "Августин", description: "Божественная милость к человеку" },
            { id: "original_sin", label: "Первородный грех", concept: "Августин", description: "Наследственная греховность" },
            { id: "two_cities", label: "Два града", concept: "Августин", description: "Град Божий и град земной" },
            { id: "time_augustine", label: "Время", concept: "Августин", description: "Растяжение души" },
            { id: "confession", label: "Исповедь", concept: "Августин", description: "Путь к Богу через самопознание" },
            { id: "faith_reason", label: "Вера и разум", concept: "Августин", description: "Верю, чтобы понимать" },
            
            // Фома Аквинский
            { id: "essence_existence", label: "Сущность и существование", concept: "Фома Аквинский", description: "Различение эссенции и экзистенции" },
            { id: "five_ways", label: "Пять путей", concept: "Фома Аквинский", description: "Доказательства бытия Бога" },
            { id: "natural_law", label: "Естественный закон", concept: "Фома Аквинский", description: "Рациональная основа морали" },
            { id: "analogy", label: "Аналогия бытия", concept: "Фома Аквинский", description: "Подобие между Богом и творением" },
            { id: "thomistic_synthesis", label: "Синтез Аристотеля", concept: "Фома Аквинский", description: "Христианизация философии Аристотеля" },
            { id: "accidents", label: "Акциденции", concept: "Фома Аквинский", description: "Несущественные свойства субстанции" },
            { id: "actual_being", label: "Актуальное бытие", concept: "Фома Аквинский", description: "Реализованное существование" },
            { id: "participatio", label: "Participatio", concept: "Фома Аквинский", description: "Участие творения в божественном бытии" },
            
            // Декарт
            { id: "cogito", label: "Cogito ergo sum", concept: "Декарт", description: "Я мыслю, следовательно существую" },
            { id: "dualism", label: "Дуализм", concept: "Декарт", description: "Разделение мышления и протяжения" },
            { id: "res_cogitans", label: "Res cogitans", concept: "Декарт", description: "Мыслящая субстанция" },
            { id: "res_extensa", label: "Res extensa", concept: "Декарт", description: "Протяженная субстанция" },
            { id: "method", label: "Метод сомнения", concept: "Декарт", description: "Радикальный скептицизм как путь к истине" },
            { id: "clear_distinct", label: "Ясные и отчётливые идеи", concept: "Декарт", description: "Критерий истинности" },
            { id: "innate_ideas", label: "Врождённые идеи", concept: "Декарт", description: "Априорное знание" },
            
            // Спиноза
            { id: "substance_spinoza", label: "Субстанция", concept: "Спиноза", description: "Бог или природа (Deus sive Natura)" },
            { id: "modes", label: "Модусы", concept: "Спиноза", description: "Проявления единой субстанции" },
            { id: "attributes", label: "Атрибуты", concept: "Спиноза", description: "Мышление и протяжение" },
            { id: "conatus", label: "Conatus", concept: "Спиноза", description: "Стремление к самосохранению" },
            { id: "intellectual_love", label: "Интеллектуальная любовь", concept: "Спиноза", description: "Amor Dei intellectualis" },
            { id: "determinism", label: "Детерминизм", concept: "Спиноза", description: "Необходимость всего существующего" },
            { id: "natura_naturans", label: "Natura naturans", concept: "Спиноза", description: "Природа творящая, Бог как активная причина" },
            { id: "natura_naturata", label: "Natura naturata", concept: "Спиноза", description: "Природа сотворённая, следствия субстанции" },
            { id: "adequate_ideas", label: "Адекватные идеи", concept: "Спиноза", description: "Истинное, полное познание" },
            
            // Лейбниц
            { id: "monads", label: "Монады", concept: "Лейбниц", description: "Простые неделимые субстанции" },
            { id: "preestablished", label: "Предустановленная гармония", concept: "Лейбниц", description: "Согласованность монад" },
            { id: "best_worlds", label: "Лучший из миров", concept: "Лейбниц", description: "Теодицея" },
            { id: "petites_perceptions", label: "Малые перцепции", concept: "Лейбниц", description: "Бессознательные восприятия" },
            { id: "sufficient_reason", label: "Достаточное основание", concept: "Лейбниц", description: "Принцип рациональности" },
            { id: "apperception", label: "Апперцепция", concept: "Лейбниц", description: "Осознанное восприятие, рефлексивное сознание" },
            { id: "continuity", label: "Принцип непрерывности", concept: "Лейбниц", description: "Natura non facit saltus - природа не делает скачков" },
            
            // Юм
            { id: "impressions", label: "Впечатления", concept: "Юм", description: "Первичные чувственные данные" },
            { id: "ideas_hume", label: "Идеи", concept: "Юм", description: "Копии впечатлений" },
            { id: "causality_critique", label: "Критика причинности", concept: "Юм", description: "Привычка, не необходимость" },
            { id: "bundle_theory", label: "Теория пучка", concept: "Юм", description: "Я как связка восприятий" },
            { id: "is_ought", label: "Гильотина Юма", concept: "Юм", description: "Разрыв между сущим и должным" },
            { id: "custom", label: "Привычка", concept: "Юм", description: "Основа веры и ожиданий" },
            
            // Кант
            { id: "thing_itself", label: "Вещь в себе", concept: "Кант", description: "Непознаваемая сущность" },
            { id: "phenomenon", label: "Феномен", concept: "Кант", description: "Явление для нас" },
            { id: "categorical", label: "Категорический императив", concept: "Кант", description: "Безусловный моральный закон" },
            { id: "apriori", label: "Априорные формы", concept: "Кант", description: "Врожденные структуры познания" },
            { id: "synthetic_apriori", label: "Синтетические априори", concept: "Кант", description: "Расширяющие априорные суждения" },
            { id: "transcendental", label: "Трансцендентальное", concept: "Кант", description: "Условия возможности опыта" },
            { id: "autonomy", label: "Автономия воли", concept: "Кант", description: "Самозаконодательство разума" },
            { id: "antinomies", label: "Антиномии", concept: "Кант", description: "Противоречия чистого разума при выходе за опыт" },
            { id: "sublime", label: "Возвышенное", concept: "Кант", description: "Эстетическая категория безграничного" },
            { id: "postulates", label: "Постулаты практического разума", concept: "Кант", description: "Бог, бессмертие души, свобода воли" },
            { id: "aesthetic_judgment", label: "Эстетическое суждение", concept: "Кант", description: "Суждение вкуса, незаинтересованное удовольствие" },
            
            // Фихте
            { id: "absolute_ego", label: "Абсолютное Я", concept: "Фихте", description: "Самополагающее сознание" },
            { id: "non_ego", label: "Не-Я", concept: "Фихте", description: "Противоположность Я" },
            { id: "tathandlung", label: "Татхандлунг", concept: "Фихте", description: "Действие-поступок Я" },
            { id: "striving", label: "Стремление", concept: "Фихте", description: "Бесконечная активность Я" },
            { id: "practical_primacy", label: "Примат практического", concept: "Фихте", description: "Приоритет действия над познанием" },
            { id: "imagination", label: "Продуктивное воображение", concept: "Фихте", description: "Einbildungskraft - синтезирующая способность Я" },
            { id: "wissenschaftslehre", label: "Наукоучение", concept: "Фихте", description: "Система философии как строгая наука" },
            
            // Гегель
            { id: "absolute_idea", label: "Абсолютная идея", concept: "Гегель", description: "Саморазвивающийся мировой дух" },
            { id: "dialectic", label: "Диалектика", concept: "Гегель", description: "Тезис-антитезис-синтез" },
            { id: "weltgeist", label: "Weltgeist", concept: "Гегель", description: "Мировой дух в истории" },
            { id: "aufhebung", label: "Aufhebung", concept: "Гегель", description: "Снятие противоречий" },
            { id: "master_slave", label: "Господин и раб", concept: "Гегель", description: "Диалектика признания" },
            { id: "objective_spirit", label: "Объективный дух", concept: "Гегель", description: "Дух в социальных институтах" },
            { id: "cunning_reason", label: "Хитрость разума", concept: "Гегель", description: "Самореализация духа через историю" },
            { id: "entfremdung", label: "Entfremdung", concept: "Гегель", description: "Отчуждение как необходимый момент развития духа" },
            { id: "negative", label: "Негативное", concept: "Гегель", description: "Движущая сила диалектики, отрицание" },
            { id: "concrete", label: "Конкретное", concept: "Гегель", description: "Единство многообразных определений" },
            { id: "abstract", label: "Абстрактное", concept: "Гегель", description: "Одностороннее, неполное определение" },
            
            // Шопенгауэр
            { id: "will_schop", label: "Мировая воля", concept: "Шопенгауэр", description: "Слепая иррациональная сила" },
            { id: "representation", label: "Представление", concept: "Шопенгауэр", description: "Мир как иллюзия" },
            { id: "suffering", label: "Страдание", concept: "Шопенгауэр", description: "Сущность жизни" },
            { id: "denial_will", label: "Отрицание воли", concept: "Шопенгауэр", description: "Путь к освобождению" },
            { id: "aesthetics_schop", label: "Эстетическое созерцание", concept: "Шопенгауэр", description: "Временное освобождение от воли" },
            { id: "compassion", label: "Сострадание", concept: "Шопенгауэр", description: "Основа морали" },
            { id: "individuation", label: "Principium individuationis", concept: "Шопенгауэр", description: "Принцип индивидуации, источник множественности" },
            
            // Кьеркегор
            { id: "stages_existence", label: "Стадии существования", concept: "Кьеркегор", description: "Эстетическая, этическая, религиозная" },
            { id: "leap_faith", label: "Прыжок веры", concept: "Кьеркегор", description: "Иррациональное решение" },
            { id: "anxiety", label: "Тревога", concept: "Кьеркегор", description: "Головокружение свободы" },
            { id: "despair", label: "Отчаяние", concept: "Кьеркегор", description: "Болезнь к смерти" },
            { id: "individual", label: "Единичный", concept: "Кьеркегор", description: "Противостояние толпе" },
            { id: "subjective_truth", label: "Субъективная истина", concept: "Кьеркегор", description: "Истина как страсть" },
            { id: "repetition", label: "Повторение", concept: "Кьеркегор", description: "Экзистенциальное возвращение, обретение себя" },
            { id: "moment", label: "Мгновение", concept: "Кьеркегор", description: "Atom вечности, встреча времени и вечного" },
            
            // Маркс
            { id: "praxis", label: "Праксис", concept: "Маркс", description: "Революционная практика" },
            { id: "alienation", label: "Отчуждение", concept: "Маркс", description: "Отчуждение труда" },
            { id: "base_superstructure", label: "Базис и надстройка", concept: "Маркс", description: "Экономика и идеология" },
            { id: "class_struggle", label: "Классовая борьба", concept: "Маркс", description: "Двигатель истории" },
            { id: "commodity_fetish", label: "Товарный фетишизм", concept: "Маркс", description: "Овеществление социальных отношений" },
            { id: "historical_materialism", label: "Исторический материализм", concept: "Маркс", description: "Материалистическое понимание истории" },
            { id: "ideology", label: "Идеология", concept: "Маркс", description: "Ложное сознание, маскирующее классовые интересы" },
            
            // Ницше
            { id: "will_power", label: "Воля к власти", concept: "Ницше", description: "Фундаментальная жизненная сила" },
            { id: "ubermensch", label: "Сверхчеловек", concept: "Ницше", description: "Преодолевший себя человек" },
            { id: "eternal_return", label: "Вечное возвращение", concept: "Ницше", description: "Циклическое повторение бытия" },
            { id: "god_dead", label: "Смерть Бога", concept: "Ницше", description: "Конец метафизических абсолютов" },
            { id: "perspectivism", label: "Перспективизм", concept: "Ницше", description: "Множественность интерпретаций" },
            { id: "master_morality", label: "Мораль господ", concept: "Ницше", description: "Аристократическая этика" },
            { id: "slave_morality", label: "Мораль рабов", concept: "Ницше", description: "Ресентимент слабых" },
            { id: "dionysian", label: "Дионисийское", concept: "Ницше", description: "Хаос, опьянение, жизненная стихия" },
            { id: "apollonian", label: "Аполлоническое", concept: "Ницше", description: "Порядок, мера, индивидуация" },
            { id: "ressentiment", label: "Ресентимент", concept: "Ницше", description: "Злоба бессильных, основа морали рабов" },
            
            // Гуссерль
            { id: "intentionality", label: "Интенциональность", concept: "Гуссерль", description: "Направленность сознания" },
            { id: "epoché", label: "Эпохе", concept: "Гуссерль", description: "Феноменологическая редукция" },
            { id: "lifeworld", label: "Жизненный мир", concept: "Гуссерль", description: "Дорефлективный опыт" },
            { id: "transcendental_ego", label: "Трансцендентальное Я", concept: "Гуссерль", description: "Чистое сознание" },
            { id: "eidetic", label: "Эйдетическая интуиция", concept: "Гуссерль", description: "Усмотрение сущностей" },
            { id: "noesis_noema", label: "Ноэзис-ноэма", concept: "Гуссерль", description: "Акт сознания и его предметное содержание" },
            { id: "constitution", label: "Конституирование", concept: "Гуссерль", description: "Созидание смысла сознанием" },
            { id: "intersubjectivity", label: "Интерсубъективность", concept: "Гуссерль", description: "Общность опыта субъектов" },
            
            // Хайдеггер
            { id: "dasein", label: "Dasein", concept: "Хайдеггер", description: "Человеческое бытие-в-мире" },
            { id: "sein", label: "Sein", concept: "Хайдеггер", description: "Бытие как таковое" },
            { id: "geworfenheit", label: "Geworfenheit", concept: "Хайдеггер", description: "Заброшенность в мир" },
            { id: "sorge", label: "Sorge", concept: "Хайдеггер", description: "Забота как основа бытия" },
            { id: "sein_zum_tode", label: "Sein-zum-Tode", concept: "Хайдеггер", description: "Бытие-к-смерти" },
            { id: "aletheia", label: "Aletheia", concept: "Хайдеггер", description: "Истина как несокрытость" },
            { id: "dwelling", label: "Обитание", concept: "Хайдеггер", description: "Аутентичное пребывание" },
            { id: "das_man", label: "Das Man", concept: "Хайдеггер", description: "Безличное 'они', неподлинное существование" },
            { id: "ereignis", label: "Ereignis", concept: "Хайдеггер", description: "Со-бытие, событие присвоения бытия" },
            { id: "geviert", label: "Четверица", concept: "Хайдеггер", description: "Das Geviert: земля, небо, божества, смертные" },
            { id: "kehre", label: "Поворот", concept: "Хайдеггер", description: "Die Kehre - поворот в мышлении бытия" },
            
            // Витгенштейн
            { id: "language_game", label: "Языковые игры", concept: "Витгенштейн", description: "Контекстуальное использование языка" },
            { id: "picture_theory", label: "Теория изображения", concept: "Витгенштейн", description: "Язык как картина мира" },
            { id: "limits_language", label: "Границы языка", concept: "Витгенштейн", description: "О чем невозможно говорить" },
            { id: "family_resemblance", label: "Семейное сходство", concept: "Витгенштейн", description: "Нечёткие категории" },
            { id: "form_of_life", label: "Форма жизни", concept: "Витгенштейн", description: "Практический контекст языка" },
            { id: "showing_saying", label: "Показывание vs говорение", concept: "Витгенштейн", description: "То, что может быть показано, не может быть сказано" },
            { id: "private_language", label: "Аргумент против приватного языка", concept: "Витгенштейн", description: "Невозможность чисто личного языка" },
            { id: "rule_following", label: "Следование правилу", concept: "Витгенштейн", description: "Проблема интерпретации правил" },
            
            // Сартр
            { id: "existence", label: "Существование", concept: "Сартр", description: "Первично перед сущностью" },
            { id: "nothingness", label: "Ничто", concept: "Сартр", description: "Источник свободы" },
            { id: "bad_faith", label: "Дурная вера", concept: "Сартр", description: "Самообман и бегство от свободы" },
            { id: "freedom_sartre", label: "Свобода", concept: "Сартр", description: "Осужденность быть свободным" },
            { id: "for_itself", label: "Для-себя-бытие", concept: "Сартр", description: "Сознание" },
            { id: "in_itself", label: "В-себе-бытие", concept: "Сартр", description: "Вещи без сознания" },
            { id: "look", label: "Взгляд Другого", concept: "Сартр", description: "Объективация через Другого" },
            { id: "project", label: "Проект", concept: "Сартр", description: "Человек как проектирование себя в будущее" },
            { id: "engagement", label: "Ангажированность", concept: "Сартр", description: "Вовлечённость, обязательство перед миром" },
            
            // Фуко
            { id: "power_knowledge", label: "Власть-знание", concept: "Фуко", description: "Неразрывность власти и знания" },
            { id: "episteme", label: "Эпистема", concept: "Фуко", description: "Исторические структуры знания" },
            { id: "discipline", label: "Дисциплина", concept: "Фуко", description: "Микрофизика власти" },
            { id: "biopower", label: "Биовласть", concept: "Фуко", description: "Власть над жизнью" },
            { id: "care_self", label: "Забота о себе", concept: "Фуко", description: "Этика самопреобразования" },
            { id: "archaeology", label: "Археология знания", concept: "Фуко", description: "Метод анализа дискурсов" },
            { id: "heterotopia", label: "Гетеротопия", concept: "Фуко", description: "Иные пространства, реальные утопии" },
            { id: "panopticon", label: "Паноптикум", concept: "Фуко", description: "Архитектура тотального надзора" },
            { id: "problematization", label: "Проблематизация", concept: "Фуко", description: "Превращение данности в вопрос" },
            
            // Делёз
            { id: "rhizome", label: "Ризома", concept: "Делёз", description: "Нелинейная структура" },
            { id: "difference", label: "Различие", concept: "Делёз", description: "Онтология множественности" },
            { id: "body_without_organs", label: "Тело без органов", concept: "Делёз", description: "Недифференцированная полнота" },
            { id: "desiring_machines", label: "Машины желания", concept: "Делёз", description: "Производство желания" },
            { id: "assemblage", label: "Ассамбляж", concept: "Делёз", description: "Множественное единство" },
            { id: "deterritorialization", label: "Детерриториализация", concept: "Делёз", description: "Разрушение структур" },
            { id: "virtual_actual", label: "Виртуальное-актуальное", concept: "Делёз", description: "Реальное, но не актуализированное" },
            { id: "event", label: "Событие", concept: "Делёз", description: "Чистое становление, смысл" },
            { id: "fold", label: "Складка", concept: "Делёз", description: "Le pli - складывание, барочная топология" }
        ];

        const links = [
            // Сократ → Платон
            { source: "maieutics", target: "anamnesis", type: "influence" },
            { source: "virtue_knowledge", target: "ideas", type: "influence" },
            { source: "care_soul", target: "tripartite_soul", type: "develop" },
            { source: "daimonion", target: "care_soul", type: "ground" },
            { source: "daimonion", target: "subjective_truth", type: "influence" },
            { source: "know_nothing", target: "maieutics", type: "ground" },
            { source: "virtue_knowledge", target: "maieutics", type: "ground" },
            { source: "care_soul", target: "virtue_knowledge", type: "ground" },
            { source: "daimonion", target: "maieutics", type: "influence" },
            { source: "soul", target: "care_soul", type: "ground" },
            { source: "soul", target: "virtue_knowledge", type: "ground" },
            { source: "daimonion", target: "soul", type: "influence" },
            
            // Платон → Аристотель
            { source: "eidos", target: "form", type: "develop" },
            { source: "ideas", target: "form", type: "critique" },
            { source: "demiurge", target: "unmoved_mover", type: "develop" },
            { source: "tripartite_soul", target: "golden_mean", type: "influence" },
            
            // Внутренние связи Платона
            { source: "ideas", target: "eidos", type: "ground" },
            { source: "eidos", target: "anamnesis", type: "ground" },
            { source: "cave", target: "ideas", type: "ground" },
            { source: "demiurge", target: "ideas", type: "influence" },
            { source: "ideal_state", target: "tripartite_soul", type: "ground" },
            { source: "tripartite_soul", target: "care_soul", type: "ground" },
            { source: "ideal_state", target: "ideas", type: "ground" },
            
            // Внутренние связи Аристотеля
            { source: "form", target: "matter_ar", type: "dialogue", bidirectional: true },
            { source: "form", target: "entelechy", type: "ground" },
            { source: "four_causes", target: "entelechy", type: "ground" },
            { source: "unmoved_mover", target: "entelechy", type: "ground" },
            { source: "categories", target: "form", type: "ground" },
            { source: "golden_mean", target: "virtue_knowledge", type: "develop" },
            { source: "golden_mean", target: "entelechy", type: "ground" },
            
            // Аристотель → Средневековье
            { source: "form", target: "essence_existence", type: "influence" },
            { source: "four_causes", target: "five_ways", type: "influence" },
            
            // Внутренние связи Августина
            { source: "grace", target: "original_sin", type: "oppose" },
            { source: "faith_reason", target: "confession", type: "ground" },
            { source: "two_cities", target: "grace", type: "ground" },
            { source: "time_augustine", target: "confession", type: "ground" },
            { source: "two_cities", target: "faith_reason", type: "ground" },
            { source: "original_sin", target: "confession", type: "ground" },
            { source: "grace", target: "confession", type: "influence" },
            
            // Августин → Фома
            { source: "faith_reason", target: "thomistic_synthesis", type: "influence" },
            { source: "grace", target: "natural_law", type: "influence" },
            
            // Внутренние связи Фомы
            { source: "essence_existence", target: "five_ways", type: "ground" },
            { source: "natural_law", target: "thomistic_synthesis", type: "ground" },
            { source: "analogy", target: "essence_existence", type: "ground" },
            { source: "thomistic_synthesis", target: "form", type: "develop" },
            { source: "thomistic_synthesis", target: "essence_existence", type: "ground" },
            { source: "natural_law", target: "five_ways", type: "ground" },
            
            // Декарт
            { source: "cogito", target: "dualism", type: "ground" },
            { source: "res_cogitans", target: "res_extensa", type: "oppose" },
            { source: "dualism", target: "res_cogitans", type: "ground" },
            { source: "method", target: "cogito", type: "ground" },
            { source: "clear_distinct", target: "innate_ideas", type: "ground" },
            { source: "innate_ideas", target: "res_cogitans", type: "ground" },
            { source: "cogito", target: "know_nothing", type: "critique" },
            
            // Спиноза
            { source: "substance_spinoza", target: "modes", type: "ground" },
            { source: "attributes", target: "substance_spinoza", type: "ground" },
            { source: "conatus", target: "modes", type: "ground" },
            { source: "intellectual_love", target: "substance_spinoza", type: "ground" },
            { source: "determinism", target: "substance_spinoza", type: "ground" },
            { source: "substance_spinoza", target: "dualism", type: "critique" },
            { source: "determinism", target: "autonomy", type: "oppose" },
            
            // Лейбниц
            { source: "monads", target: "preestablished", type: "ground" },
            { source: "sufficient_reason", target: "best_worlds", type: "ground" },
            { source: "petites_perceptions", target: "monads", type: "ground" },
            { source: "monads", target: "substance_spinoza", type: "critique" },
            { source: "preestablished", target: "dualism", type: "synthesize" },
            { source: "best_worlds", target: "demiurge", type: "develop" },
            { source: "sufficient_reason", target: "four_causes", type: "develop" },
            { source: "sufficient_reason", target: "preestablished", type: "ground" },
            { source: "best_worlds", target: "monads", type: "ground" },
            
            // Юм
            { source: "impressions", target: "ideas_hume", type: "ground" },
            { source: "causality_critique", target: "custom", type: "ground" },
            { source: "bundle_theory", target: "impressions", type: "ground" },
            { source: "is_ought", target: "natural_law", type: "critique" },
            { source: "causality_critique", target: "four_causes", type: "critique" },
            { source: "impressions", target: "innate_ideas", type: "critique" },
            { source: "causality_critique", target: "impressions", type: "ground" },
            { source: "custom", target: "ideas_hume", type: "ground" },
            { source: "is_ought", target: "impressions", type: "ground" },

            // Кант
            { source: "thing_itself", target: "phenomenon", type: "oppose" },
            { source: "apriori", target: "phenomenon", type: "ground" },
            { source: "categorical", target: "autonomy", type: "ground" },
            { source: "synthetic_apriori", target: "transcendental", type: "ground" },
            { source: "transcendental", target: "apriori", type: "ground" },
            { source: "thing_itself", target: "ideas", type: "critique" },
            { source: "apriori", target: "impressions", type: "critique" },
            { source: "synthetic_apriori", target: "innate_ideas", type: "develop" },
            { source: "categorical", target: "natural_law", type: "develop" },
            { source: "categorical", target: "apriori", type: "ground" },
            { source: "autonomy", target: "transcendental", type: "ground" },
            { source: "categorical", target: "phenomenon", type: "influence" },
            
            // Фихте
            { source: "absolute_ego", target: "non_ego", type: "oppose" },
            { source: "tathandlung", target: "absolute_ego", type: "ground" },
            { source: "striving", target: "non_ego", type: "ground" },
            { source: "practical_primacy", target: "tathandlung", type: "ground" },
            { source: "absolute_ego", target: "transcendental", type: "develop" },
            { source: "tathandlung", target: "cogito", type: "critique" },
            
            // Гегель
            { source: "dialectic", target: "aufhebung", type: "ground" },
            { source: "absolute_idea", target: "weltgeist", type: "ground" },
            { source: "dialectic", target: "absolute_idea", type: "ground" },
            { source: "master_slave", target: "dialectic", type: "ground" },
            { source: "objective_spirit", target: "weltgeist", type: "ground" },
            { source: "cunning_reason", target: "weltgeist", type: "ground" },
            { source: "aufhebung", target: "non_ego", type: "synthesize" },
            { source: "dialectic", target: "thing_itself", type: "synthesize" },
            { source: "absolute_idea", target: "absolute_ego", type: "develop" },
            
            // Шопенгауэр
            { source: "will_schop", target: "representation", type: "oppose" },
            { source: "suffering", target: "will_schop", type: "ground" },
            { source: "denial_will", target: "suffering", type: "oppose" },
            { source: "aesthetics_schop", target: "denial_will", type: "ground" },
            { source: "compassion", target: "denial_will", type: "ground" },
            { source: "will_schop", target: "absolute_idea", type: "critique" },
            { source: "representation", target: "phenomenon", type: "develop" },
            
            // Кьеркегор
            { source: "stages_existence", target: "leap_faith", type: "ground" },
            { source: "anxiety", target: "leap_faith", type: "ground" },
            { source: "despair", target: "anxiety", type: "ground" },
            { source: "individual", target: "subjective_truth", type: "ground" },
            { source: "subjective_truth", target: "leap_faith", type: "ground" },
            { source: "individual", target: "absolute_idea", type: "critique" },
            { source: "leap_faith", target: "dialectic", type: "critique" },
            
            // Маркс
            { source: "praxis", target: "alienation", type: "oppose" },
            { source: "base_superstructure", target: "class_struggle", type: "ground" },
            { source: "commodity_fetish", target: "alienation", type: "ground" },
            { source: "historical_materialism", target: "base_superstructure", type: "ground" },
            { source: "praxis", target: "tathandlung", type: "develop" },
            { source: "dialectic", target: "historical_materialism", type: "influence" },
            { source: "alienation", target: "objective_spirit", type: "critique" },
            { source: "historical_materialism", target: "praxis", type: "ground" },
            { source: "base_superstructure", target: "alienation", type: "ground" },
            { source: "class_struggle", target: "praxis", type: "ground" },
            { source: "commodity_fetish", target: "base_superstructure", type: "ground" },
            { source: "ideology", target: "base_superstructure", type: "ground" },
            { source: "ideology", target: "alienation", type: "ground" },
            
            // Ницше
            { source: "will_power", target: "ubermensch", type: "ground" },
            { source: "god_dead", target: "ubermensch", type: "ground" },
            { source: "eternal_return", target: "will_power", type: "ground" },
            { source: "perspectivism", target: "god_dead", type: "ground" },
            { source: "master_morality", target: "slave_morality", type: "oppose" },
            { source: "will_schop", target: "will_power", type: "develop" },
            { source: "god_dead", target: "absolute_idea", type: "critique" },
            { source: "ubermensch", target: "categorical", type: "critique" },
            { source: "perspectivism", target: "thing_itself", type: "critique" },
            { source: "master_morality", target: "natural_law", type: "critique" },
            { source: "master_morality", target: "will_power", type: "ground" },
            { source: "master_morality", target: "ubermensch", type: "ground" },
            { source: "slave_morality", target: "god_dead", type: "influence" },
            
            // Гуссерль
            { source: "intentionality", target: "epoché", type: "ground" },
            { source: "transcendental_ego", target: "eidetic", type: "ground" },
            { source: "lifeworld", target: "epoché", type: "oppose" },
            { source: "eidetic", target: "intentionality", type: "ground" },
            { source: "transcendental_ego", target: "cogito", type: "develop" },
            { source: "epoché", target: "method", type: "develop" },
            
            // Хайдеггер
            { source: "dasein", target: "sein", type: "ground" },
            { source: "geworfenheit", target: "sorge", type: "ground" },
            { source: "dasein", target: "geworfenheit", type: "ground" },
            { source: "sein_zum_tode", target: "dasein", type: "ground" },
            { source: "aletheia", target: "sein", type: "ground" },
            { source: "dwelling", target: "dasein", type: "ground" },
            { source: "sein", target: "absolute_idea", type: "critique" },
            { source: "dasein", target: "transcendental_ego", type: "critique" },
            { source: "sorge", target: "intentionality", type: "develop" },
            
            // Витгенштейн
            { source: "language_game", target: "form_of_life", type: "ground" },
            { source: "picture_theory", target: "limits_language", type: "ground" },
            { source: "family_resemblance", target: "language_game", type: "ground" },
            { source: "limits_language", target: "categories", type: "critique" },
            { source: "language_game", target: "picture_theory", type: "critique" },
            
            // Сартр
            { source: "existence", target: "nothingness", type: "ground" },
            { source: "freedom_sartre", target: "bad_faith", type: "oppose" },
            { source: "nothingness", target: "freedom_sartre", type: "ground" },
            { source: "for_itself", target: "in_itself", type: "oppose" },
            { source: "look", target: "for_itself", type: "ground" },
            { source: "existence", target: "dasein", type: "develop" },
            { source: "nothingness", target: "sein", type: "develop" },
            { source: "freedom_sartre", target: "geworfenheit", type: "dialogue", bidirectional: true },
            { source: "bad_faith", target: "dualism", type: "critique" },
            { source: "for_itself", target: "nothingness", type: "ground" },
            { source: "for_itself", target: "freedom_sartre", type: "ground" },
            { source: "look", target: "bad_faith", type: "influence" },
            { source: "in_itself", target: "existence", type: "ground" },
            
            // Фуко
            { source: "power_knowledge", target: "episteme", type: "ground" },
            { source: "discipline", target: "biopower", type: "ground" },
            { source: "archaeology", target: "episteme", type: "ground" },
            { source: "care_self", target: "care_soul", type: "develop" },
            { source: "power_knowledge", target: "transcendental", type: "critique" },
            { source: "episteme", target: "apriori", type: "critique" },
            { source: "biopower", target: "conatus", type: "develop" },
            { source: "discipline", target: "power_knowledge", type: "ground" },
            { source: "biopower", target: "episteme", type: "influence" },
            { source: "care_self", target: "discipline", type: "oppose" },
            
            // Делёз
            { source: "rhizome", target: "assemblage", type: "ground" },
            { source: "difference", target: "body_without_organs", type: "ground" },
            { source: "desiring_machines", target: "body_without_organs", type: "ground" },
            { source: "deterritorialization", target: "rhizome", type: "ground" },
            { source: "difference", target: "dialectic", type: "critique" },
            { source: "rhizome", target: "weltgeist", type: "critique" },
            { source: "body_without_organs", target: "res_extensa", type: "critique" },
            { source: "desiring_machines", target: "conatus", type: "develop" },
            
            // Дополнительные межконцептуальные связи
            { source: "conatus", target: "will_power", type: "influence" },
            { source: "eternal_return", target: "dialectic", type: "critique" },
            { source: "compassion", target: "categorical", type: "influence" },
            { source: "alienation", target: "bad_faith", type: "influence" },
            { source: "determinism", target: "freedom_sartre", type: "oppose" },
            { source: "entelechy", target: "conatus", type: "influence" },
            { source: "original_sin", target: "geworfenheit", type: "influence" },
            { source: "look", target: "master_slave", type: "develop" },
            { source: "intentionality", target: "lifeworld", type: "ground" },
            
            // Внутренние противоречия в философских системах
            { source: "thing_itself", target: "phenomenon", type: "internal_contradiction" },
            { source: "res_cogitans", target: "res_extensa", type: "internal_contradiction" },
            { source: "freedom_sartre", target: "bad_faith", type: "internal_contradiction" },
            { source: "will_schop", target: "denial_will", type: "internal_contradiction" },
            { source: "for_itself", target: "in_itself", type: "internal_contradiction" },
            { source: "absolute_ego", target: "non_ego", type: "internal_contradiction" },
            
            // Душа в истории философии
            { source: "soul", target: "tripartite_soul", type: "develop" },
            { source: "soul", target: "anamnesis", type: "influence" },
            { source: "soul", target: "entelechy", type: "influence" },
            { source: "soul", target: "confession", type: "influence" },
            { source: "soul", target: "res_cogitans", type: "influence" },
            { source: "soul", target: "despair", type: "influence" },
            
            // Идеология в критике и диалоге
            { source: "ideology", target: "absolute_idea", type: "critique" },
            { source: "ideology", target: "objective_spirit", type: "critique" },
            { source: "ideology", target: "power_knowledge", type: "dialogue", bidirectional: true },
            { source: "ideology", target: "episteme", type: "dialogue", bidirectional: true },
            { source: "ideology", target: "slave_morality", type: "dialogue", bidirectional: true },
            { source: "ideology", target: "bad_faith", type: "influence" },
            { source: "ideology", target: "perspectivism", type: "dialogue", bidirectional: true },
            { source: "ideology", target: "deterritorialization", type: "influence" },
            
            // Аристотель: акт/потенция
            { source: "act_potency", target: "form", type: "dialogue", bidirectional: true },
            { source: "act_potency", target: "matter_ar", type: "dialogue", bidirectional: true },
            { source: "act_potency", target: "entelechy", type: "ground" },
            { source: "four_causes", target: "act_potency", type: "ground" },
            
            // Аристотель → Фома (критичная историческая связь!)
            { source: "act_potency", target: "essence_existence", type: "influence" },
            
            // Платон: благо
            { source: "good", target: "ideas", type: "ground" },
            { source: "good", target: "eidos", type: "ground" },
            { source: "cave", target: "good", type: "influence" },
            { source: "good", target: "demiurge", type: "influence" },
            
            // Платон: Эрос
            { source: "eros", target: "anamnesis", type: "influence" },
            { source: "eros", target: "care_soul", type: "influence" },
            { source: "eros", target: "good", type: "ground" },
            { source: "eros", target: "cave", type: "influence" },
            
            // Гегель: Entfremdung
            { source: "entfremdung", target: "objective_spirit", type: "ground" },
            { source: "dialectic", target: "entfremdung", type: "ground" },
            { source: "entfremdung", target: "aufhebung", type: "synthesize" },
            { source: "master_slave", target: "entfremdung", type: "ground" },
            
            // Гегель → Маркс (различие между отчуждениями!)
            { source: "entfremdung", target: "alienation", type: "influence" },
            
            // Кант
            { source: "antinomies", target: "thing_itself", type: "ground" },
            { source: "transcendental", target: "antinomies", type: "ground" },
            { source: "synthetic_apriori", target: "antinomies", type: "influence" },
            
            // Кант → Гегель (важная связь!)
            { source: "antinomies", target: "dialectic", type: "influence" },
            
            // Ницше: дионисийское/аполлоническое
            { source: "dionysian", target: "apollonian", type: "oppose" },
            { source: "dionysian", target: "will_power", type: "ground" },
            { source: "apollonian", target: "will_power", type: "ground" },
            { source: "dionysian", target: "eternal_return", type: "influence" },
            { source: "apollonian", target: "representation", type: "dialogue", bidirectional: true },
            
            // Ницше: ресентимент
            { source: "ressentiment", target: "slave_morality", type: "ground" },
            { source: "ressentiment", target: "master_morality", type: "oppose" },
            { source: "ressentiment", target: "will_power", type: "oppose" },
            
            // Хайдеггер
            { source: "das_man", target: "dasein", type: "ground" },
            { source: "das_man", target: "geworfenheit", type: "influence" },
            { source: "das_man", target: "sein_zum_tode", type: "oppose" },
            { source: "dwelling", target: "das_man", type: "oppose" },
            
            // Спиноза → Ницше (важное влияние!)
            { source: "intellectual_love", target: "eternal_return", type: "influence" },
            { source: "determinism", target: "eternal_return", type: "dialogue", bidirectional: true },
            
            // Платон → Августин (влияние на христианство)
            { source: "good", target: "grace", type: "influence" },
            { source: "ideas", target: "faith_reason", type: "influence" },
            
            // Аристотель → Спиноза (через схоластику)
            { source: "entelechy", target: "substance_spinoza", type: "influence" },
            
            // Кант → Сартр (через феноменологию)
            { source: "phenomenon", target: "for_itself", type: "influence" },
            
            // Платон: новые связи
            { source: "methexis", target: "eidos", type: "ground", bidirectional: true },
            { source: "methexis", target: "cave", type: "ground" },
            { source: "methexis", target: "ideas", type: "ground" },
            { source: "mimesis", target: "methexis", type: "develop" },
            { source: "mimesis", target: "ideas", type: "ground" },
            { source: "chora", target: "demiurge", type: "ground" },
            { source: "chora", target: "matter_ar", type: "dialogue", bidirectional: true },
            { source: "good", target: "methexis", type: "influence" },
            
            // Аристотель: новые связи
            { source: "phronesis", target: "golden_mean", type: "ground" },
            { source: "phronesis", target: "virtue_knowledge", type: "develop" },
            { source: "eudaimonia", target: "entelechy", type: "ground" },
            { source: "eudaimonia", target: "golden_mean", type: "ground" },
            { source: "logos", target: "form", type: "ground" },
            { source: "logos", target: "categories", type: "ground" },
            { source: "phronesis", target: "practical_primacy", type: "influence" },
            { source: "eudaimonia", target: "categorical", type: "critique" },
            
            // Фома Аквинский: новые связи
            { source: "accidents", target: "essence_existence", type: "ground" },
            { source: "actual_being", target: "act_potency", type: "develop" },
            { source: "actual_being", target: "essence_existence", type: "ground" },
            { source: "participatio", target: "methexis", type: "develop" },
            { source: "participatio", target: "essence_existence", type: "ground" },
            { source: "participatio", target: "analogy", type: "ground" },
            
            // Спиноза: новые связи
            { source: "natura_naturans", target: "substance_spinoza", type: "ground" },
            { source: "natura_naturata", target: "modes", type: "ground" },
            { source: "natura_naturans", target: "natura_naturata", type: "oppose" },
            { source: "adequate_ideas", target: "intellectual_love", type: "ground" },
            { source: "adequate_ideas", target: "clear_distinct", type: "dialogue", bidirectional: true },
            
            // Лейбниц: новые связи
            { source: "apperception", target: "monads", type: "ground" },
            { source: "apperception", target: "petites_perceptions", type: "oppose" },
            { source: "apperception", target: "transcendental_ego", type: "influence" },
            { source: "apperception", target: "intentionality", type: "influence" },
            { source: "continuity", target: "preestablished", type: "ground" },
            { source: "continuity", target: "monads", type: "ground" },
            
            // Кант: новые связи
            { source: "sublime", target: "thing_itself", type: "influence" },
            { source: "sublime", target: "aesthetic_judgment", type: "ground" },
            { source: "sublime", target: "dionysian", type: "dialogue", bidirectional: true },
            { source: "postulates", target: "categorical", type: "ground" },
            { source: "postulates", target: "autonomy", type: "ground" },
            { source: "aesthetic_judgment", target: "phenomenon", type: "ground" },
            { source: "aesthetic_judgment", target: "transcendental", type: "ground" },
            
            // Фихте: новые связи
            { source: "imagination", target: "absolute_ego", type: "ground" },
            { source: "imagination", target: "non_ego", type: "ground" },
            { source: "imagination", target: "tathandlung", type: "ground" },
            { source: "wissenschaftslehre", target: "tathandlung", type: "ground" },
            { source: "wissenschaftslehre", target: "absolute_ego", type: "ground" },
            
            // Гегель: новые связи
            { source: "negative", target: "dialectic", type: "ground" },
            { source: "negative", target: "aufhebung", type: "ground" },
            { source: "negative", target: "nothingness", type: "develop" },
            { source: "concrete", target: "abstract", type: "oppose" },        // Оппозиция
            { source: "abstract", target: "dialectic", type: "ground" },       // Обоснование
            { source: "abstract", target: "aufhebung", type: "synthesize" },   // Синтез
            { source: "concrete", target: "absolute_idea", type: "ground" },
            { source: "concrete", target: "dialectic", type: "ground" },
            
            // Шопенгауэр: новые связи
            { source: "individuation", target: "representation", type: "ground" },
            { source: "individuation", target: "will_schop", type: "oppose" },
            { source: "individuation", target: "suffering", type: "ground" },
            
            // Кьеркегор: новые связи
            { source: "repetition", target: "eternal_return", type: "dialogue", bidirectional: true },
            { source: "repetition", target: "stages_existence", type: "ground" },
            { source: "moment", target: "leap_faith", type: "ground" },
            { source: "moment", target: "time_augustine", type: "develop" },
            { source: "moment", target: "anxiety", type: "ground" },
            
            // Гуссерль: новые связи
            { source: "noesis_noema", target: "intentionality", type: "ground" },
            { source: "noesis_noema", target: "eidetic", type: "ground" },
            { source: "constitution", target: "transcendental_ego", type: "ground" },
            { source: "constitution", target: "intentionality", type: "ground" },
            { source: "intersubjectivity", target: "lifeworld", type: "ground" },
            { source: "intersubjectivity", target: "look", type: "influence" },
            { source: "intersubjectivity", target: "transcendental_ego", type: "critique" },
            
            // Хайдеггер: новые связи
            { source: "ereignis", target: "sein", type: "ground" },
            { source: "ereignis", target: "aletheia", type: "ground" },
            { source: "ereignis", target: "event", type: "dialogue", bidirectional: true },
            { source: "geviert", target: "dwelling", type: "ground" },
            { source: "geviert", target: "dasein", type: "ground" },
            { source: "kehre", target: "sein", type: "internal_contradiction" },
            { source: "kehre", target: "ereignis", type: "ground" },
            
            // Витгенштейн: новые связи
            { source: "showing_saying", target: "limits_language", type: "ground" },
            { source: "showing_saying", target: "picture_theory", type: "ground" },
            { source: "private_language", target: "form_of_life", type: "ground" },
            { source: "private_language", target: "language_game", type: "ground" },
            { source: "rule_following", target: "language_game", type: "ground" },
            { source: "rule_following", target: "family_resemblance", type: "ground" },
            { source: "logos", target: "limits_language", type: "critique" },
            
            // Сартр: новые связи
            { source: "project", target: "existence", type: "ground" },
            { source: "project", target: "freedom_sartre", type: "ground" },
            { source: "project", target: "for_itself", type: "ground" },
            { source: "engagement", target: "bad_faith", type: "oppose" },
            { source: "engagement", target: "praxis", type: "dialogue", bidirectional: true },
            { source: "engagement", target: "freedom_sartre", type: "ground" },
            
            // Фуко: новые связи
            { source: "panopticon", target: "discipline", type: "ground" },
            { source: "panopticon", target: "biopower", type: "ground" },
            { source: "heterotopia", target: "episteme", type: "influence" },
            { source: "heterotopia", target: "power_knowledge", type: "ground" },
            { source: "problematization", target: "archaeology", type: "ground" },
            { source: "problematization", target: "care_self", type: "ground" },
            
            // Делёз: новые связи
            { source: "virtual_actual", target: "difference", type: "ground" },
            { source: "virtual_actual", target: "act_potency", type: "develop" },
            { source: "event", target: "ereignis", type: "dialogue", bidirectional: true },
            { source: "event", target: "difference", type: "ground" },
            { source: "fold", target: "body_without_organs", type: "develop" },
            { source: "fold", target: "rhizome", type: "ground" }
            
        ];
        
        // Индивидуальные веса для связей (примеры ключевых связей)
        const specificWeights = {
            // Фундаментальные сильные связи (вес 3)
            "ideas-form": 3,                    // Платон → Аристотель (критика идей)
            "eidos-form": 3,                    // Эйдос → Форма (развитие)
            "cogito-dualism": 3,                // Cogito обосновывает дуализм
            "substance_spinoza-modes": 3,       // Субстанция обосновывает модусы
            "dialectic-absolute_idea": 3,       // Диалектика обосновывает абсолютную идею
            "will_schop-representation": 3,     // Воля противостоит представлению
            "thing_itself-phenomenon": 3,       // Вещь в себе vs феномен
            "existence-nothingness": 3,         // Существование обосновывает Ничто
            "intentionality-epoché": 3,         // Интенциональность обосновывает эпохе
            "dasein-sein": 3,                   // Dasein обосновывает Sein
            
            // Исторически значимые влияния (вес 3)
            "form-essence_existence": 3,        // Аристотель → Фома
            "absolute_ego-absolute_idea": 3,    // Фихте → Гегель
            "dialectic-historical_materialism": 3, // Гегель → Маркс
            "will_schop-will_power": 3,         // Шопенгауэр → Ницше
            "transcendental-absolute_ego": 3,   // Кант → Фихте
            
            // Внутренние противоречия (вес 2-3 в зависимости от центральности)
            "thing_itself-phenomenon_internal": 3, // Центральная антиномия Канта
            "res_cogitans-res_extensa_internal": 3, // Центральная проблема Декарта
            "freedom_sartre-bad_faith_internal": 2, // Важная, но не единственная тема
            
            // Средние связи (вес 2) - существенные, но не критичные
            "maieutics-anamnesis": 2,
            "care_soul-tripartite_soul": 2,
            "four_causes-five_ways": 2,
            "impressions-ideas_hume": 2,
            "apriori-phenomenon": 2,
            "master_slave-dialectic": 2,
            
            // Слабые связи (вес 1) - косвенные влияния
            "daimonion-subjective_truth": 1,    // Дальняя связь Сократ → Кьеркегор
            "demiurge-best_worlds": 1,          // Периферийное влияние
            "tripartite_soul-golden_mean": 1,   // Косвенное влияние
            "geworfenheit-original_sin": 1,     // Тематическая параллель, не прямое влияние
            
            // Аристотель
            "act_potency-form": 3,
            "act_potency-matter_ar": 3,
            "act_potency-entelechy": 3,
            "act_potency-essence_existence": 3,  // Ключевое влияние на томизм
            
            // Платон
            "good-ideas": 3,
            "good-eidos": 3,
            "eros-anamnesis": 2,
            "eros-good": 2,
            
            // Гегель
            "dialectic-entfremdung": 2,
            "entfremdung-objective_spirit": 2,
            "entfremdung-alienation": 3,  // Важная историческая связь
            
            // Кант
            "antinomies-thing_itself": 3,
            "antinomies-dialectic": 3,  // Ключевое влияние
            
            // Ницше
            "dionysian-apollonian": 3,  // Центральная оппозиция
            "dionysian-will_power": 2,
            "apollonian-will_power": 2,
            "ressentiment-slave_morality": 3,
            
            // Хайдеггер
            "das_man-dasein": 2,
            
            // Платон: новые веса
            "methexis-eidos": 3,                    // Центральная связь платонизма
            "methexis-cave": 2,
            "mimesis-methexis": 2,
            "chora-demiurge": 2,
            
            // Аристотель: новые веса
            "phronesis-golden_mean": 3,
            "phronesis-virtue_knowledge": 3,        // Развитие сократовской этики
            "eudaimonia-entelechy": 3,
            "logos-form": 3,
            "eudaimonia-categorical": 2,            // Важная критика Кантом
            
            // Фома: новые веса
            "participatio-methexis": 3,             // Ключевое историческое влияние
            "participatio-essence_existence": 3,
            "actual_being-act_potency": 3,
            
            // Спиноза: новые веса
            "natura_naturans-substance_spinoza": 3,
            "natura_naturata-modes": 3,
            "adequate_ideas-intellectual_love": 2,
            
            // Лейбниц: новые веса
            "apperception-monads": 3,
            "apperception-intentionality": 2,       // Важное влияние на феноменологию
            
            // Кант: новые веса
            "sublime-thing_itself": 2,
            "postulates-categorical": 3,
            "aesthetic_judgment-transcendental": 2,
            
            // Фихте: новые веса
            "imagination-absolute_ego": 3,
            "imagination-non_ego": 3,
            "wissenschaftslehre-tathandlung": 2,
            
            // Гегель: новые веса
            "negative-dialectic": 3,                // Центральная концепция
            "negative-aufhebung": 3,
            "concrete-absolute_idea": 2,
            "concrete-abstract": 3,                 // Центральная оппозиция Гегеля
            "abstract-dialectic": 2,
            "abstract-aufhebung": 2,
            
            // Шопенгауэр: новые веса
            "individuation-representation": 3,
            "individuation-will_schop": 2,
            
            // Кьеркегор: новые веса
            "repetition-eternal_return": 2,
            "moment-leap_faith": 3,
            "moment-time_augustine": 2,
            
            // Гуссерль: новые веса
            "noesis_noema-intentionality": 3,       // Центральная структура
            "constitution-transcendental_ego": 3,
            "intersubjectivity-lifeworld": 2,
            
            // Хайдеггер: новые веса
            "ereignis-sein": 3,                     // Поздний Хайдеггер
            "geviert-dwelling": 2,
            "kehre-sein": 2,
            
            // Витгенштейн: новые веса
            "showing_saying-limits_language": 3,    // Tractatus
            "private_language-form_of_life": 3,    // Философские исследования
            "rule_following-language_game": 3,
            
            // Сартр: новые веса
            "project-existence": 3,
            "project-freedom_sartre": 3,
            "engagement-bad_faith": 2,
            
            // Фуко: новые веса
            "panopticon-discipline": 3,             // Знаменитый анализ
            "problematization-archaeology": 2,
            
            // Делёз: новые веса
            "virtual_actual-difference": 3,
            "event-ereignis": 2,
            "fold-body_without_organs": 2
            
        };
        
        // Функция для генерации ключа связи
        function getLinkKey(link) {
            const source = typeof link.source === 'string' ? link.source : link.source.id;
            const target = typeof link.target === 'string' ? link.target : link.target.id;
            return `${source}-${target}`;
        }
        
        // Назначаем веса
        links.forEach(link => {
            const key = getLinkKey(link);
            const reverseKey = `${typeof link.target === 'string' ? link.target : link.target.id}-${typeof link.source === 'string' ? link.source : link.source.id}`;
            
            // Проверяем специфический вес
            if (specificWeights[key]) {
                link.weight = specificWeights[key];
            } else if (specificWeights[reverseKey] && link.bidirectional) {
                link.weight = specificWeights[reverseKey];
            } else {
                // Вес по умолчанию в зависимости от типа связи
                switch(link.type) {
                    case "ground":
                    case "develop":
                    case "synthesize":
                        link.weight = 2; // По умолчанию среднее для этих типов
                        break;
                    case "internal_contradiction":
                        link.weight = 2; // Противоречия обычно важны
                        break;
                    case "influence":
                    case "dialogue":
                        link.weight = 1; // По умолчанию слабое для косвенных влияний
                        break;
                    case "oppose":
                    case "critique":
                        link.weight = 2; // Критика обычно существенна
                        break;
                    default:
                        link.weight = 2;
                }
            }
        });
        
        // Дополнительная логика: усиливаем веса для связей внутри одного философа
        links.forEach(link => {
            const sourceNode = nodes.find(n => n.id === (typeof link.source === 'string' ? link.source : link.source.id));
            const targetNode = nodes.find(n => n.id === (typeof link.target === 'string' ? link.target : link.target.id));
            
            // Если связь внутри системы одного философа и это ground/synthesize
            if (sourceNode && targetNode && 
                sourceNode.concept === targetNode.concept && 
                (link.type === "ground" || link.type === "synthesize")) {
                // Увеличиваем вес на 1, но не больше 3
                link.weight = Math.min(link.weight + 1, 3);
            }
        });
        
        // Состояние фильтров
        let selectedPhilosophers = new Set(Object.keys(philosopherConcepts));
        let selectedRelations = new Set(Object.keys(relationTypes));
        
        // Режимы фильтрации: 'all' - только выбранные, 'internal' - только внутренние, 'context' - с соседними
        let filterMode = 'all';
        
        // Инициализация селектов для поиска пути
        function initPathFinder() {
            const sourceSelect = document.getElementById('sourceSelect');
            const targetSelect = document.getElementById('targetSelect');
            
            nodes.forEach(node => {
                const option1 = document.createElement('option');
                option1.value = node.id;
                option1.textContent = `${node.label} (${node.concept})`;
                sourceSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = node.id;
                option2.textContent = `${node.label} (${node.concept})`;
                targetSelect.appendChild(option2);
            });
        }
        
        // Поиск кратчайшего пути между двумя концепциями (BFS)
        function findShortestPath(sourceId, targetId, respectChronology = true, respectDirection = true) {
            if (sourceId === targetId) return [sourceId];
            
            const queue = [[sourceId]];
            const visited = new Set([sourceId]);
            
            // Создаем граф смежности
            const adjacency = {};
            nodes.forEach(n => adjacency[n.id] = []);
            
            links.forEach(l => {
                const src = l.source.id || l.source;
                const tgt = l.target.id || l.target;
                
                if (respectDirection) {
                    // Учитываем направленность связей
                    adjacency[src].push(tgt);
                    if (l.bidirectional) {
                        adjacency[tgt].push(src);
                    }
                } else {
                    // Игнорируем направленность - граф становится неориентированным
                    adjacency[src].push(tgt);
                    adjacency[tgt].push(src);
                }
            });
            
            while (queue.length > 0) {
                const path = queue.shift();
                const currentNodeId = path[path.length - 1];
                
                if (currentNodeId === targetId) {
                    return path;
                }
                
                const neighbors = adjacency[currentNodeId] || [];
                for (const neighborId of neighbors) {
                    if (!visited.has(neighborId)) {
                        // Проверка хронологии
                        if (respectChronology) {
                            const currentNode = nodes.find(n => n.id === currentNodeId);
                            const nextNode = nodes.find(n => n.id === neighborId);
                            
                            const currentYear = philosopherOrder[currentNode.concept];
                            const nextYear = philosopherOrder[nextNode.concept];
                            
                            // Разрешаем переход только вперёд во времени или к современникам (±50 лет)
                            if (nextYear < currentYear - 50) {
                                continue; // Пропускаем переход "в прошлое"
                            }
                        }
                        
                        visited.add(neighborId);
                        queue.push([...path, neighborId]);
                    }
                }
            }
            
            return null; // Путь не найден
        }
        
        // Функция для отображения найденного пути
        function findAndShowPath() {
            const sourceId = document.getElementById('sourceSelect').value;
            const targetId = document.getElementById('targetSelect').value;
            const resultDiv = document.getElementById('pathResult');
            
            const respectChronology = document.getElementById('respectChronology').checked;
            const respectDirection = document.getElementById('respectDirection').checked;
            
            if (!sourceId || !targetId) {
                alert('Выберите обе концепции');
                return;
            }
            
            if (sourceId === targetId) {
                alert('Выберите разные концепции');
                return;
            }
            
            const path = findShortestPath(sourceId, targetId, respectChronology, respectDirection);
            
            if (!path) {
                const sourceNode = nodes.find(n => n.id === sourceId);
                const targetNode = nodes.find(n => n.id === targetId);
                
                let message = 'Эти концепции не связаны';
                if (respectChronology && respectDirection) {
                    message += ' хронологически корректным путём с учётом направленности связей.';
                } else if (respectChronology) {
                    message += ' хронологически корректным путём.';
                } else if (respectDirection) {
                    message += ' с учётом направленности связей.';
                } else {
                    message += ' в графе.';
                }
                
                resultDiv.innerHTML = `
                    <div class="path-length">❌ Путь не найден</div>
                    <div class="path-chain">${message}<br><br>
                    <small style="color: #95a5a6;">Попробуйте снять ограничения ниже.</small></div>
                    <button onclick="clearPathHighlight()" style="width: 100%; margin-top: 10px; background: #95a5a6; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                        Очистить
                    </button>
                `;
                resultDiv.classList.add('show');
                resetHighlight();
                return;
            }
            
            // Формируем визуальное представление пути
            const pathNodes = path.map(id => nodes.find(n => n.id === id));
            const pathHTML = pathNodes.map(n => 
                `<span class="path-node" title="${n.concept}">${n.label}</span>`
            ).join('<span class="path-arrow">→</span>');
            
            // Добавляем информацию о хронологии
            const years = pathNodes.map(n => philosopherConcepts[n.concept].years);
            const chronologyInfo = respectChronology ? 
                `<div style="margin-top: 8px; font-size: 10px; color: #7f8c8d;">
                    Хронология: ${years[0]} → ${years[years.length - 1]}
                </div>` : '';
            
            resultDiv.innerHTML = `
                <div class="path-length">✅ Длина пути: ${path.length} концепций</div>
                <div class="path-chain">${pathHTML}</div>
                ${chronologyInfo}
                <button onclick="clearPathHighlight()" style="width: 100%; margin-top: 10px; background: #e74c3c; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: background 0.3s;" onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'">
                    🔄 Сбросить подсветку
                </button>
            `;
            resultDiv.classList.add('show');
            
            // Подсвечиваем путь на графе
            highlightPath(path, respectDirection);
        }
        
        // Подсветка пути на графе
        function highlightPath(path, respectDirection = true) {
            resetHighlight();
            
            const pathSet = new Set(path);
            const pathLinks = new Set();
            
            // Находим связи, которые входят в путь
            for (let i = 0; i < path.length - 1; i++) {
                const currentNode = path[i];
                const nextNode = path[i + 1];
                
                const link = links.find(l => {
                    const src = l.source.id || l.source;
                    const tgt = l.target.id || l.target;
                    
                    if (respectDirection) {
                        // Учитываем направленность: ищем связь в прямом направлении или bidirectional
                        return (src === currentNode && tgt === nextNode) ||
                               (l.bidirectional && src === nextNode && tgt === currentNode);
                    } else {
                        // Не учитываем направленность: любая связь между этими узлами подходит
                        return (src === currentNode && tgt === nextNode) ||
                               (src === nextNode && tgt === currentNode);
                    }
                });
                
                if (link) pathLinks.add(link);
            }
            
            // Применяем стили
            node.classed("dimmed", d => !pathSet.has(d.id))
                .classed("highlighted", d => pathSet.has(d.id));
            
            link.classed("dimmed", l => !pathLinks.has(l))
                .classed("path-highlight", l => pathLinks.has(l));
        }
        
        // Очистка подсветки пути
        function clearPathHighlight() {
            resetHighlight();
            const resultDiv = document.getElementById('pathResult');
            resultDiv.classList.remove('show');
            resultDiv.innerHTML = '';
        }
        
        // Инициализация фильтров
        function initFilters() {
            // Создаем фильтры философов
            const philContainer = document.getElementById('philosopherFilters');
            Object.entries(philosopherConcepts).forEach(([name, data]) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <input type="checkbox" id="phil-${name}" checked onchange="togglePhilosopher('${name}')">
                    <label for="phil-${name}">
                        <div class="legend-color" style="background: ${data.color}"></div>
                        <span>${name}<small style="color: #95a5a6; font-size: 9px;"> (${data.years})</small></span>
                    </label>
                `;
                philContainer.appendChild(item);
            });
        
            // Создаем фильтры связей (без изменений)
            const relContainer = document.getElementById('relationFilters');
            Object.entries(relationTypes).forEach(([type, typeData]) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <input type="checkbox" id="rel-${type}" checked onchange="toggleRelation('${type}')">
                    <label for="rel-${type}">
                        <div class="legend-line" style="background: ${typeData.color}"></div>
                        <span>${typeData.label}</span>
                    </label>
                `;
                relContainer.appendChild(item);
            });
        }
        
        // Переключение философа
        function togglePhilosopher(philosopher) {
            if (selectedPhilosophers.has(philosopher)) {
                selectedPhilosophers.delete(philosopher);
            } else {
                selectedPhilosophers.add(philosopher);
            }
            applyFilters();
        }
        
        // Переключение типа связи
        function toggleRelation(relationType) {
            if (selectedRelations.has(relationType)) {
                selectedRelations.delete(relationType);
            } else {
                selectedRelations.add(relationType);
            }
            applyFilters();
        }
        
        // Выбрать всех философов
        function selectAllPhilosophers() {
            selectedPhilosophers = new Set(Object.keys(philosopherConcepts));
            Object.keys(philosopherConcepts).forEach(name => {
                document.getElementById(`phil-${name}`).checked = true;
            });
            applyFilters();
        }
        
        // Снять всех философов
        function deselectAllPhilosophers() {
            selectedPhilosophers.clear();
            Object.keys(philosopherConcepts).forEach(name => {
                document.getElementById(`phil-${name}`).checked = false;
            });
            applyFilters();
        }
        
        // Выбрать все связи
        function selectAllRelations() {
            selectedRelations = new Set(Object.keys(relationTypes));
            Object.keys(relationTypes).forEach(type => {
                document.getElementById(`rel-${type}`).checked = true;
            });
            applyFilters();
        }
        
        // Снять все связи
        function deselectAllRelations() {
            selectedRelations.clear();
            Object.keys(relationTypes).forEach(type => {
                document.getElementById(`rel-${type}`).checked = false;
            });
            applyFilters();
        }
        
        // Переключение режима фильтрации
        function changeFilterMode(mode) {
            filterMode = mode;
            applyFilters();
        }
        
        // Применение фильтров с взаимосвязанной логикой
        function applyFilters() {
            const allRelationsSelected = selectedRelations.size === Object.keys(relationTypes).length;
            
            if (filterMode === 'all') {
                // Режим 1: Только выбранные философы
                // Связи, где ОБА узла принадлежат выбранным философам
                const validLinks = links.filter(l => {
                    const typeSelected = selectedRelations.has(l.type);
                    const sourcePhilosopherSelected = selectedPhilosophers.has(l.source.concept);
                    const targetPhilosopherSelected = selectedPhilosophers.has(l.target.concept);
                    return typeSelected && sourcePhilosopherSelected && targetPhilosopherSelected;
                });
                
                const nodesInValidLinks = new Set();
                validLinks.forEach(l => {
                    nodesInValidLinks.add(l.source.id || l.source);
                    nodesInValidLinks.add(l.target.id || l.target);
                });
                
                node.style("display", d => {
                    const philosopherSelected = selectedPhilosophers.has(d.concept);
                    const inValidLinks = allRelationsSelected || nodesInValidLinks.has(d.id);
                    return (philosopherSelected && inValidLinks) ? null : "none";
                });
                
                link.style("display", l => {
                    const typeSelected = selectedRelations.has(l.type);
                    const sourcePhilosopherSelected = selectedPhilosophers.has(l.source.concept);
                    const targetPhilosopherSelected = selectedPhilosophers.has(l.target.concept);
                    const sourceInValidLinks = allRelationsSelected || nodesInValidLinks.has(l.source.id);
                    const targetInValidLinks = allRelationsSelected || nodesInValidLinks.has(l.target.id);
                    
                    return (typeSelected && sourcePhilosopherSelected && targetPhilosopherSelected && 
                            sourceInValidLinks && targetInValidLinks) ? null : "none";
                });
                
            } else if (filterMode === 'internal') {
                // Режим 2: Только внутренние связи
                // Связи, где оба узла от ОДНОГО философа из выбранных
                const validLinks = links.filter(l => {
                    const typeSelected = selectedRelations.has(l.type);
                    const sourcePhilosopherSelected = selectedPhilosophers.has(l.source.concept);
                    const targetPhilosopherSelected = selectedPhilosophers.has(l.target.concept);
                    const samePhilosopher = l.source.concept === l.target.concept;
                    return typeSelected && sourcePhilosopherSelected && targetPhilosopherSelected && samePhilosopher;
                });
                
                const nodesInValidLinks = new Set();
                validLinks.forEach(l => {
                    nodesInValidLinks.add(l.source.id || l.source);
                    nodesInValidLinks.add(l.target.id || l.target);
                });
                
                node.style("display", d => {
                    const philosopherSelected = selectedPhilosophers.has(d.concept);
                    const inValidLinks = allRelationsSelected || nodesInValidLinks.has(d.id);
                    return (philosopherSelected && inValidLinks) ? null : "none";
                });
                
                link.style("display", l => {
                    const typeSelected = selectedRelations.has(l.type);
                    const sourcePhilosopherSelected = selectedPhilosophers.has(l.source.concept);
                    const targetPhilosopherSelected = selectedPhilosophers.has(l.target.concept);
                    const samePhilosopher = l.source.concept === l.target.concept;
                    const sourceInValidLinks = allRelationsSelected || nodesInValidLinks.has(l.source.id);
                    const targetInValidLinks = allRelationsSelected || nodesInValidLinks.has(l.target.id);
                    
                    return (typeSelected && sourcePhilosopherSelected && targetPhilosopherSelected && 
                            samePhilosopher && sourceInValidLinks && targetInValidLinks) ? null : "none";
                });
                
            } else if (filterMode === 'context') {
                // Режим 3: С соседними узлами
                // Показываем выбранных философов + все узлы, с которыми они связаны
                
                // Сначала находим все связи, где хотя бы ОДИН конец - выбранный философ
                const validLinks = links.filter(l => {
                    const typeSelected = selectedRelations.has(l.type);
                    const sourcePhilosopherSelected = selectedPhilosophers.has(l.source.concept);
                    const targetPhilosopherSelected = selectedPhilosophers.has(l.target.concept);
                    // Связь валидна, если хотя бы один конец принадлежит выбранному философу
                    return typeSelected && (sourcePhilosopherSelected || targetPhilosopherSelected);
                });
                
                // Собираем все узлы, участвующие в этих связях (включая "соседей")
                const visibleNodes = new Set();
                validLinks.forEach(l => {
                    visibleNodes.add(l.source.id || l.source);
                    visibleNodes.add(l.target.id || l.target);
                });
                
                // Показываем все узлы, которые участвуют в валидных связях
                node.style("display", d => {
                    return visibleNodes.has(d.id) ? null : "none";
                });
                
                // Показываем все валидные связи
                link.style("display", l => {
                    const typeSelected = selectedRelations.has(l.type);
                    const sourcePhilosopherSelected = selectedPhilosophers.has(l.source.concept);
                    const targetPhilosopherSelected = selectedPhilosophers.has(l.target.concept);
                    const sourceVisible = visibleNodes.has(l.source.id);
                    const targetVisible = visibleNodes.has(l.target.id);
                    
                    return (typeSelected && (sourcePhilosopherSelected || targetPhilosopherSelected) && 
                            sourceVisible && targetVisible) ? null : "none";
                });
            }
            
            // Обновляем статистику
            updateFilterStats();
            
            // Сбрасываем подсветку для скрытых узлов
            const visibleNodeIds = new Set();
            node.each(function(d) {
                if (this.style.display !== "none") {
                    visibleNodeIds.add(d.id);
                }
            });
            
            selectedNodes.forEach(node => {
                if (!visibleNodeIds.has(node.id)) {
                    selectedNodes.delete(node);
                }
            });
        
            if (selectedNodes.size === 0) {
                resetHighlight();
            } else {
                highlightConnected(Array.from(selectedNodes));
            }
        }
        // Обновление статистики фильтров
        function updateFilterStats() {
            let visibleNodesCount = 0;
            let visibleLinksCount = 0;
            
            node.each(function() {
                if (this.style.display !== "none") visibleNodesCount++;
            });
            
            link.each(function() {
                if (this.style.display !== "none") visibleLinksCount++;
            });
            
            const totalNodes = nodes.length;
            const totalLinks = links.length;
            
            document.getElementById('filterStats').textContent = 
                `Показано: ${visibleNodesCount}/${totalNodes} концепций, ${visibleLinksCount}/${totalLinks} связей`;
        }
        
        // Расчет влиятельности концепций (degree centrality)
        function calculateInfluence() {
            const influence = {};
            
            nodes.forEach(n => {
                influence[n.id] = { in: 0, out: 0, total: 0, node: n };
            });
            
            links.forEach(l => {
                const src = l.source.id || l.source;
                const tgt = l.target.id || l.target;
                influence[src].out++;
                influence[tgt].in++;
                if (l.bidirectional) {
                    influence[src].in++;
                    influence[tgt].out++;
                }
            });
            
            Object.values(influence).forEach(i => {
                i.total = i.in + i.out;
            });
            
            return Object.values(influence).sort((a, b) => b.total - a.total);
        }
        
        // Расчет узлов-мостов (betweenness centrality - упрощенная версия)
        function calculateBetweenness() {
            const betweenness = {};
            nodes.forEach(n => betweenness[n.id] = { count: 0, node: n });
            
            // Для каждой пары узлов находим кратчайшие пути
            for (let i = 0; i < nodes.length; i++) {
                for (let j = i + 1; j < nodes.length; j++) {
                    const path = findShortestPath(nodes[i].id, nodes[j].id);
                    if (path && path.length > 2) {
                        // Увеличиваем счетчик для промежуточных узлов
                        for (let k = 1; k < path.length - 1; k++) {
                            betweenness[path[k]].count++;
                        }
                    }
                }
            }
            
            return Object.values(betweenness)
                .filter(b => b.count > 0)
                .sort((a, b) => b.count - a.count);
        }
        
        // Отображение статистики
        function displayStatistics() {
            const influence = calculateInfluence();
            const betweenness = calculateBetweenness();
            
            // Топ-10 влиятельных концепций
            const topConceptsDiv = document.getElementById('topConcepts');
            topConceptsDiv.innerHTML = influence.slice(0, 10).map((item, index) => `
                <div class="stat-item" onclick="highlightNodeById('${item.node.id}')">
                    <span class="stat-rank">${index + 1}.</span>
                    <span class="stat-name">${item.node.label}</span>
                    <span class="stat-value">${item.total}</span>
                    <span class="stat-philosopher">${item.node.concept}</span>
                </div>
            `).join('');
            
            // Топ-10 узлов-мостов
            const bridgeNodesDiv = document.getElementById('bridgeNodes');
            if (betweenness.length > 0) {
                bridgeNodesDiv.innerHTML = betweenness.slice(0, 10).map((item, index) => `
                    <div class="stat-item" onclick="highlightNodeById('${item.node.id}')">
                        <span class="stat-rank">${index + 1}.</span>
                        <span class="stat-name">${item.node.label}</span>
                        <span class="stat-value">${item.count}</span>
                        <span class="stat-philosopher">${item.node.concept}</span>
                    </div>
                `).join('');
            } else {
                bridgeNodesDiv.innerHTML = '<div style="font-size: 11px; color: #95a5a6; font-style: italic;">Вычисление...</div>';
            }
        }
        
        // Подсветка узла по ID
        function highlightNodeById(nodeId) {
            const nodeData = nodes.find(n => n.id === nodeId);
            if (nodeData) {
                selectedNodes.clear();
                selectedNodes.add(nodeData);
                highlightConnected([nodeData]);
                
                // Центрируем на узле
                const nodeElement = node.filter(d => d.id === nodeId);
                if (nodeElement.size() > 0) {
                    const d = nodeElement.datum();
                    const transform = d3.zoomIdentity
                        .translate(width / 2 - d.x, height / 2 - d.y)
                        .scale(1.5);
                    svg.transition().duration(750).call(zoom.transform, transform);
                }
            }
        }
        
        // Экспорт в PNG
        function exportToPNG() {
            const svgElement = document.getElementById('graph');
            const svgClone = svgElement.cloneNode(true);
            
            // Получаем текущий transform от zoom
            const gElement = svgClone.querySelector('g');
            const transform = g.attr('transform');
            if (transform) {
                gElement.setAttribute('transform', transform);
            }
            
            // Применяем инлайн-стили к тексту
            const textElements = svgClone.querySelectorAll('text');
            textElements.forEach(text => {
                text.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
                text.style.fontSize = '10px';
                text.style.fontWeight = '600';
                text.style.fill = '#fff';
                text.style.textShadow = '0 0 4px black';
            });
            
            // Применяем инлайн-стили к узлам
            const circles = svgClone.querySelectorAll('circle');
            circles.forEach(circle => {
                const computedStyle = window.getComputedStyle(circle);
                circle.style.strokeWidth = '3px';
                circle.style.filter = 'drop-shadow(0 0 10px rgba(255,255,255,0.4))';
            });
            
            // Применяем инлайн-стили к связям
            const paths = svgClone.querySelectorAll('path.link');
            paths.forEach(path => {
                path.style.fill = 'none';
                const computedStyle = window.getComputedStyle(path);
                path.style.stroke = computedStyle.stroke;
                path.style.strokeWidth = computedStyle.strokeWidth;
                path.style.opacity = computedStyle.opacity;
            });
            
            // Увеличиваем разрешение для лучшего качества
            const scale = 2;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = width * scale;
            canvas.height = height * scale;
            ctx.scale(scale, scale);
            
            const svgData = new XMLSerializer().serializeToString(svgClone);
            const img = new Image();
            
            img.onload = function() {
                // Рисуем фон
                ctx.fillStyle = '#0f0c29';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Рисуем SVG
                ctx.drawImage(img, 0, 0, width, height);
                
                // Конвертируем в PNG
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = 'philosophy-graph.png';
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                }, 'image/png');
            };
            
            img.onerror = function(e) {
                console.error('Ошибка загрузки изображения:', e);
                alert('Ошибка при экспорте. Попробуйте использовать экспорт в SVG.');
            };
            
            // Кодируем SVG данные
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);
            img.src = url;
        }
        
        // Экспорт в SVG
        function exportToSVG() {
            const svgElement = document.getElementById('graph');
            const svgData = new XMLSerializer().serializeToString(svgElement);
            
            const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.download = 'philosophy-graph.svg';
            link.href = url;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        const width = window.innerWidth;
        const height = window.innerHeight;
        
        const svg = d3.select("#graph")
            .attr("width", width)
            .attr("height", height);

        // Контейнер для масштабирования и прокрутки
        const g = svg.append("g");

        // Настройка zoom
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        // Клик на фон для сброса подсветки
        svg.on("click", function(event) {
            if (event.target === this) {
                resetHighlight();
            }
        });

        const defs = svg.append("defs");
        
        Object.keys(relationTypes).forEach(type => {
            defs.append("marker")
                .attr("id", `arrow-${type}`)
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 26)
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,-5L10,0L0,5")
                .attr("fill", relationTypes[type].color);
            // Специальный маркер для внутренних противоречий
            defs.append("marker")
                .attr("id", "arrow-internal_contradiction")
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 26)
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,-5L10,0L0,5")
                .attr("fill", relationTypes["internal_contradiction"].color);
            
        });

        let simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(160))
            .force("charge", d3.forceManyBody().strength(-350))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(45));

        // Позиции для группировки по философам
        const philosophers = Object.keys(philosopherConcepts);
        const groupPositions = {};
        const cols = 6;
        const rows = Math.ceil(philosophers.length / cols);
        const spacingX = width / (cols + 1);
        const spacingY = height / (rows + 1);

        philosophers.forEach((phil, i) => {
            const col = i % cols;
            const row = Math.floor(i / cols);
            groupPositions[phil] = {
                x: spacingX * (col + 1),
                y: spacingY * (row + 1)
            };
        });

        let isGrouped = false;
        let selectedNodes = new Set(); // Множество выбранных узлов

        const link = g.append("g")
            .selectAll("path")
            .data(links)
            .enter()
            .append("path")
            .attr("class", d => {
                let classes = "link";
                if (d.bidirectional) classes += " bidirectional";
                if (d.type === "internal_contradiction") classes += " internal-contradiction";
                
                // Добавляем класс веса
                if (d.weight === 1) classes += " weight-weak";
                else if (d.weight === 2) classes += " weight-medium";
                else if (d.weight === 3) classes += " weight-strong";
                
                return classes;
            })
            .attr("stroke", d => relationTypes[d.type].color)
            .attr("marker-end", d => `url(#arrow-${d.type})`);

        const node = g.append("g")
            .selectAll("g")
            .data(nodes)
            .enter()
            .append("g")
            .attr("class", "node")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        node.append("circle")
            .attr("r", 18)
            .attr("fill", d => philosopherConcepts[d.concept].color)
            .attr("stroke", "#fff");

        node.append("text")
            .attr("dy", -25)
            .attr("text-anchor", "middle")
            .text(d => d.label);

        // Обработка клика на узле
        let clickTimer = null;
        let clickCount = 0;
        
        node.on("click", function(event, d) {
            event.stopPropagation();
            
            clickCount++;
            
            if (clickCount === 1) {
                // Первый клик - ждём, будет ли второй
                clickTimer = setTimeout(() => {
                    // Одинарный клик - подсветка связей
                    if (event.ctrlKey || event.metaKey) {
                        // Ctrl зажат - множественный выбор
                        if (selectedNodes.has(d)) {
                            selectedNodes.delete(d);
                        } else {
                            selectedNodes.add(d);
                        }
                    } else {
                        // Ctrl не зажат - одиночный выбор
                        if (selectedNodes.size === 1 && selectedNodes.has(d)) {
                            selectedNodes.clear();
                        } else {
                            selectedNodes.clear();
                            selectedNodes.add(d);
                        }
                    }
                    
                    if (selectedNodes.size > 0) {
                        highlightConnected(Array.from(selectedNodes));
                    } else {
                        resetHighlight();
                    }
                    clickCount = 0;
                }, 300);
            } else if (clickCount === 2) {
                // Двойной клик - показываем детальную информацию
                clearTimeout(clickTimer);
                showDetailModal(d);
                clickCount = 0;
            }
        });

        // Подсветка связанных узлов и связей
        function highlightConnected(selectedDataArray) {
            const connectedNodes = new Set();
            const connectedLinks = new Set();
            
            // Обрабатываем каждый выбранный узел
            selectedDataArray.forEach(selectedData => {
                connectedNodes.add(selectedData.id);
                
                // Находим все связанные узлы и связи
                links.forEach(l => {
                    if (l.source.id === selectedData.id) {
                        connectedNodes.add(l.target.id);
                        connectedLinks.add(l);
                    } else if (l.target.id === selectedData.id) {
                        connectedNodes.add(l.source.id);
                        connectedLinks.add(l);
                    }
                });
            });
            
            // Применяем стили только к видимым элементам
            node.each(function(d) {
                const element = d3.select(this);
                if (element.style("display") !== "none") {
                    const isSelected = selectedDataArray.some(sd => sd.id === d.id);
                    element.classed("dimmed", !connectedNodes.has(d.id))
                           .classed("highlighted", connectedNodes.has(d.id))
                           .classed("selected", isSelected);
                }
            });
            
            link.each(function(l) {
                const element = d3.select(this);
                if (element.style("display") !== "none") {
                    element.classed("dimmed", !connectedLinks.has(l))
                           .classed("highlighted", connectedLinks.has(l));
                }
            });
        }

        // Сброс подсветки
        function resetHighlight() {
            selectedNodes.clear();
            node.classed("dimmed", false)
                .classed("highlighted", false)
                .classed("selected", false);
            link.classed("dimmed", false)
                .classed("highlighted", false);
        }

        // Tooltip
        // Tooltip
        const tooltip = d3.select("#tooltip");

        node.on("mouseover", function(event, d) {
            tooltip
                .style("opacity", 1)
                .html(`<strong>${d.label}</strong><br/>${d.description}<br/><em>${d.concept}</em>`)
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 15) + "px");
        })
        .on("mouseout", function() {
            tooltip.style("opacity", 0);
        });

        link.on("mouseover", function(event, d) {
            const sourceNode = nodes.find(n => n.id === d.source.id);
            const targetNode = nodes.find(n => n.id === d.target.id);
            const direction = d.bidirectional ? "↔" : "→";
            tooltip
                .style("opacity", 1)
                .html(`<strong>${relationTypes[d.type].label}</strong><br/>${sourceNode.label} ${direction} ${targetNode.label}`)
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 15) + "px");
        })
        .on("mouseout", function() {
            tooltip.style("opacity", 0);
        });

        simulation.on("tick", () => {
            link.attr("d", d => {
                const dx = d.target.x - d.source.x;
                const dy = d.target.y - d.source.y;
                const dr = Math.sqrt(dx * dx + dy * dy) * 1.5;
                return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
            });

            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        function resetSimulation() {
            nodes.forEach(n => {
                n.fx = null;
                n.fy = null;
            });
            resetHighlight();
            simulation.alpha(1).restart();
        }

        function centerGraph() {
            const transform = d3.zoomIdentity
                .translate(window.innerWidth / 2, window.innerHeight / 2)
                .scale(1);
            svg.transition().duration(750).call(zoom.transform, transform);
            simulation.force("center", d3.forceCenter(window.innerWidth / 2, window.innerHeight / 2));
            simulation.alpha(0.3).restart();
        }

        function toggleGrouping() {
            isGrouped = !isGrouped;
            const btn = document.getElementById('groupBtn');
            
            resetHighlight();
            
            if (isGrouped) {
                btn.classList.add('active');
                btn.textContent = '📦 Разгруппировать';
                
                // Добавляем силы группировки
                simulation
                    .force("x", d3.forceX(d => groupPositions[d.concept].x).strength(0.3))
                    .force("y", d3.forceY(d => groupPositions[d.concept].y).strength(0.3))
                    .force("charge", d3.forceManyBody().strength(-200))
                    .force("collision", d3.forceCollide().radius(40));
            } else {
                btn.classList.remove('active');
                btn.textContent = '📦 Группировать';
                
                // Убираем силы группировки
                simulation
                    .force("x", null)
                    .force("y", null)
                    .force("charge", d3.forceManyBody().strength(-350))
                    .force("collision", d3.forceCollide().radius(45))
                    .force("center", d3.forceCenter(window.innerWidth / 2, window.innerHeight / 2));
            }
            
            simulation.alpha(0.5).restart();
        }

        window.addEventListener('resize', () => {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight;
            svg.attr("width", newWidth).attr("height", newHeight);
            
            // Пересчитываем позиции групп
            const newSpacingX = newWidth / (cols + 1);
            const newSpacingY = newHeight / (rows + 1);
            philosophers.forEach((phil, i) => {
                const col = i % cols;
                const row = Math.floor(i / cols);
                groupPositions[phil] = {
                    x: newSpacingX * (col + 1),
                    y: newSpacingY * (row + 1)
                };
            });
            
            if (isGrouped) {
                simulation
                    .force("x", d3.forceX(d => groupPositions[d.concept].x).strength(0.3))
                    .force("y", d3.forceY(d => groupPositions[d.concept].y).strength(0.3));
            } else {
                simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2));
            }
            
            simulation.alpha(0.3).restart();
        });
        
        function showDetailModal(conceptData) {
            const modal = document.getElementById('detailModal');
            const overlay = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            
            const rubricName = conceptToRubric[conceptData.id];
            const rubricData = rubricName ? rubrics[rubricName] : null;
            
            let html = `
                <h2>${conceptData.label}</h2>
                <div class="philosopher-tag" style="background: ${philosopherConcepts[conceptData.concept].color}">
                    ${conceptData.concept}
                </div>
                <div class="description">${conceptData.description}</div>
            `;
            
            if (rubricData) {
                // Находим другие концепции из той же рубрики
                const relatedConcepts = nodes.filter(n => 
                    rubricData.concepts.includes(n.id) && n.id !== conceptData.id
                );
                
                html += `
                    <div class="rubric-section">
                        <div class="rubric-title">📚 Рубрика: ${rubricName}</div>
                        <div class="rubric-description">${rubricData.description}</div>
                        
                        ${relatedConcepts.length > 0 ? `
                            <div class="related-concepts">
                                <div class="related-title">Также в этой рубрике: (${relatedConcepts.length}):</div>
                                ${relatedConcepts.map(c => `
                                    <div class="concept-item" onclick="closeDetailModal(); setTimeout(() => showDetailModal(nodes.find(n => n.id === '${c.id}')), 100);">
                                        <div class="concept-color" style="background: ${philosopherConcepts[c.concept].color}"></div>
                                        <div class="concept-name">${c.label}</div>
                                        <div class="concept-philosopher">${c.concept}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                html += `<div class="rubric-section">
                    <div class="rubric-description" style="color: #95a5a6;">
                        Эта концепция пока не отнесена к какой-либо рубрике.
                    </div>
                </div>`;
            }
            
            content.innerHTML = html;
            modal.classList.add('show');
            overlay.classList.add('show');
        }
        
        function closeDetailModal() {
            const modal = document.getElementById('detailModal');
            const overlay = document.getElementById('modalOverlay');
            modal.classList.remove('show');
            overlay.classList.remove('show');
        }
        
        // Закрытие по клику на overlay
        document.getElementById('modalOverlay').addEventListener('click', closeDetailModal);
        
        // Закрытие по Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeDetailModal();
            }
        });
        
        // Инициализируем фильтры при загрузке
        initFilters();
        updateFilterStats();
        
        // Инициализируем новые функции
        initPathFinder();
        displayStatistics();
        
        // Обновляем статистику после завершения симуляции
        simulation.on("end", () => {
            setTimeout(() => {
                displayStatistics();
            }, 500);
        });
        
    </script>
</body>
</html>
